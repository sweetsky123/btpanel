import{r as e,c as a,o as t,v as l,I as s,J as o,z as n,x as i,y as r,e as d,C as u,A as c,F as m,b1 as f,O as p,D as h,G as v,L as b,B as y,R as _,a1 as x,U as g,am as k,an as V,ad as w,ak as T,aj as j,c5 as C,V as D,aT as U,ab as L}from"./base-lib.js?v=1763689792";import{bR as S,e as $,ax as E,d as I,N as R,k as A,$ as H,b as O,_ as F}from"./utils-lib.js?v=1763689792";import{u as N}from"./index283.js?v=1763689792";import{Q as q,R as J,S as P,T as z,g as B}from"./useController7.js?v=1763689792";import{f as G}from"./validator.js?v=1763689792";import{addProxyProject as M}from"./site.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./column.js?v=1763689792";import"./index107.js?v=1763689792";const{domainId:Q,domainName:K,createSiteType:W}=N(),X=e([]),Y=[{value:"url",label:"URL地址"},{value:"unix",label:"unix地址"}],Z=(e,a)=>{const t=a.domains[e];t.name&&t.suffix?(t.fullDomain="".concat(t.name).concat(t.suffix),0===e&&(a.remark=t.fullDomain)):t.fullDomain=""},ee=(e,a)=>{let t="";if(e.domains&&e.domains.length>0){const a=e.domains.find(e=>e.suffix&&""!==e.suffix);a&&(t=a.suffix)}!t&&Array.isArray(a)&&a.length>0&&(t=a[0].value),e.domains.push({name:"",suffix:t,fullDomain:"",status:"",hint:""})},ae=(e,a)=>{if(a.domains.length>1&&(a.domains.splice(e,1),0===e&&a.domains.length>0)){const e=a.domains[0];e.name&&e.suffix&&(e.fullDomain="".concat(e.name).concat(e.suffix),a.remark=e.fullDomain)}},te=(e,a)=>{G({type:"file",path:e.proxysite,change:t=>{const l=S(t,"string","");e.proxysite=l,a&&a.value&&a.value.validateField("proxysite")}})},le=(e,a)=>{if("object"==typeof e)return;if("unix"===a.targetType)return void(a.todomain="$http_host");let t=e.replace(/^http[s]?:\/\//,"");t=t.replace(/(:|\?|\/|\\)(.*)$/,""),a.todomain=t},se=async(e,a,t,l,s,o)=>{var n;s.value=!0;let i=null;try{const t=a.domains[0];if(t&&"*"===t.name)return t.hint="第一个域名不能是通配符",t.status="error",l.error("第一个域名不能是通配符"),!1;"local"!==(null==W?void 0:W.value)?await(async e=>{try{const a=e.domains.filter(e=>e.name&&e.suffix).map(e=>e.fullDomain);if(0===a.length)return;e.domains.forEach(e=>{e.name&&e.suffix&&(e.status="checking",e.hint="检测中...")});const t=await P({domains:a});if(t.data&&t.data.data){const a=t.data.data;e.domains.forEach(e=>{if(e.name&&e.suffix){const t=a[e.fullDomain];!0===t?(e.status="available",e.hint="域名可用"):!1===t?(e.status="registered",e.hint="域名已被注册"):(e.status="error",e.hint="检测失败")}})}}catch(a){e.domains.forEach(e=>{e.name&&e.suffix&&(e.status="error",e.hint="检测失败")})}})(a):a.domains.forEach(e=>{e.name&&e.suffix&&(e.status="available",e.hint="")});let s=0,d=0,u=0,c=0;const m=[];for(const e of a.domains)if(e.name&&e.suffix)switch(e.status){case"checking":s++;break;case"registered":d++;break;case"error":u++;break;case"available":c++,m.push(e)}if(s>0)return l.error("域名检测中，请稍候..."),!1;if(d>0)return l.error("存在不可用的域名，请检查后重试"),!1;if(u>0)return l.error("域名检测失败，请重试"),!1;if(c>0&&(i=l.load("所有域名都可用，正在创建反向代理...")),0===m.length)return l.error("没有可用的域名"),!1;const f=m.map(e=>e.fullDomain),p=m[0],h={remark:p?"".concat(a.remark).concat(p.suffix):a.remark,proxy_type:"url"===a.targetType?"http":"unix",proxy_pass:a.proxysite,domains:f.join("\n"),proxy_host:p?"".concat(a.todomain).concat(p.suffix):a.todomain};if((await M(h)).status){try{const e=m.map(e=>{const a=o.value.find(a=>a.value===e.suffix),t=(null==a?void 0:a.id)||Q.value||0;return{name:e.fullDomain,["domain"===W.value?"domain_id":"local_domain_id"]:t,record:e.name}}),t=JSON.stringify(e);let l="",s=!1;"certificate"===a.ssl_type&&a.ssl_cert&&(l=a.ssl_cert,s=a.force_https);const i={domain_list:t,ssl_hash:l,site_name:(null==(n=m[0])?void 0:n.fullDomain)||"",https:s};await q(i)}catch(r){}return e&&e(),l.success("反向代理创建成功"),!0}return l.error("反向代理创建失败"),!1}catch(d){return!1}finally{null==i||i.close(),s.value=!1}};let oe="",ne="";const ie=(e,a)=>{oe=e,ne=a},re=(e,a)=>{if(e===oe){a([...X.value].sort((e,a)=>{const t=e.label===oe&&e.value===ne,l=a.label===oe&&a.value===ne;return t&&!l?-1:!t&&l?1:0}))}else if(e){const t=X.value.filter((e=>a=>{const t=a.label.split(" - ")[0],l=e.toLowerCase();return t.toLowerCase().includes(l)||a.label.toLowerCase().includes(l)})(e));a(t)}else a(X.value)},de={class:"reverse-proxy-form"},ue={class:"domain-input-container"},ce={class:"domain-input-group"},me={class:"domain-actions"},fe={class:"cert-option-content"},pe={class:"cert-name text-base font-500 mb-3"},he={class:"cert-sublabel text-small"},ve={class:"flex items-center"},be=F(a({__name:"index",props:{compData:{default:()=>({domainId:0})}},setup(a,{expose:S}){const{domainId:F,getDomainHintClass:q}=N(),P=e(!1),G=e(!1),M=e(),Q=t({domains:[{name:"",suffix:"",fullDomain:"",status:"",hint:""}],targetType:"url",proxysite:"http://",todomain:"$http_host",remark:"",ssl_type:"false",ssl_cert:"",force_https:!1}),oe=e([]),ne=e(""),be=e(""),ye=()=>{Q.proxysite="url"===Q.targetType?"http://":""},_e=async e=>{const a=String(e);if(ne.value="",be.value="",Q.ssl_cert="",ie("",""),"certificate"===a)try{const e=await z({p:1,limit:100,reverse:1,search_limit:1});e.status&&e.data&&(X.value=e.data.map(e=>{var a,t;const l=e.dns&&e.dns.length>0?e.dns.join(", "):e.subject||"未知域名";let s="";if(void 0!==e.endtime)if(e.endtime<0)s="已过期".concat(Math.abs(e.endtime),"天");else{const t=(null==(a=e.info)?void 0:a.notAfter)||"未知";s="过期时间：".concat(t,"（剩").concat(e.endtime,"天）")}const o=(null==(t=e.info)?void 0:t.issuer_O)?" - ".concat(e.info.issuer_O):"";return{label:l+" - "+s+o,subLabel:s+o,value:e.hash}}))}catch(t){}else Q.ssl_cert="",Q.force_https=!1},xe={proxysite:[{required:!0,message:"请输入目标地址",trigger:"blur"},{validator:(e,a,t)=>{if(!a)return void t(new Error("url"===Q.targetType?"目标地址不能为空":"请选择sock文件"));if("unix"===Q.targetType)return void t();const l=a.trim();if(/^https?:\/\/$/.test(l))return void t(new Error("请输入目标URL域名"));if(!/^https?:\/\/.+/.test(l))return void t(new Error("目标URL格式不正确，应以http://或https://开头"));let s=a.replace(/^http[s]?:\/\//,"");s=s.replace(/(:|\?|\/|\\)(.*)$/,""),/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/.test(s)?Q.todomain="$http_host":Q.todomain=s,t()}}],todomain:[{required:!0,message:"请输入发送域名",trigger:["blur","change"]}]},ge=async()=>{P.value=!0;try{await(async(e,a,t)=>{var l;try{const s={p:1,limit:200},o="domain"===W.value?await t(s):await J(s),n="domain"===W.value?o.data:o.data.data;if(n&&n.length>0){const t=n.map(e=>({label:".".concat("domain"===W.value?e.full_domain:e.domain),value:".".concat("domain"===W.value?e.full_domain:e.domain),id:(W.value,e.id),fullDomain:"domain"===W.value?e.full_domain:e.domain})).sort((e,a)=>e.label.localeCompare(a.label));e.value=t;let s=(null==(l=t[0])?void 0:l.value)||"";if(K.value){const e=t.find(e=>e.value===".".concat(K.value)||e.value===K.value);e&&(s=e.value)}a.domains.forEach(e=>{e.suffix&&""!==e.suffix||(e.suffix=s)})}}catch(s){}})(oe,Q,B)}catch(e){}finally{P.value=!1}};return l(ge),S({init:ge,onConfirm:e=>{const a=O();return se(e,Q,0,a,G,oe)}}),(e,a)=>{const t=g,l=k,S=V,O=$,F=w,N=T,J=j,z=C,B=D,K=E,W=I,X=R,se=A,ge=U,ke=H,Ve=L,we=s("bt-loading");return o((i(),r("div",de,[d(Ve,{model:n(Q),rules:xe,disabled:n(G),ref_key:"addSiteFormRef",ref:M},{default:u(()=>[d(F,{label:"域名","label-width":"100px",class:"!mb-0"},{default:u(()=>[c("div",ue,[(i(!0),r(m,null,f(n(Q).domains,(e,s)=>(i(),r("div",{key:s,class:"domain-item"},[c("div",ce,[d(t,{modelValue:e.name,"onUpdate:modelValue":a=>e.name=a,placeholder:"请输入子域名 (不支持通配符)",class:"domain-name-input",onInput:()=>n(Z)(s,n(Q))},null,8,["modelValue","onUpdate:modelValue","onInput"]),d(S,{modelValue:e.suffix,"onUpdate:modelValue":a=>e.suffix=a,placeholder:"选择后缀",class:"domain-suffix-select",onChange:()=>n(Z)(s,n(Q))},{default:u(()=>[(i(!0),r(m,null,f(n(oe),e=>(i(),p(l,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),c("div",me,[s===n(Q).domains.length-1&&n(Q).domains.length<10?(i(),p(O,{key:0,onClick:a[0]||(a[0]=()=>n(ee)(n(Q),n(oe))),class:"text-primary"},{default:u(()=>[...a[11]||(a[11]=[h(" 添加 ",-1)])]),_:1})):v("",!0),n(Q).domains.length>1?(i(),p(O,{key:1,onClick:()=>n(ae)(s,n(Q)),class:"text-danger"},{default:u(()=>[...a[12]||(a[12]=[h(" 移除 ",-1)])]),_:1},8,["onClick"])):v("",!0)])]),c("div",{class:b(["domain-hint",n(q)(e.status)])},y(e.hint),3)]))),128))])]),_:1}),d(F,{"label-width":"100px",label:"SSL证书配置"},{default:u(()=>[d(J,{modelValue:n(Q).ssl_type,"onUpdate:modelValue":a[1]||(a[1]=e=>n(Q).ssl_type=e),onChange:_e},{default:u(()=>[d(N,{value:"false"},{default:u(()=>[...a[13]||(a[13]=[h("不使用SSL",-1)])]),_:1}),d(N,{value:"certificate"},{default:u(()=>[...a[14]||(a[14]=[h("证书夹",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"certificate"===n(Q).ssl_type?(i(),p(F,{key:0,"label-width":"100px",label:"选择证书"},{default:u(()=>[d(z,{"popper-class":"my-autocomplete",modelValue:n(ne),"onUpdate:modelValue":a[2]||(a[2]=e=>_(ne)?ne.value=e:null),class:"!w-[52rem]","popper-append-to-body":!1,"fetch-suggestions":n(re),"trigger-on-focus":!0,clearable:"","value-key":"label",onSelect:a[3]||(a[3]=e=>{ne.value=e.label,be.value=e.value,n(Q).ssl_cert=e.value,n(ie)(e.label,e.value)}),placeholder:"请输入或选择证书"},{default:u(({item:e})=>[c("div",{class:b(["cert-option !h-[5.4rem] !leading-auto !line-height-normal flex flex-col justify-center",e.label===n(ne)&&e.value===n(be)?"is-selected":""])},[c("div",fe,[c("div",pe,y(e.label.split(" - ")[0]),1),c("div",he,y(e.subLabel),1)])],2)]),_:1},8,["modelValue","fetch-suggestions"])]),_:1})):v("",!0),"certificate"===n(Q).ssl_type?(i(),p(F,{key:1,"label-width":"100px",label:"强制HTTPS访问"},{default:u(()=>[d(B,{modelValue:n(Q).force_https,"onUpdate:modelValue":a[4]||(a[4]=e=>n(Q).force_https=e)},{default:u(()=>[...a[15]||(a[15]=[h("启用强制HTTPS访问",-1)])]),_:1},8,["modelValue"])]),_:1})):v("",!0),d(F,{"label-width":"100px",label:"目标",prop:"proxysite"},{default:u(()=>[c("div",ve,[d(F,{"label-width":"50px"},{default:u(()=>[d(K,{modelValue:n(Q).targetType,"onUpdate:modelValue":a[5]||(a[5]=e=>n(Q).targetType=e),placeholder:"请选择",options:n(Y),style:{width:"16rem","margin-right":"1rem"},onChange:ye},null,8,["modelValue","options"])]),_:1}),d(se,{modelValue:n(Q).proxysite,"onUpdate:modelValue":a[7]||(a[7]=e=>n(Q).proxysite=e),placeholder:"url"===n(Q).targetType?"请输入目标地址":"请选择sock文件",width:"35rem",iconType:"url"!==n(Q).targetType&&"folder",onInput:a[8]||(a[8]=e=>n(le)(e,n(Q)))},x({_:2},["url"!==n(Q).targetType?{name:"append",fn:u(()=>[d(X,{onClick:a[6]||(a[6]=()=>n(te)(n(Q),n(M)))},{default:u(()=>[d(W,{icon:"el-folder-opened",class:"cursor-pointer"})]),_:1})]),key:"0"}:void 0]),1032,["modelValue","placeholder","iconType"])])]),_:1}),d(F,{"label-width":"100px",label:"发送域名(host)",prop:"todomain"},{default:u(()=>[d(ge,{content:"请求转发到后端服务器时的主机名，一般为$http_host，如果目标URL是域名，则需要改为域名",placement:"top","show-after":300},{default:u(()=>[d(se,{modelValue:n(Q).todomain,"onUpdate:modelValue":a[9]||(a[9]=e=>n(Q).todomain=e),placeholder:"请输入发送域名",width:"52rem"},null,8,["modelValue"])]),_:1})]),_:1}),d(F,{"label-width":"100px",label:"备注"},{default:u(()=>[d(se,{modelValue:n(Q).remark,"onUpdate:modelValue":a[10]||(a[10]=e=>n(Q).remark=e),placeholder:"请输入备注,可为空",width:"52rem"},null,8,["modelValue"])]),_:1}),d(F,{label:" "},{default:u(()=>[d(ke,{options:[{content:"堡塔后台开启密保验证功能，无法添加解析记录"}]})]),_:1})]),_:1},8,["model","disabled"])])),[[we,n(P)]])}}}),[["__scopeId","data-v-deae7b5b"]]);export{be as default};
