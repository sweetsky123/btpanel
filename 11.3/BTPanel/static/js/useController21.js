import{e,u as t,d as a,k as l,j as s,ax as n,Q as r,aK as u,M as o,p as i,az as c}from"./utils-lib.js?v=1763689792";import{c as m,v as p,I as d,J as g,z as v,x as y,y as h,F as f,B as x,G as b,A as _,e as w,D as k,C as j,t as E,O as V,R as C,M as I,ap as S,b2 as L,V as z,H as T,aA as P,ad as R,ab as B,j as U,r as N,o as q,g as H,n as O}from"./base-lib.js?v=1763689792";import{_ as A,f as G,p as M}from"./validator.js?v=1763689792";import{_ as F}from"./index.vue_vue_type_script_setup_true_lang20.js?v=1763689792";import{_ as D}from"./index123.js?v=1763689792";import{u as J,S as K}from"./useStore4.js?v=1763689792";import{_ as Q}from"./index107.js?v=1763689792";import{p as W}from"./useController5.js?v=1763689792";import{A as X}from"./index350.js?v=1763689792";import{getSiteErrorLogs as Y,getSpringBootLogList as Z,getSpringBootLog as $,changeSiteLogPath as ee,setPushTask as te,getSiteLogPushStatus as ae,getIpArea as le,getSiteLogs as se,getSiteLogFile as ne}from"./site.js?v=1763689792";const re={class:"h-full"},ue={key:0,class:"mb-[16px]"},oe={class:"flex"},ie={key:1,class:"bg-light flex items-center justify-center h-full",style:{"min-height":"500px"}},ce={class:"bg-lighter px-[48px] py-[16px] text-default flex items-center"},me=m({__name:"error-log",setup(t,{expose:a}){const{isBindExtranet:l,siteType:s}=J(),{jumpTabEvent:n}=K();return p(st),a({init:st}),(t,a)=>{const r=e,u=d("bt-loading");return g((y(),h("div",re,[v(l)?(y(),h(f,{key:0},["proxy"===v(s)?(y(),h("div",ue,"日志大小："+x(v(Qe).size),1)):b("",!0),_("div",oe,[w(D,{content:v(Qe).logs,isHtml:!0,fullScreen:{title:"全屏查看[错误]日志",onRefresh:v(st)},style:{height:"56rem",width:"99.5%"}},null,8,["content","fullScreen"])])],64)):(y(),h("div",ie,[_("div",ce,[a[2]||(a[2]=k(" 请开启 ",-1)),w(r,{class:"mx-[.4rem]",onClick:a[0]||(a[0]=e=>v(n)("mapping"))},{default:j(()=>[...a[1]||(a[1]=[k(" 外网映射 ",-1)])]),_:1}),a[3]||(a[3]=k(" 后查看 ",-1))])]))])),[[u,v(Ke)]])}}}),pe={class:"h-full"},de={key:0,class:"flex items-center justify-between pb-1.6rem"},ge={class:"flex items-center"},ve={class:"ml-[8px]"},ye={class:"flex items-center"},he={class:"flex items-center p-[12px]"},fe={key:1,class:"mb-[16px]"},xe={key:2,class:"mt-1rem"},be={key:1,class:"bg-light flex items-center justify-center h-full",style:{"min-height":"500px"}},_e={class:"bg-lighter px-[48px] py-[16px] text-default flex items-center"},we={class:"p-[20px]"},ke=m({__name:"response-log",setup(n,{expose:r}){const{plugin:u,enterpriseRec:o}=t(),{webserver:i}=E(u.value),{isBindExtranet:c,siteType:m}=J(),{jumpTabEvent:U}=K();return p(St),r({init:St}),(t,n)=>{const r=S,u=L,p=a,E=z,N=Q,q=T,H=P,O=e,G=l,M=R,F=B,J=s,K=d("bt-loading");return y(),h("div",pe,[v(c)?(y(),h(f,{key:0},["proxy"!==v(m)?(y(),h("div",de,[g((y(),h("div",ge,["python"!==v(m)?(y(),h(f,{key:0},[w(r,{onChange:v(wt),modelValue:v(dt).alert,"onUpdate:modelValue":n[0]||(n[0]=e=>v(dt).alert=e)},null,8,["onChange","modelValue"]),_("span",ve,[n[14]||(n[14]=k(" 关键字告警 ",-1)),_("span",{class:"!inline-block bt-link",onClick:n[1]||(n[1]=(...e)=>v(Vt)&&v(Vt)(...e))}," [配置] ")]),w(u,{direction:"vertical",class:"!h-2rem !mx-1.6rem"})],64)):b("",!0),v(o)?(y(),V(E,{key:1,onChange:v(_t),modelValue:v(dt).showIp,"onUpdate:modelValue":n[2]||(n[2]=e=>v(dt).showIp=e)},{default:j(()=>[_("div",ye,[n[15]||(n[15]=k(" 显示IP归属地信息 ",-1)),w(p,{icon:"icon-ltd",size:16,color:"#9B7E48",class:"ml-[4px]"})])]),_:1},8,["onChange","modelValue"])):b("",!0),"php"===v(m)?(y(),h(f,{key:2},[w(u,{direction:"vertical",class:"!h-2rem !mx-1.6rem"}),w(H,{trigger:"click",placement:"bottom","popper-class":"white-tips-popover",width:"400",visible:v(pt),"onUpdate:visible":n[5]||(n[5]=e=>C(pt)?pt.value=e:null)},{reference:j(()=>[w(q,{type:"default"},{default:j(()=>[...n[17]||(n[17]=[k("更改日志路径",-1)])]),_:1})]),default:j(()=>[_("div",he,[w(N,{placeholder:"请输入日志路径",modelValue:v(mt),"onUpdate:modelValue":n[3]||(n[3]=e=>C(mt)?mt.value=e:null),onIconClick:v(xt),icon:"el-folder-opened"},null,8,["modelValue","onIconClick"]),w(q,{type:"primary",class:"!ml-[8px]",onClick:n[4]||(n[4]=e=>v(bt)())},{default:j(()=>[...n[16]||(n[16]=[k(" 保存 ",-1)])]),_:1})])]),_:1},8,["visible"])],64)):b("",!0)])),[[K,v(Ke)]]),w(q,{type:"primary",onClick:n[6]||(n[6]=()=>v(Ct)())},{default:j(()=>[...n[18]||(n[18]=[k("刷新日志",-1)])]),_:1})])):b("",!0),"proxy"===v(m)?(y(),h("div",fe,"日志大小："+x(v(dt).size),1)):b("",!0),g(w(D,{content:v(dt).logs,isHtml:!0,fullScreen:{title:"全屏查看[响应]日志",onRefresh:v(Ct)},style:I({height:"php"===v(m)?"52rem":"56rem",width:"99.5%"})},null,8,["content","fullScreen","style"]),[[K,v(Ke)]]),"nginx"===v(i)&&"php"===v(m)?(y(),h("div",xe,[n[19]||(n[19]=k(" * 若网站开启cdn导致日志",-1)),n[20]||(n[20]=_("span",{class:"text-danger"},"来源IP",-1)),n[21]||(n[21]=k("解析错误，可前往[ ",-1)),_("span",{class:"cursor-pointer bt-link",onClick:n[7]||(n[7]=e=>v(W)("globalSetting"))},"全局设置"),n[22]||(n[22]=k(" ]打开cdn来源IP解析 ",-1))])):b("",!0)],64)):(y(),h("div",be,[_("div",_e,[n[24]||(n[24]=k(" 请开启 ",-1)),w(O,{class:"mx-[.4rem]",onClick:n[8]||(n[8]=e=>v(U)("mapping"))},{default:j(()=>[...n[23]||(n[23]=[k(" 外网映射 ",-1)])]),_:1}),n[25]||(n[25]=k(" 后查看 ",-1))])])),w(J,{title:"关键字告警配置",onConfirm:n[12]||(n[12]=e=>v(jt)(v(ht),"confirm")),onCancel:v(kt),modelValue:v(vt),"onUpdate:modelValue":n[13]||(n[13]=e=>C(vt)?vt.value=e:null),area:46,showFooter:""},{default:j(()=>[_("div",we,[w(F,{"label-position":"right",model:v(ht),rules:v(ft),ref_key:"alertSetFormRef",ref:yt},{default:j(()=>[w(M,{label:"周期",prop:"cycle"},{default:j(()=>[w(G,{modelValue:v(ht).cycle,"onUpdate:modelValue":n[9]||(n[9]=e=>v(ht).cycle=e),type:"number",min:1,width:"24rem","text-type":"分钟"},null,8,["modelValue"])]),_:1}),w(M,{label:"关键字",prop:"keys"},{default:j(()=>[w(G,{modelValue:v(ht).keys,"onUpdate:modelValue":n[10]||(n[10]=e=>v(ht).keys=e),type:"textarea",resize:"none",row:6,width:"24rem"},null,8,["modelValue"])]),_:1}),w(M,{label:"告警方式",prop:"channel"},{default:j(()=>[w(A,{modelValue:v(ht).channel,"onUpdate:modelValue":n[11]||(n[11]=e=>v(ht).channel=e),multiple:!0,limit:["sms"],class:"!w-[24rem]"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),n[26]||(n[26]=_("ul",{class:"mt-[8px] leading-8 text-small list-disc ml-[20px]"},[_("li",null,"检查时只检查间隔时间内的日志内容"),_("li",null,"周期时间请勿设置太小，建议10分钟以上以免导致服务器资源异常")],-1))])]),_:1},8,["onCancel","modelValue"])])}}}),je={key:1,class:"bg-light flex items-center justify-center h-full",style:{"min-height":"500px"}},Ee={class:"bg-lighter px-[48px] py-[16px] text-default flex items-center"},Ve=m({__name:"safe-analysis",setup(t){const{isBindExtranet:a,siteInfo:l}=J(),{jumpTabEvent:s}=K();return(t,n)=>{const r=e;return y(),h("div",null,[v(a)?(y(),V(X,{key:0,type:"site",name:v(l).name},null,8,["name"])):(y(),h("div",je,[_("div",Ee,[n[2]||(n[2]=k(" 请开启 ",-1)),w(r,{class:"mx-[.4rem]",onClick:n[0]||(n[0]=e=>v(s)("mapping"))},{default:j(()=>[...n[1]||(n[1]=[k(" 外网映射 ",-1)])]),_:1}),n[3]||(n[3]=k(" 后查看 ",-1))])]))])}}}),Ce={class:"flex flex-col"},Ie={class:"flex items-center"},Se={class:"mt-[16px]"},Le={class:"p-[12px] w-full flex items-start overflow-y-auto h-full"},ze=["innerHTML"],Te=m({__name:"spring-boot-logs",setup(e,{expose:a}){const{mainHeight:l}=t();return p(ct),a({init:ct}),(e,t)=>{const a=n,r=T,u=s,o=d("bt-loading");return g((y(),h("div",Ce,[_("div",Ie,[t[2]||(t[2]=_("span",null,"日志路径",-1)),w(a,{modelValue:v($e).path,"onUpdate:modelValue":t[0]||(t[0]=e=>v($e).path=e),options:v(We),onChange:v(rt),placeholder:"请选择",class:"!w-[38rem] !mx-[.8rem]"},null,8,["modelValue","options","onChange"])]),_("div",Se,[_("div",null,[w(r,{type:"primary",onClick:v(nt)},{default:j(()=>[...t[3]||(t[3]=[k("刷新日志",-1)])]),_:1},8,["onClick"]),w(r,{type:"default",onClick:v(ot)},{default:j(()=>[...t[4]||(t[4]=[k("实时日志",-1)])]),_:1},8,["onClick"])]),w(D,{title:"全屏查看【项目】日志",content:v($e).logs,isHtml:!0,fullScreen:{title:"全屏查看【项目】日志",onRefresh:v(nt)},class:"mt-[16px]",style:I({height:"java"===v(Xe)?"48rem":"64rem",width:"99.5%"})},null,8,["content","fullScreen","style"])]),w(u,{title:"查看日志",onCancel:v(it),modelValue:v(Ye),"onUpdate:modelValue":t[1]||(t[1]=e=>C(Ye)?Ye.value=e:null),area:["100%","100%"],"close-btn":1},{default:j(()=>[_("div",{ref_key:"logPopupCon",ref:Ze,class:"bg-[#333] text-white w-full h-full",style:I("height: ".concat(v(l),"px;"))},[_("pre",Le,[t[5]||(t[5]=k("\t\t\t\t\t",-1)),_("code",{class:"flex-1 w-full p-0 bg-none whitespace-pre-line text-i text-[#ececec]",innerHTML:v($e).logs},null,8,ze),t[6]||(t[6]=k("\n\t\t\t\t",-1))])],4)]),_:1},8,["onCancel","modelValue"])])),[[o,v(Ke)]])}}}),Pe=U("SITE-LOGS-STORE",()=>{const{siteType:e,siteInfo:t}=J();return{getErrorLogsEvent:async t=>{try{const{data:a}=await Y(t,e.value);return{data:a,status:!0}}catch(a){return{msg:"获取错误日志失败",status:!1}}},getSpringLogEvent:async e=>{try{const{data:t}=await Z(e);return{data:t.data,status:t.status}}catch(t){return{msg:"获取日志失败",status:!1}}},setSpringPathEvent:async e=>{try{const{data:t}=await $(e);return{status:t.status,msg:t.data}}catch(t){return{msg:"保存路径失败",status:!1}}},saveResLogPathEvent:async e=>{try{const t=await r({loading:"正在保存日志路径，请稍后...",request:ee(e),message:!0});return{status:t.status,msg:t.msg}}catch(t){return{msg:"保存路径失败",status:!1}}},setPushTaskEvent:async e=>{try{const t=await r({loading:"正则处理中，请稍后...",request:te(e),message:!0});return{status:t.status,msg:t.msg}}catch(t){return{status:!1,msg:"推送失败"}}},getLogPushEvent:async()=>{try{return{data:await r({request:ae({sitename:t.value.name}),data:{status:Boolean,"config.cycle":[Number,"cycle"],"config.keys":[Array,"keys"],"config.channel":[String,"channel"]}}),status:!0}}catch(e){return{msg:"获取推送配置失败",status:!1}}},getIpStatusEvent:async()=>{try{return{data:(await r({request:le(),data:{msg:[Number,"msg"]}})).msg,status:!0}}catch(e){return{msg:"获取IP归属地失败",status:!1}}},getResLogEvent:async t=>{try{const a=await se(t,e.value);return{data:a.data,status:a.status}}catch(a){return{msg:"获取日志失败",status:!1}}}}}),{payment:Re}=t(),{authType:Be}=E(Re.value),{getErrorLogsEvent:Ue,getSpringLogEvent:Ne,setSpringPathEvent:qe,saveResLogPathEvent:He,setPushTaskEvent:Oe,getLogPushEvent:Ae,getIpStatusEvent:Ge,getResLogEvent:Me}=Pe(),{siteType:Fe,siteInfo:De,isBindExtranet:Je}=J(),Ke=N(!1),Qe=N({logs:"",size:"0 b"}),We=N([]),Xe=N(""),Ye=N(!1),Ze=N(null),$e=q({path:"",logs:"",type:"",size:"",isNew:!1,isGunicorn:!1}),et=H(()=>{var e;return(null==(e=De.value)?void 0:e.tabName)||("java"===Fe.value?"projectLog":"response")}),tt=N([{label:"响应日志",name:"response",lazy:!0,render:()=>w(ke,null,null)},{label:"错误日志",name:"error",lazy:!0,render:()=>w(me,null,null)},{label:"日志安全分析",name:"safe",lazy:!0,render:()=>w(Ve,null,null)}]),at=e=>{},lt=()=>{var e,t,a,l;"java"===Fe.value?(tt.value.some(e=>"projectLog"===e.name)||tt.value.unshift({label:"项目日志",name:"projectLog",lazy:!0,render:()=>w(F,null,null)}),"springboot"===(null==(t=null==(e=De.value)?void 0:e.project_config)?void 0:t.java_type)?tt.value.some(e=>"springbootLog"===e.name)||tt.value.push({label:"springBoot日志",name:"springbootLog",lazy:!0,render:()=>w(Te,null,null)}):tt.value=tt.value.filter(e=>"springbootLog"!==e.name)):tt.value=tt.value.filter(e=>"projectLog"!==e.name&&"springbootLog"!==e.name);["php","proxy","html"].includes(Fe.value)?Je.value=!0:Je.value=!!(null==(l=null==(a=De.value)?void 0:a.project_config)?void 0:l.bind_extranet)},st=async()=>{var e,t;if(!Je.value)return;const a=De.value.name,l=Fe.value,s={proxy:{site_name:a,type:"error"},default:{siteName:a}};try{Ke.value=!0;const a=await Ue(s[l]||s.default);return"proxy"===l&&(Qe.value.size=a.data.size||"0 b"),Qe.value.logs=(null==(e=a.data)?void 0:e.logs)||(null==(t=a.data)?void 0:t.msg)||"暂无日志信息",a}catch(n){return u(n),{msg:"获取错误日志失败",status:!1}}finally{Ke.value=!1}},nt=async()=>{Ke.value=!0;try{const e={project_name:De.value.name},{data:t,status:a}=await Ne(e);a&&(We.value=t.map(e=>({label:e,value:e})),$e.logs="正在获取日志",$e.path=(null==t?void 0:t[0])||"",rt())}catch(e){}finally{Ke.value=!1}},rt=async e=>{try{if(!$e.path)return $e.logs="暂未在SpringBoot框架中查找到日志配置信息",!1;const e=await qe({log_file:$e.path});return e.status||o.error(e.msg),$e.logs=e.msg||"获取日志失败",e}catch(t){return{msg:"保存路径失败",status:!1}}};let ut=null;const ot=()=>{Ye.value=!0,O(()=>{Ze.value&&(Ze.value.scrollTop=Ze.value.scrollHeight)}),ut&&clearInterval(ut),ut=setInterval(()=>{nt()},2e3)},it=()=>{Ye.value=!1,clearInterval(ut),ut=null},ct=()=>{var e,t;Xe.value="java",$e.type=(null==(e=De.value.project_config)?void 0:e.loglevel)||"",$e.isGunicorn="gunicorn"===(null==(t=De.value.project_config)?void 0:t.stype),nt()},mt=N(""),pt=N(!1),dt=q({alert:!1,showIp:!1,ipData:0,logs:"",size:"0 b"}),gt=N(!1),vt=N(!1),yt=N(),ht=q({cycle:0,keys:"",channel:[]}),ft=q({cycle:[{required:!0,message:"请输入周期",trigger:"blur"}],keys:[{required:!0,message:"请输入关键字",trigger:"blur"}],channel:[{required:!0,message:"请选择告警方式",trigger:"blur"}]}),xt=()=>{G({type:"dir",path:mt.value,change:e=>{mt.value=e,setTimeout(()=>{pt.value=!0},0)}})},bt=async(e={site_name:De.value.name,log_path:mt.value})=>{await i({title:"保存日志路径",content:"是否保存日志路径[".concat(mt.value,"]")});(await He({site_name:De.value.name,log_path:mt.value})).status&&(Ct(),It(),pt.value=!1)},_t=async()=>{"ltd"!==Be.value?(dt.showIp=!1,M({disablePro:!0,sourceId:184})):Ct()},wt=async e=>{gt.value=!0,e?vt.value=!0:jt({},"switch")},kt=()=>{gt.value&&(dt.alert=!dt.alert,gt.value=!1)},jt=async(e,t)=>{try{vt.value&&await yt.value.validate();let a={sitename:De.value.name};"switch"!==t&&(gt.value||delete a.sitename,a.channel=e.channel.filter(e=>""!==e).join(","),a.cycle=e.cycle,a.keys=JSON.stringify(c(e.keys)?e.keys.split(","):e.keys));const l=await Oe(a);return l.status&&Et(),l.status}catch(a){return!1}},Et=async()=>{try{const e=await Ae();let t={};if(e.status){dt.alert=e.data.status;const{cycle:a,keys:l,channel:s}=e.data;t={cycle:a,keys:l,channel:s.split(","),status:e.status}}else dt.alert=!1;return Object.assign(ht,t),{data:t,status:e.status}}catch(e){return{msg:"获取告警配置失败",status:!1}}},Vt=()=>{vt.value=!0,Et()},Ct=async(e=De.value.name,t=Fe.value)=>{"ltd"!==Be.value&&(dt.showIp=!1);const a={proxy:{site_name:e,type:"access"},default:{siteName:e,ip_area:Number(dt.showIp)}};try{Ke.value=!0;const e=await Me(a[t]||a.default);return"proxy"===t?(dt.logs=e.data.msg||"暂无日志信息",dt.size=e.data.size||"0 b"):dt.logs=e.data.msg||"暂无日志信息",e}catch(l){return u(l),{msg:"获取日志失败",status:!1}}finally{Ke.value=!1}},It=()=>{r({request:ne({siteName:De.value.name}),data:{log_file:String,status:Boolean,msg:String},success:e=>{mt.value=e.log_file,e.status||o.error(e.msg)}})},St=async()=>{Je.value&&(await(async()=>{try{const e=await Ge();dt.showIp=1===e.data}catch(e){return{msg:"获取IP归属地失败",status:!1}}})(),"python"!==Fe.value&&await Et(),await Ct(),It())};export{ke as _,tt as a,me as b,lt as i,at as o,et as t};
