import{aK as e,n as a,H as t,Q as s,b as n,u as l,b3 as r,an as i,q as o,x as p,ap as u,e as c}from"./utils-lib.js?v=1763689792";import{_ as m}from"./index109.js?v=1763689792";import{j as v,p as d,r as _,g as h,c as f,s as y,e as g,D as w,w as b,v as j,n as x,x as k,y as P,C,z as O,A as T,R as q,F as E,b1 as I,L as S,an as L,O as R,am as D}from"./base-lib.js?v=1763689792";import{u as V}from"./index147.js?v=1763689792";import{f as A,i as M,o as B,h as N}from"./validator.js?v=1763689792";import"./index.vue_vue_type_style_index_0_scoped_cdc7f4d3_lang.js?v=1763689792";import{c as z,a as J,d as U,g as F,u as H}from"./column.js?v=1763689792";import{c as G,h as K,d as Q,e as W,g as Y,i as $,s as X,j as Z,u as ee,a as ae,k as te}from"./useController6.js?v=1763689792";import{u as se,S as ne}from"./useStore4.js?v=1763689792";import{getPyVersion as le,getPythonEnvironment as re,changeProjectConf as ie,createPythonProject as oe,getPythonAppInfo as pe,getPythonProjectInfo as ue,setPythonEnvironment as ce,pythonRecreateProject as me,advanceCheckPort as ve,batchStatus as de,batchDelSite as _e}from"./site.js?v=1763689792";const he=v("SITE-PYTHON-STORE",()=>({checkPythonVersion:async()=>{try{const e=await le();return{data:e.data,status:e.status}}catch(a){e(a)}}})),fe=n(),{activeType:ye,isRefreshList:ge,siteInfo:we,rowData:be}=se(),{getClassList:je,getProjectConfig:xe,addGeneralProject:ke,getRootUser:Pe,setSiteInfo:Ce}=ne(),{checkPythonVersion:Oe}=he(),Te=d("_python_mask",!1),qe=()=>{we.value=null,a({title:"添加Python项目",area:[68],component:()=>t(()=>import("./index394.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),showFooter:!0})},Ee=e=>{a({isAsync:!0,title:"Python环境管理",area:105,component:()=>t(()=>import("./index395.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),onCancel:()=>{"function"==typeof e&&e()}})},Ie=e=>{a({title:"终端",area:[90,50],isAsync:!0,showFooter:!1,component:()=>t(()=>import("./index396.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{hostInfo:{pj_name:e.name},row:e,cmd:e.shell_active}})},Se=async(e,s="")=>{try{if(["running","failure"].includes(e.project_config.prep_status))return"failure"===e.project_config.prep_status&&await me({name:e.name}),a({isAsync:!0,title:"正在创建Python项目，请耐心等候...",area:52,component:()=>t(()=>import("./index397.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{type:"createPythonProject",logPath:"/www/server/python_project/vhost/logs/".concat(e.name,".log"),endMsg:"尝试启动项目",failMsg:"环境准备失败",successMsg:"创建成功",isClear:!0,completeEvent:async(e,a)=>{e||fe.error("环境准备失败"),ge.value=!0,a()}}});Ce(e,s),a({title:"Python项目管理["+e.name+"] -- 添加时间["+e.addtime+"]",area:[84,76],component:()=>t(()=>import("./index398.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})}catch(n){}},Le=async()=>{try{const e=await s({request:re({sort_not_use:1})});e.status||(fe.error(e.msg),Ve.value=[]),Ve.value=e.data.env_list}catch(e){return{data:[],total:0}}},Re=e=>{switch(e){case"venv":return"虚拟环境";case"conda":return"Conda环境";case"system":return"系统级环境"}},De=_([]),Ve=_([]),Ae=_([]),Me=h(()=>{var e;return null==(e=we.value)?void 0:e.id});_([]);const Be=_({envType:0,rfile:"",pjname:"",port:"",path:"",framework:"",stype:"command",xsgi:"wsgi",requirement_path:"",auto_run:!1,venv_path:"",version:"",parm:"",env:"",envPath:"",app:"",processes:"",threads:"",user:"www",is_http:!0,listenMsg:"",initialize:"",python_bin:""}),Ne=async()=>{try{await Le();const a=await Pe();if(Ae.value=a.data,Me.value){const a=await xe({data:JSON.stringify({name:we.value.name})}),{project_config:t,listen:s,pyenv_data:n}=a.data,{call_app:l,env_file:r,env_list:i,stype:o,project_cmd:p}=t;r&&(Be.value.envPath=r,Be.value.envType=2),(null==i?void 0:i.length)>0&&(e=i,Be.value.env=e.map(e=>e.k+"="+e.v).join("\n"),Be.value.envType=1,Be.value.envType=1),Object.assign(Be.value,{...t,app:l,parm:"command"===o?p:"",python_bin:n.bin_path}),!s.includes(Number(Be.value.port))&&s.length>0&&(Be.value.listenMsg="当前监听端口".concat(s.join(",")))}}catch(a){}var e},ze=()=>{Object.assign(Be.value,{envType:0,rfile:"",pjname:"",port:"",path:"",framework:"",stype:"command",xsgi:"wsgi",requirement_path:"",auto_run:!1,venv_path:"",version:"",parm:"",env:"",envPath:"",app:"",processes:"",threads:"",user:"www",is_http:!0,listenMsg:"",initialize:"",python_bin:""})},Je=async e=>{try{if(!Me.value&&"command"!==e.stype){const a=await(async e=>{if(!e.port)return!1;try{const a=await ve({port:e.port},"python");return a.status||(fe.request(a),e.port=""),a.status}catch(a){}})(e);if(!a)return fe.error("端口被占用，请更换端口"),!1}let{pjname:a,port:t,path:n,version:l,parm:r,framework:i,requirement_path:o,envPath:p,stype:u,rfile:c,app:m,initialize:v,processes:d,threads:_,is_http:h,user:f,auto_run:y,envType:g,env:w,xsgi:b}=e;const j="command"!==u;1===g&&(w=(e=>{let a=e.split("\n").filter(e=>""!==e),t=[];return a.forEach(e=>{let a=e.split("=");t.push({k:a[0],v:a[1]})}),t})(w));let x={pjname:a,port:t,stype:u,path:n,user:f,requirement_path:o,env_file:2===g?p:"",env_list:JSON.stringify(1===g?w:[]),framework:i,project_cmd:j?void 0:r,xsgi:j?b:void 0,rfile:j?c:void 0,call_app:j?m:void 0,python_bin:Be.value.python_bin};Me.value?x={...x,processes:d,threads:_,is_http:h,auto_run:y}:x.initialize=v;const k={data:JSON.stringify(Me.value?{name:we.value.name,data:x}:x)},P=Me.value?ie:oe,C=await s({loading:"正在提交，请稍后...",request:P(k),message:!0});return ge.value=!0,C.status}catch(a){}},Ue=()=>{A({type:"dir",path:Be.value.path,change:e=>{var a;if(e){Be.value.path=e;let t=null==(a=e.substring(e.lastIndexOf("/")+1))?void 0:a.replace(/\./g,"_").replace(/\/\//g,"/");Be.value.pjname=t,Qe()}}})},Fe=()=>{A({type:"file",path:Be.value.requirement_path,change:e=>{e&&(Be.value.requirement_path=e)}})},He=()=>{A({type:"file",path:Be.value.rfile,change:e=>{Be.value.rfile=e,Ke()}})},Ge=()=>{A({type:"file",path:Be.value.envPath,change:e=>{Be.value.envPath=e}})},Ke=async()=>{try{const e=await pe({runfile:Be.value.rfile});if(!e.status)return void fe.request(e);const{framework:a,xsgi:t,call_app:s}=e.data;a&&(Be.value.framework=e.data.framework),t&&(Be.value.xsgi=e.data.xsgi),s&&(Be.value.app=e.data.call_app)}catch(a){e(a)}},Qe=async()=>{try{const e=Be.value.path,a=await ue({path:e});if(!a.status)return void fe.request(a);const{framework:t,requirement_path:s,runfile:n,xsgi:l,call_app:r}=a.data;t&&(Be.value.framework=a.data.framework),Be.value.requirement_path=s?a.data.requirement_path:"",n&&(Be.value.rfile=a.data.runfile),l&&(Be.value.xsgi=a.data.xsgi),r&&(Be.value.app=a.data.call_app)}catch(a){e(a)}},We=async(e,a,t,s,n,l)=>{const{label:r,value:i}=s,{enable:o,exclude:p}=l,u=new Map([["start","批量启动选中项目后，项目将正常访问"],["stop","批量停用选中的项目后，项目将会停止运行"],["restart","批量重启选中的项目后，项目将会重新启动"],["delete","批量删除选中的项目后，项目将无法恢复"]]);await e({title:"批量".concat(r),content:"".concat(u.get(i),"，是否继续操作？"),column:[{label:"项目名称",prop:"name"},z()],onConfirm:async()=>{const e=await(async()=>{const e=new Map([["start",de],["stop",de],["restart",de],["delete",_e]]).get(i);switch(i){case"start":case"stop":case"restart":if(e){const a=t.value.map(e=>({project_name:e.name})),s=N(!1,p,o,{params:{site_list:JSON.stringify(a),status:i,project_type:ye.value.toUpperCase()}});return await e(s,ye.value)}case"delete":if(e){const a=N(t.value,p,o,{params:{project_type:ye.value.toUpperCase()}});return await e(a)}}})();ge.value=!0,n&&n();let{data:a}=M(e.data);a=a.map(e=>({...e,name:e.name||e.project_name})),B(a,{title:"".concat(r,"网站")})}})},Ye=_("0"),$e=_([{label:"系统默认",value:"0"}]),Xe=async()=>{var e,a;try{const t=await s({request:re({sort_not_use:0})});if(!t.status)return fe.error(t.msg),$e.value=[],{data:[],total:0};Ye.value=(null==(e=t.data.now_env)?void 0:e.bin_path)||"0",$e.value=t.data.env_list.filter(e=>e.can_set_default).map(e=>({label:e.name,value:e.bin_path})),(null==(a=t.data.now_env)?void 0:a.bin_path)&&$e.value.unshift({label:t.data.now_env.name,value:t.data.now_env.bin_path}),$e.value.push({label:"系统默认",value:"0"})}catch(t){}},Ze=async e=>{await s({loading:"正在设置，请稍后...",request:ce({path:"0"===e?"":e}),message:!0,success:()=>{Xe()}})},ea={class:"flex items-center mx-12px"},aa={class:"flex items-center ml-[12px]"},ta=f({__name:"index",setup(a){l();const{getSiteList:s,setSiteInfo:n}=ne(),{activeType:v,isRefreshList:d,siteInfo:_,searchWidth:h}=y(ne()),{BtOperation:f}=r({options:[{type:"button",label:"添加项目",active:!0,onClick:qe},{type:"button",label:"Python环境管理",onClick:Ee}]}),A=V({key:"type_id",name:"Python分类",options:()=>[{label:"全部分类",value:"all"}],event:$,ignore:["0"],field:"type_name"}),M=u([{label:"启动项目",value:"start",event:We},{label:"停用项目",value:"stop",event:We},{label:"重启项目",value:"restart",event:We},ee(),ae({classList:te}),{label:"删除项目",value:"delete",event:We}]),{BtTable:B,BtPage:N,BtRefresh:z,BtSearch:se,BtColumn:le,BtBatch:re,BtTableCategory:ie,refresh:oe,config:pe}=i({request:e=>{const{type_id:a,...t}=e;return s({data:JSON.stringify({...t,type_id:o(a)||"all"===a?"":a})})},columns:[J({type:"page",key:"id"}),G({onClick:Se}),K({onClick:(e,a)=>{if("setting"===a)return void Se(e,"state");const t=e.run?"stop":"start";X(e,"restart"===a?a:t)}}),{label:"PID",isCustom:!1,render:e=>{var a,t;return o(e.pids)||0===(null==(a=e.pids)?void 0:a.length)?"--":(null==(t=e.pids)?void 0:t.join(","))||"--"}},{label:"监听端口",isCustom:!1,render:e=>{var a,t;return o(e.listen)||0===(null==(a=e.listen)?void 0:a.length)?"--":(null==(t=e.listen)?void 0:t.join(","))||"--"}},{label:"CPU",isCustom:!1,render:e=>o(e.cpu)?"--":e.cpu.toFixed(2)+"%"},{label:"内存",isCustom:!1,render:e=>o(e.mem)?"--":p(e.mem)},U(),Q(),F({table:"sites",width:200}),W({onClick:e=>Se(e,"ssl")}),H([{title:"终端",onClick:Ie},{title:"设置",onClick:e=>Se(e)},{title:"模块",onClick:e=>Se(e,"envManager")},{title:"删除",onClick:e=>{Z(e,v.value)}}])],extension:[A,M],empty:()=>g("span",null,[w("您的列表为空，您可以"),g("span",{class:"bt-link",onClick:qe},[w("添加一个项目")])])});return b(d,async e=>{var a;if(e){if(await oe(),null==(a=_.value)?void 0:a.name){const e=pe.data.find(e=>e.name===_.value.name);e&&n(e)}d.value=!1}}),j(()=>{(async()=>{try{const e=await Oe();Te.value=!1,e.data.cpy_installed.length||e.data.pypy_installed.length||(Te.value=!0),De.value=e.data.cpy_installed.concat(e.data.pypy_installed)}catch(a){e(a)}})(),Xe(),x(()=>{t(()=>import("./index394.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),t(()=>import("./index398.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})}),(e,a)=>{const t=D,s=L,n=c,l=m;return k(),P("div",null,[g(l,null,{"header-left":C(()=>[g(O(f)),T("div",ea,[a[4]||(a[4]=T("span",{class:"mr-4px"},"命令行版本",-1)),g(s,{class:"!w-[10rem]",placeholder:"未设置",modelValue:O(Ye),"onUpdate:modelValue":a[1]||(a[1]=e=>q(Ye)?Ye.value=e:null),options:O($e),onChange:O(Ze)},{footer:C(()=>[T("div",{class:"flex items-center justify-center py-[.8rem] cursor-pointer",onClick:a[0]||(a[0]=e=>O(Ee)(O(Xe)))},[...a[3]||(a[3]=[T("span",{class:"bt-link"},"前往管理",-1)])])]),default:C(()=>[(k(!0),P(E,null,I(O($e),(e,a)=>(k(),R(t,{key:a,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","options","onChange"])]),T("div",aa,[g(n,{href:"https://www.bt.cn/bbs/thread-144409-1-1.html"},{default:C(()=>[...a[5]||(a[5]=[w(" Python项目教程 ",-1)])]),_:1}),a[6]||(a[6]=T("i",{class:"svgtofont-el-link text-primary text-medium ml-[4px]"},null,-1))]),T("div",{class:"flex items-center ml-1rem <xl:hidden",onClick:a[2]||(a[2]=(...e)=>O(Y)&&O(Y)(...e))},[...a[7]||(a[7]=[T("i",{class:"svgtofont-desired text-medium"},null,-1),T("span",{class:"bt-link"},"需求反馈",-1)])])]),"header-right":C(()=>[g(O(ie),{class:"!w-[140px] mr-[10px]"}),g(O(se),{class:S(["mr-[10px]","!w-[".concat(O(h),"px]")]),placeholder:"请输入项目名称或备注"},null,8,["class"]),g(O(z),{class:"mr-[10px]"}),g(O(le))]),content:C(()=>[g(O(B))]),"footer-left":C(()=>[g(O(re))]),"footer-right":C(()=>[g(O(N))]),_:1})])}}}),sa=Object.freeze(Object.defineProperty({__proto__:null,default:ta},Symbol.toStringTag,{value:"Module"}));export{ze as $,Me as a,Ue as b,Qe as c,He as d,Ve as e,Ke as f,Le as g,Ge as h,Ne as i,Fe as j,Re as k,sa as l,Ee as o,Be as p,Je as s,Ae as u};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
