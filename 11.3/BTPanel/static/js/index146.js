import{E as e,Q as a,jd as l,je as t,x as s,b as n,jf as r,aA as o,jg as i,n as u,H as c,jh as m,p as d,ji as p,ay as v,an as f,_ as y,aC as b,$ as g,aj as h,O as _}from"./utils-lib.js?v=1763689792";import{r as k,e as x,aT as w,D as j,as as D,at as I,ar as O,i as z,a8 as P,c as C,x as N,y as T,A as q,B as S,z as B,C as L,F as E,b1 as G,R as U,ay as M,O as V,aD as A,P as W,b6 as H,v as R,a0 as F}from"./base-lib.js?v=1763689792";import{_ as J}from"./index110.js?v=1763689792";import{_ as K}from"./index109.js?v=1763689792";const Q=n(),Y=k("all");let $=null;const X=e=>({request:async a=>await te({...a,service_name:e.value.serviceName},Y.value),columns:[{label:"名称",prop:"name",align:"center",width:200},{label:"描述",prop:"description",render:e=>x(w,{effect:"dark",content:e.description,"popper-class":"w-[35rem]","show-after":500,placement:"top-start",disabled:!e._isOverflow},{default:()=>[x("div",{class:"w-[95%] truncate",ref:a=>{a&&(e._isOverflow=a.scrollWidth>a.clientWidth)}},[e.description])]})},{label:"版本",prop:"version",align:"center",width:100},{label:"大小",prop:"size",align:"center",width:100},{label:"状态",prop:"status",align:"center",width:100,renderHeader:()=>x(O,{onCommand:a=>ae(a,Y,e.value)},{default:()=>x("div",{class:"flex items-center"},[x("span",null,[j("状态")]),x("span",null,["all"===Y.value?"":"(".concat(ee(Y.value),")")]),x("span",{class:"svgtofont-el-arrow-down"},null)]),dropdown:()=>{let e;return x(D,null,"function"==typeof(a=e=Z.map(e=>x(I,{command:e.value},{default:()=>[e.label]})))||"[object Object]"===Object.prototype.toString.call(a)&&!z(a)?e:{default:()=>[e]});var a}}),render:a=>{let l="",t="",s="";switch(a.status){case"installed":l="已安装",t="primary";break;case"downloading":l="下载中",t="warning",s="cursor-pointer flex items-center";break;case"failed":l="失败",t="danger",s="cursor-pointer";break;default:l="未安装",t="#666"}return x("span",{class:"text-".concat(t," ").concat(s),onClick:()=>ne(a,e.value)},[l,"downloading"===a.status&&x("span",{class:"inline-block svgtofont-el-loading"},null)])}},{label:"操作",prop:"operate",fixed:"right",width:140,align:"right",render:a=>x("div",{class:"w-full flex items-center justify-end"},["installed"===a.status&&x("span",{class:"bt-link",onClick:()=>se(a,e.value)},[j("查看详情")]),"downloading"===a.status&&x("span",null,[j("--")]),"installed"!==a.status&&"downloading"!==a.status&&x("span",{class:"bt-link",onClick:()=>re(a,e.value)},[j("下载")]),"installed"===a.status&&x("span",null,[x(J,null,null),x("span",{class:"bt-link",onClick:()=>oe(a,e.value)},[j("删除")])])])}]}),Z=[{label:"全部",value:"all"},{label:"已安装",value:"installed"},{label:"下载中",value:"downloading"},{label:"失败",value:"failed"},{label:"未安装",value:"uninstall"}],ee=e=>({all:"",installed:"已安装",downloading:"下载中",failed:"失败",uninstall:"未安装"}[e]),ae=(e,a,l)=>{a.value=e,1===l.param.p?l.refresh():l.param.p=1},le={mode:"ace/mode/json",theme:e.value?"ace/theme/clouds_midnight":"ace/theme/monokai",wrap:!0,showInvisibles:!1,showFoldWidgets:!1,useSoftTabs:!0,tabSize:2,showPrintMargin:!1,readOnly:!0,fontSize:"12px"},te=async(e,l)=>{const{data:t}=await a({request:r({...e,status:l}),loading:"正在获取模型列表"});return t.status?{total:o(t.page),data:t.data}:(Q.error(t.msg),{total:0,data:[]})},se=async(e,l)=>{a({request:i({model_name:e.name,model_version:e.version,service_name:l.serviceName}),loading:"正在获取模型详情",success:a=>{a.status&&u({title:"模型详情-".concat(e.name),area:75,component:()=>c(()=>import("./model-detail-popup.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:JSON.stringify(a.data,null,2),btns:!1})}})},ne=async(e,a)=>{if("downloading"!==e.status)return;const l=[],t=k("正在获取日志");let s=null;return null==$||$.close(),$=v({route:"/sock_shell",onMessage:(e,n)=>{const r=n.data;l.push(r),l.length>50?t.value=l.slice(l.length-50).join("\n"):t.value=l.join("\n"),r.includes("bt_successful")&&(s&&s.unmount(),s=null,a.refresh())}}),null==$||$.send({}),null==$||$.send("tail -f /tmp/".concat(a.serviceName,".log")),s=await u({title:"模型安装日志-".concat(e.name),area:75,component:()=>c(()=>import("./model-install-log.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:t,onCancel:()=>{null==$||$.close(),s=null},btns:!1}),s},re=async(e,l)=>{if(!e.can_down)return Q.error("当前已存在下载任务，请等待下载完成");a({request:m({model_name:e.name,service_name:l.serviceName,model_version:e.version}),loading:"正在下载模型",success:a=>{a.status?(Q.success("开始下载"),l.refresh(),ne({name:e.name,status:"downloading"},l)):Q.error(a.msg)},error:()=>{Q.error("下载失败")}})},oe=async(e,l)=>{try{await d({title:"删除模型-".concat(e.name),content:"确定删除该模型吗？"}),a({request:p({service_name:l.serviceName,model_name:e.name,model_version:e.version}),loading:"正在删除模型",success:e=>{e.status?(l.refresh(),Q.success("删除成功")):Q.error(e.msg)}})}catch(t){}},ie=k({}),ue=e=>{var a;return(null==(a=e.power)?void 0:a.current)&&(a.current/=1e3),(null==a?void 0:a.max)&&(a.max/=1e3),(e=>{const a=e=>s(e*1024**3);(null==e?void 0:e.free)&&(e.free=a(e.free)),(null==e?void 0:e.used)&&(e.used=a(e.used)),(null==e?void 0:e.size)&&(e.size=a(e.size))})(e.memory),e},ce=async e=>{try{const n=Number.isInteger(Number(e)),{status:r,data:o,msg:i,...u}=await a({request:n?l({index:Number(e)}):t()});if(!1===r)return Q.error(i),n?void 0:ie.value={system:!1,list:[],tableList:[]};if(n)return void(ie.value.list[Number(e)]={key:e,value:ue(o)});const c=[],m=Object.entries(o).filter(([e])=>"system"!==e).map(([e,a])=>{var l;const t=ue(a);return null==(l=t.processes)||l.forEach(a=>c.push({gpu:e,pid:a.pid,type:a.type,name:a.name,memory:s(a.usedGpuMemory)})),{key:e,value:t}});return o.system.version.cuda="".concat(o.system.version.cuda).split("0").filter(Boolean).join("."),ie.value={system:o.system,list:m,tableList:c},{data:c,total:o.system.count}}catch(n){ie.value={system:!1,list:[],tableList:[]}}},me=y({name:"ollama",props:["compData"],setup(e){const a=k(),{BtTable:l,BtPage:t,BtSearch:s,BtRefresh:n,refresh:r,param:o}=f(X(a));return a.value={refresh:r,serviceName:e.compData.service_name,param:o},P(()=>{Y.value="all",ie.value={}}),()=>x("div",{class:"relative"},[x(K,null,{"header-left":()=>x("div",{class:"flex items-center"},[x(s,{class:"!w-[47rem]",placeholder:"请输入模型名称/描述"},null)]),"header-right":()=>x(n,null,null),content:()=>x("div",null,[x(l,{key:"ollamaTable","max-height":410,class:"!min-h-[350px]"},null)]),"footer-right":()=>x(t,null,null)})])}},[["__scopeId","data-v-20353357"]]),de={key:0},pe={class:"flex items-center mb-[2rem]"},ve={class:"text-base leading-[2.1rem]"},fe={class:"text-base leading-[2.1rem] ml-[2rem]"},ye={key:1},be=C({__name:"gpu-info",props:{compData:{}},setup(e){var a;const l=C({props:{data:{type:Object,required:!0},cpuIndex:{type:Number,required:!0}},setup(e){const a=a=>{var l;return"cpuIndex"===a?e.cpuIndex:null!=(l=a.split(".").reduce((e,a)=>e&&e[a],e.data))?l:"null"},l=[{name:"GPU",key:"cpuIndex"},{name:"型号",key:"name"},{name:"核心频率",key:"clock.graphics",unit:"MHz"},{name:"内存频率",key:"clock.memory",unit:"MHz"},{name:"显存大小",key:"memory.size"},{name:"已使用显存",key:"memory.used"},{name:"剩余显存",key:"memory.free"},{name:"当前功耗",key:"power.current",unit:"W"},{name:"最大功耗",key:"power.max",unit:"W"},{name:"风扇转速",key:"fan",unit:"%"}],t=[{content:"显示null说明可能因驱动版本过低或显卡版本过低无法获取对应数据"}],s=[{name:"GPU使用率",key:"utilization.gpu",unit:"%"},{name:"GPU温度",key:"temperature",unit:"°C"}];return()=>x("div",{class:"flex h-[41.5rem]"},[x("div",{class:"flex flex-1 justify-evenly"},[s.map(e=>x("div",null,[x("div",{class:"flex justify-center mb-[2rem]"},[e.name]),x("div",{class:"p-[12px] flex flex-col items-start"},[x(H,{width:170,type:"circle",percentage:a(e.key),"stroke-width":12,color:"var(--el-color-primary)"},{default:()=>x("div",null,[x("div",{class:"font-bold text-medium"},[a(e.key)+(e.unit||"")]),x("div",{class:"mt-[1rem] text-base"},[e.name])])})])]))]),x("div",{class:"flex flex-col items-center justify-start max-w-[20rem]"},[l.map(e=>x("div",{class:"flex items-center justify-start w-full text-base leading-[2.6rem]"},[x("span",null,[e.name,j("：")]),x("span",null,[a(e.key)]),x("span",null,[e.unit||""])])),x(g,{class:"mt-[2.2rem]",options:t},null)])])}}),t=k("".concat(null==(a=e.compData.value.list[0])?void 0:a.key)||"");return(a,s)=>{var n,r,o,i;const u=b,c=M;return N(),T("div",null,[e.compData.value.list&&e.compData.value.list.length>0?(N(),T("div",de,[q("div",pe,[q("span",ve,"驱动版本："+S(null==(r=null==(n=B(ie))?void 0:n.system)?void 0:r.version.driver),1),q("span",fe,"Cuda版本："+S(null==(i=null==(o=B(ie))?void 0:o.system)?void 0:i.version.cuda),1)]),x(u,{modelValue:B(t),"onUpdate:modelValue":s[0]||(s[0]=e=>U(t)?t.value=e:null),onChange:B(ce)},{default:L(()=>[(N(!0),T(E,null,G(e.compData.value.list,e=>(N(),V(B(A),{key:e.key,name:e.key,label:"gpu".concat(e.key)},{default:L(()=>[(N(),V(W(B(l)),{data:e.value,cpuIndex:e.key},null,8,["data","cpuIndex"]))]),_:2},1032,["name","label"]))),128))]),_:1},8,["modelValue","onChange"])])):(N(),T("div",ye,[x(c,{description:"未找到GPU设备或未安装GPU驱动"})]))])}}}),ge={name:"ProcessInfo",props:["compData"],setup(e){const{BtTable:a,refresh:l}=f({request:async a=>({data:e.compData.value.tableList,total:e.compData.value.tableList.length}),columns:[{label:"GPU",prop:"gpu"},{label:"PID",prop:"pid"},{label:"TYPE",prop:"type"},{label:"进程名称",prop:"name"},{label:"显存占用",prop:"memory"}]});let t=null;return R(()=>{t=setInterval(()=>{l()},2e3)}),P(()=>{clearInterval(t)}),()=>x("div",null,[x(K,null,{content:()=>x(a,{"max-height":500},null)})])}},he=C({__name:"index",props:{compData:{type:Object,default:()=>({})}},setup(e){const a=e,l=k(!1),t=k(a.compData.tabActive||"manager");F("gpuOpenStatus",l);const{BtTabs:s}=h({type:"left-bg-card",value:t,options:[{label:"模型管理",name:"manager",lazy:!0,render:()=>x(me,{compData:a.compData},null)},{label:"显卡信息",name:"gpu",lazy:!0,render:()=>x(be,{compData:ie},null)},{label:"进程信息",name:"process",lazy:!0,render:()=>x(ge,{compData:ie},null)}]});let n=null;return R(()=>{if(a.compData.appinfo&&a.compData.appinfo.length>0){const e=a.compData.appinfo.find(e=>"gpu"===e.fieldKey);e&&e.fieldValue&&(l.value=!0)}l.value?(ce(),n=setInterval(()=>{_(["/mod/docker/gpu/get_all_device_info"]),ce()},3e3)):ie.value={system:!1,list:[],tableList:[]}}),P(()=>{n&&clearInterval(n)}),(e,a)=>(N(),V(B(s)))}}),_e=Object.freeze(Object.defineProperty({__proto__:null,default:he},Symbol.toStringTag,{value:"Module"}));export{le as e,_e as i};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
