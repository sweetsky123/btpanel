import{_ as a}from"./index109.js?v=1763689792";import{s as t,j as e,r as n,e as s,c as r,D as o,x as i,y as l,A as u,C as m,z as c,R as d,B as p,J as v,K as y,G as h,g,aA as f,H as w}from"./base-lib.js?v=1763689792";import{Q as b,bb as _,M as x,R as j,ch as S,a_ as N,p as O,aK as T,hy as D,ao as E,ap as P,L as J,cf as k,ar as C,n as B,k as I}from"./utils-lib.js?v=1763689792";import{B as A}from"./index442.js?v=1763689792";import{h as H}from"./form-item.js?v=1763689792";import{u as R,S as q}from"./useStore4.js?v=1763689792";import{o as M}from"./useController6.js?v=1763689792";import{getOtherDomainList as V,getHttpsPort as L,setProxyHttpsPort as F,setHttpsPort as U,addDomain as z,addProjectDomain as K,removeDomain as G,removeProjectDomain as Q,multiRemoveProjectDomain as W}from"./site.js?v=1763689792";import{u as X}from"./useStore12.js?v=1763689792";import{a as Y}from"./column.js?v=1763689792";const Z=e("SITE-DOMAIN-STORE",()=>{const{siteType:a,siteInfo:t}=R(),e=n();return{isRefreshDomain:n(!1),port:e,delMultDomainEvent:async t=>{const e=x.load("正在删除域名，请稍后...");try{let e=[];const{data:n}=await W(t,a.value);if(null==n?void 0:n.success){e=n.success.map(a=>({name:a,status:!0}));const a=Object.entries(n.error).map(([a,t])=>({name:a,msg:t,status:!1}));e=e.concat(a)}return Array.isArray(n.data)&&(e=n.data.map(a=>({name:(null==a?void 0:a.name)||(null==a?void 0:a.domain),msg:a.msg,status:a.status}))),{data:e,status:!0}}catch(n){return{status:!1,msg:"删除域名失败"}}finally{e.close()}},getDomainListEvent:async(t,e)=>{try{const n=await b({request:e.isSpecial?await _(t):await V(t,a.value),...e.isPort?{}:{data:Array}});return{data:e.isPort?n.data.data:n,status:!0}}catch(n){return{status:!1,msg:"获取域名信息失败"}}},getPortEvent:async()=>{try{const a=await L({siteName:t.value.name});return e.value=a.data||"未开启",{data:a.data,status:a.status}}catch(a){return{status:!1,msg:"获取https端口失败"}}},addDomainEvent:async t=>{try{const e=await b({loading:"正在添加域名，请稍后...",request:"php"===a.value?z(t):K(t,a.value)});return{status:e.status,msg:e.msg,data:e.data}}catch(e){return{status:!1,msg:"添加域名失败"}}},setPortEvent:async t=>{try{const e="proxy"===a.value?F:U;return{...await b({loading:"正在设置HTTPS端口，请稍候...",request:e(t),message:!0})}}catch(e){return{status:!1,msg:"设置https端口失败"}}},delDomainEvent:async t=>{var e;let n=x.load("正在删除域名，请稍后...");try{const n=a.value,s="php"===n?await G(t):await Q(t,n),r=(null==(e=s.data)?void 0:e.hasOwnProperty("status"))?s.data:s;return j(r.data)?{status:r.status,msg:r.data[0].msg}:{status:r.status,msg:(null==r?void 0:r.data)||(null==r?void 0:r.error_msg)||r.msg}}catch(s){return{status:!1,msg:"删除域名失败"}}finally{n.close()}}}}),$=()=>t(Z()),{isBindExtranet:aa,siteType:ta,siteInfo:ea}=R(),{getProjectConfig:na}=q(),{port:sa,isRefreshDomain:ra}=$(),{getDomainListEvent:oa,getPortEvent:ia,setPortEvent:la,addDomainEvent:ua,delDomainEvent:ma,delMultDomainEvent:ca}=Z(),da=n(!1),pa=n(""),va=["php","html"],ya=[{label:"域名",prop:"name"},{label:"结果",align:"right",render:a=>{const t=a;return s("span",{class:"".concat(t.status?"text-primary":"text-danger"),innerHTML:t.status?(null==t?void 0:t.msg)||"操作成功":(null==t?void 0:t.msg)||"操作失败"},null)}}],ha=async()=>{var a,t,e,n,s,r;try{const o=pa.value,i=["21","25","443","888","8888","8443"];if(""===o)return x.error("域名不能为空"),!1;let l=String(o.match(/:(\d+)/g)).replace(/:/g,"");if(i.includes(l))return x.error("端口不能为常用端口21、25、443、888、8888、8443"),!1;if(!(await fa()))return!1;const u=(a=>{const{name:t,id:e}=ea.value,n=ta.value,s=a.split("\n"),r=JSON.stringify(s),o={php:{domain:a.replace(/\n/g,","),webname:t,id:e},python:{data:JSON.stringify({name:t,domains:s})},phpasync:{sitename:t,domains:r},proxy:{id:e,site_name:t,domains:a},java:{project_name:t,domains:r},default:{data:JSON.stringify({project_name:t,domains:s})}};return o[n]||o.default})(o),m=await ua(u);return m.status&&((null==(t=null==(a=null==m?void 0:m.data)?void 0:a.domains)?void 0:t.length)||(null==(n=null==(e=null==m?void 0:m.data)?void 0:e.data)?void 0:n.length))&&M({title:"域名添加结果",resultData:(null==(s=null==m?void 0:m.data)?void 0:s.domains)||(null==(r=null==m?void 0:m.data)?void 0:r.data)||[],autoTitle:"添加域名完成",resultColumn:ya}),ra.value=!0,pa.value="",m.status}catch(o){}},ga=async()=>{try{const a=ta.value,t=(()=>{const a=ta.value,t=ea.value,e={name:t.name,id:t.id};if(va.includes(a))return{table:"domain",list:"True",search:e.id};const n={python:{data:JSON.stringify({name:e.name})},phpasync:{sitename:e.name},proxy:{site_name:e.name,id:e.id},default:{data:JSON.stringify({project_name:e.name})}};return n[a]||n.default})();let e=va.includes(a);const n=["proxy"].includes(a);let s=null;["phpasync","php"].includes(a)&&(s=await ia());const r=await oa(t,{isSpecial:e,isPort:n});return s&&(sa.value=Number(s.data)||"未开启"),n?(sa.value=Number(r.data.https_port)||"未开启",{data:r.data.domain_list,total:r.data.domain_list.length,other:{port:r.data.https_port}}):{data:r.data,total:r.data.length,other:{...s?{port:Number(s.data)}:{}}}}catch(a){return{data:[],total:0,other:{}}}},fa=async(a=pa.value)=>{let t=a.trim().replace(" ","").split("\n");const e=t.findIndex(a=>a.split(":")[0].length<3);for(var n=0;n<t.length;n++){var s=t[n];let a=s.includes(":");if(a&&!S(s))return x.error("第"+(n+1)+"行【"+s+"】域名格式错误"),!1;if(!a&&!N(s))return x.error("第"+(n+1)+"行【"+s+"】域名格式错误"),!1}return-1!==e?(x.error("第 ".concat(e+1," 个域名长度不符合要求（必须大于3个字符）")),!1):t},wa=async a=>{try{const t={..."proxy"===ta.value?{site_name:ea.value.name}:{siteName:ea.value.name},..."proxy"===ta.value?{https_port:a.value.port}:{port:a.value.port}},e=await la(t);(null==e?void 0:e.status)&&(sa.value=Number(a.value.port))}catch(t){}},ba=async a=>{try{await O({icon:"warning-filled",title:"删除【".concat(a.name,"】"),content:"删除".concat(a.name,"后，将无法使用该域名访问网站，是否继续操作？")});const t=(a=>{const t=ta.value,{id:e,name:n}=ea.value,s={php:{webname:n,id:a.pid,domain:a.name,port:a.port},phpasync:{sitename:n,domain:JSON.stringify([a.id])},python:{data:JSON.stringify({name:n,domain:a.name+":"+a.port})},proxy:{id:e,site_name:n,domain:"".concat(a.name,":").concat(a.port),port:a.port},java:{data:JSON.stringify({project_name:n,domains:[a.id]})},html:{data:JSON.stringify({project_name:n,domain:"".concat(a.name,":").concat(a.port)})},default:{data:JSON.stringify({project_name:n,domain:"".concat(a.name,":").concat(a.port)})}};return s[t]||s.default})(a),e=await ma(t);return x.request(e),ra.value=!0,e}catch(t){}},_a=async a=>{try{await O({icon:"warning-filled",title:"批量删除",content:"同时删除选中的域名，是否继续？",type:"calc"});const t=ta.value;let e=[];if(["php","python","java","phpasync","proxy"].includes(t)){const t=(a=>{const{id:t,name:e}=ea.value,n=ta.value,s=a.map(a=>a.id),r=a.map(a=>a.name).join("\n"),o={php:{domains_id:s.join(","),id:t},java:{data:JSON.stringify({project_name:e,domains:s})},python:{name:e,domain_ids:JSON.stringify(s)},phpasync:{sitename:e,domain:JSON.stringify(s)},proxy:{id:t,site_name:e,domains:r}};return o[n]||o.default})(a),n=await ca(t);e=n.data}else await Promise.all(a.map(async a=>{const t={data:JSON.stringify({project_name:ea.value.name,domain:a.name})};try{const n=await ma(t);e.push({name:(null==a?void 0:a.name)||(null==a?void 0:a.domain),msg:n.msg,status:n.status})}catch(n){T(n)}}));return await M({resultData:e,autoTitle:"删除域名完成",resultColumn:ya}),ra.value=!0,{status:!0,msg:"删除域名成功"}}catch(t){return{status:!1,msg:"删除域名失败"}}},xa=async()=>{try{const a=ta.value;return["php","proxy","html","phpasync"].includes(a)?aa.value=!0:await(async()=>{try{let{project_type:a,name:t}=ea.value,e="python"===a?{name:t}:{project_name:t};await na(e)}catch(a){return{status:!1,msg:"获取域名信息失败"}}})(),await ga()}catch(a){return{data:[],total:0,other:{}}}},ja={class:""},Sa={class:"flex items-end mb-[12px]"},Na={key:0},Oa={key:0,class:"mt-[.8rem] leading-8 text-small list-disc ml-2rem"},Ta={key:0,class:"text-danger"},Da=r({__name:"index",setup(t,{expose:e}){const{isBindExtranet:n,siteType:r}=R(),{isRefreshDomain:b,port:_}=$(),{sslInfo:x}=X(),j=P([{label:"删除",value:"delete",event:async(a,t,e,n)=>{_a(e.value)}}]),{BtTable:S,BtBatch:N,config:O,refresh:T}=D({request:xa,columns:[Y(),{label:"域名",prop:"name",width:400,render:a=>s("div",{class:""},[s("a",{class:"inline-block bt-link  truncate",href:"http".concat(x.value.https?"s":"","://").concat(a.name).concat(x.value.https?"":":".concat(a.port)),title:a.name,target:"_blank"},[a.name]),"php"===r.value&&(null==a?void 0:a.cn_name)&&a.name!==(null==a?void 0:a.cn_name)?s("span",null,[o("（"),a.cn_name,o("）")]):""])},{label:"端口",prop:"port"},{label:"操作",align:"right",render:a=>1===O.data.length&&n.value?s("span",null,[o("不可操作")]):s("span",{class:"bt-link",onClick:()=>{ba(a)}},[o("删除")])}],extension:[j,E(b)]}),q=()=>{const{BtForm:a,submit:t}=J({data:{port:O.other.port},options:a=>g(()=>[H("HTTPS端口",()=>s(A,{modelValue:a.value.port,"onUpdate:modelValue":t=>a.value.port=t},null),"port",{attrs:{min:1,max:65535},rules:[k({message:"请输入端口号",trigger:"blur"}),C()]})]),submit:wa});B({title:"更换端口",area:42,showFooter:!0,component:()=>s(a,{class:"p-2rem"},null),onConfirm:t})};return e({init:T}),(t,e)=>{const n=I,g=f,b=w,x=a;return i(),l("div",ja,[u("div",Sa,[s(g,{ref:"popover",placement:"top-start",width:"36rem","popper-class":"green-tips-popover !p-0 !border-none",visible:c(da),"onUpdate:visible":e[2]||(e[2]=a=>d(da)?da.value=a:null),"trigger-keys":[],trigger:"focus"},{default:m(()=>[...e[3]||(e[3]=[u("div",{class:"!p-[12px] bg-primary text-white leading-[2.4rem]"},[o(" 如需绑定外网，请换行填写，每行一个域名，默认为80端口 "),u("br"),o(" IP地址格式：192.168.1.199 "),u("br"),o(" 泛解析添加方法 *.domain.com "),u("br"),o(" 如另加端口格式为 www.domain.com:88 ")],-1)])]),reference:m(()=>[s(n,{modelValue:c(pa),"onUpdate:modelValue":e[0]||(e[0]=a=>d(pa)?pa.value=a:null),type:"textarea",resize:"none",rows:4,width:"42rem",onFocus:e[1]||(e[1]=a=>da.value=!0),placeholder:"如需绑定外网，请换行填写，每行一个域名，默认为80端口\nIP地址格式：192.168.1.199\n泛解析添加方法 *.domain.com\n如另加端口格式为 www.domain.com:88",class:"domain-textarea"},null,8,["modelValue"])]),_:1},8,["visible"]),s(b,{type:"primary",class:"absolute",style:{right:"4rem",top:"5rem"},onClick:c(ha)},{default:m(()=>[...e[4]||(e[4]=[o("添加",-1)])]),_:1},8,["onClick"])]),s(x,null,{"header-right":m(()=>[["php","proxy","phpasync"].includes(c(r))?(i(),l("div",Na,[o(" HTTPS端口："+p(c(_))+" ",1),v(u("span",{class:"bt-link cursor-pointer",onClick:q},"更换",512),[[y,"number"==typeof c(_)]])])):h("",!0)]),content:m(()=>[s(c(S),{"max-height":440})]),"footer-left":m(()=>[s(c(N))]),_:1}),["php","java"].includes(c(r))?h("",!0):(i(),l("ul",Oa,[e[5]||(e[5]=u("li",null,"如果您的是HTTP项目，且需要映射到外网，请至少绑定一个域名",-1)),e[6]||(e[6]=u("li",null,"建议所有域名都使用默认的80端口",-1)),"phpasync"===c(r)?(i(),l("li",Ta,"只有部署前端或反向代理域名后此域名才可用")):h("",!0)]))])}}});export{Da as _};
