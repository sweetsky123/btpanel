import{Q as t,iP as a,T as e,cf as s,eD as l,M as n,n as r,H as u,p as o,L as i,bE as c,ax as d,e as m,j as p,B as v,k as y}from"./utils-lib.js?v=1763689792";import{j as h,r as g,g as _,o as f,c as w,e as b,J as j,K as k,ad as x,D as C,V,H as E,x as I,y as S,z as P,A,F as L,b1 as U,C as O,B as R,G as q,R as N,b2 as D,ax as F,az as T,v as J,I as B,L as H,O as z,ap as M,ab as $}from"./base-lib.js?v=1763689792";import{B as G}from"./column.js?v=1763689792";import{l as K}from"./form-item.js?v=1763689792";import{f as Q}from"./validator.js?v=1763689792";import{s as W}from"./useController6.js?v=1763689792";import{u as X,S as Y}from"./useStore4.js?v=1763689792";import{setNewAlarmTask as Z,getJavaProjectInfo as tt,getRestartProjectConfig as at,setRestartProjectConfig as et,setPath as st,getProjectRunState as lt,getSystemUserListAsync as nt,getDirUserINI as rt,createRules as ut,modifyProjectAsync as ot}from"./site.js?v=1763689792";const it=h("SITE-SERVICE-STORE",()=>{const{siteInfo:s}=X();return{setAlertConfigEvent:async e=>{try{const s=await t({request:e.template_id?a(e):Z({...e,template_id:"9"}),message:!0});return{data:s.data,status:s.status}}catch(s){return{msg:"修改状态失败",status:!1}}},getAlarmConfig:async()=>{try{const t=await e();return{data:t.data.data,status:t.status}}catch(t){return{msg:"获取告警配置失败",status:!1}}},getJavaServiceEvent:async t=>{try{const a=await tt(t);return{data:a.data,status:a.status}}catch(a){return{msg:"获取项目配置失败",status:!1}}},getRestartConfigEvent:async a=>{try{const{data:e}=await t({request:at(a)});return{data:e,status:!0}}catch(e){return{msg:"获取重启配置失败",status:!1}}},setRestartStatusEvent:async a=>{try{const e=await t({loading:"正在设置状态，请稍后...",request:et(a),message:!0});return{data:e.data,status:e.status}}catch(e){return{msg:"设置状态失败",status:!1}}},saveSitePathEvent:async a=>{try{await t({loading:"正在保存中，请稍后...",request:st(a),message:!0})}catch(e){}},getRunInfoEvent:async()=>{try{const a=await t({request:lt({sitename:s.value.name})});return{data:a.data,status:a.status}}catch(a){return{msg:"获取运行信息失败",status:!1}}},getDirInIEvent:async a=>{try{const e=await t({request:rt(a),data:{"runPath.dirs":[Array,"data"]}});return{data:e.data,status:!!e.data}}catch(e){}},releasePortEvent:async a=>{try{const e=await t({loading:"正在放行端口，请稍后...",request:ut(a),message:!0});return{msg:e.msg,status:e.status}}catch(e){return{msg:"释放端口失败",status:!1}}},getAsyncSystemUserList:async()=>{try{return{data:await t({request:nt(),data:Array}),status:!0}}catch(a){return{msg:"获取系统用户失败",status:!1}}},submitAsyncConfigEvent:async a=>{try{const e=await t({loading:"正在保存，请稍后...",request:ot(a),message:!0});return{status:e.status,msg:e.msg}}catch(e){return{msg:"保存失败",status:!1}}}}}),{siteInfo:ct,siteType:dt}=X(),{getPhpVersionList:mt,setSiteInfo:pt,jumpTabEvent:vt}=Y(),{setAlertConfigEvent:yt,getAlarmConfig:ht,getJavaServiceEvent:gt,getRestartConfigEvent:_t,setRestartStatusEvent:ft,saveSitePathEvent:wt,getRunInfoEvent:bt,getAsyncSystemUserList:jt,getDirInIEvent:kt,releasePortEvent:xt,submitAsyncConfigEvent:Ct}=it(),Vt=g(!1),Et=_(()=>{var t,a;return"java"===dt.value?null!==(null==(t=ct.value)?void 0:t.pid):"phpasync"===dt.value?!!(null==(a=ct.value)?void 0:a.status):ct.value.run}),It=g(!1),St=_(()=>{var t;return null==(t=ct.value)?void 0:t.starting}),Pt=g({}),At=g([]),Lt=f({status:!1,id:""}),Ut=f({module:[],status:Lt.status,interval:60,count:1,push_count:1}),Ot=g(),Rt=g([]),qt=g(!1);g();const Nt=g(!1),Dt=g(),Ft=g({status:!1,time:0,where_hour:0,where_minute:0}),Tt=f({where_hour:[s({message:"请输入小时"}),{validator:(t,a,e)=>{!/^[0-9]*$/.test(a)||a<0||a>23||!Number.isInteger(parseFloat(a))?e(new Error("请输入0-23之间的整数")):e()}}],where_minute:[s({message:"请输入分钟"}),{validator:(t,a,e)=>{!/^[0-9]*$/.test(a)||a<0||a>59||!Number.isInteger(parseFloat(a))?e(new Error("请输入0-59之间的整数")):e()}}]}),Jt=t=>St.value?"开启中":t?"运行中":"已停止",Bt=t=>St.value?"el-icon-loading":t?"bt-link svgtofont-icon-start":"bt-danger svgtofont-icon-stop",Ht=()=>{St.value&&vt("logsManager")},zt=async()=>{var t,a;try{const e=await bt();return e.status&&(pt({...ct.value,...e.data,status:e.data.status}),Object.assign(Pt.value,e.data),Pt.value.is_power_on=1===e.data.is_power_on,Pt.value.allPort=null==(a=null==(t=e.data.Listen)?void 0:t.map(t=>t[1]))?void 0:a.join(", ")),e}catch(e){return{msg:"获取项目状态失败",status:!1}}},Mt=async t=>{const a=await W(ct.value,t,dt.value);"java"===dt.value&&(null==a?void 0:a.status)?Qt():"phpasync"===dt.value&&(null==a?void 0:a.status)&&zt()},$t=async t=>{try{if(Ut.status)return await Kt(),void Gt("open");const a=await l({task_id:Lt.id,status:t?1:0});n.request(a),a.status||Gt()}catch(a){return{msg:"修改状态失败",status:!1}}},Gt=t=>{r({isAsync:!0,title:Lt.title||"项目异常停止告警设置",component:()=>u(()=>import("./project-exception-alarm.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),area:48,btn:!0,compData:{refreshEvent:Kt,type:t}})},Kt=async()=>{try{const t=await ht();if(t.status){const a=t.data.find(t=>"project_status"===t.source&&t.task_data.project===ct.value.id);if(a){const{task_data:t,status:e,sender:s,number_rule:l,id:n}=a;Object.assign(Ut,{...t,status:e,interval:t.interval,count:t.count,push_count:t.push_count||l.day_num,module:s}),Object.assign(Lt,{status:e,id:n})}else Object.assign(Ut,{status:!1,type:"project_status",title:"项目停止告警",tid:"9",interval:600,count:1,push_count:1,module:[]}),Object.assign(Lt,{status:!1,id:""})}return{data:Ut,status:!0}}catch(t){return{msg:"获取告警配置失败",status:!1}}},Qt=async t=>{try{const a=JSON.stringify({project_name:ct.value.name}),e=await gt({data:a});return!0===t&&e.status&&n.success("刷新成功"),e.status&&pt(e.data),e}catch(a){return{msg:"获取项目配置失败",status:!1}}},Wt=async(t=ct.value.name,a=dt.value)=>{try{Vt.value=!0;const t=await _t({model_name:dt.value,project_name:ct.value.name});return Vt.value=!1,Object.assign(Ft.value,{...t.data,status:!!t.data.status}),Nt.value=Boolean(t.data.status),"phpasync"===dt.value&&await zt(),{data:{...t.data,status:!!t.data.status},status:!0}}catch(e){return{msg:"获取重启配置失败",status:!1}}},Xt=()=>{Ft.value.status=Nt.value,Ft.value.where_hour=0,Ft.value.where_minute=0},Yt=async t=>{try{if(!It.value&&t)return void(It.value=!0);It.value&&await Dt.value.validate();const a={model_name:dt.value,project_name:ct.value.name,status:t?1:0,hour:Ft.value.where_hour,minute:Ft.value.where_minute};(await ft(a)).status?(It.value=!1,await Wt(),"phpasync"===dt.value&&await zt()):Xt()}catch(a){return{msg:"修改状态失败",status:!1}}},Zt=async()=>{Kt(),Wt(),"java"===dt.value&&Qt()},ta=async t=>{try{const a=(t=>({template_id:"9",task_data:JSON.stringify({task_data:{...t,cycle:{java:1,nodejs:2,go:3,python:4,other:5}[dt.value],project:ct.value.id,interval:Number(t.interval)},sender:t.module,time_rule:{send_interval:Number(t.interval),time_range:[0,86399]},number_rule:{day_num:Number(t.push_count),total:0}}),title:"项目"+ct.value.name+"停止告警",status:t.status?1:0}))(t),e=await yt(a);return e.status&&Kt(),e.status}catch(a){return!1}},aa=async()=>{try{const t=await wt({path:Pt.value.project_path,id:ct.value.id});return sa(),t}catch(t){return{msg:"保存路径失败",status:!1}}},ea=async()=>{var t,a;try{const e=await bt();e.status&&(Object.assign(Pt.value,e.data),Pt.value.is_power_on=1===e.data.is_power_on,Pt.value.allPort=null==(a=null==(t=e.data.Listen)?void 0:t.map(t=>t[1]))?void 0:a.join(", "))}catch(e){return{msg:"获取项目信息失败",status:!1}}},sa=async()=>{try{const t={path:Pt.value.project_path,id:ct.value.id},a=await kt(t);return a.status&&(Rt.value=a.data.map(t=>({label:t,value:t}))),a}catch(t){return{msg:"获取目录用户配置失败",status:!1}}},la=async t=>{var a;try{if((null==(a=null==Pt?void 0:Pt.value.Listen)?void 0:a.length)>1&&!qt.value)return void(qt.value=!0);let e="",s=[],l=[],r=[];if(qt.value){if(0===t.length)return n.error("最少选择一个端口进行放行"),!1;r=t}else r=null==Pt?void 0:Pt.value.Listen;e=r.map(t=>("127.0.0.1"===t[0]||"localhost"===t[0]?s.push(t[1]):l.push(t[1]),t[1])).join(","),await o({icon:"warning-filled",title:"放行端口",content:"放行端口".concat(l.length?" [ "+l.join(",")+" ] 后，当前端口将正常访问，":"","  ").concat(s.length?" [ "+s.join(",")+" ] 为本地端口，只能本地访问，":""," 是否继续操作？")});const u={data:JSON.stringify({protocol:"tcp",ports:e,choose:"all",types:"accept",brief:ct.value.name+"项目放行端口",address:"",domain:"",source:""})};(await xt(u)).status&&qt.value&&(qt.value=!1)}catch(e){return{msg:"放行端口失败",status:!1}}},na=async(t,a)=>{try{await a();let e={sitename:ct.value.name,...t.value,is_power_on:Pt.value.is_power_on?1:0};delete e.status,delete e.ps;const s=await Ct(e);return s.status&&(ct.value.php_version=(e.php_version/10).toFixed(1)),ea(),s.status}catch(e){return{msg:"提交配置失败",status:!1}}},ra=async()=>{"phpasync"===ct.value.project_type&&(await(async()=>{const t=await mt();At.value=t.data.map(t=>({...t,key:t.value,label:t.name,value:t.version})).filter(t=>"纯静态"!==t.name),At.value=At.value.reverse()})(),await(async()=>{try{const t=await jt();t.status&&(Ot.value=Array.isArray(t.data)?t.data.map(t=>({label:t,value:t})):[])}catch(t){}})(),Pt.value&&Pt.value.pid||await ea(),await sa())},ua={class:"relative -left-[3rem]"},oa={class:"text-[#777] mt-[2px] leading-[2rem] text-small list-disc",style:{"padding-left":"4rem"}},ia={key:0},ca={key:0},da={class:"p-[20px]"},ma=w({__name:"phpasync-config",setup(t){const{jumpTabEvent:a}=Y(),{BtForm:e,submit:l}=i({data:async()=>(await ra(),Pt.value||{}),options:t=>_(()=>[{type:"custom",render:()=>b(c,{label:"pid"},{default:()=>{var a,e;return[b("div",{class:"flex items-center"},[b("span",null,[t.value.pid]),j(b("template",null,[b(x,{label:"端口"},{default:()=>[b("span",{class:"truncate block max-w-[30rem]",title:t.value.allPort},[t.value.allPort])]}),b("span",{class:"bt-link ml-1rem",onClick:la},[C("一键放行")])]),[[k,null==(e=null==(a=t.value)?void 0:a.Listen)?void 0:e.length]])])]}})},{type:"custom",render:()=>b(c,{label:"开机启动"},{default:()=>[b(V,{modelValue:t.value.is_power_on,"onUpdate:modelValue":a=>t.value.is_power_on=a},null)]})},{type:"input",label:"启动命令",key:"project_cmd",attrs:{placeholder:"请输入启动命令，例：php server.php",width:"34rem"},rules:[s({message:"请输入项目执行命令"})]},K("根目录","project_path",{attrs:{width:"34rem",placeholder:"请输入项目目录"}},()=>{var a,e;a=t.value.project_path,e="project_path",a&&"/"===a[a.length-1]&&(a=a.slice(0,-1)),Q({type:"all",path:a||"/www/wwwroot",change:t=>{Pt.value[e]=t,aa()}})}),{type:"custom",render:()=>b(c,{label:"运行目录"},{default:()=>[b(d,{modelValue:t.value.site_run_path,"onUpdate:modelValue":a=>t.value.site_run_path=a,options:Rt.value,class:"mr-[12px]",style:"width: 34rem;"},null),b("span",{class:"text-tertiary text-small ml-[.4rem]"},[C(" * 前端文件的运行目录 ")])]})},{type:"select",label:"PHP版本",key:"php_version",options:At.value,attrs:{class:"!w-[16rem]"}},{type:"custom",render:()=>b(c,{label:"运行用户"},{default:()=>[b(d,{modelValue:t.value.run_user,"onUpdate:modelValue":a=>t.value.run_user=a,options:Ot.value,class:"mr-[12px]",style:"width: 16rem;"},null),b("span",{class:"text-tertiary text-small ml-[.4rem]"},[C(" * 无特殊需求请选择www用户 ")])]})},{type:"custom",render:()=>b(c,{label:" "},{default:()=>[b(E,{type:"primary",onClick:l},{default:()=>[C("保存")]})]})}]),submit:na});return(t,s)=>{var l,n,r;const u=D,o=m,i=F,c=T,d=p;return I(),S("div",ua,[b(u),b(P(e),{"label-width":"80px"}),A("ul",oa,[(null==(n=null==(l=P(Pt))?void 0:l.Listen)?void 0:n.length)?(I(),S("li",ia,[s[3]||(s[3]=C(" 可以通过 ",-1)),(I(!0),S(L,null,U(null==(r=P(Pt))?void 0:r.Listen,(t,a)=>{var e;return I(),S(L,{key:a},[b(o,{href:"http://".concat(null==t?void 0:t.join(":"),"}")},{default:O(()=>[C(R(null==t?void 0:t.join(":")),1)]),_:2},1032,["href"]),a!==(null==(e=P(Pt))?void 0:e.Listen.length)-1?(I(),S("span",ca,"、")):q("",!0)],64)}),128)),s[4]||(s[4]=C(" 访问此服务（需放行使用到的端口，",-1)),b(o,{onClick:P(la)},{default:O(()=>[...s[2]||(s[2]=[C("一键放行",-1)])]),_:1},8,["onClick"]),s[5]||(s[5]=C("） ",-1))])):q("",!0),A("li",null,[s[7]||(s[7]=C("可以通过设置 ",-1)),b(o,{onClick:s[0]||(s[0]=t=>P(a)("proxy"))},{default:O(()=>[...s[6]||(s[6]=[C("反向代理",-1)])]),_:1}),s[8]||(s[8]=C(" 后通过域名访问",-1))])]),b(d,{title:"一键放行端口",modelValue:P(qt),"onUpdate:modelValue":s[1]||(s[1]=t=>N(qt)?qt.value=t:null),area:42,onConfirm:P(la),showFooter:""},{default:O(()=>{var t;return[A("div",da,[s[9]||(s[9]=A("div",{class:"leading-[2rem] mb-1rem"},"请选中需要放行的端口进行放行：",-1)),b(c,{ref:"releasePortRef",class:"param-table",data:null==(t=P(Pt))?void 0:t.Listen,"tooltip-effect":"dark",style:{width:"100%"},"max-height":280},{default:O(()=>[b(i,{type:"selection",width:"36"}),b(i,{label:"端口"},{default:O(t=>[C(R(t.row[1]),1)]),_:1}),b(i,{label:"监听地址"},{default:O(t=>[C(R(t.row[0]),1)]),_:1})]),_:1},8,["data"])])]}),_:1},8,["modelValue","onConfirm"])])}}}),pa={class:"flex flex-col text-secondary"},va={class:"mb-[12px] flex items-center"},ya={key:0,class:"ml-[5rem]"},ha={key:0},ga={key:1,class:"ml-[2rem]"},_a={key:0,class:"ml-[3rem]"},fa={key:1,class:"ml-[3rem]"},wa={class:"flex items-center"},ba={class:"flex items-center"},ja={key:1,class:"flex items-center"},ka={key:2,class:"pb-2rem leading-[2.6rem]"},xa={class:"items-center flex"},Ca={class:"text-supplement bg-darker inline-block rounded-sm px-[0.4rem] leading-2rem"},Va={class:"p-2rem"},Ea={class:"flex items-center"},Ia=w({__name:"index",setup(t,{expose:a}){const{siteType:e,siteInfo:s}=X();return J(Zt),a({init:Zt}),(t,a)=>{const l=E,n=D,r=M,u=m,o=x,i=$,c=p,d=B("bt-loading");return j((I(),S("div",null,[A("div",pa,[A("span",va,[a[15]||(a[15]=C("当前状态： ",-1)),"java"!==P(e)?(I(),S(L,{key:0},[b(P(G),{modelValue:P(Et),"onUpdate:modelValue":a[0]||(a[0]=t=>N(Et)?Et.value=t:null),data:["停止","开启"]},null,8,["modelValue"]),"python"===P(e)?(I(),S("span",ya,[P(s).listen&&P(s).listen.length>0?(I(),S("span",ha,"监听端口："+R(P(s).listen.join(",")),1)):q("",!0),P(s).pids&&P(s).pids.length>0?(I(),S("span",ga,"PID："+R(P(s).pids.join(",")),1)):q("",!0)])):q("",!0)],64)):(I(),S(L,{key:1},[A("div",{class:H(["flex items-center",{"cursor-pointer":P(St)}]),onClick:a[1]||(a[1]=(...t)=>P(Ht)&&P(Ht)(...t))},[A("span",{class:H("".concat(P(Et)?"bt-link":"bt-danger"))},R(P(Jt)(P(Et))),3),A("span",{class:H(P(Bt)(P(Et))+" iconfont")},null,2)],2),P(s).pid?(I(),S("span",_a,"pid："+R(P(s).pid),1)):q("",!0),P(s).project_config.port?(I(),S("span",fa,"端口："+R(P(s).project_config.port),1)):q("",!0)],64))]),A("div",wa,[P(Et)?q("",!0):(I(),z(l,{key:0,type:"default",onClick:a[2]||(a[2]=t=>P(Mt)("start"))},{default:O(()=>[...a[16]||(a[16]=[C("启动",-1)])]),_:1})),P(Et)?(I(),z(l,{key:1,type:"default",onClick:a[3]||(a[3]=t=>P(Mt)("stop"))},{default:O(()=>[...a[17]||(a[17]=[C("停止",-1)])]),_:1})):q("",!0),b(l,{type:"default",onClick:a[4]||(a[4]=t=>P(Mt)("restart"))},{default:O(()=>[...a[18]||(a[18]=[C("重启",-1)])]),_:1}),"java"===P(e)?(I(),z(l,{key:2,type:"default",onClick:a[5]||(a[5]=t=>P(Qt)(!0))},{default:O(()=>[...a[19]||(a[19]=[C("刷新",-1)])]),_:1})):q("",!0)])]),"phpasync"!==P(e)?(I(),S(L,{key:0},["net"!==P(e)?(I(),S(L,{key:0},[b(n),A("span",ba,[a[21]||(a[21]=C("项目异常停止时提醒我: ",-1)),b(r,{modelValue:P(Ut).status,"onUpdate:modelValue":a[6]||(a[6]=t=>P(Ut).status=t),class:"mx-[4px]",onChange:P($t)},null,8,["modelValue","onChange"]),b(u,{onClick:P(Gt)},{default:O(()=>[...a[20]||(a[20]=[C("告警设置",-1)])]),_:1},8,["onClick"])])],64)):q("",!0),b(n),"java"!==P(e)?(I(),S("span",ja,[a[23]||(a[23]=C("项目定时重启: ",-1)),b(r,{modelValue:P(Ft).status,"onUpdate:modelValue":a[7]||(a[7]=t=>P(Ft).status=t),class:"mx-[4px]",onChange:P(Yt)},null,8,["modelValue","onChange"]),b(u,{onClick:a[8]||(a[8]=t=>It.value=!0)},{default:O(()=>[...a[22]||(a[22]=[C("定时重启设置",-1)])]),_:1})])):(I(),S("div",ka,[a[25]||(a[25]=A("div",null,"命令行操作:",-1)),a[26]||(a[26]=A("div",null,[C(" 命令行可使用 "),A("code",{class:"text-supplement bg-darker inline-block rounded-sm px-[0.4rem] leading-2rem"}," java-service [项目名称] [start|stop|restart] "),C(" 进行启动，停止和重启操作 ")],-1)),A("div",xa,[a[24]||(a[24]=C(" 示例： ",-1)),A("code",Ca," java-service "+R(P(s).name)+" start ",1),A("span",{class:"ml-[1rem] svgtofont-el-document-copy cursor-pointer",onClick:a[9]||(a[9]=t=>P(v)({value:"java-service ".concat(P(s).name," start")}))})]),a[27]||(a[27]=A("div",null,"如果提示没有该命令，可以尝试关闭系统加固，并重启面板，再次加载 java-service指令",-1))]))],64)):(I(),z(ma,{key:1})),b(c,{title:"项目重启设置",modelValue:P(It),"onUpdate:modelValue":a[13]||(a[13]=t=>N(It)?It.value=t:null),area:48,onConfirm:a[14]||(a[14]=t=>P(Yt)(!0)),onCancel:P(Xt),showFooter:""},{default:O(()=>[A("div",Va,[b(i,{ref_key:"restartFormRef",ref:Dt,"label-position":"right",model:P(Ft),rules:P(Tt)},{default:O(()=>[b(o,{label:"项目名称"},{default:O(()=>[b(P(y),{modelValue:P(s).name,"onUpdate:modelValue":a[10]||(a[10]=t=>P(s).name=t),disabled:"",width:"24rem"},null,8,["modelValue"])]),_:1}),b(o,{label:"执行周期"},{default:O(()=>[A("div",Ea,[b(o,{prop:"where_hour"},{default:O(()=>[b(P(y),{type:"number",width:"18.6rem",modelValue:P(Ft).where_hour,"onUpdate:modelValue":a[11]||(a[11]=t=>P(Ft).where_hour=t)},{prepend:O(()=>[...a[28]||(a[28]=[C("每天",-1)])]),append:O(()=>[...a[29]||(a[29]=[C("时",-1)])]),_:1},8,["modelValue"])]),_:1}),b(o,{prop:"where_minute"},{default:O(()=>[b(P(y),{type:"number",width:"14rem",modelValue:P(Ft).where_minute,"onUpdate:modelValue":a[12]||(a[12]=t=>P(Ft).where_minute=t)},{append:O(()=>[...a[30]||(a[30]=[C("分",-1)])]),_:1},8,["modelValue"])]),_:1})])]),_:1})]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","onCancel"])])),[[d,P(Vt)]])}}});export{Ia as _,Kt as g,Ut as m,ta as s};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
