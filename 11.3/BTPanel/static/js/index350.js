import{_ as a}from"./index109.js?v=1763689792";import{j as t,s as e,r as s,o as l,W as n,e as r,c as o,g as i,x as u,y as c,C as g,z as p,D as m,L as d,A as v,H as h}from"./base-lib.js?v=1763689792";import{Q as y,M as _,aA as w,T as f,u as b,p as D,n as S,H as x,b as L,f0 as k,ao as j,_ as O}from"./utils-lib.js?v=1763689792";import{K as q,M as C,N as P,O as T,P as E,Q as A,R,L as I}from"./useStore7.js?v=1763689792";import{u as B,Z as F}from"./config.js?v=1763689792";const H=t("LOG-ANALYSE-STORE",()=>{const a=s(!1),t=s({type:"logs",name:""}),e=s([]),n=s({status:!1,channel:"",cycle:0,path:"",task_id:null}),r=s({}),o=s(""),i=s(!1),u=s(0),c=l({p:1,row:10,path:""}),g={status:!1,channel:[],cycle:0,path:""},p={give:[],status:!1,cycle:1,task_id:null},m=s(),d=s(),v=l({give:n.value.channel,status:Boolean(n.value.status),cycle:1,task_id:n.value.task_id});return{isRefreshList:a,routeData:t,logPath:o,msgForm:v,scanData:n,tableData:e,tableParam:c,loading:i,percentum:u,rowData:r,getLogsTableData:async a=>{try{const t=await y({loading:i,request:C(a),data:{data:Array,page:String}});return{data:t.data,total:w(t.page)}}catch(t){return{data:[],total:0,other:{}}}},logScanEvent:async()=>{try{const{status:a,msg:t}=await y({loading:i,request:P({path:o.value}),data:{status:Boolean,msg:String}});return{status:a,msg:t}}catch(a){return{status:!1,msg:"扫描失败"}}},delAllLogDataEvent:async()=>{try{return await y({loading:"正在清空日志，请稍后...",request:E({path:o.value}),message:!0}),{status:!0,msg:"清空日志成功"}}catch(a){return{status:!1,msg:"清空日志失败"}}},tableColumn:m,getDetailData:async()=>{try{const a=await A({path:"/www/wwwlogs/"+t.value.name+".log",type:r.value.type,time:r.value.start_time});return{data:a.data.msg||[],status:a.status,msg:"获取详情数据成功"}}catch(a){return{data:[],status:!1,msg:"获取详情数据失败"}}},logScanForm:d,onConfirmScanConfig:async a=>{try{return await y({loading:"正在设置定期扫描,请稍候...",request:R(a),data:{msg:String},message:!0}),{status:!0,msg:"设置定期扫描成功"}}catch(t){return{status:!1,msg:"设置定期扫描失败"}}},getLogsPath:async()=>{try{const a=await y({loading:i,request:q({siteName:t.value.name}),data:{log_file:String,status:Boolean,msg:String},success:a=>{o.value=a.log_file,c.path=a.log_file,a.status||_.error(a.msg)}});return{data:a.log_file,status:a.status,msg:a.msg}}catch(a){return{data:"",status:!1,msg:"获取日志路径失败"}}},getScanData:async()=>{try{const{data:a}=await y({request:f(),success:({data:a})=>{const e=a.data.find(a=>{var e;return(null==(e=a.task_data)?void 0:e.site_name)===t.value.name&&"web_log_scan"===a.source&&"110"===a.template_id});e?(Object.assign(n.value,{status:e.status,channel:e.sender,cycle:1,path:e.task_data.log_path}),Object.assign(v,{give:e.sender,status:e.status,cycle:1,task_id:e.id})):(Object.assign(n.value,g),Object.assign(v,p))}});return{data:{give:n.value.channel,status:n.value.status,cycle:1},status:!0,msg:"获取扫描数据成功"}}catch(a){return{status:!1,msg:"获取扫描数据失败"}}},startScanTimer:async t=>{const e=await ga(),s=setInterval(async()=>{const{data:l}=await T({path:o.value});u.value=l.msg,100===l.msg&&(clearInterval(s),e.unmount(),_.success("扫描完成"),u.value=0,a.value=!0,t&&t())},1e3)}}}),N=()=>e(H()),Q=L();b();const U=[["xss","XSS"],["sql","SQL"],["san","扫描"],["php","PHP攻击"],["ip","IP(top100)"],["url","URL(top100)"]],V=H(),{routeData:W,logPath:M,rowData:z,msgForm:G,isRefreshList:J}=e(V),{getLogsPath:K,getLogsTableData:X,getScanData:Y,startScanTimer:Z,logScanEvent:$,delAllLogDataEvent:aa,getDetailData:ta,onConfirmScanConfig:ea}=H(),sa=async()=>{await D({title:"清空扫描日志【".concat(W.value.name,"】"),type:"input",input:{content:"清空日志"},icon:"warning-filled",content:"风险操作，清空该扫描日志后，将无法查到以往的扫描日志记录，此操作不可逆，是否继续清空？"}),await aa(),J.value=!0},la=async()=>{await D({title:"日志扫描",icon:"warning-filled",content:"建议在服务器负载较低时进行安全分析，本次将对【".concat(W.value.name,".log】文件进行扫描，可能等待时间较长，是否继续？")});const a=await $();if(!a.status)return Q.error(a.msg);Z()},na=s([{label:"访问次数",prop:"num",width:80},{label:"访问路径",prop:"path",showOverflowTooltip:!0}]),ra=n([{label:"攻击ip",prop:"ip"},{label:"攻击时间",prop:"time"},{label:"user-agent",prop:"ua",showOverflowTooltip:!0},{label:"请求URL",width:210,render:a=>"san"===z.value.type?a.url:r("span",{class:"bg-lighter text-danger break-words"},[a.url])}]),oa=s(),ia=async a=>{try{const{data:t,status:e}=await ta(),s=["sql","san","xss","php"];return oa.value=s.includes(a)?ra.value:na.value,e?{data:t,total:t.length,other:{}}:{data:[],total:0,other:{}}}catch(t){return{data:[],total:0,other:{}}}},ua=async(a,t,e)=>{try{await t();const{give:a,cycle:e,status:s,task_id:l}=G.value,n={template_id:110,task_data:JSON.stringify({task_data:{tid:"110",type:"web_log_scan",title:"Web日志扫描告警",status:s,count:0,interval:600,project:"",site_name:W.value.name},sender:a||[]})};let r;if(s)r=await y({request:B(n),loading:"正在设置定期扫描告警",message:!0});else{if(!l)return Q.error("请开启自动扫描"),!1;r=await y({loading:"正在关闭告警任务，请稍候...",request:F({task_id:l}),message:!0})}return J.value=!0,r.status}catch(s){}},ca=()=>{if(""===M.value)return Q.error("配置文件丢失");S({title:"定期扫描",area:48,showFooter:!0,component:()=>x(()=>import("./scan-form.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},ga=()=>S({title:!1,component:()=>x(()=>import("./progress.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),area:40}),pa=O(o({__name:"index",props:{type:{default:"logs"},name:{default:""}},setup(t,{expose:s}){const l=t,{mainHeight:n}=b(),o=i(()=>"site"===l.type?426:n.value-426),y=H(),{isRefreshList:_,scanData:w}=e(y),{BtTable:f,BtPage:D,refresh:L}=k({request:a=>{const{limit:t,...s}=a;return(async(a,t)=>{try{if(W.value=t,"site"===t.type);else{const{selectedWebSite:a}=e(I());W.value={name:a.value,type:t.type}}return W.value.name?(await K(),await Y(),await X({...a,path:M.value})):{data:[],total:0}}catch(s){return{data:[],total:0}}})({...s,row:t},l)},columns:[{label:"扫描时间",prop:"start_time",showOverflowTooltip:!0},{label:"耗时",prop:"time",render:a=>{var t;return(null==(t=a.time)?void 0:t.substring(0,4))+"秒"}},...U.map(a=>({label:a[1],prop:a[0],width:"ip"!==a[0]&&"php"!==a[0]&&"url"!==a[0]?50:"auto",render:function(t){return t[a[0]]?r("span",{class:"bt-link ".concat("ip"===a[0]||"url"===a[0]?"":"!text-danger"),onClick:()=>(async(a,t)=>{z.value=a,z.value.type=t,["sql","san","xss","php"].includes(t)||(na.value[1].label="url"===t?"访问URL":"访问ip"),S({title:"日志详情",area:72,compData:{row:a,type:t},component:()=>x(()=>import("./log-detail.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})})(t,a[0])},[t[a[0]]]):r("span",null,[t[a[0]]])}})),{label:"合计",render:function(a){let t=0;for(let e in a)"start_time"!=e&&"time"!=e&&"ip"!=e&&"url"!=e&&"is_status"!=e&&a[e]>0&&(t+=a[e]);return r("span",null,[t])}}],extension:[j(_)]});return s({init:L}),(t,e)=>{const s=h,l=a;return u(),c("div",null,[r(l,null,{"header-left":g(()=>[r(s,{onClick:p(la),type:"primary"},{default:g(()=>[...e[0]||(e[0]=[m("日志扫描",-1)])]),_:1},8,["onClick"]),r(s,{type:"default",class:d({"not-status":!Boolean(p(w).status)}),onClick:p(ca)},{default:g(()=>[e[1]||(e[1]=m(" 定期扫描 ",-1)),v("i",{class:d("text-small svgtofont-icon-".concat(p(w).status?"start text-primary":"stop text-danger"," "))},null,2)]),_:1},8,["class","onClick"]),r(s,{onClick:p(sa)},{default:g(()=>[...e[2]||(e[2]=[m("清空扫描日志",-1)])]),_:1},8,["onClick"])]),content:g(()=>[r(p(f),{"max-height":p(o)},null,8,["max-height"])]),"footer-right":g(()=>[r(p(D))]),_:1}),e[3]||(e[3]=v("ul",{class:"mt-8px leading-8 text-small list-disc ml-20px"},[v("li",null,[m(" 日志安全分析：扫描网站(.log)日志中含有攻击类型的请求(类型包含： "),v("span",{class:"text-danger"},"xss,sql,san,php"),m(" ) ")]),v("li",null,"分析的日志数据包含已拦截的请求"),v("li",null,"如日志文件过大，扫描可能等待时间较长，请耐心等待")],-1))])}}}),[["__scopeId","data-v-55808dbc"]]);export{pa as A,H as L,ia as r,ua as s,oa as t,N as u};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
