import{c as e,r as l,o as a,aE as t,v as s,I as o,J as n,z as d,x as r,y as i,A as c,e as p,C as u,D as m,F as _,K as g,G as f,ap as x,ad as h,H as b,ab as v,b2 as C,c5 as w}from"./base-lib.js?v=1763689792";import{u as y,p as P,Q as I,$ as V,aK as F,b as j,_ as X}from"./utils-lib.js?v=1763689792";import{_ as k}from"./index107.js?v=1763689792";import{f as R}from"./validator.js?v=1763689792";import{o as U}from"./useController6.js?v=1763689792";import{getGloalSetting as q,setSitesLogStatus as S,openCdnIp as A,setFreeTotalStatus as H,getCdnIp as T,getFreeTotalStatus as D,setSitesLogPath as K}from"./site.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./column.js?v=1763689792";import"./useStore4.js?v=1763689792";const W={class:"flex flex-col site-globa-setting-module"},z={class:"flex items-center"},B={class:"flex items-center"},E={class:"flex items-center"},G={class:"flex items-center"},J={class:"flex items-center"},Q={class:"flex items-center"},$={class:"flex items-center"},L=X(e({__name:"global-setting",setup(e){const X=j(),{plugin:L}=y(),{webserver:M}=L.value,N=l(!1),O=l(),Y=a({log_split:!1,log_path:""}),Z=a({page_index:!1,page_404:!1}),ee=a({total_flow:!1}),le=a({cdn_ip:"",header:""});let ae="";const te=a({log_path:[{required:!0,message:"请选择日志路径",trigger:"change"}]}),se=l([{label:"名称",prop:"site_name"},{label:"结果",render:e=>t("span",{class:e.status?"text-primary":"text-danger"},e.status?"操作成功":"操作失败")}]),oe=[{value:"X-Forwarded-For",label:"X-Forwarded-For"},{value:"X-Real-IP",label:"X-Real-IP"},{value:"X-Forwarded",label:"X-Forwarded"},{value:"Forwarded-For",label:"Forwarded-For"},{value:"Forwarded",label:"Forwarded"},{value:"True-Client-IP",label:"True-Client-IP"},{value:"Client-IP",label:"Client-IP"},{value:"Ali-Cdn-Real-IP",label:"Ali-Cdn-Real-IP"},{value:"Cdn-Src-IP",label:"Cdn-Src-IP"},{value:"Cdn-Real-IP",label:"Cdn-Real-IP"},{value:"Cf-Connecting-IP",label:"Cf-Connecting-IP"},{value:"X-Cluster-Client-IP",label:"X-Cluster-Client-IP"},{value:"Wl-Proxy-Client-IP",label:"Wl-Proxy-Client-IP"},{value:"Proxy-Client-IP",label:"Proxy-Client-IP"}],ne=(e,l)=>{l(oe)},de=async()=>{N.value=!0;try{const{data:e}=await q();Y.log_path=e.log_path,Y.log_split=e.log_split,Z.page_index=e.page_index,Z.page_404=e.page_404,le.cdn_ip=e.cdn_ip}catch(e){}finally{N.value=!1}},re=async()=>{await O.value.validate(),await P({title:"修改日志路径",content:"是否修改日志预设路径,继续执行?",type:"check",icon:"warning-filled",check:{content:"更改已有网站日志",value:!0,onConfirm:async e=>{try{const l=await K({mv_log:"1",change_sites:e?"1":"0",log_path:Y.log_path});e?U({resultColumn:se.value,resultData:l.data,resultTitle:"修改日志路径",title:"修改日志路径结果"}):X.request(l)}catch(l){F(l)}}}})},ie=()=>{R({type:"dir",path:Y.log_path,change:e=>{Y.log_path=e}})},ce=async()=>{I({loading:"正在设置，请稍后...",request:S({log_split:Y.log_split,page_index:Z.page_index,page_404:Z.page_404}),message:!0})},pe=async e=>{I({loading:"正在设置，请稍后...",request:A({cdn_ip:e,header_cdn:le.header}),message:!0,success:de})},ue=async()=>{try{ee.total_flow||await P({title:"关闭日流量统计",content:"关闭全局日流量统计后,网站的单独设置将失效,是否继续执行?"}),I({loading:"正在设置，请稍后...",message:!0,request:H({site_id:"global",status:ee.total_flow?1:0}),success:e=>{e.status||(ee.total_flow=!ee.total_flow)}})}catch(e){ee.total_flow=!ee.total_flow}},me=()=>{ae=le.header,le.header=""},_e=()=>{""===le.header&&(le.header=ae)};return s(()=>{de(),(async()=>{const{data:e}=await T();le.header=e.header_cdn||"X-Forwarded-For"})(),(async()=>{const{data:e}=await D({site_id:"global"});ee.total_flow=e.data.status})()}),(e,l)=>{const a=x,t=h,s=k,y=b,P=v,I=C,F=V,j=w,X=o("bt-loading");return n((r(),i("div",W,[c("div",null,[p(P,{ref_key:"globalSettingRef",ref:O,model:d(Y),rules:d(te)},{default:u(()=>[p(t,{label:"日志切割"},{default:u(()=>[c("div",z,[p(a,{onChange:ce,modelValue:d(Y).log_split,"onUpdate:modelValue":l[0]||(l[0]=e=>d(Y).log_split=e)},null,8,["modelValue"]),l[8]||(l[8]=c("span",{class:"text-tertiary ml-[4px]"},"*提示：开启该选项将自动创建网站日志切割任务，当存在所有网站日志切割任务时不会新建",-1))])]),_:1}),p(t,{label:"预设日志路径",prop:"log_path"},{default:u(()=>[c("div",B,[p(s,{modelValue:d(Y).log_path,"onUpdate:modelValue":l[1]||(l[1]=e=>d(Y).log_path=e),icon:"icon-file_mode",onIconClick:ie},null,8,["modelValue"]),p(y,{type:"primary",class:"!ml-1rem",onClick:re},{default:u(()=>[...l[9]||(l[9]=[m("保存",-1)])]),_:1})])]),_:1})]),_:1},8,["model","rules"])]),p(I),p(P,{model:d(Z)},{default:u(()=>[p(t,{label:"默认页面设置"},{default:u(()=>[c("div",E,[p(a,{onChange:ce,modelValue:d(Z).page_index,"onUpdate:modelValue":l[2]||(l[2]=e=>d(Z).page_index=e)},null,8,["modelValue"]),l[10]||(l[10]=c("span",{class:"ml-[4px] mb-[2px]"},"自动生成index.html(默认首页)",-1))])]),_:1}),p(t,{label:" "},{default:u(()=>[c("div",G,[p(a,{onChange:ce,modelValue:d(Z).page_404,"onUpdate:modelValue":l[3]||(l[3]=e=>d(Z).page_404=e)},null,8,["modelValue"]),l[11]||(l[11]=c("span",{class:"ml-[4px] mb-[2px]"},"自动生成404.html(默认404页面)",-1))])]),_:1})]),_:1},8,["model"]),p(F,{options:[{content:"请注意，仅对后续创建的PHP网站生效。"}],class:"ml-[20px] mt-[20px]"}),p(I),p(P,{model:d(ee)},{default:u(()=>[p(t,{label:"网站统计"},{default:u(()=>[c("div",J,[p(a,{onChange:ue,modelValue:d(ee).total_flow,"onUpdate:modelValue":l[4]||(l[4]=e=>d(ee).total_flow=e)},null,8,["modelValue"]),l[12]||(l[12]=c("span",{class:"text-tertiary ml-[4px]"},"*提示：开启会适量占用服务器内存，如需针对某个网站单独开关请到 网站设置->其它设置 中调整。",-1))])]),_:1})]),_:1},8,["model"]),p(F,{options:[{content:"注意，关闭后网站的单独设置将失效。"},{content:"不影响监控报表插件的配置。"}],class:"ml-[20px] mt-[20px]"}),"nginx"===d(M)?(r(),i(_,{key:0},[p(I),p(P,{model:d(le)},{default:u(()=>[p(t,{label:"cdn来源IP解析"},{default:u(()=>[c("div",Q,[p(a,{onChange:pe,modelValue:d(le).cdn_ip,"onUpdate:modelValue":l[5]||(l[5]=e=>d(le).cdn_ip=e)},null,8,["modelValue"]),l[13]||(l[13]=c("span",{class:"ml-[4px] mb-[2px]"},[m(" * 请确保使用 "),c("span",{class:"text-danger"},"安全可靠"),m(" 的cdn ")],-1))])]),_:1}),n(p(t,{label:"来源的请求头"},{default:u(()=>[c("div",$,[p(j,{modelValue:d(le).header,"onUpdate:modelValue":l[6]||(l[6]=e=>d(le).header=e),"fetch-suggestions":ne,placeholder:"请选择或输入来源的请求头",onFocus:me,onBlur:_e},{suffix:u(()=>[...l[14]||(l[14]=[c("span",{class:"svgtofont-el-arrow-down"},null,-1)])]),_:1},8,["modelValue"]),p(y,{type:"primary",class:"!ml-1rem",onClick:l[7]||(l[7]=e=>pe(d(le).cdn_ip))},{default:u(()=>[...l[15]||(l[15]=[m("保存",-1)])]),_:1})])]),_:1},512),[[g,d(le).cdn_ip]])]),_:1},8,["model"])],64)):f("",!0)])),[[X,d(N)]])}}}),[["__scopeId","data-v-ce5033ca"]]);export{L as default};
