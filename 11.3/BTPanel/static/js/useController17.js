import{closeLimitNet as t,setLimitNet as e,setModulesLimitNet as a,batchPhpLimit as r,getLimitNet as s,getModulesLimitNet as l,getPluginInfo as i,getFlowQuotaConfigData as u,getFlowNumData as n}from"./site.js?v=1763689792";import{Q as c,M as o,x as p,p as v}from"./utils-lib.js?v=1763689792";import{r as m,g as d,o as _}from"./base-lib.js?v=1763689792";import{o as y}from"./useController6.js?v=1763689792";import{u as f}from"./useStore4.js?v=1763689792";import{h as g,i as b,p as h,k as w}from"./validator.js?v=1763689792";import{u as j,Z as q,t as k}from"./config.js?v=1763689792";const{siteInfo:N,siteType:S,isBindExtranet:x,isRefreshList:P,selectedList:O,batchConfig:D}=f(),M=m([{label:"论坛/博客",value:0,items:{perserver:300,perip:25,limit_rate:512}},{label:"图片站",value:1,items:{perserver:200,perip:10,limit_rate:1024}},{label:"下载站",value:2,items:{perserver:50,perip:3,limit_rate:2048}},{label:"商城",value:3,items:{perserver:500,perip:10,limit_rate:2048}},{label:"门户",value:4,items:{perserver:400,perip:15,limit_rate:1024}},{label:"企业",value:5,items:{perserver:60,perip:10,limit_rate:512}},{label:"视频",value:6,items:{perserver:150,perip:4,limit_rate:1024}},{label:"自定义",value:7,items:{perserver:"",perip:"",limit_rate:""}}]),B=async(e,a)=>{if(!E.value)if(e)C(a);else{const e={["php"!==S.value&&"phpasync"!==S.value?"site_id":"id"]:N.value.id};(await c({loading:"正在关闭流量限制，请稍后...",request:t(e,S.value),message:!0})).status&&await H()}},C=async t=>{try{if(!E.value){const r=["php","proxy","phpasync"].includes(S.value),{perserver:s,perip:l,limit_rate:i}=t,u={perserver:s,perip:l,limit_rate:i,[r?"id":"site_id"]:N.value.id};return void((await c({loading:"正在设置流量，请稍后...",request:r?e(u):a(u,S.value),message:!0})).status&&H())}let s=o.load("正在设置，请稍后..."),l=[];O.value.forEach(t=>{var e;"PHPMOD"===(null==(e=null==t?void 0:t.project_config)?void 0:e.type)&&l.push({name:t.name,msg:"异步项目不支持",status:!1})});const i=O.value.filter(t=>{var e;return"PHPMOD"!==(null==(e=null==t?void 0:t.project_config)?void 0:e.type)}),{enable:u,exclude:n}=D.value,p=g(i,n,u,{params:{...Q,close_limit_net:Q.value?0:1,project_type:"PHP"}}),v=await c({request:r(p)}),{data:m}=b(v.data);return y({resultData:l.concat(m)}),O.value=[],s.close(),P.value=!0,!0}catch(s){return!1}},H=async()=>{try{const t=["php","proxy","phpasync"].includes(S.value),e={["php"!==S.value&&"phpasync"!==S.value?"site_id":"id"]:N.value.id},a=await c({loading:R,request:t?s(e):l(e,S.value)});return a.data.hasOwnProperty("limit_rate")?(J.value=!1,Q.limit_rate=a.data.limit_rate,Q.perserver=a.data.perserver,Q.perip=a.data.perip,Object.values(a.data).every(t=>0===t)?(Q.value=!1,Q.type=0,L(0)):(Q.type=a.data.value-1,Q.value=!0),-1===Q.type&&(Q.type=7),Q):(J.value=!0,o.error("获取流量限制失败"),J.value=!0,G.value=a.data.msg,{status:!1,msg:"获取流量限制失败"})}catch(t){return{status:!1,msg:"获取流量限制失败"}}},I=async()=>{var t,e;try{let a=null==(t=N.value.project_type)?void 0:t.toLowerCase();if("node"===a&&(a="nodejs"),"nodejs"===a){if(x.value=null==(e=N.value.project_config)?void 0:e.bind_extranet,!x.value)return J.value=!0,Q;J.value=!1}else x.value=!0;return E.value?await L(0):await H(),Q}catch(a){}},L=t=>{const{perserver:e,perip:a,limit_rate:r}=M.value[t].items;Q.perserver=e,Q.perip=a,Q.limit_rate=r},E=d(()=>O.value.length>0),J=m(!1),F=m(!1),G=m(""),Q=_({value:!0,perserver:300,perip:25,limit_rate:512,type:0}),R=m(!1),T=async t=>{try{let e=A(t);const a=await c({loading:"正在添加告警任务，请稍候...",request:j(e),message:!0,success:t=>{}});return a.status&&(V.value=!0),a.status}catch(e){return!1}},Y=async t=>{try{const e={template_id:131,task_data:{task_data:Z(t),sender:t.sender,number_rule:{day_num:0,total:Number(t.total)},time_rule:{send_interval:0,time_range:[0,86399]}}};e.task_data=JSON.stringify(e.task_data);const a=await c({loading:"正在添加告警任务，请稍候...",request:j(e),message:!0,success:t=>{}});return a.status&&(V.value=!0),a.status}catch(e){return!1}},Z=t=>{const e={tid:131,type:"monitor_traffic_total",title:"[监控报表]网站流量限额提醒",status:!0,count:0,interval:600,project:""};return e.site=N.value.name,e.cycle=Number(t.cycle),e.traffic=Number(t.traffic),e.traffic_unit=t.traffic_unit,e},z=t=>{const e={};return e.tid="total"===t.type?130:132,e.type="total"===t.type?"monitor_traffic_attack":"monitor_http_flood",e.title="total"===t.type?"[监控报表]网站流量异常告警":"[监控报表]网站请求异常告警",e.status=!0,e.count=0,e.interval=600,e.project="",e.site=N.value.name,e.cycle=Number(t.cycle),e.cycle_unit=t.cycle_unit,"total"===t.type?(e.traffic=Number(t.traffic),e.traffic_unit=t.traffic_unit):(e.request=Number(t.request),e.request_unit=t.request_unit),e},A=t=>{const e={template_id:"total"===t.type?130:132,task_data:{task_data:z(t),sender:t.sender,number_rule:{day_num:0,total:Number(t.total)},time_rule:{send_interval:0,time_range:[0,86399]}}};return e.task_data=JSON.stringify(e.task_data),e},K=async()=>{try{const{data:t}=await i({sName:"monitor"});U.value.total_status=t.setup&&t.endtime>=0,U.value.total_status||(F.value=!0)}catch(t){}},U=m({nginx_status:!1,total_status:!1,buy_status:!1});m({length:"--",request:"--"});const V=m(!1),W=async t=>{if("buy"===t)h({sourceId:142});else try{const{data:t}=await i({sName:"monitor"});await w({name:t.name,type:"i",pluginInfo:t})}catch(e){}},X=async()=>{try{const{data:t}=await u({site_name:N.value.name});return{data:t.data,total:t.data.length,other:{}}}catch(t){return{data:[],total:0,other:{}}}},$=[{label:"MB",value:"mb"},{label:"GB",value:"gb"}],tt=[{label:"次",value:"c"},{label:"千次",value:"kc"},{label:"百万次",value:"mc"}],et=m({traffic:"--",request:"--"}),at=async()=>{var t,e,a;try{if(!U.value.total_status)return et.value.traffic="--",void(et.value.request="--");const r=new Date,s=r.getFullYear(),l=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0"),u="".concat(s,"-").concat(l,"-").concat(i),{data:c}=await n({SiteName:N.value.name,part_type:"hour",start_date:u,end_date:u});et.value.traffic=null!=(t=p(Number(c.total.sent_bytes)))?t:0,et.value.request=null!=(e=(a=Number(c.total.request))?a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):"0")?e:0}catch(r){}},rt=async t=>{try{await v({title:"删除".concat(t.task_data.title),icon:"warning-filled",content:"是否删除".concat(t.title,"？")}),await c({loading:"正在删除告警任务，请稍候...",request:q({task_id:t.id}),message:!0}),V.value=!0}catch(e){}},st=async t=>{await v({title:"".concat(t.status?"禁用":"启用","【").concat(t.title,"】任务"),content:"您真的要".concat(t.status?"禁用":"启用","【").concat(t.title,"】这个任务吗？")}),await c({loading:"正在修改告警任务状态，请稍候...",request:k({task_id:t.id,status:Number(!t.status)}),message:!0}),V.value=!0};export{E as a,G as b,at as c,F as d,U as e,W as f,X as g,B as h,I as i,et as j,st as k,rt as l,J as m,$ as n,C as o,M as p,T as q,tt as r,Y as s,V as t,K as u,R as v};
