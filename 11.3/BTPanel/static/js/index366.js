import{k_ as e,L as a,k$ as s,l0 as l}from"./utils-lib.js?v=1763689792";import{r as t,c as r,aB as p,g as u,aE as o,H as i,a8 as n,x as v,y as d,e as y,z as _,aZ as c}from"./base-lib.js?v=1763689792";import{h,i as m}from"./useController11.js?v=1763689792";import{b as g,e as k,d as f,c as w,F as b,j as P}from"./form-item.js?v=1763689792";import{u as x}from"./index66.js?v=1763689792";import{u as S}from"./useStore10.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./validator.js?v=1763689792";import"./index110.js?v=1763689792";import"./column.js?v=1763689792";import"./index107.js?v=1763689792";import"./index109.js?v=1763689792";import"./index147.js?v=1763689792";import"./index131.js?v=1763689792";import"./index.vue_vue_type_style_index_0_scoped_cdc7f4d3_lang.js?v=1763689792";x();const{rowData:I}=S(),j=()=>{var e,a,s,l,t,r,p,u,o,i,n,v,d,y,_;try{let c="api";(null==(e=I.value)?void 0:e.app_key)?c="app":(null==(a=I.value)?void 0:a.api_key)?c="api":(null==(s=I.value)?void 0:s.ssh_conf)&&(c="ssh");const h={ssh_ip:(null==(l=I.value)?void 0:l.ssh_conf.host)||"",ssh_type:(null==(t=I.value)?void 0:t.ssh_conf.pkey)?"key":"password",ssh_password:(null==(r=I.value)?void 0:r.ssh_conf.password)||"",ssh_key:(null==(p=I.value)?void 0:p.ssh_conf.pkey)||"",ssh_port:(null==(u=I.value)?void 0:u.ssh_conf.port)||"22",ssh_pkey_passwd:(null==(o=I.value)?void 0:o.ssh_conf.pkey_passwd)||""};return{...(null==(i=I.value)?void 0:i.id)?{id:null==(n=I.value)?void 0:n.id}:{},address:(null==(v=I.value)?void 0:v.address)||"",verify_type:c,api_key:"",app_key:"",category_id:(null==(y=null==(d=I.value)?void 0:d.category_id)?void 0:y.toString())||"0",remarks:(null==(_=I.value)?void 0:_.remarks)||"",...h}}catch(c){return{}}},A={class:"p-[2rem]"},H=r({__name:"index",setup(r,{expose:I}){const{isEdit:H,isVerify:C}=x(),q=p("popupLoading",(e,a)=>({close:()=>{}})),L=t(!1),{rowData:T,nodeCategory:N}=S(),B=u(()=>N.value.filter(e=>"all"!==e.value&&Number(e.value)>=0)),{buttonText:D,buttonType:E,buttonLoading:F,buttonClick:J,textChange:O}=(()=>{const a=t("测试连接"),s=t("default"),l=t(!1);return{buttonText:a,buttonType:s,buttonLoading:l,buttonClick:async(t,r)=>{if(!(await r()))return;l.value=!0,a.value="测试中",s.value="default";const p=await e({host:t.value.ssh_ip,port:parseInt(t.value.ssh_port),test_case:1,..."password"==t.value.ssh_type?{password:t.value.ssh_password}:{pkey:t.value.ssh_key,pkey_passwd:t.value.ssh_pkey_passwd}});l.value=!1,p.status?(a.value="连接成功",s.value="success"):(a.value="连接失败",s.value="danger")},textChange:()=>{a.value="测试连接",s.value="default",l.value=!1}}})(),{BtForm:R,submit:U,clearValidate:V,validate:z}=a({data:j,options:e=>u(()=>{var a;return[g("节点名称","remarks",{attrs:{class:"!w-[32rem]",placeholder:"请输入节点名称"},rules:[{required:!0,message:"节点名称不能为空",trigger:["blur","change"]}]}),k("验证类型","verify_type",[{label:"API密钥",value:"api"},{label:"APP插件",value:"app"},{label:"SSH",value:"ssh"}],{attrs:{onChange:()=>{V()}}}),..."ssh"===e.value.verify_type?[f([g("节点IP","ssh_ip",{attrs:{class:"!w-[150px]",placeholder:"例如:192.168.1.1",onInput:O},rules:[{required:!0,message:"请输入节点IP",trigger:["change","blur"]}]}),g("SSH端口","ssh_port",{attrs:{class:"!w-[70px]",placeholder:"22",onInput:O},rules:[{required:!0,message:"请输入SSH端口",trigger:["change","blur"]}]})]),k("认证方式","ssh_type",[{label:"密码",value:"password"},{label:"密钥",value:"key"}],{attrs:{onChange:()=>{V(),O()}}}),f([..."password"===e.value.ssh_type?[g("SSH密码","ssh_password",{attrs:{class:"!w-[230px]",type:"password",placeholder:"例如:123456",onInput:O},rules:[{required:!0,message:"请输入SSH密码",trigger:["change","blur"]}]})]:[w("SSH密钥","ssh_key",{attrs:{class:"!w-[230px]",placeholder:"请输入SSH密钥",onInput:O},rules:[{required:!0,message:"请输入SSH密钥",trigger:["change","blur"]}]})],b(()=>o(i,{plain:!0,type:E.value,class:"ml-[1.5rem] self-end mb-[1.8rem]",loading:F.value,disabled:F.value,onClick:()=>J(e,z)},D.value))]),..."key"===e.value.ssh_type?[g("SSH私钥密码","ssh_pkey_passwd",{attrs:{class:"!w-[320px]",type:"password",placeholder:"若没有密码，请留空",onInput:O}})]:[]]:[],..."api"===e.value.verify_type?[g("面板地址","address",{attrs:{class:"!w-[320px]",clearable:!0,placeholder:"例如:http://192.168.1.1:88 或 https://domain.com:88",onInput:a=>{if(e.value.address=e.value.address.trim(),s(e.value.address)){const a=new URL(e.value.address);e.value.address=a.origin}}},rules:[l()]})]:[],..."api"===e.value.verify_type?[g("API密钥","api_key",{attrs:{class:"!w-[32rem]",placeholder:H.value?"请输入API密钥,留空则沿用之前的密钥":"请输入API密钥"},rules:[{required:!H.value,message:"API密钥不能为空",trigger:["blur","change"]}]})]:[],..."app"===e.value.verify_type?[...C.value?[b(()=>o(c,{class:"!w-[32rem] !mb-[1rem] !ml-[10rem]",title:"请回到面板【堡塔APP】插件上点击确认按钮来完成验证",type:"warning",closable:!1}))]:[g("APP密钥","app_key",{attrs:{class:"!w-[32rem]",placeholder:H.value?"请输入APP插件密钥,留空则沿用之前的密钥":"请输入APP插件密钥"},rules:[{required:!H.value,message:"APP插件密钥不能为空",trigger:["blur","change"]}]})]]:[],P("分类","category_id",B.value||[{label:"默认分类",value:"0"}],{attrs:{class:"!w-[32rem]",placeholder:"请选择分类",defaultId:null==(a=e.value)?void 0:a.category_id}}),..."api"===e.value.verify_type?[{type:"help",options:[{content:"第一步：填写面板URL地址，示例：https://192.168.1.2:8888"},{content:"第二步：打开面板，转到【面板设置】页面，点击【API接口配置】"},{isHtml:!0,content:'<li style="color:red">第三步：配置【IP白名单】，输入您电脑的公网固定IP，如果没有固定IP，请直接填星号(*)</li>'},{content:"第四步：在【API接口配置】窗口中复制【接口密钥】"},{content:"第五步：回到节点管理窗口，粘贴到【API密钥】输入框"}]}]:"ssh"===e.value.verify_type?[{type:"help",options:[{content:"请输入root账户信息"}]}]:[{type:"help",options:[{content:"第一步：在面板【软件商店】安装【堡塔APP】插件1.2以上版本"},{content:"第二步：点击【复制绑定密钥】按钮获取密钥"},{content:"第三步：粘贴到【APP密钥】输入框，并点击【验证】按钮"},{content:"第四步：回到面板【堡塔APP】插件上点击【确认】按钮来完成验证"}]}]]}),submit:async(e,a,s)=>{var l;return await a(),"app"===e.value.verify_type&&""!==e.value.app_key&&(null==(l=T.value)?void 0:l.app_key)!==e.value.app_key?new Promise(async(a,s)=>{const{close:l}=q(C,"请先完成验证");L.value=await h({remarks:e.value.remarks,app_key:e.value.app_key},async()=>{l(),a(await Z(e))}),L.value||(l(),C.value=!1,s(!1))}):await Z(e)}}),Z=async e=>{const{address:a,category_id:s,api_key:l,app_key:t,remarks:r,ssh_ip:p,ssh_port:u,ssh_type:o,ssh_password:i,ssh_key:n,ssh_pkey_passwd:v}=e.value;let d={..."api"===e.value.verify_type?{api_key:l}:{},..."app"===e.value.verify_type?{app_key:t}:{},..."ssh"===e.value.verify_type?{ssh_conf:JSON.stringify({host:p,port:u,..."password"===o?{password:i}:{pkey:n,pkey_passwd:v}})}:{address:a},category_id:"all"===s?0:s,remarks:r};return H.value&&(""===e.value.api_key&&(d.api_key=T.value.api_key),""===e.value.app_key&&(d.app_key=T.value.app_key),"ssh"!==e.value.verify_type&&(d.ssh_conf=JSON.stringify(T.value.ssh_conf)),d.id=T.value.id),await m(d,H.value)};return n(()=>{C.value=!1,L.value&&L.value()}),I({onConfirm:U}),(e,a)=>(v(),d("div",A,[y(_(R),{disabled:_(C)},null,8,["disabled"])]))}});export{H as default};
