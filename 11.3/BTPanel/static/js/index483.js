import{r as a,c as e,o as l,g as t,v as s,I as o,J as n,z as i,x as u,y as d,e as r,C as m,A as c,F as f,b1 as p,O as v,D as _,G as b,L as h,B as g,R as y,U as w,am as x,an as V,ad as k,ak as D,aj as C,c5 as S,V as j,ab as P}from"./base-lib.js?v=1763689792";import{b6 as U,bR as q,H as T,n as L,aK as I,u as E,e as F,k as O,ax as A,$ as H,b as N,_ as R}from"./utils-lib.js?v=1763689792";import{_ as M}from"./index107.js?v=1763689792";import{l as J}from"./useController5.js?v=1763689792";import{Q,R as z,S as B,T as G,g as K}from"./useController7.js?v=1763689792";import{u as $,S as W}from"./useStore4.js?v=1763689792";import{u as X}from"./index283.js?v=1763689792";import{f as Y,k as Z}from"./validator.js?v=1763689792";import{addSiteTypes as aa,modifySiteTypes as ea,removeSiteType as la,addPhpSite as ta,GetPHPVersion as sa,getFtpMysqlStatus as oa}from"./site.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./column.js?v=1763689792";import"./index110.js?v=1763689792";import"./useController6.js?v=1763689792";import"./useMethod5.js?v=1763689792";const{domainId:na,domainName:ia,createSiteType:ua}=X(),da=a([]),ra=(a,e)=>{const l=e.domains[a];l.name&&l.suffix?(l.fullDomain="".concat(l.name).concat(l.suffix),0===a&&(e.ps=l.fullDomain,e.path="/www/wwwroot/".concat(l.fullDomain),e.ftp_username=l.fullDomain.replace(/\./g,"_"),e.ftp_password=U(8),e.datauser=l.fullDomain.replace(/\./g,"_"),e.datapassword=U(8))):l.fullDomain=""},ma=(a,e)=>{let l="";if(a.domains&&a.domains.length>0){const e=a.domains.find(a=>a.suffix&&""!==a.suffix);e&&(l=e.suffix)}!l&&Array.isArray(e)&&e.length>0&&(l=e[0].value),a.domains.push({name:"",suffix:l,fullDomain:"",status:"",hint:""})},ca=(a,e)=>{if(e.domains.length>1&&(e.domains.splice(a,1),0===a&&e.domains.length>0)){const a=e.domains[0];a.name&&a.suffix&&(a.fullDomain="".concat(a.name).concat(a.suffix),e.ps=a.fullDomain,e.path="/www/wwwroot/".concat(a.fullDomain),e.ftp_username=a.fullDomain.replace(/\./g,"_"),e.ftp_password=U(8),e.datauser=a.fullDomain.replace(/\./g,"_"),e.datapassword=U(8))}},fa=a=>{Y({type:"dir",path:a.path,change:e=>{const l=q(e,"string","");a.path=l}})},pa=async a=>{try{const{getPluginInfo:e}=await T(()=>import("./utils-lib.js?v=1763689792").then(a=>a.lU),__vite__mapDeps([]),import.meta.url),{data:l}=await e({sName:a});Z({name:l.name,type:"i",pluginInfo:l})}catch(e){}},va=async(a,e)=>{try{if(a.value&&a.value.length>0)return;const{data:l}=await e();a.value=l}catch(l){a.value=[]}},_a=async(a,e,l)=>{var t;try{const s={p:1,limit:200},o="domain"===ua.value?await l(s):await z(s),n="domain"===ua.value?o.data:o.data.data;if(n&&n.length>0){const l=n.map(a=>({label:".".concat("domain"===ua.value?a.full_domain:a.domain),value:".".concat("domain"===ua.value?a.full_domain:a.domain),id:(ua.value,a.id),fullDomain:"domain"===ua.value?a.full_domain:a.domain})).sort((a,e)=>a.label.localeCompare(e.label));a.value=l;let s=(null==(t=l[0])?void 0:t.value)||"";if(ia.value){const a=l.find(a=>a.value===".".concat(ia.value)||a.value===ia.value);a&&(s=a.value)}e.domains.forEach(a=>{a.suffix&&""!==a.suffix||(a.suffix=s)})}}catch(s){}},ba=async(a,e)=>{var l;try{const t=await sa();a.value=t.data;let s="00";null==(l=a.value)||l.forEach(a=>{Number(a.version)>Number(s)&&(s=a.version)}),e.version=s}catch(t){}},ha=(a,e,l)=>{L({title:"分类管理",area:"54",compData:{ignore:["0","-2"],field:"name",getClassList:async()=>{const{data:l}=await e();return a.value=l,l},addClass:a=>aa(a,l),editClass:a=>ea(a,l),deleteClass:a=>la(a,l),updateOptions:e=>{a.value=e},showEdit:!0},component:()=>T(()=>import("./class-manage.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},ga=async(a,e,l,t,s,o,n)=>{var i,u,d;o.value=!0;let r=null;try{const s=e.domains[0];if(s&&"*"===s.name)return s.hint="第一个域名不能是通配符",s.status="error",t.error("第一个域名不能是通配符"),!1;"local"!==ua.value?await(async a=>{try{const e=a.domains.filter(a=>a.name&&a.suffix).map(a=>a.fullDomain);if(0===e.length)return;a.domains.forEach(a=>{a.name&&a.suffix&&(a.status="checking",a.hint="检测中...")});const l=await B({domains:e});if(l.data&&l.data.data){const e=l.data.data;a.domains.forEach(a=>{if(a.name&&a.suffix){const l=e[a.fullDomain];!0===l?(a.status="available",a.hint="域名可用"):!1===l?(a.status="registered",a.hint="域名已被注册"):(a.status="error",a.hint="检测失败")}})}}catch(e){a.domains.forEach(a=>{a.name&&a.suffix&&(a.status="error",a.hint="检测失败")})}})(e):e.domains.forEach(a=>{a.name&&a.suffix&&(a.status="available",a.hint="")});let o=0,c=0,f=0,p=0;const v=[];for(const a of e.domains)if(a.name&&a.suffix)switch(a.status){case"checking":o++;break;case"registered":c++;break;case"error":f++;break;case"available":p++,v.push(a)}if(o>0)return t.error("域名检测中，请稍候..."),!1;if(c>0)return t.error("存在不可用的域名，请检查后重试"),!1;if(f>0)return t.error("域名检测失败，请重试"),!1;if(p>0&&(r=t.load("所有域名都可用，正在创建站点...")),0===v.length)return t.error("没有可用的域名"),!1;if(!l.value)return t.error("表单引用不存在"),!1;if(!(await l.value.validate()))return!1;const _=v.map(a=>a.fullDomain),b={path:e.path,ftp:e.ftp,type:"PHP",type_id:e.type_id,ps:e.ps,port:e.port,version:e.version,need_index:0,need_404:0,sql:e.sql,codeing:e.codeing,webname:JSON.stringify({domain:_[0]||"",domainlist:_.slice(1),count:_.length-1}),add_dns_record:!1,ftp_username:e.ftp_username,ftp_password:e.ftp_password,datauser:e.datauser,datapassword:e.datapassword},h=await ta(b),g={ftp:e.ftp,ftpStatus:(null==(i=h.data)?void 0:i.ftpStatus)||!1,ftpData:{username:e.ftp_username,password:e.ftp_password},sql:e.sql,databaseStatus:(null==(u=h.data)?void 0:u.databaseStatus)||!1,sqlData:{username:e.datauser,password:e.datapassword},siteStatus:(null==(d=h.data)?void 0:d.siteStatus)||!1,site:!1};if(h.status&&h.data.siteId){try{const a=v.map(a=>{const e=n.value.find(e=>e.value===a.suffix),l=(null==e?void 0:e.id)||na.value||0;return{name:a.fullDomain,["domain"===ua.value?"domain_id":"local_domain_id"]:l,record:a.name}}),l=JSON.stringify(a);let t="",s=!1;"certificate"===e.ssl_type&&e.ssl_cert&&(t=e.ssl_cert,s=e.force_https);const o={domain_list:l,ssl_hash:t,site_id:h.data.siteId,https:s};await Q(o)}catch(m){}return a&&a(),e.ftp||e.sql?L({isAsync:!0,title:"网站添加结果",area:46,component:()=>T(()=>import("./add-result.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:g}):t.success("网站创建成功"),!0}return t.error(h.msg||"站点创建失败"),!1}catch(c){return t.error(c.message||"提交失败"),!1}finally{null==r||r.close(),o.value=!1}};let ya="",wa="";const xa=(a,e)=>{ya=a,wa=e},Va=(a,e)=>{if(a===ya){e([...da.value].sort((a,e)=>{const l=a.label===ya&&a.value===wa,t=e.label===ya&&e.value===wa;return l&&!t?-1:!l&&t?1:0}))}else if(a){const l=da.value.filter((a=>e=>{const l=e.label.split(" - ")[0],t=a.toLowerCase();return l.toLowerCase().includes(t)||e.label.toLowerCase().includes(t)})(a));e(l)}else e(da.value)},ka={class:"php-site-form"},Da={class:"domain-input-container"},Ca={class:"domain-input-group"},Sa={class:"domain-actions"},ja={class:"cert-option-content"},Pa={class:"cert-name text-base font-500 mb-3"},Ua={class:"cert-sublabel text-small"},qa={class:"items-center flex"},Ta={class:"flex items-center mb-[8px]"},La={class:"flex items-center"},Ia={class:"flex items-center mb-[4px]"},Ea=R(e({__name:"index",props:{compData:{default:()=>({domainId:0})}},setup(e,{expose:U}){const{activeType:q}=$(),{getClassList:T}=W(),{getDomainHintClass:L}=X(),R=a(!1),Q=a(!1),z=a(),B=l({database:!1,ftp:!1}),Y=l({domains:[{name:"",suffix:"",fullDomain:"",status:"",hint:""}],ps:"",path:"/www/wwwroot/",ftp:!1,ftp_username:"",ftp_password:"",sql:!1,codeing:"utf8mb4",datauser:"",datapassword:"",version:"",type_id:"",port:80,ssl_type:"false",ssl_cert:"",force_https:!1,title:""}),Z=a([]),aa=a([]),ea=a(""),la=a(""),ta=t(()=>J.value.filter(a=>"all"!==a.value&&Number(a.value)>=0)),sa=async a=>{const e=String(a);if(ea.value="",la.value="",Y.ssl_cert="",xa("",""),"certificate"===e)try{const a=await G({p:1,limit:100,reverse:1,search_limit:1});a.status&&a.data&&(da.value=a.data.map(a=>{var e,l;const t=a.dns&&a.dns.length>0?a.dns.join(", "):a.subject||"未知域名";let s="";if(void 0!==a.endtime)if(a.endtime<0)s="已过期".concat(Math.abs(a.endtime),"天");else{const l=(null==(e=a.info)?void 0:e.notAfter)||"未知";s="过期时间：".concat(l,"（剩").concat(a.endtime,"天）")}const o=(null==(l=a.info)?void 0:l.issuer_O)?" - ".concat(a.info.issuer_O):"";return{label:t+" - "+s+o,subLabel:s+o,value:a.hash}}))}catch(l){}else Y.ssl_cert="",Y.force_https=!1},na={path:[{required:!0,message:"请输入根目录",trigger:"blur"}],ftp_username:[{required:!0,message:"请输入FTP账号",trigger:"blur"}],datauser:[{required:!0,message:"请输入数据库账号",trigger:"blur"}]},ia=async()=>{var a,e,l;R.value=!0;try{const t=await(async()=>{try{const{data:a}=await oa();return{ftp:a.ftp,mysql:a.mysql}}catch(a){I(a)}})();B.database=null==(a=null==t?void 0:t.mysql)||a,B.ftp=null==(e=null==t?void 0:t.ftp)||e,await Promise.all([ba(Z,Y),_a(aa,Y,K),va(J,T)]),Y.type_id=null==(l=ta.value[0])?void 0:l.value;const{panel:s}=E(),o=s.value.sitePath;o&&(Y.path=o)}catch(t){}finally{R.value=!1}};return s(ia),U({init:ia,onConfirm:a=>{const e=N();return ga(a,Y,z,e,0,Q,aa)}}),(a,e)=>{const l=w,t=x,s=V,U=F,I=k,E=D,N=C,G=S,K=j,$=O,W=M,X=A,oa=H,ia=P,ua=o("bt-loading");return n((u(),d("div",ka,[r(ia,{model:i(Y),rules:na,disabled:i(Q),ref_key:"addSiteFormRef",ref:z},{default:m(()=>[r(I,{label:"域名",class:"!mb-0"},{default:m(()=>[c("div",Da,[(u(!0),d(f,null,p(i(Y).domains,(a,o)=>(u(),d("div",{key:o,class:"domain-item"},[c("div",Ca,[r(l,{modelValue:a.name,"onUpdate:modelValue":e=>a.name=e,placeholder:"请输入子域名 (不支持通配符)",class:"domain-name-input",onInput:()=>i(ra)(o,i(Y))},null,8,["modelValue","onUpdate:modelValue","onInput"]),r(s,{modelValue:a.suffix,"onUpdate:modelValue":e=>a.suffix=e,placeholder:"选择后缀",class:"domain-suffix-select",onChange:()=>i(ra)(o,i(Y))},{default:m(()=>[(u(!0),d(f,null,p(i(aa),a=>(u(),v(t,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),c("div",Sa,[o===i(Y).domains.length-1&&i(Y).domains.length<10?(u(),v(U,{key:0,onClick:e[0]||(e[0]=()=>i(ma)(i(Y),i(aa))),class:"text-primary"},{default:m(()=>[...e[20]||(e[20]=[_(" 添加 ",-1)])]),_:1})):b("",!0),i(Y).domains.length>1?(u(),v(U,{key:1,onClick:()=>i(ca)(o,i(Y)),class:"text-danger"},{default:m(()=>[...e[21]||(e[21]=[_(" 移除 ",-1)])]),_:1},8,["onClick"])):b("",!0)])]),c("div",{class:h(["domain-hint",i(L)(a.status)])},g(a.hint),3)]))),128))])]),_:1}),r(I,{label:"SSL证书配置"},{default:m(()=>[r(N,{modelValue:i(Y).ssl_type,"onUpdate:modelValue":e[1]||(e[1]=a=>i(Y).ssl_type=a),onChange:sa},{default:m(()=>[r(E,{value:"false"},{default:m(()=>[...e[22]||(e[22]=[_("不使用SSL",-1)])]),_:1}),r(E,{value:"certificate"},{default:m(()=>[...e[23]||(e[23]=[_("证书夹",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"certificate"===i(Y).ssl_type?(u(),v(I,{key:0,label:"选择证书"},{default:m(()=>[r(G,{"popper-class":"my-autocomplete",modelValue:i(ea),"onUpdate:modelValue":e[2]||(e[2]=a=>y(ea)?ea.value=a:null),class:"!w-[52rem]","popper-append-to-body":!1,"fetch-suggestions":i(Va),"trigger-on-focus":!0,clearable:"","value-key":"label",onSelect:e[3]||(e[3]=a=>{ea.value=a.label,la.value=a.value,i(Y).ssl_cert=a.value,i(xa)(a.label,a.value)}),placeholder:"请输入或选择证书"},{default:m(({item:a})=>[c("div",{class:h(["cert-option !h-[5.4rem] !leading-auto !line-height-normal flex flex-col justify-center",a.label===i(ea)&&a.value===i(la)?"is-selected":""])},[c("div",ja,[c("div",Pa,g(a.label.split(" - ")[0]),1),c("div",Ua,g(a.subLabel),1)])],2)]),_:1},8,["modelValue","fetch-suggestions"])]),_:1})):b("",!0),"certificate"===i(Y).ssl_type?(u(),v(I,{key:1,label:"强制HTTPS访问"},{default:m(()=>[r(K,{modelValue:i(Y).force_https,"onUpdate:modelValue":e[4]||(e[4]=a=>i(Y).force_https=a)},{default:m(()=>[...e[24]||(e[24]=[_("启用强制HTTPS访问",-1)])]),_:1},8,["modelValue"])]),_:1})):b("",!0),r(I,{label:"备注"},{default:m(()=>[r($,{modelValue:i(Y).ps,"onUpdate:modelValue":e[5]||(e[5]=a=>i(Y).ps=a),placeholder:"请输入备注,可为空",width:"52rem"},null,8,["modelValue"])]),_:1}),r(I,{label:"根目录",prop:"path"},{default:m(()=>[r(W,{modelValue:i(Y).path,"onUpdate:modelValue":e[6]||(e[6]=a=>i(Y).path=a),placeholder:"请输入根目录",icon:"el-folder-opened",width:"52rem",onIconClick:e[7]||(e[7]=()=>i(fa)(i(Y)))},null,8,["modelValue"])]),_:1}),r(I,{label:"FTP"},{default:m(()=>[c("div",qa,[r(s,{class:"!w-[15rem]",modelValue:i(Y).ftp,"onUpdate:modelValue":e[8]||(e[8]=a=>i(Y).ftp=a),disabled:!i(B).ftp},{default:m(()=>[r(t,{label:"不创建",value:!1}),r(t,{label:"创建",value:!0})]),_:1},8,["modelValue","disabled"]),i(B).ftp?b("",!0):(u(),d("span",{key:0,onClick:e[9]||(e[9]=a=>i(pa)("pureftpd")),class:"ml-[4px] text-danger cursor-pointer !text-small"},"未安装FTP，点击安装"))])]),_:1}),i(Y).ftp?(u(),v(I,{key:2,label:"FTP账号"},{default:m(()=>[c("div",Ta,[r(I,{prop:"ftp_username"},{default:m(()=>[r($,{placeholder:"创建FTP账号",modelValue:i(Y).ftp_username,"onUpdate:modelValue":e[10]||(e[10]=a=>i(Y).ftp_username=a),width:"24rem"},null,8,["modelValue"])]),_:1}),r(I,{label:"密码",class:"!mt-0"},{default:m(()=>[r($,{placeholder:"FTP密码",modelValue:i(Y).ftp_password,"onUpdate:modelValue":e[11]||(e[11]=a=>i(Y).ftp_password=a),width:"24rem"},null,8,["modelValue"])]),_:1})]),e[25]||(e[25]=c("span",{class:"text-tertiary text-small"},"创建站点的同时，为站点创建一个对应FTP帐户，并且FTP目录指向站点所在目录。",-1))]),_:1})):b("",!0),r(I,{label:"数据库"},{default:m(()=>[c("div",La,[r(s,{class:"!w-[15rem]",modelValue:i(Y).sql,"onUpdate:modelValue":e[12]||(e[12]=a=>i(Y).sql=a),disabled:!i(B).database},{default:m(()=>[r(t,{label:"不创建",value:!1}),r(t,{label:"MySQL",value:"MySQL"})]),_:1},8,["modelValue","disabled"]),i(B).database?b("",!0):(u(),d("span",{key:0,onClick:e[13]||(e[13]=a=>i(pa)("mysql")),class:"ml-[4px] text-danger cursor-pointer !text-small"},"未安装数据库，点击安装")),i(Y).sql?(u(),v(s,{key:1,class:"ml-[8px] !w-[15rem]",modelValue:i(Y).codeing,"onUpdate:modelValue":e[14]||(e[14]=a=>i(Y).codeing=a)},{default:m(()=>[r(t,{label:"utf8mb4",value:"utf8mb4"}),r(t,{label:"utf8",value:"utf8"}),r(t,{label:"gbk",value:"gbk"}),r(t,{label:"big5",value:"big5"})]),_:1},8,["modelValue"])):b("",!0)])]),_:1}),i(Y).sql?(u(),v(I,{key:3,label:"数据库账号"},{default:m(()=>[c("div",Ia,[r(I,{prop:"datauser"},{default:m(()=>[r($,{placeholder:"创建数据库账号",class:"w-[24rem]",modelValue:i(Y).datauser,"onUpdate:modelValue":e[15]||(e[15]=a=>i(Y).datauser=a)},null,8,["modelValue"])]),_:1}),r(I,{label:"密码",class:"!mt-0"},{default:m(()=>[r($,{placeholder:"数据库密码",class:"w-[24rem]",modelValue:i(Y).datapassword,"onUpdate:modelValue":e[16]||(e[16]=a=>i(Y).datapassword=a)},null,8,["modelValue"])]),_:1})]),e[26]||(e[26]=c("span",{class:"text-tertiary text-small"},"创建站点的同时，为站点创建一个对应的数据库帐户，方便不同站点使用不同数据库。",-1))]),_:1})):b("",!0),r(I,{label:"PHP版本"},{default:m(()=>[r(s,{class:"!w-[15rem]",modelValue:i(Y).version,"onUpdate:modelValue":e[17]||(e[17]=a=>i(Y).version=a)},{default:m(()=>[(u(!0),d(f,null,p(i(Z),a=>(u(),v(t,{key:a.value,label:a.name,value:a.version},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),r(I,{label:"网站分类"},{default:m(()=>[r(X,{modelValue:i(Y).type_id,"onUpdate:modelValue":e[18]||(e[18]=a=>i(Y).type_id=a),options:i(ta),class:"!w-[15rem]"},null,8,["modelValue","options"]),r(U,{class:"ml-[8px]",onClick:e[19]||(e[19]=a=>i(ha)(i(J),i(T),i(q)))},{default:m(()=>[...e[27]||(e[27]=[_("分类设置",-1)])]),_:1})]),_:1}),r(I,{label:" "},{default:m(()=>[r(oa,{options:[{content:"堡塔后台开启密保验证功能，无法添加解析记录"}]})]),_:1})]),_:1},8,["model","disabled"])])),[[ua,i(R)]])}}}),[["__scopeId","data-v-51421a65"]]);export{Ea as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
