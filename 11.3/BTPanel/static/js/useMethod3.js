import{x as e,M as a,n as t,H as s,bU as l,p as i}from"./utils-lib.js?v=1763689792";import{g as r,r as u,o,aE as n,e as p,V as c}from"./base-lib.js?v=1763689792";import{aa as d,ab as m,ac as v,a2 as _,ad as b,ae as f}from"./config.js?v=1763689792";import{d as y,i as g}from"./useMethod2.js?v=1763689792";import{l as w}from"./validator.js?v=1763689792";const k=r(()=>"add"===y.value.operateType),h=r(()=>"restore"===y.value.operateType),z=r(()=>"detail"===y.value.operateType),L=u(["1"]),x=u({}),j=u(!1),N=u(!1);u(null),u("计算中...");const T=u([]),O=u(!1);o({web:"",ftp:"",database:""});const C=u(!1),K=o({size:0,current:0});r(()=>K.size<K.current),u(0);const F=e=>{const a=new Date(new Date),t=a.getFullYear(),s=a.getMonth()+1,l=a.getDate(),i=a.getHours(),r=a.getMinutes();return"备份-".concat(t,"-").concat(s<10?"0"+s:s,"-").concat(l<10?"0"+l:l,"-").concat(i<10?"0"+i:i).concat(r<10?"0"+r:r)},P=async(e,t,s,l)=>{const i={site:"site",database:"database",wptools:"wp_tools",plugin:"plugin",runtime:"soft",Ftp:"ftp",Crontab:"crontab",Vmail:"vmail",Terminal:"ssh",Firewall:"firewall",node:"node"};if(x.value=e,J.status=1,J.progress=0,J.msg="准备"+(h.value?"还原":"备份")+"数据",""===e.exec_time&&"restore"===y.value.operateType&&(B.value=D()),"restore"===y.value.operateType){const e={timestamp:y.value.timestamp,auto_exit:j.value?1:0,force_restore:N.value?1:0};await d(e);return}const r=[];Object.entries(t).map(([e,a])=>{("database"===e&&l.length>0||"site"===e&&s.length>0||a)&&r.push(i[e])});let u={backup_name:e.name,auto_exit:j.value?1:0,storage_type:e.path,timestamp:e.exec_time/1e3,site_id:JSON.stringify(s.map(e=>e.id)),database_id:JSON.stringify(l.map(e=>e.id)),data_list:JSON.stringify(r)};const o=await m(u);g.value=!0,a.request(o),""===e.exec_time&&o.status&&(B.value=D())},V=async e=>{C.value||(C.value=!0,await S(void 0,!0),h.value&&(a.success("刷新成功"),e.disabled=K.size>K.current,C.value=!1))},D=e=>t({title:!1,component:()=>s(()=>import("./back-progress.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{type:e},area:52}),E=async a=>{const{data:t}=await v({type:h.value||"restore"===a?"restore":"backup"});if("string"==typeof t.data)return Object.assign(J,{status:1,progress:0,msg:"获取进度日志中...",time:0}),M.value=t.data+"，或请稍等片刻后检查进度是否更新，若未更新请重新进行操作",void(B.value&&setTimeout(E,1500));J.status=t.data.task_status,J.time=t.data.left_time||0,M.value=t.data.exec_log||"暂无日志";2===t.data.task_status||3===t.data.task_status?(J.progress=100,J.msg="备份"+(2===t.data.task_status?"成功":"结束"),t.data.backup_file_info&&Object.assign(q.value,{name:t.data.backup_file_info.backup_name,files_size:e(Number(t.data.backup_file_info.backup_file_size)),end_time:t.data.backup_file_info.done_time,time_count:t.data.backup_file_info.restore_total_time||t.data.backup_file_info.total_time,backup_file_sha256:t.data.backup_file_info.backup_file_sha256}),3===t.data.task_status&&(J.msg="备份失败",J.progress=0,U.value=t.data.err_info||[]),g.value=!0):(J.progress=t.data.progress,J.msg=t.data.task_msg,B.value&&setTimeout(E,1500))},S=async(e,t)=>{try{if(C.value=!0,"restore"===y.value.operateType){const{data:e}=await _({timestamp:y.value.timestamp,type:"backup"});return I(e.data.data_status),K.size=e.data.disk_use,K.current=e.data.disk_free,void(C.value=!1)}if(l(e)||void 0===e){const{data:e}=await b();"add"===y.value.operateType&&H(e.data),I(e.data)}else I(e);C.value=!1,t&&a.success("刷新成功")}catch(s){}},H=e=>{var a,t,s;T.value=(null==(a=e.oss_list)?void 0:a.map(e=>({label:e.name,value:e.value,status:Boolean(e.status),disabled:"localhost"!==e.value&&!e.status,render:e=>p("div",{class:"flex items-center justify-between"},[p("span",null,[e.label]),p("span",{onClick:()=>{w({name:e.value})},class:"float-right text-small text-danger cursor-pointer ml-12px ".concat("localhost"!==e.value?"":"!hidden")},[e.status?"":"[未配置]"])])})))||[],T.value&&"local"===(null==(t=T.value[0])?void 0:t.value)||null==(s=T.value)||s.unshift({label:"本地存储",value:"local"})},I=e=>{const a={command_size:"命令列表",ssh_size:"终端数据"},t={firewall_conutry:"地区规则",firewall_ip:"IP规则",firewall_forward:"端口转发规则",firewall_malicious_ip:"恶意IP",firewall_new:"端口规则"};Q.value=e.site_list,$.value=e.database_list,X.value=e.btnode_list,ie.value.ftpList=e.ftp_list,ie.value.crontabList=e.crontab_list,ie.value.vmailList=e.vmail_list,ie.value.termList=Object.keys(e.ssh_list).filter(e=>"status"!==e&&"err_msg"!==e).map(t=>({name:a[t],size:e.ssh_list[t]})),ie.value.firewallList=Object.keys(e.firewall_list).length>0?Object.keys(t).filter(e=>"firewall_conutry"!==e).map(a=>({name:t[a],total:e.firewall_list[a]||"--"})):[],ae.value=e.plugin_list||[],se.value=e.soft_data||[],Z.value=e.wp_tools_list||[],Object.keys(ue.value).forEach(e=>ue.value[e.toLowerCase()]=!1),"restore"!==y.value.operateType&&(K.size=e.disk_use,K.current=e.disk_free)},M=u(""),B=u(),J=o({status:1,progress:0,time:0,msg:"准备开始操作"}),q=u({name:"",backup_file:"",files_size:"",end_time:"",time_count:"",backup_file_sha256:""}),U=u([]),A=[{type:"index"},{label:"失败项",prop:"name"},{label:"失败原因",prop:"msg",width:140,render:e=>p("span",{class:"text-dangerDark"},[e.msg])},{label:"类型",prop:"type"}],R=()=>{Q.value=[],ie.value.ftpList=[],ie.value.crontabList=[],ie.value.termList=[],ie.value.firewallList=[],ae.value=[],se.value=[],Object.keys(ue.value).forEach(e=>ue.value[e.toLowerCase()]=!0),L.value=["1"]},G=async()=>{try{await i({title:"确认继续"+(h.value?"还原":"备份"),content:"即将尝试继续"+(h.value?"还原":"备份")+"数据，是否继续操作？"}),(await B.value).unmount(),B.value=null,P(x.value)}catch(e){}},Q=u([]),Y=r(()=>e(Q.value.reduce((e,a)=>e+Number(a.size),0))),$=u([]),W=r(()=>e($.value.reduce((e,a)=>e+Number(a.size),0))),X=u([]),Z=u([]),ee=r(()=>e(Z.value.reduce((e,a)=>e+Number(a.size),0))),ae=u([]),te=r(()=>e(ae.value.reduce((e,a)=>e+Number(a.size),0))),se=u([]),le=r(()=>e(se.value.reduce((e,a)=>e+Number(a.size),0))),ie=u({ftpList:[],crontabList:[],vmailList:[],termList:[],firewallList:[]}),re=a=>e(ie.value[a].reduce((e,a)=>e+Number(a.size||a.vmail_size||0),0)),ue=u({site:!0,database:!0,ftp:!0,crontab:!0,vmail:!0,terminal:!0,firewall:!0,wptools:!0,plugin:!0,runtime:!0,node:!0,other:!0}),oe=r(()=>({Ftp:{title:"FTP",icon:"ftp",dataKey:"ftpList",loadingKey:"ftp",tooltip:"仅备份FTP账号和密码，不备份FTP目录"},Crontab:{title:"计划任务",icon:"crontab",dataKey:"crontabList",loadingKey:"crontab"},Vmail:{title:"邮局服务器",icon:"mail",dataKey:"vmailList",loadingKey:"vmail",count:!0},Terminal:{title:"终端",icon:"xterm",dataKey:"termList",loadingKey:"terminal"},Firewall:{title:"系统防火墙",icon:"firewall",dataKey:"firewallList",loadingKey:"firewall"}})),ne=r(()=>[...h.value?[]:[{type:"CheckBox",width:36,renderHeader:()=>n("div"),render:(e,a,{handleScopeChange:t})=>p(c,{modelValue:e.keys_scopes_status,"onUpdate:modelValue":a=>e.keys_scopes_status=a,onChange:s=>t(s,e,a,"id")},null)}],{label:"网站名称",prop:"name"},{label:"网站大小",render:a=>e(Number(a.size))},{label:"网站类型",prop:"type"}]),pe=r(()=>[...h.value?[]:[{type:"CheckBox",width:36,renderHeader:()=>n("div"),render:(e,a,{handleScopeChange:t})=>p(c,{modelValue:e.keys_scopes_status,"onUpdate:modelValue":a=>e.keys_scopes_status=a,onChange:s=>t(s,e,a,"id")},null)}],{label:"数据库名称",prop:"name"},{label:"数据库大小",render:a=>e(Number(a.size))},{label:"数据库类型",prop:"type"}]),ce=[{label:"网站名称",prop:"name",width:120},{label:"网站大小",render:a=>e(Number(a.size))},{label:"网站类型",render:e=>"local"===e.type?"本地":"远程"}],de=[{label:"插件名称",prop:"name"},{label:"大小",render:a=>e(Number(a.size))}],me=[{label:"运行环境",prop:"name"},{label:"版本",prop:"version"},{label:"大小",render:a=>e(Number(a.size))}],ve=[{label:"名称",prop:"name"},{label:"服务器IP",prop:"server_ip"}],_e=async()=>{await i({title:"确认取消"+(h.value?"还原":"备份"),content:"即将取消"+(h.value?"还原":"备份")+"数据，是否继续操作？"});let e=a.load("正在取消任务，请稍后...");const t=await f({timestamp:y.value.timestamp});(await B.value).unmount(),B.value=null,e.close(),a.request(t),g.value=!0};export{R as $,re as A,te as B,de as C,se as D,le as E,me as F,L as G,j as H,N as I,C as J,V as K,J as L,M,E as N,_e as O,q as P,A as Q,U as R,G as S,ae as a,T as b,F as c,O as d,P as e,k as f,K as g,S as h,h as i,$ as j,z as k,Y as l,W as m,pe as n,D as o,B as p,Z as q,ee as r,ne as s,ue as t,ce as u,X as v,Q as w,ve as x,oe as y,ie as z};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
