import{u as a,n as e,H as t,Q as s,p as l,M as i,aK as n,R as r,l as o,_ as u}from"./utils-lib.js?v=1763689792";import{s as c,j as d,r as m,o as p,e as _,b8 as g,c as y,x as v,y as h,A as f,z as b,B as w,D as P,C as T,F as S,b1 as F,L as I,H as k}from"./base-lib.js?v=1763689792";import{u as x,x as j,l as O,y as L,z as D,A as N,B as q,C as A,D as B,E as C,G as E,H as J,I as R}from"./useStore9.js?v=1763689792";import{u as z}from"./column.js?v=1763689792";import{p as H}from"./validator.js?v=1763689792";const V=d("FTP_LOGS_ANALYSIS",()=>{const a=m(),e=m({scanStatus:!1,autoScanText:"定时自动扫描",btn:"立即扫描",data:[]}),t=m({login_error:!0,time:!0,area:!0,anonymous:!0,upload_shell:!0,day:7,otherDay:1,user:"all",userList:[],cycle:1,channel:[],option:{},config:{login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"},search:"",status:!0}),s=m([]),l=m(null),i=m([]),n=m(),r=m(!1),o=m(),u=m([]);return{ftpAnalysisList:e,ftpScanTable:a,ruleForm:t,whiteTableData:i,ip:n,setScanInfo:l,addFtpInfo:m(),isAutoScan:o,userOptions:u,isLoading:r,areaOptions:s}}),G=()=>c(V()),{payment:M}=a(),{isRefreshFtpList:W}=x(),{ftpAnalysisList:K,ruleForm:Q,whiteTableData:Y,ip:$,setScanInfo:U,addFtpInfo:X,isAutoScan:Z,userOptions:aa,isLoading:ea,areaOptions:ta}=G(),sa=async(a={search:Q.value.search,day:"other"===Q.value.day?Number(Q.value.otherDay):Number(Q.value.day),user:"all"===Q.value.user?"[]":JSON.stringify(Q.value.userList)})=>{try{const e=await A(a);if(e.status){K.value.data=[];for(const a in e.data){const t=e.data[a];K.value.data.push({time:t.exec_time,type:t.type,user:t.user,ip:a,id:t.id})}}}catch(e){n(e)}},la=()=>{K.value={scanStatus:!1,autoScanText:"定时自动扫描",btn:"立即扫描",data:[]},Q.value={login_error:!0,time:!0,area:!0,anonymous:!0,upload_shell:!0,day:7,otherDay:1,user:"all",userList:[],cycle:1,channel:[],option:{},config:{login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"},search:"",status:!0}},ia=p({login_error:[{validator:(a,e,t)=>{e>0?t():t("请输入大于0的整数")},trigger:["change"]}],se_time:[{validator:(a,e,t)=>{Q.value.config.start_time&&Q.value.config.end_time?t():t("开始时间和结束时间不能为空")},trigger:["blur"]}]}),na=a=>{Q.value.config.start_time=a},ra=a=>{Q.value.config.end_time=a},oa=async a=>{await U.value.validate();const e=((a=Q.value.config)=>({time:JSON.stringify({start_time:Number(a.start_time.split(":")[0]),end_time:Number(a.end_time.split(":")[0])}),area:JSON.stringify({country:a.area.country,city:[]}),upload_shell:JSON.stringify(a.upload_shell_br.split("\n")),login_error:a.login_error}))();(await s({loading:"正在提交中数据，请稍候...",request:E(e),message:!0})).status&&(_a(),a&&a())},ua=[{label:"IP",render:a=>_("span",null,[a])},z([{onClick:async a=>{(await s({loading:"正在删除白名单IP，请稍后...",request:q({ip:a,type:"del"}),data:{status:Boolean},message:!0})).status&&(da(),sa())},title:"删除"}])],ca=async(a={ip:$.value,type:"add"})=>{a.ip?/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(a.ip)?await s({loading:"正在添加白名单IP，请稍后...",request:q(a),data:{status:Boolean},message:!0,success:a=>{a.status&&($.value="",da(),sa())}}):i.error("请输入正确的ip地址"):i.error("请输入ip地址")},da=async()=>{await s({loading:"正在获取白名单列表，请稍后...",request:B(),data:{ip:[Array,Y]}})},ma=g({otherDay:[{validator:(a,e,t)=>{"other"===Q.value.day&&(e<1||!Number.isInteger(parseFloat(e)))?t(new Error("天数必须大于0的整数")):t()},trigger:["change"]}],userList:[{validator:(a,e,t)=>{"other"===Q.value.user&&0===e.length?t("请选择指定用户"):t()},trigger:["change"]}],risk:[{validator:(a,e,t)=>{Q.value.login_error||Q.value.time||Q.value.area||Q.value.anonymous||Q.value.upload_shell?t():t("请至少选择一个安全风险")},trigger:["change"]}],channel:[{type:"array",required:!0,message:"请至少选择一个告警方式",trigger:"change"}]}),pa=a=>{const{country:e,city:t}=a,s=r(e)?e.join(","):"",l=r(t)?t.join(","):"";return"非".concat(s).concat(s&&l?",":"").concat(l,"地区")},_a=async()=>{ea.value=!0;try{const{data:a}=await J(),{area:e,cron_task_status:t,time:s,login_error:l,upload_shell:i,cron_task:n}=a;if(Q.value.config={...a,login_error_des:"超过".concat(l,"次"),time_des:"".concat(s.start_time,"点至").concat(s.end_time,"点范围外"),area_des:pa(e),upload_shell_des:r(i)?i.join(","):""},Z.value&&t){const{task_type:a,cycle:e,channel:s}=n;Object.assign(Q.value,{anonymous:a.anonymous,area:a.area,login_error:a.login_error,time:a.time,upload_shell:a.upload_shell,cycle:e,channel:s?s.split(","):[],status:!!t})}else Object.assign(Q.value,{anonymous:!0,area:!0,login_error:!0,time:!0,upload_shell:!0})}catch(a){n(a)}finally{ea.value=!1}},ga=()=>{e({title:"扫描触发条件",area:[50,34],btn:["保存","取消"],component:()=>t(()=>import("./scan.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},ya=a=>{Q.value.user=a,"other"===a&&(Q.value.anonymous=!1)},va=async a=>{let e;await X.value.validate();try{e=i.load("扫描中...");const t=((a=Q.value,e=Z.value)=>{let t={};const s=JSON.stringify({anonymous:a.anonymous,area:a.area,login_error:a.login_error,time:a.time,upload_shell:a.upload_shell});return t=e?{task_type:s,cycle:1,channel:a.channel.join(","),status:a.status?1:0}:{search:s,day:"other"===a.day?Number(a.otherDay):a.day,username:"all"===a.user?"[]":JSON.stringify(a.userList)},t})();if(Q.value.search=(null==t?void 0:t.search)||(null==t?void 0:t.task_type),Z.value){const e=await C(t);i.request(e),e.status&&_a(),a()}else{const e=await A(t);if(i.request({status:e.status,msg:e.status?"扫描成功":"扫描失败",time:500}),e.status){K.value.data=[];for(const a in e.data){const t=e.data[a];K.value.data.push({time:t.exec_time,type:t.type,user:t.user,ip:a,id:t.id}),K.value.data.sort((a,e)=>{var t,s;return new Date(null==(t=e.time)?void 0:t.replace(/-/g,"/")).getTime()-new Date(null==(s=a.time)?void 0:s.replace(/-/g,"/")).getTime()})}K.value.btn="重新扫描",K.value.scanStatus=!0,a()}}}catch(t){n(t)}finally{null==e||e.close()}},ha=()=>{Q.value.config={login_error:5,time:{start_time:0,end_time:24},area:{country:[],city:[]},upload_shell:[],login_error_des:"超过5次",time_des:"0点至24点范围外",area_des:"非地区",upload_shell_des:"未配置"},(async()=>{try{const{data:a}=await R();r(a)&&(aa.value=[],a.forEach(a=>{aa.value.push({label:a,value:a})}),Q.value.userList=a.length>0?[a[0]]:[])}catch(a){}})(),_a()},fa=()=>{const a=Q.value.config;Object.assign(Q.value.config,{...a,start_time:a.time.start_time<10?"0".concat(a.time.start_time,":00"):"".concat(a.time.start_time,":00"),end_time:a.time.end_time<10?"0".concat(a.time.end_time,":00"):"".concat(a.time.end_time,":00"),upload_shell_br:a.upload_shell.join("\n")}),ta.value=["美国","中国","印度","日本","德国","英国","法国","俄罗斯","巴西","加拿大","意大利","澳大利亚","韩国","墨西哥","印度尼西亚","沙特阿拉伯","南非","阿根廷","土耳其","西班牙"].map(a=>({label:a,value:a}))},ba=[{label:"类型",prop:"type",minWidth:100},{label:"用户名",prop:"user",minWidth:60},{label:"IP",prop:"ip"},{label:"操作时间",prop:"time"},z([{onClick:async({ip:a})=>{await l({icon:"warning-filled",title:"IP封禁",content:"封禁【"+a+"】后，将不再允许此IP访问服务器，是否继续操作？"});const e=JSON.stringify({choose:"address",address:a,domain:"",types:"drop",brief:"FTP日志分析点击IP拉黑"});(await s({loading:"正在封禁IP，请稍后...",request:L({data:e}),data:{status:Boolean},message:!0})).status&&sa()},title:"IP拉黑",width:50},{onClick:async({user:a,id:e})=>{if(0===e)return i.error("匿名用户不可删除"),!1;await l({icon:"warning-filled",title:"删除FTP用户",content:"删除选中的FTP用户后，该FTP用户将彻底失去访问和操作权限，是否继续操作？"});(await s({loading:"正在删除FTP用户，请稍后...",request:D({id:e,username:a}),data:{status:Boolean},message:!0})).status&&(sa(),W.value=!0)},title:"删除账号",width:60},{onClick:async({user:a,id:e})=>{if(0===e)return i.error("匿名用户不可停用");await l({icon:"warning-filled",title:"停用FTP用户",content:"停用【"+a+"】后，该FTP用户将失去访问权限，是否继续操作？"});const t=await s({loading:"正在停用FTP用户，请稍后...",request:N({id:e,username:a,status:0}),data:{status:Boolean},message:!0});(null==t?void 0:t.status)&&(sa(),W.value=!0)},title:"停用账号",width:60},{onClick:async({ip:a})=>{await l({icon:"warning-filled",title:"忽略IP",content:"忽略【"+a+"】后，该IP将加入白名单中，FTP日志分析将不在记录该IP的数据，是否继续操作？"});(await s({loading:"正在忽略IP，请稍后...",request:q({ip:a,type:"add"}),data:{status:Boolean},message:!0})).status&&sa()},title:"忽略"}])],wa=()=>e({title:"FTP日志白名单",area:[70,45],component:()=>t(()=>import("./whitelist.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)}),Pa=a=>{e({title:"FTP日志".concat(a?"分析条件":"自动分析推送"),area:a?[66,30]:[70],btn:a?"立即扫描":"保存配置",component:()=>t(()=>import("./timed-scan.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},Ta=async a=>{if(Z.value=!Boolean(a),"ltd"===M.value.authType){const{status:e,msg:t}=await s({loading:"正在获取日志服务状态，请稍后...",request:j({exec_name:"getlog"}),data:{status:Boolean,msg:String}});if(!e||"stop"===t){await l({icon:"warning-filled",title:"开启FTP日志服务",content:"FTP日志服务未启动，无法记录访问日志，是否启动日志服务?"});const e=await s({loading:"正在开启FTP日志服务，请稍后...",request:j({exec_name:"start"}),data:{status:Boolean},message:!0});(null==e?void 0:e.status)&&Pa(a)}Pa(a)}else i.error("企业版专享功能！"),await H({sourceId:O.value?260:220})},Sa=[{icon:"user",title:"多次登录失败"},{icon:"login-address",title:"登录地区异常"},{icon:"shell-file",title:"上传脚本文件"},{icon:"anonymous",title:"匿名用户登录"},{icon:"login-time",title:"登录时间异常"}],Fa=[{label:"7天",value:7},{label:"30天",value:30},{label:"自定义",value:"other"}],Ia=[{label:"全部",value:"all"},{label:"指定用户",value:"other"}],ka={class:"ftp-log-scan"},xa={class:"scan-header"},ja={class:"scan-header-left"},Oa={class:"scan-header-title"},La={key:0},Da={key:1},Na={class:"scan-content"},qa={key:0,class:"scan-content-preview"},Aa={class:"scan-content-preview-list"},Ba={class:"text-small"},Ca={key:1},Ea=u(y({__name:"index",setup(a,{expose:e}){const{ftpAnalysisList:t,ftpScanTable:s}=G();return e(la),(a,e)=>{const l=k,i=o;return v(),h("div",ka,[f("div",xa,[f("div",ja,[e[4]||(e[4]=f("i",{class:"svgtofont-icon-ftp-log !text-large54 text-tertiary mr-16px"},null,-1)),f("div",Oa,[b(t).scanStatus?(v(),h("div",Da,"扫描完成，"+w(b(t).data.length?"共扫描出"+b(t).data.length+"条风险记录":"未扫描出风险记录"),1)):(v(),h("div",La,"FTP日志扫描，快速扫描当前FTP的安全详情")),f("p",null,[e[2]||(e[2]=P(" 推荐定期自动扫描功能，定期扫描生成分析结果并发送通知【 ",-1)),f("span",{class:"bt-link",onClick:e[0]||(e[0]=a=>b(Ta)(0))},w(b(t).autoScanText),1),e[3]||(e[3]=P(" 】 ",-1))])])]),_(l,{class:"scan-header-btn",type:"primary",title:b(t).btn,onClick:e[1]||(e[1]=a=>b(Ta)(1))},{default:T(()=>[P(w(b(t).btn),1)]),_:1},8,["title"])]),f("div",Na,[b(t).scanStatus?(v(),h("div",Ca,[_(l,{class:"!mb-[1rem]",onClick:b(wa)},{default:T(()=>[...e[6]||(e[6]=[P(" 白名单 ",-1)])]),_:1},8,["onClick"]),_(i,{ref_key:"ftpScanTable",ref:s,"max-height":"310",column:b(ba),data:b(t).data,description:"扫描列表为空"},null,8,["column","data"])])):(v(),h("div",qa,[e[5]||(e[5]=f("div",null,"支持以下FTP日志安全风险扫描：",-1)),f("div",Aa,[(v(!0),h(S,null,F(b(Sa),(a,e)=>(v(),h("div",{class:"preview-list-item",key:e},[f("i",{class:I("svgtofont-icon-".concat(a.icon," text-extraLarge mr-4px text-tertiary"))},null,2),f("span",Ba,w(a.title),1)]))),128))])]))])])}}}),[["__scopeId","data-v-f6e94919"]]),Ja=Object.freeze(Object.defineProperty({__proto__:null,default:Ea},Symbol.toStringTag,{value:"Module"}));export{ca as a,ha as b,va as c,ga as d,ra as e,Fa as f,da as g,Ia as h,fa as i,ya as j,Ja as k,oa as o,ia as r,na as s,ma as t,G as u,ua as w};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
