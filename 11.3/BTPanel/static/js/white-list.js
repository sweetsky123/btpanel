import{V as e,aK as a,p as t,Q as l,aA as n,aC as s,k as i,l as o,ah as c,$ as r,b as u,_ as d}from"./utils-lib.js?v=1763689792";import{_ as p}from"./index109.js?v=1763689792";import{_ as m}from"./index130.js?v=1763689792";import{c as w,r as v,o as h,g as f,e as _,D as y,F as b,v as g,I as j,J as x,z as V,x as C,y as k,O as H,G as M,R as q,C as D,A as R,ap as z,n as E,H as I}from"./base-lib.js?v=1763689792";import{a as O,g as U,u as A,c as P}from"./column.js?v=1763689792";import{getTamperRuleByPath as F,addWhiteDirs as G,addWhiteFiles as J,releaseWhiteDirname as K,releaseWhiteFileExt as Q,getActionLogsForDirname as S,getActionLogsForFilename as T,setWhiteDirWithPs as W,removeWhiteDirs as $,removeWhiteFiles as B}from"./site.js?v=1763689792";import{v as L}from"./useController6.js?v=1763689792";import{u as N}from"./useStore4.js?v=1763689792";import{_ as X}from"./masker.vue_vue_type_script_setup_true_lang.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./validator.js?v=1763689792";import"./index107.js?v=1763689792";import"./index137.js?v=1763689792";import"./index.vue_vue_type_style_index_0_scoped_cdc7f4d3_lang.js?v=1763689792";const Y={class:"flex gap-col-1rem"},Z=d(w({__name:"white-list",props:{compData:{default:{}}},setup(d,{expose:w}){const{siteInfo:Z}=N(),ee=u(),ae=v("dir"),te=v(),le=v(!1),ne=v(""),se=v(!1),ie=v({}),oe=v([]);v(!1),v(!1),v(),v(!1),h({sites:[],list:[]}),h({isRecurrence:!1,describe:{title:"",th:"",message:"",propsValue:""}});const ce=f(()=>"dir"===ae.value?[{content:_(b,null,[y("此处允许使用全路径或目录名或路径的一部分如："),_("code",null,[y("/www/abc/cache/test/,test,cache/test/")])])},{content:_(b,null,[y("全路径首位必需为"),_("code",null,[y("/")]),y("，如："),_("code",null,[y("/www/abc/cache/test/")])])},{content:_(b,null,[y("录名或路径的一部分首位不能是"),_("code",null,[y("/")]),y("，如："),_("code",null,[y("cache/test/")]),y("或"),_("code",null,[y("test")])])},{content:_(b,null,[y("例1："),_("code",null,[y("/www/abc/")]),y("匹配:"),_("code",null,[y("/www/abc/*")]),y("不匹配："),_("code",null,[y("/www/abc")]),_("code",null,[y("/www/abc123")])])},{content:_(b,null,[y("例2："),_("code",null,[y("test")]),y("匹配："),_("code",null,[y("/www/test/1.txt")]),_("code",null,[y("/www/test_abc")]),y("不匹配："),_("code",null,[y("/www/1.php")])])},{content:_(b,null,[y("例3："),_("code",null,[y("cache/test/")]),y("匹配："),_("code",null,[y("/www/cache/test/1.txt")]),_("code",null,[y("/cache/test/")]),y("不匹配："),_("code",null,[y("/www/cache/test")]),_("code",null,[y("/cache/")])])}]:[{content:"支持以下5种方式"},{content:_(b,null,[y("1、完整文件路径，如："),_("code",null,[y("/www/wwwroot/test/123.php")])])},{content:_(b,null,[y("2、相对于网站的相对路径，如：全路径是"),_("code",null,[y("/www/wwwroot/test/app/123.php")]),y("相对路径"),_("code",null,[y("./app/123.php")])])},{content:_(b,null,[y("3、指定目录下的所有文件，如："),_("code",null,[y("/www/wwwroot/test/app/*")]),y("相对路径"),_("code",null,[y("./app/*")])])},{content:_(b,null,[y("4、指定目录下的指定文件类型，如："),_("code",null,[y("/www/wwwroot/test/app/*.php")]),y("相对路径"),_("code",null,[y("./app/*.php")])])},{content:_("span",{class:"text-danger"},[y("注意，已经在【受保护的文件类型】中被包含的文件无需专门设置规则")])}]),re=async(e,a,t,l)=>{const n="dir"===ae.value,s=n?"目录":"文件",{label:i,value:o}=l,c=new Map([["start","批量开启选中的".concat(s,"白名单")],["stop","批量关闭选中的".concat(s,"白名单")],["delete","批量删除选中的".concat(s,"白名单")]]),r=async(e,a)=>{const t=new Map([["start",n?K:Q],["stop",n?K:Q],["delete",n?$:B]]).get(o);let l={path_id:ie.value.pid,[n?"dirname":"filename"]:e[n?"dir":"filename"]};switch(o){case"start":case"stop":return l.release="start"===o?1:0,t(l);case"delete":return l.path=ie.value.path,t(l)}};await e({title:"批量".concat(i),content:"".concat(c.get(o),"，是否继续操作？"),column:[{prop:"".concat(n?"dir":"filename"),label:"".concat(n?"文件全路径 或 相对路径":"文件类型")},P()],onConfirm:async()=>(await a(r),me(),!1)})},ue=()=>v([{label:"开启".concat("dir"==ae.value?"目录":"文件","白名单"),value:"start",event:re},{label:"关闭".concat("dir"==ae.value?"目录":"文件","白名单"),value:"stop",event:re},{label:"删除".concat("dir"==ae.value?"目录":"文件","白名单"),value:"delete",event:re}]),de=()=>v([O({key:"dir"}),{label:"dir"==ae.value?"目录":"文件名",prop:"dir"==ae.value?"dir":"filename"},"dir"==ae.value?U({minWidth:150,width:300,request:_e}):{label:"备注",prop:"ps"},{label:"状态",prop:"limit_status",width:50,render:e=>{let a=1===e.limit_status;return _(z,{size:"small",modelValue:a,"onUpdate:modelValue":e=>a=e,onChange:a=>ve(e,a)},null)}},A([{title:"日志",onClick:fe},{title:"删除",onClick:he}])]),pe=v([{label:"目录白名单",name:"dir",lazy:!0,render:()=>_("span",null,null)},{label:"文件白名单",name:"file",lazy:!0,render:()=>_("span",null,null)}]),me=async(t=!1)=>{var l,n;try{t&&(le.value=!0);const{data:a}=await F({path:Z.value.path});let s=[];if(a.hasOwnProperty("status"))if(ie.value=a,"dir"==ae.value)null==(l=null==a?void 0:a.unused_white_dirs)||l.forEach(e=>{s.push({...e,ps:e.ps||"",limit_status:0})}),null==(n=null==a?void 0:a.white_dirs)||n.forEach(t=>{var l;let n={...t,ps:t.ps||"",limit_status:1},i=null==(l=null==a?void 0:a.temporarily_dirs)?void 0:l.find(e=>e.value===t.dir);i&&(n.time=i.time,n.ps="临时放行截止至"+e(i.time,"yyyy-MM-dd HH:mm:ss")),s.push(n)});else{let t=a.white_files;a.unused_white_files.forEach(e=>{s.push({filename:e,limit_status:0,ps:"-"})}),t.forEach(t=>{var l;let n={filename:t,limit_status:1,ps:"-"},i=null==(l=null==a?void 0:a.temporarily_files)?void 0:l.find(e=>e.value===t);i&&(n.time=i.time,n.ps="临时放行截止至"+e(i.time,"yyyy-MM-dd HH:mm:ss")),s.push(n)})}oe.value=s}catch(s){a(s)}finally{t&&(le.value=!1)}},we=async()=>{if(""===ne.value)return ee.error("文件类型不能为空");try{const e="dir"==ae.value?await G({path_id:ie.value.pid,path:ie.value.path,dirnames:ne.value}):await J({path_id:ie.value.pid,path:ie.value.path,filename:ne.value});ee.request(e),e.status&&(ne.value="",me())}catch(e){}},ve=async(e,a)=>{const n="dir"==ae.value;try{if(e.hasOwnProperty("time"))return void E(()=>{e.limit_status=!a,ee.error("临时放行文件无法修改状态")});e.limit_status=a?1:0,await t({title:"".concat(a?"开启":"关闭","【").concat(n?e.dir:e.filename,"】"),content:"".concat(a?"开启该文件白名单后，该文件将不被保护，是否继续？":"关闭该文件白名单后，该文件将被保护，是否继续？")});const s={path_id:ie.value.pid,[n?"dirname":"filename"]:e[n?"dir":"filename"],release:a?1:0},i=n?K:Q;(await l({loading:"正在设置白名单状态，请稍后...",request:i(s),message:!0})).status&&me()}catch(s){"cancel"===s&&(e.limit_status=a?0:1)}},he=async e=>{let a="dir"===ae.value,n=a?"目录":"文件";await t({title:"删除【".concat(a?e.dir:e.filename,"】"),content:"删除该".concat(n,"白名单后，该").concat(n,"将受到保护，是否继续操作？")});const s={path_id:ie.value.pid,path:ie.value.path,[a?"dirname":"filename"]:e[a?"dir":"filename"]},i=a?$:B;(await l({loading:"正在删除".concat(n,"白名单，请稍后..."),request:i(s),message:!0})).status&&me()},fe=async e=>{var t;const l="dir"===ae.value;try{const a={path_id:ie.value.pid,[l?"dirname":"filename"]:e[l?"dir":"filename"],row:10,pid:ie.value.pid,p:1},s=l?S:T,{data:i}=await s(a);(null==(t=i.data)?void 0:t.length)?L({title:"".concat("dir"===ae.value?"目录【".concat(e.dir,"】"):"文件【".concat(e.filename,"】"),"白名单日志"),row:e,data:i,params:{...a,total:n(i.page)}}):ee.error("暂无日志")}catch(s){a(s)}},_e=async(e,a)=>{l({loading:"正在修改备注信息，请稍后...",request:W({path_id:ie.value.pid,dir_name:e.dir,ps:a}),message:!0})},ye=de(),be=ue(),ge=e=>{ne.value="",ae.value=e,ye.value=de().value,be.value=ue().value,oe.value=[],me()};return g(()=>{me(!0)}),w({init:()=>{me(!0)}}),(e,a)=>{var t;const l=s,n=i,u=I,w=m,v=o,h=c,f=p,b=r,g=j("bt-loading");return x((C(),k("div",null,[(null==(t=V(ie))?void 0:t.path)?M("",!0):(C(),H(X,{key:0,compData:{...d.compData,init:me}},null,8,["compData"])),_(l,{ref:"tamperRef",type:"",modelValue:V(ae),"onUpdate:modelValue":a[0]||(a[0]=e=>q(ae)?ae.value=e:null),options:V(pe),onChange:ge},null,8,["modelValue","options"]),_(f,null,{"header-left":D(()=>[R("div",Y,[_(n,{modelValue:V(ne),"onUpdate:modelValue":a[1]||(a[1]=e=>q(ne)?ne.value=e:null),width:"30rem",placeholder:"".concat("dir"===V(ae)?"目录名":"文件名")},null,8,["modelValue","placeholder"]),_(u,{type:"primary",onClick:we},{default:D(()=>[...a[2]||(a[2]=[y("添加",-1)])]),_:1})])]),"header-right":D(()=>[_(w,{onRefresh:me})]),content:D(()=>[x(_(v,{ref_key:"whiteTableRef",ref:te,column:V(ye),maxHeight:350,data:V(oe)},null,8,["column","data"]),[[g,V(se)]])]),"footer-left":D(()=>[_(h,{"table-ref":V(te),options:V(be)},null,8,["table-ref","options"])]),"footer-right":D(()=>[...a[3]||(a[3]=[])]),_:1}),_(b,{options:V(ce),class:"ml-2rem mt-2rem tamper-help-info leading-2rem"},null,8,["options"])])),[[g,V(le)],[g,"正在获取站点防篡改信息，请稍侯","title"]])}}}),[["__scopeId","data-v-77447fa2"]]);export{Z as default};
