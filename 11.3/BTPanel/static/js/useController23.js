import{u as t,M as a,p as e,n as s,H as o,Q as n,aK as i,aH as p}from"./utils-lib.js?v=1763689792";import{s as r,r as l,o as c}from"./base-lib.js?v=1763689792";import{k as u,p as d}from"./validator.js?v=1763689792";import{modifyProjectAsync as h,setSitePhpVersion as m,setSessionStatus as v,setProtectStatus as y,getPhpSiteSafeLog as f,setPhpVersionSafe as w,getSessionStatus as g,getProjectRunState as _,getSitePhpVersion as P,getPhpVersion as T,getProtectStatus as I,getPhpVersionSafe as j,getPhpSiteSafe as x}from"./site.js?v=1763689792";import{u as H,S as V}from"./useStore4.js?v=1763689792";import{u as b}from"./useController5.js?v=1763689792";import{u as S}from"./useController22.js?v=1763689792";const{payment:k}=t(),{authType:q}=k.value,{siteInfo:C,isRefreshList:L}=H(),{setSiteInfo:A}=V(),{isRefreshLocalList:N}=r(b()),O=l(null),R=c({phpVersion:"",other:"",options:[],helpIndex:0,toggleShow:!1,noInstall:!1}),D=l(""),E=c({status:!1}),M=c({status:!1,version:"",deCompatible:!1,today:0,total:0,tips:!0,tipsIndex:0,safeTip:{show:!1,alarmTip:!1,safeTip:!1,allTip:!1}}),U=c({list:[],path:""}),B=l(!1),K=[[{content:"请根据您的程序需求选择版本"}],[{content:"请根据您的程序需求选择版本"},{content:"【自定义】可自定义PHP连接信息，选择此项需填写可用的PHP连接配置"},{content:"【自定义】当前仅支持nginx，可配合[宝塔负载均衡 - 重构版]插件的TCP负载功能实现PHP负载集群"},{content:"【PHP连接配置】支持TCP或Unix配置，示例：192.168.1.25:9001 或 unix:/tmp/php8.sock"}],[{content:"请根据您的程序需求选择版本"},{content:"PHP7不支持mysql扩展，默认安装mysqli以及mysql-pdo。"}],[{content:"请根据您的程序需求选择版本"},{content:"若非必要,请尽量不要使用PHP5.2,这会降低您的服务器安全性；"}]],Q=[{content:"开启后将会把session文件存放到独立文件夹，不与其他站点公用存储位置"},{content:"若您在PHP配置中将session保存到memcache/redis等缓存器时，请不要开启此选项"}],$=[{content:"基于PHP内核的监控工具，实时监控网站木马、漏洞等其他入侵行为，发现木马支持自动隔离"},{content:"安全告警默认会监视当前网站访问非当前网站文件的行为(例：你的站点A.com访问了站点B.com的文件或者目录)，通过添加监视器路径，当路径被访问时发送告警/redis等缓存器时，请不要开启此选项"}],z=t=>{R.phpVersion=t,R.toggleShow=t!==M.version,R.noInstall=R.options.some(a=>a.key===t&&(null==a?void 0:a.noInstall)),F(t)},F=t=>{switch(t){case"other":R.helpIndex=1;break;case"52":R.helpIndex=3;break;default:"7"===t[0]?R.helpIndex=2:R.helpIndex=0}},G=async()=>{try{const{data:t}=await _({sitename:C.value.name});t.data.is_power_on=1===t.data.is_power_on,A(t.data)}catch(t){}},J=t=>{R.other=t,t!==D.value?R.toggleShow=!0:R.toggleShow=!1},W=async()=>{var t;if("phpasync"===(null==(t=C.value)?void 0:t.project_type)){let t=a.load("正在保存，请稍后..."),e={sitename:C.value.name,...C.value,is_power_on:C.value.is_power_on?1:0,...C.value.project_config,php_version:R.phpVersion};delete e.status,delete e.ps,delete e.project_config;const s=await h(e);return t.close(),a.request(s),void(s.status&&(G(),L.value=!0,R.toggleShow=!1))}if("other"===R.phpVersion&&""===R.other)return a.error("自定义PHP版本时，PHP连接配置不能为空"),void O.value.$refs.inputRef.focus();const e=await m({siteName:C.value.name,version:R.phpVersion,other:R.other});e.status?(a.request(e),L.value=!0,N.value=!0,R.toggleShow=!1):a.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:e.msg||e,type:"error",duration:0,showClose:!0}),e.status&&(ct(),S())},X=async t=>{const e=t?1:0,s=await v({id:C.value.id,act:e});a.request(s),ot()},Y=async t=>{M.tips=!0,M.version=t;if(M.tips=["52","00","82"].includes(t),M.tips)return void(M.tipsIndex=0);const{data:a}=await p({sName:"security_notice"});M.tips=!0,!(null==a?void 0:a.setup)&&a.endtime>=0?M.tipsIndex=1:a.endtime<0?M.tipsIndex=2:(M.tips=!1,await nt())},Z=async t=>{try{if(M.safeTip.safeTip)return M.status=!M.status,void a.error("请先开启PHP-".concat(M.version,"防护"));if(M.deCompatible)return M.status=!M.status,a.error("当前版本不兼容安全防护功能");await e({title:"".concat(t?"开启":"关闭","站点安全告警"),width:"35rem",icon:"warning-filled",content:t?"开启后，检测到安全问题时将会发送告警通知，是否继续？":"关闭后，该网站将不再接收安全告警，是否继续？"});const s=await y({siteName:C.value.name},t);s.status?a.request(s):(M.status=!M.status,a.error("当前PHP版本未开启防护，无法设置该站点！"))}catch(s){M.status=!M.status}},tt=()=>{s({area:93,isAsync:!0,title:"【".concat(C.value.name,"】监视器"),component:()=>o(()=>import("./index518.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{data:U.list,name:C.value.name,path:U.path}})},at=async()=>{const t=await f({siteName:C.value.name,page:1,limit:10});t.status?0!=t.data.data.length?s({area:93,isAsync:!0,title:"【".concat(C.value.name,"】网站安全日志"),component:()=>o(()=>import("./index519.js?v=1763689792").then(t=>t.f),__vite__mapDeps([]),import.meta.url),compData:{data:t.data.data,page:t.data.page}}):a.error("暂无日志"):a.error(t.msg)},et=async()=>{},st=async()=>{await e({title:"开启【PHP-".concat(M.version,"】防护"),width:"35rem",icon:"warning-filled",content:"开启后，该版本下的所有站点将受到安全防护，是否继续？"}),await n({loading:"正在开启防护，请稍后...",request:w({php_version:M.version,enable:1}),message:!0}),ct()},ot=async()=>{try{const t=await g({id:C.value.id});t.status&&(E.status=t.data)}catch(t){i(t)}},nt=async()=>{var t,e,s,o;try{const n=await I();if((null==(t=n.data.msg)?void 0:t.includes("插件不存在"))||(null==(e=n.data.msg)?void 0:e.includes("未购买"))||(null==(s=n.data.msg)?void 0:s.includes("已到期")))return M.tips=!0,M.tipsIndex=1,"ltd"!==q&&(M.tipsIndex=2),a.error(n.data.msg),!1;const i=n.data.send,p=await j();!1===p.status&&a.error(p.msg);const r=p.data.php_versions.filter(t=>t.v===M.version)||[],l=r.length>0&&1!==(null==(o=null==r?void 0:r.at(0))?void 0:o.state);!l&&i||(!i&&(M.safeTip.alarmTip=!0),l&&!i&&(M.safeTip.allTip=!0),l&&(M.safeTip.safeTip=!0),M.safeTip.show=!0),l||(M.safeTip.safeTip=!1,M.safeTip.allTip=!1),i&&(M.safeTip.alarmTip=!1,M.safeTip.allTip=!1),!l&&i&&(M.safeTip.show=!1);const c=await x();c.status||a.error(c.msg);const u=c.data.sites.find(t=>t.path===C.value.path&&t.site_name===C.value.name);u&&(M.today=u.total.day_total||0,M.total=u.total.total||0,M.status=u.open,M.deCompatible=-1!=u.version.indexOf("暂不兼容"),it(u.config.file_info),U.path=u.path)}catch(n){i(n)}},it=t=>{const a=[];for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&a.push({...t[e],path:e});U.list=a},pt=async t=>{try{const a=(t||R.phpVersion).split(""),e="php-".concat(a[0],".").concat(a[1]);u({type:"i",name:e})}catch(a){}},rt=async()=>{try{await u({type:"i",name:"security_notice"})}catch(t){}},lt=()=>{d({sourceId:114})},ct=async()=>{var t;B.value=!0;try{"phpasync"===(null==(t=C.value)?void 0:t.project_type)&&await G(),await(async()=>{var t;if("phpasync"===(null==(t=C.value)?void 0:t.project_type))R.phpVersion=C.value.php_version.replace(".",""),Y(R.phpVersion);else{const t=await P({siteName:C.value.name});t.status&&(R.phpVersion=t.data.phpversion,"other"==R.phpVersion&&(D.value=t.data.php_other,R.other=t.data.php_other),Y(t.data.phpversion))}})(),await(async()=>{var t,a,e;let s={s_type:1,all:1};"phpasync"===(null==(t=C.value)?void 0:t.project_type)&&delete s.s_type;const o=await T(s);if(o.status&&o.data.length>0){const t="phpasync"===(null==(a=C.value)?void 0:a.project_type)?null==(e=o.data)?void 0:e.filter(t=>"纯静态"!==t.name):o.data;R.options=t.map(t=>({title:t.name+(t.status?"":" (未安装)"),label:t.name,key:t.version,status:t.status}));const s=R.options.find(t=>t.key===R.phpVersion);R.toggleShow=!1,R.noInstall=!s.status,s||(R.options.push({title:"PHP-".concat(R.phpVersion,"(未安装)"),key:R.phpVersion,noInstall:!0}),R.noInstall=!0)}})(),await ot()}catch(a){}finally{B.value=!1}};export{R as a,pt as b,E as c,X as d,z as e,Q as f,M as g,J as h,ct as i,Z as j,et as k,$ as l,tt as m,rt as n,st as o,K as p,lt as q,U as r,W as s,at as t,B as v};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
