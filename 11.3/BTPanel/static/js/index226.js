import{c as a,aB as e,r as s,W as t,g as l,o,w as r,x as u,y as n,e as i,C as p,D as c,z as d,A as m,B as f,F as v,O as h,J as w,K as g,H as _,b4 as b,ax as z,b6 as y,ay as x,az as k}from"./base-lib.js?v=1763689792";import{u as j,x as q,a1 as C,b as D}from"./utils-lib.js?v=1763689792";import{u as O}from"./useStore2.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";const E={class:"p-[2rem]"},S={class:"h-[40rem] border border-base mt-[1rem]"},B={class:"ml-[0.5rem]"},F=a({__name:"index",props:{compData:{default:()=>({path:"",refreshEvent:()=>{}})}},setup(a,{expose:F}){const H=D(),{panel:I}=j();O();const M=a,P=e("popupSetFooter"),A=e("buttonText");let J=!0;const K=s(),T=s([]),W=t([".sql",".zip",".bak",".gz"].join(",")),G={"x-http-token":window.vite_public_request_token},L=window.location.protocol+"//"+window.location.host+"/files?action=upload",N=l(()=>{var a;return M.compData.path?M.compData.path:null==(a=I.value.backupPath+"/database")?void 0:a.replace(/\/\//g,"/")}),Q=o({f_size:0,f_path:N.value,f_name:"",f_start:0}),R=()=>{H.success("上传成功"),M.compData.refreshEvent()},U=(a,e,s)=>{s.push(e),H.error("上传失败")},V=a=>{Q.f_size=a.size,Q.f_name=a.name,Q.f_start=0},X=(a,e)=>{const s=a.name.substring(a.name.lastIndexOf(".")+1),t=["sql","zip","bak","gz"];if(-1===t.indexOf(s))return!1;T.value=e.filter(a=>{let e=a.name.substring(a.name.lastIndexOf(".")+1);return-1!==t.indexOf(e)})||[]},Y=(a,e,s)=>{Q.f_start=a.percent,T.value=s.map(s=>(s.uid===e.uid&&(s.percentage=a.percent),s))},Z=async a=>{for(const[e,s]of a)await s();R()};return r(()=>T.value.length,a=>{if(0===a)return void P(!1);const e=["success","fail","ready"];for(let s=0;s<T.value.length;s++)if(!e.includes(T.value[s].status))return void P(!1);T.value.some(a=>"success"!==a.status)&&(A.value=J?"开始上传":"重新上传",P(!0))}),F({onConfirm:()=>{T.value.map(a=>{"success"!==a.status&&(a.status="ready")}),J=!1;const a=new Map;T.value.forEach(e=>{a.set(e.uid,async()=>await C(e.raw,{path:N.value,name:e.name,useChunked:e.size>10485760,onProgress:a=>{T.value=T.value.map(s=>(s.uid===e.uid&&(s.percentage=a,s.status="uploading"),s))},onSuccess:()=>{T.value=T.value.map(a=>(a.uid===e.uid&&(a.status="success"),a))},onError:a=>{T.value=T.value.map(a=>(a.uid===e.uid&&(a.status="fail"),a)),H.error("文件上传失败")}}))}),Z(a),P(!1)}}),(a,e)=>{const s=_,t=b,l=z,o=y,r=x,j=k;return u(),n("div",E,[i(t,{class:"upload-demo",ref_key:"upload",ref:K,name:"blob",data:d(Q),action:L,headers:G,accept:d(W),multiple:!0,"show-file-list":!1,"auto-upload":!1,"file-list":d(T),"on-error":U,"on-success":R,"on-progress":Y,"on-change":X,"before-upload":V},{default:p(()=>[i(s,{type:"primary"},{default:p(()=>[...e[0]||(e[0]=[c("上传",-1)])]),_:1})]),_:1},8,["data","accept","file-list"]),m("div",S,[i(j,{height:"400",data:d(T)},{empty:p(()=>[i(r,{description:"只支持'.sql', '.zip', '.bak', '.gz'文件格式导入"})]),default:p(()=>[i(l,{prop:"name","show-overflow-tooltip":!0,label:"名称"},{default:p(a=>[e[1]||(e[1]=m("i",{class:"svgtofont-el-document text-supplement"},null,-1)),m("span",B,f(a.row.name),1)]),_:1}),i(l,{prop:"name",label:"是否成功",width:"300"},{default:p(a=>["success"===a.row.status?(u(),n(v,{key:0},[c("上传成功！")],64)):"fail"===a.row.status?(u(),n(v,{key:1},[c("上传失败!")],64)):"ready"===a.row.status?(u(),n(v,{key:2},[c("等待上传")],64)):(u(),h(o,{key:3,percentage:Math.floor(a.row.percentage)},null,8,["percentage"]))]),_:1}),i(l,{width:"120",prop:"size",label:"大小"},{default:p(a=>[c(f(d(q)(a.row.size)),1)]),_:1}),i(l,{prop:"name",width:"180",align:"right","show-overflow-tooltip":!0,label:"操作"},{default:p(a=>[w(i(s,{type:"text",size:"small",onClick:e=>{return s=a.row,void(T.value=T.value.filter(a=>a.name!==s.name));var s}},{default:p(()=>[...e[2]||(e[2]=[c("删除",-1)])]),_:1},8,["onClick"]),[[g,"ready"===a.row.status||"fail"===a.row.status]])]),_:1})]),_:1},8,["data"])]),e[3]||(e[3]=m("ul",{class:"mt-8px leading-8 text-small list-disc ml-2rem"},[m("li",null,"仅支持sql、zip、sql.gz、(tar.gz|gz|tgz)")],-1))])}}});export{F as default};
