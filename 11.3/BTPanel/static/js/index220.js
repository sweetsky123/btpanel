import{_ as e}from"./index109.js?v=1763689792";import{M as a,Q as l,x as t,l as n,ah as o,j as s,aK as i}from"./utils-lib.js?v=1763689792";import{c as m,r,o as c,v as d,I as p,x as u,y as b,e as f,a1 as _,z as y,C as v,J as w,O as g,G as h,R as I,A as x,aZ as M,ad as q,ab as z}from"./base-lib.js?v=1763689792";import{_ as j}from"./index107.js?v=1763689792";import{exportTableStr as k,getTableInfo as S,getModulesTableInfo as D,conversionTable as O,optimizeTable as A,repairTable as R,modifyTableComment as C}from"./database.js?v=1763689792";import{g as V}from"./useStore2.js?v=1763689792";import{a as B,g as T,u as J,c as E}from"./column.js?v=1763689792";import{f as F}from"./validator.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";const N={class:"p-[16px]"},P={key:0,class:"mt-[8px] ml-[16px] leading-8 text-small list-disc"},U=m({__name:"index",props:{compData:{default:()=>({name:""})}},setup(m){const U=m,{refs:{tabActive:Z}}=V(),G=r(),H=r(!1),K=r("暂无数据"),Q=r([]),L=r(!1),W=r(),X=c({db_name:"",table_name:"",filename:""}),Y=c({filename:[{required:!0,message:"请输入导出文件路径",trigger:["blur","input"]}]}),$=async(e,a,l,t)=>{let n={Repair:["修复",""],Optimization:["优化","，将回收未释放的磁盘空间，"],InnoDB:["转换引擎","为【InnoDB】"],MyISAM:["转换引擎","为【MyISAM】"]};const{label:o,value:s}=t;await e({title:"批量".concat(o),content:"批量".concat(n[s][0],"已选数据库表").concat(n[s][1],"，是否继续？"),column:[{prop:"table_name",label:"表名"},E()],onConfirm:async()=>(await a(e=>ee(e,s)),se(),!1)})},ee=async(e,a)=>{const{table_name:l}=e;try{let e={db_name:U.compData.name,tables:JSON.stringify([l]),table_type:a};switch("Repair"!==a&&"Optimization"!==a||delete e.table_type,a){case"Repair":return await R(e);case"Optimization":return await A(e);case"InnoDB":case"MyISAM":return await O(e)}}catch(t){i(t,"tools-handleOperateRequest")}},ae=()=>{F({type:"dir",change:e=>{X.filename=e+"/"+X.db_name+"_"+X.table_name+".sql"}})},le=async(e,l)=>{const t=a.load("正在操作表【".concat(e.table_name,"】，请稍后...")),n=await ee(e,l);t.close(),a.request(n),se()},te=[B({key:"table_name"}),{label:"表名",prop:"table_name",showOverflowTooltip:!0},T({request:(e,a)=>(async(e,a)=>{await l({loading:"正在修改中，请稍后...",request:C({db_name:U.compData.name,table_name:e.table_name,comment:a}),message:!0}),se()})(e,a),prop:"comment"}),{label:"引擎",prop:"type",width:80},{label:"字符集",prop:"collation",showOverflowTooltip:!0},{label:"行数",align:"center",width:60,prop:"rows_count"},{label:"大小",prop:"data_size"},J([{onClick:e=>{X.db_name=U.compData.name,X.table_name=e.table_name,L.value=!0},title:"导出表结构",width:70},{onClick:e=>le(e,"Repair"),title:"修复"},{onClick:e=>le(e,"Optimization"),title:"优化"},{onClick:e=>le(e,"MyISAM"===e.type?"InnoDB":"MyISAM"),title:"转换引擎",width:70}])],ne=[{label:"集合名称",prop:"collection_name"},{label:"文档数量",prop:"count"},{label:"内存中的大小",render:e=>t(e.size)},{label:"对象平均大小",render:e=>t(e.avg_obj_size)},{label:"存储大小",render:e=>t(e.storage_size)},{label:"索引数量",prop:"nindexes"},{label:"索引大小",render:e=>t(e.total_index_size)}],oe=[{label:"修复",value:"Repair",event:$},{label:"优化",value:"Optimization",event:$},{label:"转为InnoDB",value:"InnoDB",event:$},{label:"转为MyISAM",value:"MyISAM",event:$}],se=async()=>{let e={db_name:U.compData.name};const{data:a}=await l({loading:H,request:"mysql"==Z.value?S(e):D({data:JSON.stringify(e)},Z.value)});"mysql"===Z.value?Q.value=a.tables:Q.value=a.data.collection_list,"mysql"==Z.value?K.value="数据库名称: ".concat(a.database," 大小: ").concat(a.data_size||0):K.value="数据库名称: ".concat(a.data.db,"\n\t\t\t 集合数量: ").concat(a.data.collections||0,"\n\t\t\t 存储大小: ").concat(t(a.data.totalSize)||0,"\n\t\t\t 索引大小: ").concat(t(a.data.indexSize)||0)};return d(()=>{se()}),(t,i)=>{const m=M,r=n,c=o,d=j,S=q,D=z,O=s,A=e,R=p("bt-loading"),C=p("trim");return u(),b("div",N,[f(A,null,_({"header-left":v(()=>[f(m,{class:"font-bold",title:y(K),type:"info",closable:!1},null,8,["title"])]),content:v(()=>["mysql"===y(Z)?w((u(),g(r,{key:0,"max-height":"300",ref_key:"mysqlToolsRef",ref:G,column:y(te),data:y(Q)},null,8,["column","data"])),[[R,y(H)],[R,"正在查询中，请稍后...","title"]]):h("",!0),"mysql"!==y(Z)?(u(),g(r,{key:1,"max-height":"300",ref:"modulesToolsRef",column:y(ne),data:y(Q)},null,8,["column","data"])):h("",!0)]),popup:v(()=>[f(O,{title:"导出表【".concat(y(X).table_name,"】结构"),modelValue:y(L),"onUpdate:modelValue":i[1]||(i[1]=e=>I(L)?L.value=e:null),area:[50],"show-footer":"",onConfirm:i[2]||(i[2]=e=>(async()=>{try{if(""===X.filename)return a.error("请填写导出文件路径"),!1;await l({loading:"正在导出中，请稍候...",request:k(X),message:!0,success:()=>{X.table_name="",X.filename="",W.value.clearValidate(),L.value=!1}})}catch(e){}})()),onCancel:i[3]||(i[3]=e=>(L.value=!1,W.value.resetFields(),void W.value.clearValidate()))},{default:v(()=>[f(D,{ref_key:"exportTableForm",ref:W,class:"px-2rem py-3rem",model:y(X),rules:y(Y)},{default:v(()=>[f(S,{label:"导出文件路径",prop:"filename"},{default:v(()=>[w(f(d,{icon:"icon-file_mode",modelValue:y(X).filename,"onUpdate:modelValue":i[0]||(i[0]=e=>y(X).filename=e),name:"filename",onIconClick:ae,width:"32rem"},null,8,["modelValue"]),[[C]])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])]),_:2},["mysql"==y(Z)?{name:"footer-left",fn:v(()=>[f(c,{options:oe,"table-ref":y(G)},null,8,["table-ref"])]),key:"0"}:void 0]),1024),"mysql"===y(Z)?(u(),b("ul",P,[...i[4]||(i[4]=[x("li",null,"【优化】执行OPTIMIZE命令，可回收未释放的磁盘空间，建议每月执行一次",-1),x("li",null,"【修复】尝试使用REPAIR命令修复损坏的表，仅能做简单修复，若修复不成功请考虑使用myisamchk工具",-1),x("li",null,"【MyISAM】转换数据表引擎，建议将所有表转为InnoDB",-1),x("li",null,"数据库大小是从数据库表中读取，会与数据库配额容量中获取存在些许误差，请注意",-1)])])):h("",!0)])}}});export{U as default};
