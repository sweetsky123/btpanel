import{c as e,s as a,r as t,h as l,i as s,w as o,a1 as n,o as c,B as i,C as u,p,k as d,J as m,x as r,e as _,y as b,z as f,F as v,q as g,v as y,l as k,I as x,aY as h,A as D,a7 as w,b1 as j,a4 as C,n as V}from"./base-lib.js?v=1763689792";import{L as T,o as q,J as M,M as P,X as J,j as U,a7 as F,e as H}from"./utils-lib.js?v=1763689792";import{ab as L,ac as N,ad as z}from"./config.js?v=1763689792";import{C as A}from"./checkbox-group.js?v=1763689792";import{s as B}from"./index9.js?v=1763689792";import{u as E,s as I}from"./useMethod9.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index118.js?v=1763689792";import"./validator.js?v=1763689792";import"./index106.js?v=1763689792";import"./column.js?v=1763689792";import"./index105.js?v=1763689792";import"./index119.js?v=1763689792";import"./index114.js?v=1763689792";import"./index116.js?v=1763689792";import"./index.vue_vue_type_script_setup_true_lang4.js?v=1763689792";const S={class:"h-[49.8rem]"},O={class:"backup-config"},R=["onClick"],W=["onClick"],X={key:2,class:"flex mb-1rem"},Y={class:"children-title"},G={class:"config-item-content"},K=H(e({__name:"add-back-task",props:{compData:{default:{refresh:()=>{}}}},setup(e,{expose:H}){const K=e,{cloudList:Q}=a(E());let Z=!1;const{isEdit:$,id:ee,active:ae,type:te}=K.compData,le=t(ae),se=t({}),oe=t(),ne=t(!1),ce=t(""),ie=t(!1),ue=t(!1),pe=t([{label:"整机备份",value:"all",disabled:!!$},{label:"环境备份",value:"env_list",disabled:!!$},{label:"数据备份",value:"data_list",disabled:!!$}]);t([new Date(2e3,1,1,0,0,0),new Date(2e3,2,1,23,59,59)]);const de=l({bp_type:"all",backup_type:"整机备份",name:"整机备份",storage_type:"local",backup_config:{},type:$?2:1,next_exec_time:""}),me={php:"PHP项目",node:"Node项目",proxy:"反向代理",python:"Python项目",other:"其他项目",net:".Net项目",java:"Java项目",html:"HTML项目"};t({env_list:!0,safety:!0,ftp_list:!0,site_list:!0,sql_list:!0});const re={name:[{required:!0,message:"请输入备份名称",trigger:["blur"]}]},_e=e=>e.getTime()<Date.now()-864e5,be=e=>{var a;de.backup_type=null==(a=pe.value.find((a=>a.value===e)))?void 0:a.label,de.name=de.backup_type;for(const t in de.backup_config){fe(de.backup_config[t],t===e||"all"===e)}};function fe(e,a){if(T(e))e.forEach((e=>{a&&3!==e.status&&!1!==(null==e?void 0:e.setup)?e.status=1:3!==e.status&&(e.status=0)}));else for(const t in e){fe(e[t],a)}}const ve=e=>{se.value={...se.value,[e]:!se.value[e]}},ge=e=>{var a;return null==(a=pe.value.find((a=>a.value===e)))?void 0:a.label},ye=e=>({site_list:"网站",sql_list:"数据库",ftp_list:"FTP",terminal_list:"终端",crontab_list:"计划任务",safety:"安全"}[e]),ke=(e,a,t)=>{var l,s;let o="";if("logs"===(null==(l=K.compData)?void 0:l.type)){const a="backup"===le.value?"备份":"还原",t=e[le.value+"_status"];-1!==t&&0!==t&&3!==t||(ie.value=!0),o=4===e.status?"[ 未恢复 ]":((e,a,t)=>{const l={"-1":'<b class="text-orange cursor-default" title="'.concat(t,'">').concat(a,"中</b>"),0:"等待".concat(a),1:'<b class="text-primary cursor-default" title="'.concat(t,'">').concat(a,"完成</b>"),2:'<b class="text-danger cursor-default" title="'.concat(t,'">').concat(a,"失败</b>")};return l[e]?" [ ".concat(l[e]," ]"):""})(t,a,null==e?void 0:e.msg)}const n="env_list"===t?a+("php"===a?"-":""):"",c=3===e.status?" [ 待开发 ]":!1===(null==e?void 0:e.setup)?" [ 未安装 ]":"logs"===(null==(s=K.compData)?void 0:s.type)?o:"";return"".concat(n).concat(e.name).concat((null==e?void 0:e.ps)?"（".concat(e.ps,"）"):"").concat(c)},xe=e=>{var a;return 3===e.status||!1===(null==e?void 0:e.setup)||2===de.type&&(!(null==e?void 0:e.backup_status)||4===(null==e?void 0:e.backup_status))||"logs"===(null==(a=K.compData)?void 0:a.type)},he=e=>{V((()=>{}))},De=e=>{const a=new Date;a.setSeconds(0,0);const t=new Date(6e4*Math.round(e.getTime()/6e4)),l=new Date(6e4*Math.round(a.getTime()/6e4));ue.value=+t==+l},we=async(e=!1)=>{var a;const t=await M({loading:ne,request:$?N({id:ee},le.value):z()});if(t.status){ce.value="",de.backup_config=t.data,(null==(a=K.compData)?void 0:a.rowData)&&delete de.backup_config.status;for(const e in de.backup_config){const a=de.backup_config[e];if(se.value[e]=!0,"data_list"===e)for(const e in a)se.value[e]=!0}}else ce.value=t.msg;e&&P.success("刷新成功")},je=async()=>{if(Z)return;const e=(new Date).getTime()/1e3;ie.value&&await we(!1);const a=(new Date).getTime()/1e3;setTimeout((()=>je()),a-e<1?4e3:3e3)},Ce=s((()=>[{label:"本地存储",value:"local"},...Q.value.filter((e=>e.config&&e.install)).map((e=>({label:e.name,value:e.type})))])),Ve=s((()=>({local:"本地存储",ftp:"FTP",alioss:"阿里云",txcos:"腾讯云",qiniu:"七牛云",webdav:"WebDAV"})));return o((()=>{var e;return null==(e=K.compData)?void 0:e.active}),(e=>{ie.value=!1,le.value=e,we()})),H({onConfirm:async e=>{await oe.value.validate();let a={...de,backup_config:JSON.stringify(de.backup_config),next_exec_time:new Date(de.next_exec_time).getTime()/1e3};(ue.value&&de.next_exec_time<new Date||!de.next_exec_time)&&(a.next_exec_time=0),delete a.bp_type,2===a.type?(a.id=K.compData.id,a.reduction_config=a.backup_config,delete a.backup_config,delete a.next_exec_time):await q({title:"提示",content:"在备份数据库时，对应网站将不可访问，是否继续操作？",type:"calc"}),await M({loading:"正在提交，请稍后...",request:L(a),message:!0,success:a=>{a.status&&(K.compData.refresh(),e())}})}}),n((()=>{Z=!0})),c((async()=>{var e,a;$&&(de.next_exec_time=K.compData.exec_time,de.name=K.compData.name,de.bp_type=null==(e=pe.value.find((e=>e.label===K.compData.backup_type)))?void 0:e.value,de.storage_type=Ve.value[K.compData.storage_type]),await we(),"logs"===(null==(a=K.compData)?void 0:a.type)&&je(),I()})),(e,a)=>{const t=D,l=w,s=J,o=U,n=F,c=j,V=C,q=i("bt-loading");return u((d(),m(V,{ref_key:"addBackupRef",ref:oe,rules:re,model:p(de),class:v(["bt-custom-form",{"-ml-2rem":"logs"===e.compData.type}]),"label-width":"4rem"},{default:r((()=>["logs"===e.compData.type?(d(),m(l,{key:0,label:"",class:"ml-2rem"},{default:r((()=>[_(t,{type:"default",onClick:a[0]||(a[0]=e=>we(!0))},{default:r((()=>a[5]||(a[5]=[b("刷新日志")]))),_:1})])),_:1})):f("",!0),p(ce)?(d(),m(l,{key:1,label:"",class:v({"ml-2rem":"logs"===e.compData.type})},{default:r((()=>[g("div",S,y(p(ce)),1)])),_:1},8,["class"])):(d(),k(x,{key:2},[_(l,{label:"备份类型",prop:"bp_type"},{default:r((()=>[_(s,{type:"button",size:"large",modelValue:p(de).bp_type,"onUpdate:modelValue":a[1]||(a[1]=e=>p(de).bp_type=e),options:p(pe),class:"w-[38rem]",onChange:be},null,8,["modelValue","options"])])),_:1}),_(l,{label:"备份名称",prop:"name",class:"!mt-[1.6rem]"},{default:r((()=>[_(o,{modelValue:p(de).name,"onUpdate:modelValue":a[2]||(a[2]=e=>p(de).name=e),name:"name",width:"32rem",disabled:!!p($)},null,8,["modelValue","disabled"])])),_:1}),_(l,{label:"存储位置",prop:"name",class:"!mt-[1.6rem]"},{default:r((()=>[_(n,{modelValue:p(de).storage_type,"onUpdate:modelValue":a[3]||(a[3]=e=>p(de).storage_type=e),class:"!w-[32rem]",options:p(Ce),disabled:!!p($)},null,8,["modelValue","options","disabled"]),_(t,{type:"primary",class:"ml-[12px]",onClick:p(B)},{default:r((()=>a[6]||(a[6]=[b("添加")]))),_:1},8,["onClick"])])),_:1}),p($)?f("",!0):(d(),m(l,{key:0,label:"执行时间"},{default:r((()=>[_(c,{modelValue:p(de).next_exec_time,"onUpdate:modelValue":a[4]||(a[4]=e=>p(de).next_exec_time=e),type:"datetime",style:{width:"32rem"},placeholder:"选择执行时间，为空默认添加后立即执行","disabled-date":_e,onChange:De},null,8,["modelValue"])])),_:1})),_(l,{label:"backup"===p(le)?"备份详情":"还原详情",prop:"backup_config"},{default:r((()=>[g("div",O,[(d(!0),k(x,null,h(p(de).backup_config,((e,a)=>(d(),k("div",{class:"backup-config-item",key:a},[g("div",{class:"config-item-title",onClick:e=>ve(a)},[g("span",null,y(ge(a)),1),g("i",{class:v("svgtofont-el-arrow-".concat(p(se)[a]?"down":"up"))},null,2)],8,R),g("div",{class:v(["config-item-content",{hidden:!p(se)[a],grid:"data_list"!==a}])},[(d(!0),k(x,null,h(e,((t,l)=>(d(),k(x,null,[p(T)(e)?(d(),m(A,{key:"".concat(a+l),"comp-data":{item:t,getDisabled:xe,changeCheckbox:he,title:ke(t)}},null,8,["comp-data"])):(d(),k(x,{key:1},["data_list"!==a?(d(!0),k(x,{key:0},h(t,((e,t)=>(d(),k(x,null,[!1!==e.setup?(d(),m(A,{key:"".concat(l+t),"comp-data":{item:e,title:ke(e,l,a),getDisabled:xe,changeCheckbox:he}},null,8,["comp-data"])):f("",!0)],64)))),256)):(d(),k(x,{key:1},[g("div",{class:v(["flex",p(se)[l]?"":"my-1rem"])},[g("div",{class:"config-item-title",onClick:e=>ve(l)},[g("span",null,y(ye(l)),1),g("i",{class:v("svgtofont-el-arrow-".concat(p(se)[l]?"down":"up"))},null,2)],8,W)],2),g("div",{class:v(["config-item-content",{hidden:!p(se)[l],grid:"site_list"!==l&&"sql_list"!==l}])},[(d(!0),k(x,null,h(t,((e,a)=>{var s;return d(),k(x,null,[p(T)(t)?(d(),m(A,{key:"".concat(l+a),"comp-data":{item:e,getDisabled:xe,changeCheckbox:he,title:ke(e)}},null,8,["comp-data"])):"safety"==l?(d(!0),k(x,{key:1},h(e,((e,t)=>(d(),m(A,{key:"".concat(a+t),"comp-data":{item:e,getDisabled:xe,changeCheckbox:he,title:ke(e)}},null,8,["comp-data"])))),128)):p(T)(e)&&"safaty"!==l?(d(),k("div",X,[g("span",Y,y(null!=(s=me[a])?s:a)+"：",1),g("div",G,[(d(!0),k(x,null,h(e,((e,a)=>(d(),m(A,{key:a,"comp-data":{item:e,title:ke(e),getDisabled:xe,changeCheckbox:he}},null,8,["comp-data"])))),128))])])):f("",!0)],64)})),256))],2)],64))],64))],64)))),256))],2)])))),128))])])),_:1},8,["label"])],64))])),_:1},8,["model","class"])),[[q,p(ne)]])}}}),[["__scopeId","data-v-d0f207d6"]]);export{K as default};
