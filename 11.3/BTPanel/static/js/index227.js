import{c as e,r as s,o as a,v as t,x as i,y as l,e as r,C as o,z as n,F as p,b1 as m,O as u,G as c,am as d,an as g,ad as f,ab as b}from"./base-lib.js?v=1763689792";import{p as v,k as y,Q as _,M as w}from"./utils-lib.js?v=1763689792";import{getPermission as h,batchSetMysqlAuth as j,setPermission as x,setPgSqlAuth as P}from"./database.js?v=1763689792";import{i as q,h as V}from"./validator.js?v=1763689792";import{x as k}from"./useMethod4.js?v=1763689792";import{g as D}from"./useStore2.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./column.js?v=1763689792";import"./index107.js?v=1763689792";const I={class:"p-20px"},O=e({__name:"index",props:{compData:{default:()=>({type:"single",rowData:{},config:{}})}},setup(e,{expose:O}){const{refs:{tabActive:S},refreshTableList:A}=D(),B=e,{rowData:C,type:F}=B.compData,{enable:M,exclude:U,clearBatch:z}=B.compData.config,G=s(),H=a({permission:"",ip:""}),J={ip:[{required:!0,trigger:["blur","change"],message:"请输入IP地址"}]},L={pgsql:{option:[{label:"所有人",value:"0.0.0.0/0"},{label:"本地服务器",value:"127.0.0.1/32"}],placeholder:"填写格式如：192.168.69.11/24",getPermission:()=>{const e="0.0.0.0/0"!==C.listen_ip&&"127.0.0.1/32"!==C.listen_ip;H.ip=e?C.listen_ip:"",H.permission=e?"ip":C.listen_ip},setPermission:async()=>{const{permission:e,ip:s}=H,a={data_name:C.name,username:C.username,listen_ip:"ip"===e?s:e};return await _({loading:"正在修改权限，请稍后...",request:P({data:JSON.stringify(a)}),success:({data:e})=>{w.request({msg:e.msg||e.data,status:e.status})}})}},mysql:{option:[{label:"所有人",value:"%"},{label:"本地服务器",value:"127.0.0.1"}],placeholder:"如果要允许IP段访问，可以使用%作为通配符，如127.17.%.%，如需要填写多个IP，请换行填写，每行一个IP",getPermission:async()=>{const{msg:e,status:s}=await _({request:h({name:C.username}),data:{msg:String,status:Boolean}});if(!s)return w.error(e);H.permission=e,"%"!==e&&"127.0.0.1"!==e&&(H.permission="ip",H.ip=e.replace(/,/g,"\n"))},setPermission:async()=>{const e=(()=>{const{permission:e,ip:s}=H;let a={name:C.username,dataAccess:e,access:"ip"===e?s:e,address:"ip"===e?s:""};return"multlples"==F?(delete a.name,V(C,U,M,{params:{...a}})):a})();if("multlples"===F){const s=await j(e),{data:a}=q(s.data);return a.length&&k(a,{title:"修改权限"}),z&&z(),s}{const s=await _({loading:"正在修改权限，请稍后...",request:x(e),message:"single"===F,data:{error:[Object,e=>Object.keys(e)],success:Array,status:Boolean,msg:String}});return s.status?s:w.error(s.msg)}}}};return t(()=>{(async()=>{"multlples"!=F?L[S.value].getPermission():H.permission=L[S.value].option.filter(e=>e.label.includes("本地"))[0].value})()}),O({onConfirm:async e=>{await G.value.validate();const{permission:s,ip:a}=H;["%","0.0.0.0/0"].includes(s)&&await v({title:"提示",content:"设置权限为所有人后，将会导致数据库安全性降低，他人可以随意访问数据库，是否继续操作？",icon:"warning-filled"});(await L[S.value].setPermission()).status&&(e(),A())}}),(e,s)=>{const a=d,t=g,v=f,_=y,w=b;return i(),l("div",I,[r(w,{ref_key:"permissionFormRef",ref:G,model:n(H),rules:J,"label-width":"5rem"},{default:o(()=>[r(v,{label:"访问权限",prop:"permission"},{default:o(()=>[r(t,{class:"!w-[22rem]",modelValue:n(H).permission,"onUpdate:modelValue":s[0]||(s[0]=e=>n(H).permission=e)},{default:o(()=>[(i(!0),l(p,null,m(L[n(S)].option,e=>(i(),u(a,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128)),r(a,{label:"指定ip",value:"ip"})]),_:1},8,["modelValue"])]),_:1}),"ip"===n(H).permission?(i(),u(v,{key:0,prop:"ip",label:"IP地址"},{default:o(()=>[r(_,{type:"mysql"===n(S)?"textarea":"text",rows:4,width:"22rem",modelValue:n(H).ip,"onUpdate:modelValue":s[1]||(s[1]=e=>n(H).ip=e),placeholder:L[n(S)].placeholder},null,8,["type","modelValue","placeholder"])]),_:1})):c("",!0)]),_:1},8,["model"])])}}});export{O as default};
