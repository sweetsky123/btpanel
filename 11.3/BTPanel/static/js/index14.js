import{n as e,H as a,p as t,b as s,ay as l,az as n,Q as o,aA as r,M as i,u as c,P as u,aB as p,l as d,ah as m,j as _}from"./utils-lib.js?v=1763689792";import{_ as v}from"./index123.js?v=1763689792";import{_ as f}from"./index109.js?v=1763689792";import{_ as b}from"./index118.js?v=1763689792";import{_ as y}from"./index130.js?v=1763689792";import{B as h}from"./index131.js?v=1763689792";import{c as g,r as w,o as k,x as C,y as x,e as j,C as T,J as O,z as E,aE as q,H as S,b4 as V,K as R,j as D,s as A,g as I,D as P,v as B,I as L,O as U,A as W,G as N,R as z,aZ as F}from"./base-lib.js?v=1763689792";import{g as J,a as M,m as H,r as $,c as G,e as K,s as Q,b as Z,d as X,f as Y,h as ee,i as ae,j as te,k as se,l as le,n as ne,o as oe,p as re,q as ie}from"./useController3.js?v=1763689792";import{a as ce,e as ue,b as pe,o as de,u as me,c as _e}from"./column.js?v=1763689792";import{c as ve}from"./validator.js?v=1763689792";const fe=g({__name:"index",emits:["upload-success"],setup(l,{expose:n,emit:o}){const r=s(),i=o,c=w(),u=window.location.protocol+"//"+window.location.host+"/crontab?action=import_crontab_from_json",p=k({overwrite:1}),d=w([]),m=[".json"].join(","),_=async(t,s,l)=>{var n,o,c;if(!1!==t.status){{let s=[];null==(n=t.successful_tasks)||n.forEach(e=>{s.push({name:e,status:1,msg:"导入成功"})}),null==(o=t.failed_tasks)||o.forEach(e=>{s.push({name:e,status:0,msg:"导入失败"})}),null==(c=t.skipped_tasks)||c.forEach(e=>{s.push({name:e,status:2,msg:"重复任务已跳过"})}),await e({title:"导入计划任务结果",area:42,component:()=>a(()=>import("./index125.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{resultData:s,autoTitle:t.msg,resultColumn:[{label:"计划任务名称",prop:"name"},{label:"操作结果",align:"right",render:e=>q("span",{class:1===e.status?"text-primary":0===e.status?"text-danger":""},e.msg)}]}})}i("upload-success")}else r.error(t.msg)},v=()=>{r.error("导入失败")},f={"x-http-token":window.vite_public_request_token},b=async e=>{e.value=e;const a=await t({type:"check",title:"提示",content:"是否继续将文件中的数据导入到现有计划任务中？",check:{content:"跳过重复计划任务",value:!0,onConfirm:e=>{p.overwrite=e?1:0}}});return a&&!p.overwrite&&await t({icon:"warning",title:"提示",content:"导入重复的任务可能会导致系统服务异常，请谨慎操作！"}),a},y=async(e,a)=>{d.value=a},h=(e,a,t)=>{d.value=t.map(t=>(t.uid===a.uid&&(t.percentage=e.percent),t))};return n({open:()=>{c.value.$el.click()},fileData:p}),(e,a)=>{const t=S,s=V;return C(),x("div",null,[j(s,{class:"upload-demo",ref:"upload",name:"file",data:()=>E(p),action:u,headers:f,accept:E(m),"on-error":v,multiple:!1,"show-file-list":!1,"auto-upload":!0,"on-success":_,"on-progress":h,"file-list":E(d),"on-change":y,"before-upload":b},{default:T(()=>[O(j(t,{ref_key:"openRef",ref:c,size:"small",type:"primary"},null,512),[[R,!1]])]),_:1},8,["data","accept","file-list"])])}}}),be=D("CRONTAB-VIEW-STORE",()=>{const e=w({}),a=w(!0),t=w([]),s=w([]);return{rowData:e,typeInit:a,$resetForm:()=>{e.value={},a.value=!0},shellOptions:t,pythonEnvOptions:s}}),ye=be(),{rowData:he}=A(ye),ge=l({route:"/ws_panel"}),we=w(),ke=w(),Ce=w([]),xe=w(!1),je=w(0),Te=k({p:1,count:20,search:"",type_id:"all",order_param:""}),Oe=w([]),Ee=w(!0),qe=w(!1),Se=w(""),Ve=()=>we.value.open(),Re=I(()=>{const{save:e,sType:a}=he.value;return!(["enterpriseBackup","logs","special_log","toShell"].includes(a)||!e&&n(e))}),De=async(e,a,t,s,l)=>{const{label:n,value:r}=s,i=n.replace("任务",""),c=async(e,a)=>{const t=new Map([["exec",X],["delete",re]]),{id:s}=e;switch(r){case"exec":case"delete":const e=t.get(r);if(e)return await e({id:s})}};await e({title:"批量".concat(i,"计划任务"),content:"即将批量".concat(i,"选中的计划任务，是否继续操作?"),column:[{label:"计划任务",prop:"rname"},_e()],onConfirm:async e=>{switch(r){case"start":case"stop":await(async(e,a)=>{const t=JSON.stringify(a.map(e=>e.id));e.unmount(),l(),await o({loading:"正在执行，请稍后...",request:ne({id_list:t,type:r,if_stop:"False"}),success:e=>{const a=e.data.map(e=>{const a=Object.entries(e)[0];return{msg:e.status?i+"成功":a[1],name:a[0],status:e.status}});oe(a,{title:"".concat(i,"计划任务")})}})})(e,t.value);break;case"delete":case"exec":await a(c);break;case"out":await(async(e,a)=>{const t=JSON.stringify(a.map(e=>e.id));e.unmount(),l(),await o({loading:"正在执行，请稍后...",request:K({ids:t}),success:e=>{window.open("/download?filename="+e.msg.replace("导出成功!,下载路径为",""),"_blank","noopener,noreferrer")}})})(e,t.value)}return Be(),!1}})},Ae=[{label:"执行任务",value:"exec",event:De},{label:"启动任务",value:"start",event:De},{label:"停止任务",value:"stop",event:De},{label:"设置分类",value:"setClass",event:async(e,a,t,s,l)=>{await ve({name:"计划任务分类",options:Oe.value.filter(e=>"all"!==e.value&&e.value>0),selectList:t.value,request:async(e,a)=>{const s=JSON.stringify(t.value.map(e=>e.id));await o({loading:"正在批量设置分类，请稍后...",request:Q({id:e.id,crontab_ids:s}),message:!0}),l(),a(),Be()}})}},{label:"导出任务",value:"out",event:De},{label:"删除任务",value:"delete",event:De}],Ie=async e=>{try{const{data:a}=await te({id:he.value.id});a.status?(de({path:a.msg}),e&&e()):i.request(a)}catch(a){}},Pe=({column:e,prop:a,order:t})=>{Te.order_param=t?a+("ascending"===t?" asc":" desc"):"",Be()},Be=async()=>{try{const e={...Te};"all"===Te.type_id&&(e.type_id=""),await o({loading:xe,request:J(e),data:{data:[Array,Ce],page:Object},success:e=>{je.value=r(e.page)}})}catch(e){}finally{xe.value=!1}},Le=async()=>{try{const e=await Z();Ee.value=Boolean(e.status)}catch(e){}},Ue=async(e,a=!1)=>{let t={};t=a?{id:he.value.id}:{id:e.id};try{const s=await X(t);i.request(s),a||We(e)}catch(s){}},We=t=>{he.value=t,e({title:"查看【"+(t.rname||t.name)+"】日志",area:80,component:()=>a(()=>import("./index126.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},Ne=t=>{he.value=t||!1,e({title:"".concat(t?(null==t?void 0:t.id)?"编辑":"复制":"添加","计划任务"),area:100,showFooter:!0,component:()=>a(()=>import("./index128.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},ze=async()=>(await o({request:ee(),data:{msg:Array},success:e=>{Oe.value=[{label:"全部分类",value:"all"},{label:"系统任务",value:"-1"},{label:"默认分类",value:"0"},{label:"正在运行",value:"-2"},{label:"已停止",value:"-3"},...e.msg.map(e=>({label:e.name,value:e.id.toString()}))]}}),Promise.resolve(Oe.value||[])),Fe={getClassList:ze,addClass:M,editClass:H,deleteClass:$},Je=w([ce({key:"id"}),ue({event:(e,a)=>{(async(e,a)=>{try{let t;"top"==a?t=await se({task_id:e.id}):"untop"==a&&(t=await le({task_id:e.id})),i.request(t),Be()}catch(t){}})(e,a)},param:"sort"}),{label:"任务名称",prop:"name",minWidth:250,sortable:"custom",showOverflowTooltip:!0,render:e=>e.rname||e.name},{label:"分类",prop:"type_name",isCustom:!0},pe({event:async e=>{try{const a=!e.status;await t({title:"".concat(a?"启用":"停用","计划任务"),content:"该计划任务".concat(a?"已停止":"正在运行","，是否要").concat(a?"启用":"停用","这个计划任务？")}),await o({loading:"正在设置计划任务状态，请稍候...",request:Y({id:Number.parseInt(e.id),if_stop:a?"False":"True"}),message:!0}),Be()}catch(a){}},sortable:"custom",data:["停用","正常"]}),{label:"执行周期",prop:"cycle",minWidth:150,isCustom:!0,showOverflowTooltip:!0},{label:"保存数量",isCustom:!0,render:t=>["site","database","enterpriseBack","path","mysql_increment_backup"].includes(t.sType)&&t.save?j("span",null,[t.save,P("份"),j("span",{class:"bt-link",onClick:()=>(t=>{he.value=t,e({title:"".concat(t.name,"-备份文件"),area:80,component:()=>a(()=>import("./index127.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})})(t)},[P("[查看]")])]):"logs"===t.sType||"special_log"===t.sType?"".concat(t.save?t.save+"份":"--"):"--"},{label:"备份到",minWidth:160,isCustom:!0,render:e=>{if("mysql_increment_backup"===e.sType||"enterpriseBackup"===e.sType){const a=e.backupTo.split("|");let t="";return a.forEach(e=>t+=G[e]+","),t.slice(0,-1)}const a=G[e.backupTo];return"toShell"===e.sType?"--":a||"--"}},{label:"备份路径",prop:"db_backup_path",width:100,isCustom:!0,showOverflowTooltip:!0,render:e=>["site","database","path"].includes(e.sType)?j("span",{class:"bt-link",onClick:()=>de({path:e.db_backup_path})},[e.db_backup_path]):"--"},{label:"上次执行时间",prop:"addtime",minWidth:150,sortable:"custom",isCustom:!0},{label:"上次定时任务执行结果",prop:"result",isCustom:!1,minWidth:160,sortable:"custom",render:e=>j("span",{class:e.result?"text-primary":"text-danger"},[e.result?"正常":"异常"])},me([{onClick:e=>Ue(e),title:"执行"},{onClick:Ne,title:"编辑"},{onClick:We,title:"日志"},{onClick:e=>Ne({...e,id:""}),title:"复制"},{onClick:async({id:e,name:a})=>{try{await t({title:"删除计划任务",content:"您确定要删除计划任务【".concat(a,"】，是否继续？")}),await o({loading:"正在删除计划任务，请稍候...",request:ae({id:e}),message:!0}),Be()}catch(s){}},title:"删除"}])]),Me=async()=>{await t({title:"一键修复",content:"此修复主要用于解决计划任务无法定时执行，请谨慎操作,是否继续?"}),qe.value=!0;let e=[];Se.value="开始修复计划任务...",ge.request("/crontab/repair_crontab_service",{customType:"model",onMessage:a=>{a.includes("修复完成")?(i.success("修复成功"),Le(),qe.value=!1):(e.push(a),Se.value=e.join("\n"))}})},He=async()=>{if(0!==Ce.value.length)try{const e=await K();window.open("/download?filename="+e.msg.replace("导出成功!,下载路径为",""),"_blank","noopener,noreferrer")}catch(e){}else i.error("暂无数据可导出")},$e=()=>{e({title:"日志切割设置",area:56,component:()=>a(()=>import("./index129.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},Ge={class:"flex items-center"},Ke={class:"flex items-center"},Qe={class:"flex-wrap"},Ze=g({__name:"index",setup:e=>(c(),B(()=>(Be(),ze(),void Le())),(e,a)=>{const t=F,s=S,l=h,n=u,o=y,r=p,i=d,c=m,g=b,w=f,k=v,q=_,V=L("bt-loading");return C(),x("div",null,[E(Ee)?N("",!0):(C(),U(t,{key:0,closable:!1,type:"error",class:"!mb-[1.6rem]"},{title:T(()=>[W("div",Ge,[a[9]||(a[9]=W("i",{class:"svgtofont-el-warning-filled text-[var(--el-color-error-light-8)] !text-base mr-[4px]"},null,-1)),a[10]||(a[10]=P(" 检测到当前计划任务服务异常，请及时修复，温馨提示：修复前请先临时关闭系统加固，否则可能导致修复失败。 ",-1)),W("span",{class:"bt-link",onClick:a[0]||(a[0]=(...e)=>E(Me)&&E(Me)(...e))},"[ 一键修复 ]")])]),_:1})),j(w,null,{"header-left":T(()=>[j(s,{type:"primary",onClick:a[1]||(a[1]=e=>E(Ne)())},{default:T(()=>[...a[11]||(a[11]=[P("添加任务",-1)])]),_:1}),j(s,{onClick:E(Ve)},{default:T(()=>[...a[12]||(a[12]=[P("导入",-1)])]),_:1},8,["onClick"]),j(s,{onClick:E(He)},{default:T(()=>[...a[13]||(a[13]=[P("导出",-1)])]),_:1},8,["onClick"]),j(s,{onClick:a[2]||(a[2]=e=>E($e)())},{default:T(()=>[...a[14]||(a[14]=[P("日志切割设置",-1)])]),_:1}),j(fe,{ref_key:"fileRef",ref:we,onUploadSuccess:E(Be)},null,8,["onUploadSuccess"]),W("div",{class:"flex items-center ml-4px",onClick:a[3]||(a[3]=e=>E(ie)())},[...a[15]||(a[15]=[W("i",{class:"svgtofont-desired text-medium"},null,-1),W("span",{class:"bt-link"},"需求反馈",-1)])])]),"header-right":T(()=>[W("div",Ke,[j(l,{name:"CrontabTask",class:"mr-[10px] !w-[16rem]",modelValue:E(Te).type_id,"onUpdate:modelValue":a[4]||(a[4]=e=>E(Te).type_id=e),options:E(Oe),field:"name",config:E(Fe),onChange:E(Be),ignore:["-1","0","-2","-3"]},null,8,["modelValue","options","config","onChange"]),W("div",null,[j(n,{class:"!w-[26rem]",modelValue:E(Te).search,"onUpdate:modelValue":a[5]||(a[5]=e=>E(Te).search=e),onSearch:E(Be),placeholder:"支持任务名称模糊搜索"},null,8,["modelValue","onSearch"])]),j(o,{onRefresh:E(Be),class:"!mx-[10px]"},null,8,["onRefresh"]),j(r,{name:"Crontab",column:E(Je)},null,8,["column"])])]),content:T(()=>[O(j(i,{ref_key:"crontabRef",ref:ke,column:E(Je),data:E(Ce),onSortChange:E(Pe)},null,8,["column","data","onSortChange"]),[[V,E(xe)],[V,"正在加载中，请稍候...","title"]])]),"footer-left":T(()=>[j(c,{"table-ref":E(ke),options:E(Ae)},null,8,["table-ref","options"])]),"footer-right":T(()=>[j(g,{page:E(Te).p,"onUpdate:page":a[6]||(a[6]=e=>E(Te).p=e),row:E(Te).count,"onUpdate:row":a[7]||(a[7]=e=>E(Te).count=e),total:E(je),onChange:E(Be)},null,8,["page","row","total","onChange"])]),_:1}),j(q,{title:"正在修复服务，请耐心等候",modelValue:E(qe),"onUpdate:modelValue":a[8]||(a[8]=e=>z(qe)?qe.value=e:null),area:[60]},{default:T(()=>[W("div",Qe,[j(k,{class:"h-[40rem] !rounded-none",content:E(Se)},null,8,["content"])])]),_:1},8,["modelValue"])])})}),Xe=Object.freeze(Object.defineProperty({__proto__:null,default:Ze},Symbol.toStringTag,{value:"Module"}));export{be as C,Xe as a,Be as g,Re as i,Ie as o,Ue as s,ge as w};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
