import{_ as e}from"./index109.js?v=1763689792";import{B as a}from"./index119.js?v=1763689792";import{u as l,Q as t,M as s,aK as o,p as r,l as n,ah as u,k as i,$ as d,j as p}from"./utils-lib.js?v=1763689792";import{c,r as m,o as y,v,I as b,x as h,y as f,e as x,C as g,D as V,J as w,z as _,R as U,A as k,O as j,G as C,F as R,b1 as q,W as L,H as E,ap as S,ad as N,ab as J}from"./base-lib.js?v=1763689792";import{_ as M}from"./index130.js?v=1763689792";import{modifyModulesProxy as O,modifyProxy as I,getProxyFile as A,removeModulesProxy as D,removeProxy as F,getModulesProxyList as H,getProxyList as P,asyncSaveProxyFile as T,saveRedirectFile as $,createProxySite as z,createProxy as B}from"./site.js?v=1763689792";import{a as G,b as K,u as Q,c as W}from"./column.js?v=1763689792";import{r as X}from"./useController6.js?v=1763689792";import{u as Y}from"./useStore4.js?v=1763689792";import"./ace.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./validator.js?v=1763689792";import"./index107.js?v=1763689792";const Z={class:"p-[20px]"},ee={class:"flex items-center"},ae={class:"flex items-center"},le=["onClick"],te={class:"p-2rem"},se=c({__name:"index",props:{compData:{default:()=>({})}},setup(c,{expose:se}){var oe,re;const{plugin:ne}=l(),{siteInfo:ue}=Y(),{webserver:ie}=ne.value,de=m(null==(re=null==(oe=ue.value)?void 0:oe.project_type)?void 0:re.toLowerCase()),pe=m();m(""),m([]),m("");const ce=m([]),me=m(!1),ye=m(!1),ve=m({}),be=y({proxyname:[{required:!0,message:"请输入代理名称",trigger:["blur","change"]},{trigger:["blur","input","change"],validator:(e,a,l)=>{a.length<3?l(new Error("代理名称必须大于3个字符串")):l()}}],proxysite:[{required:!0,message:"请输入目标url",trigger:"blur",validator:(e,a,l)=>{a?l():l(new Error("目标URL不能为空"))}}],todomain:[{required:!0,message:"请输入发送域名",trigger:["blur","change"]}]}),he=m({isEdit:!1,type:!0,cache:!1,advanced:!1,proxyname:"",cachetime:1,proxydir:"/",proxysite:"http://",todomain:"",subfilter:[{sub1:"",sub2:"",id:1}],subNum:1,path:"",content:""}),fe=m(!1),xe=m(!1),ge=[{content:"代理目录：访问这个目录时将会把目标URL的内容返回并显示(需要开启高级功能)"},{content:"目标URL：可以填写你需要代理的站点，目标URL必须为可正常访问的URL，否则将返回错误"},{content:"发送域名：将域名添加到请求头传递到代理服务器，默认为目标URL域名，若设置不当可能导致代理无法正常运行"},{content:"内容替换：只能在使用nginx时提供，最多可以添加3条替换内容,如果不需要替换请留空"}],Ve=async(e,a,l,t)=>{const{label:s,value:o}=t,r=new Map([["start","批量启动选中的规则后，配置的反向代理规则将继续生效"],["stop","批量停用选中的规则后，配置的反向代理规则将会失效"],["delete","批量删除选中的规则后，配置的反向代理规则将会彻底失效"]]),n=async(e,a)=>{const{proxyname:l,subfilter:t}=e,s=["proxy","phpasync"].includes(de.value);switch(o){case"start":case"stop":let a={...e,subfilter:JSON.stringify(t),type:"start"===o?1:0};const r=s?await O(a,de.value):await I(a);return{...e,batchStatus:r.status?1:2,message:r.msg};case"delete":const n={sitename:ue.value.name,proxyname:"phpasync"===de.value?[l]:l},u=s?await D(n,de.value):await F(n);return{...e,batchStatus:u.status?1:2,message:u.msg}}};await e({title:"批量".concat(s),content:"".concat(r.get(o),"，是否继续操作？"),column:[{label:"名称",prop:"proxyname"},W()],onConfirm:async()=>(await a(n),Ne(),!1)})},we=e=>{let a=e.replace(/^http[s]?:\/\//,"");a=a.replace(/(:|\?|\/|\\)(.*)$/,""),he.value.todomain=a},_e=async(e,a)=>{let l={...e,subfilter:JSON.stringify(e.subfilter)};"cache"===a?l.cache=e.cache?0:1:l.type=e.type?0:1;const s=["proxy","phpasync"].includes(de.value);(await t({loading:"正在修改状态中，请稍后...",request:s?O(l,de.value):I(l),message:!0})).status&&Ne()},Ue=async e=>{try{if(0===e.type)return s.error("该规则已暂停，无法查看配置文件");const{data:a}=await A({sitename:ue.value.name,proxyname:e.proxyname,webserver:ie});!1===a.status?s.request(a):(he.value.content=a[0].data,he.value.path=a[1],he.value.proxyname=e.proxyname,xe.value=!0)}catch(a){o(a)}},ke=async()=>{const e="phpasync"===de.value,a=e?T:$,l={path:he.value.path,[e?"config":"data"]:he.value.content,encoding:"utf-8"};(await t({loading:"正在保存配置文件，请稍后...",request:a(l),message:!0})).status&&(xe.value=!1,Re(),Ne())},je=async e=>{he.value.isEdit=!0,he.value.proxyname=e.proxyname,he.value.proxydir=e.proxydir,he.value.proxysite=e.proxysite,he.value.todomain=e.todomain,he.value.type=!!e.type,he.value.cache=!!e.cache,he.value.advanced=!!e.advanced,he.value.cachetime=e.cachetime,he.value.subfilter=e.subfilter.map((e,a)=>({sub1:e.sub1,sub2:e.sub2,id:a})).filter(e=>""!==e.sub1),fe.value=!0},Ce=async()=>{Re(),fe.value=!0},Re=async()=>{he.value.isEdit=!1,he.value.proxyname="",he.value.proxydir="/",he.value.proxysite="http://",he.value.todomain="",he.value.type=!0,he.value.cache=!1,he.value.advanced=!1,he.value.cachetime=1,he.value.subfilter=[{sub1:"",sub2:"",id:1}],he.value.subNum=1},qe=async()=>{3!==he.value.subfilter.length?he.value.subfilter.push({sub1:"",sub2:"",id:100*Math.random()}):s.error("最多添加三条内容替换")},Le=e=>{const a=[...e];for(;a.length<3;)a.push({sub1:"",sub2:""});return a.map((e,a)=>({sub1:e.sub1,sub2:e.sub2,id:100*Math.random()}))},Ee=async()=>{await ve.value.validate();const{isEdit:e,type:a,subfilter:l,cache:s,advanced:o,proxyname:r,proxydir:n,proxysite:u,todomain:i,cachetime:d}=he.value;let p={subfilter:JSON.stringify(Le(l).map(e=>({sub1:e.sub1,sub2:e.sub2}))),type:a?1:0,cache:s?1:0,advanced:o?1:0,sitename:ue.value.name,proxyname:r,proxydir:n,proxysite:u,todomain:i,cachetime:d};const c=["proxy","phpasync"].includes(de.value),m=e?O:z,y=e?I:B;(await t({loading:ye,request:c?m(p,de.value):y(p),message:!0})).status&&(Ne(),fe.value=!1)},Se=async e=>{await r({title:"删除反向代理规则【".concat(e.proxyname,"】"),content:"删除选中的规则后，配置的反向代理规则将会彻底失效，是否继续操作？",icon:"warning-filled"});const a=["proxy","phpasync"].includes(de.value),l={phpasync:{sitename:ue.value.name,proxyname:e.proxyname},default:{sitename:ue.value.name,proxyname:[e.proxyname]}},s=l[de.value]||l.default;(await t({loading:"正在删除，请稍后...",request:a?D(s,de.value):F(l.default),message:!0})).status&&Ne()},Ne=async()=>{const e={sitename:ue.value.name},a=["proxy","phpasync"].includes(de.value);await t({loading:me,request:a?H(e,de.value):P(e),data:[Array,ce]})},Je=[{label:"启用反向代理规则",value:"start",event:Ve},{label:"停用反向代理规则",value:"stop",event:Ve},{label:"删除反向代理规则",value:"delete",event:Ve}],Me=L([G({key:"proxydir"}),{label:"名称",prop:"proxyname"},{label:"代理目录",prop:"proxydir"},{label:"目标URL",width:140,render:e=>x("span",{class:"bt-link",onClick:()=>{window.open(e.proxysite)}},[e.proxysite])},{prop:"cache",label:"缓存",width:60,render:e=>{const{cache:a}=e;return x("span",{class:"".concat(a?"bt-link":"bt-danger"),onClick:()=>{_e(e,"cache")}},[a?"已开启":"已关闭"])}},K({prop:"type",event:_e,data:["已暂停","运行中"]}),Q([{onClick:Ue,title:"配置文件",width:56},{onClick:je,title:"编辑"},{onClick:Se,title:"删除"}])]);return v(Ne),se({init:Ne}),(l,t)=>{const o=E,r=M,c=n,m=u,y=S,v=N,L=i,O=J,I=d,A=p,D=a,F=e,H=b("bt-loading");return h(),f("div",null,[x(F,null,{"header-left":g(()=>[x(o,{type:"primary",onClick:Ce},{default:g(()=>[...t[11]||(t[11]=[V("添加反向代理",-1)])]),_:1})]),"header-right":g(()=>[x(r,{onRefresh:Ne})]),content:g(()=>[w(x(c,{ref_key:"reverseTableRef",ref:pe,column:_(Me),"max-height":520,data:_(ce)},null,8,["column","data"]),[[H,_(me)],[H,"正在获取列表，请稍候...","title"]])]),"footer-left":g(()=>[x(m,{"table-ref":_(pe),options:_(Je)},null,8,["table-ref","options"])]),"footer-right":g(()=>[...t[12]||(t[12]=[])]),popup:g(()=>[x(A,{title:_(he).isEdit?"修改反向代理【".concat(_(he).proxyname,"】"):"添加反向代理",modelValue:_(fe),"onUpdate:modelValue":t[8]||(t[8]=e=>U(fe)?fe.value=e:null),"show-footer":!0,area:68,onConfirm:Ee},{default:g(()=>[k("div",Z,[x(O,{ref_key:"proxyForm",ref:ve,model:_(he),rules:_(be),disabled:_(ye),"label-width":"80px"},{default:g(()=>[x(v,{label:"开启代理"},{default:g(()=>[k("div",ee,[x(y,{modelValue:_(he).type,"onUpdate:modelValue":t[0]||(t[0]=e=>_(he).type=e)},null,8,["modelValue"]),x(v,{label:"开启缓存",class:"!mt-0"},{default:g(()=>[x(y,{modelValue:_(he).cache,"onUpdate:modelValue":t[1]||(t[1]=e=>_(he).cache=e)},null,8,["modelValue"])]),_:1}),x(v,{label:"高级功能",class:"!mt-0"},{default:g(()=>[x(y,{modelValue:_(he).advanced,"onUpdate:modelValue":t[2]||(t[2]=e=>_(he).advanced=e)},null,8,["modelValue"])]),_:1})])]),_:1}),x(v,{label:"代理名称",prop:"proxyname"},{default:g(()=>[x(L,{modelValue:_(he).proxyname,"onUpdate:modelValue":t[3]||(t[3]=e=>_(he).proxyname=e),disabled:_(he).isEdit,placeholder:"请输入代理名称",width:"20rem"},null,8,["modelValue","disabled"])]),_:1}),_(he).cache?(h(),j(v,{key:0,label:"缓存时间",prop:"cachetime"},{default:g(()=>[x(L,{modelValue:_(he).cachetime,"onUpdate:modelValue":t[4]||(t[4]=e=>_(he).cachetime=e),placeholder:"请输入缓存时间",width:"20rem",textType:"分钟"},{append:g(()=>[...t[13]||(t[13]=[V(" 分钟 ",-1)])]),_:1},8,["modelValue"])]),_:1})):C("",!0),_(he).advanced?(h(),j(v,{key:1,label:"代理目录",prop:"proxydir"},{default:g(()=>[x(L,{modelValue:_(he).proxydir,"onUpdate:modelValue":t[5]||(t[5]=e=>_(he).proxydir=e),placeholder:"请输入代理目录",width:"20rem"},null,8,["modelValue"])]),_:1})):C("",!0),x(v,{label:"目标URL",prop:"proxysite","label-width":"80px"},{default:g(()=>[k("div",ae,[x(L,{modelValue:_(he).proxysite,"onUpdate:modelValue":t[6]||(t[6]=e=>_(he).proxysite=e),placeholder:"请输入目标URL",width:"20rem",onInput:we},null,8,["modelValue"]),x(v,{label:"发送域名",prop:"todomain","label-width":"50px"},{default:g(()=>[x(L,{modelValue:_(he).todomain,"onUpdate:modelValue":t[7]||(t[7]=e=>_(he).todomain=e),placeholder:"请输入发送域名",width:"20rem"},null,8,["modelValue"])]),_:1})])]),_:1}),x(v,{label:"内容替换"},{default:g(()=>[(h(!0),f(R,null,q(_(he).subfilter,(e,a)=>(h(),f("div",{key:e.id,class:"flex items-center mb-1rem"},[x(L,{modelValue:e.sub1,"onUpdate:modelValue":a=>e.sub1=a,placeholder:"被替换的文本，可留空",width:"20rem",class:"mr-2rem !w-20rem"},null,8,["modelValue","onUpdate:modelValue"]),x(L,{modelValue:e.sub2,"onUpdate:modelValue":a=>e.sub2=a,placeholder:"替换为，可留空",width:"20rem",class:"mr-1rem !w-20rem"},null,8,["modelValue","onUpdate:modelValue"]),k("span",{class:"text-danger cursor-pointer",onClick:a=>(async e=>{1!==he.value.subfilter.length?he.value.subfilter=he.value.subfilter.filter(a=>a.id!==e.id):s.error("至少保留一条内容替换")})(e)},"删除",8,le)]))),128)),x(o,{disabled:3===_(he).subfilter.length,type:"primary",class:"!mt-1rem",onClick:qe},{default:g(()=>[...t[14]||(t[14]=[k("span",{class:"svgtofont-el-plus"},null,-1),V(" 添加内容替换 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1},8,["model","rules","disabled"]),x(I,{options:ge,class:"mt-2rem pl-2rem"})])]),_:1},8,["title","modelValue"]),x(A,{title:"编辑配置文件【".concat(_(he).proxyname,"】"),modelValue:_(xe),"onUpdate:modelValue":t[10]||(t[10]=e=>U(xe)?xe.value=e:null),area:55},{default:g(()=>[k("div",te,[t[16]||(t[16]=k("div",{class:"text-secondary h-[2rem] leading-[2rem] mb-[1rem]"},"提示：Ctrl+S 保存",-1)),x(D,{modelValue:_(he).content,"onUpdate:modelValue":t[9]||(t[9]=e=>_(he).content=e),filePath:_(he).path,config:_(X)(),request:!1,class:"!h-38rem",onSave:ke},null,8,["modelValue","filePath","config"]),x(o,{type:"primary",class:"!mt-2rem",onClick:ke},{default:g(()=>[...t[15]||(t[15]=[V("保存",-1)])]),_:1})])]),_:1},8,["title","modelValue"])]),_:1}),t[17]||(t[17]=k("ul",{class:"mt-[20px] leading-8 text-small list-disc ml-[20px]"},[k("li",null,"设置了反向代理后，【访问限制】中的相应路径的规则将会失效")],-1))])}}});export{se as default};
