import{L as e,p as a,n as t,M as s,ld as l,an as r,le as o,x as n,_ as i}from"./utils-lib.js?v=1763689792";import{j as m,b as d,h as c,f as u}from"./form-item.js?v=1763689792";import{a as p}from"./column.js?v=1763689792";import{a as v,b as g}from"./index68.js?v=1763689792";import{c as y,r as b,e as _,V as f,D as h,ag as j,ak as w,aj as I,x,y as z,z as P,i as q}from"./base-lib.js?v=1763689792";import{_ as M}from"./index109.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./useController6.js?v=1763689792";import"./site.js?v=1763689792";import"./validator.js?v=1763689792";import"./index107.js?v=1763689792";import"./useStore4.js?v=1763689792";const S={class:"p-[2rem] node-master-mysql-add-form"};const k=i(y({__name:"add-form",props:{compData:{default:()=>({panel_address:""})}},setup(i,{expose:y}){var k;const{mysqlRowData:B,isRefreshList:D}=v(),A=[{label:"面板自动同步",value:"auto",desc:"通过主库面板连接从库面板进行导入导出数据，简单快捷，建议内网机器使用"},{label:"手动同步到从库",value:"manual",desc:"通过主库面板备份，手动将备份文件上传至从库导入后进行数据还原后同步，大于1G数据建议使用此方法同步"}],C=b({node_id:"",master_ip:(null==(k=null==i?void 0:i.compData)?void 0:k.panel_address)||"",slave_ip:"",err_code:["1062"],sync_type:"auto",db_name:""}),{BtForm:T,validate:V,param:E,submit:L}=e({data:C.value,options:[m("选择从库节点","node_id",B.value,{attrs:{placeholder:"请选择从库节点",class:"!w-[45rem]",onChange:e=>{var a;E.value.slave_ip=(null==(a=B.value.find(a=>a.value===e))?void 0:a.remarks)||""}},rules:[{required:!0,message:"请选择从库节点",trigger:"change"}]}),d("主库IP地址","master_ip",{attrs:{placeholder:"请输入主库IP地址，如：192.168.1.100",class:"!w-[45rem]"},rules:[{required:!0,message:"请输入主库IP地址",trigger:["blur","change"]},{pattern:/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,message:"请输入正确的IP地址格式",trigger:["blur","change"]}]}),d("从库IP地址","slave_ip",{attrs:{placeholder:"请输入从库IP地址，如：192.168.1.101",class:"!w-[45rem]"},rules:[{required:!0,message:"请输入从库IP地址",trigger:["blur","change"]},{pattern:/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,message:"请输入正确的IP地址格式",trigger:["blur","change"]}]}),c(" ",()=>_(j,{modelValue:E.value.err_code,"onUpdate:modelValue":e=>E.value.err_code=e,class:"mb-[1.2rem]"},{default:()=>[_(f,{value:"1062",key:"1062"},{default:()=>[_("span",null,[h("跳过1062错误")]),_("div",{class:"err_code_desc"},[h("跳过主键或唯一键冲突错误")])]})]}),"err_code"),(()=>{const{BtTable:e,BtPage:a,BtSearch:t}=r({request:async e=>{e.limit=50;const{data:a}=await o(e);return a.data[0].keys_scopes_status=!0,{data:a.data,total:a.page.total_count}},columns:[p({key:"id"}),{label:"数据库名称",prop:"name"},{label:"数据库大小",prop:"size",render:e=>_("span",null,[n(e.size)])},{label:"数据库引擎",prop:"type"}]});return c("同步数据库",()=>_("div",{class:"w-[94.2%]"},[_(M,null,{"header-right":()=>_(t,{placeholder:"请输入数据库名称",class:"!w-[20rem]"},null),content:()=>_(e,{height:"200px",onSelectionChange:async e=>{try{E.value.db_name=e.map(e=>e.name).join(","),E.value.db_type=e.map(e=>e.type).join(","),await V()}catch(a){}}},null),"footer-right":()=>_(a,{layout:"prev, pager, next, total, jumper","page-size":50},null)})]),"db_name",{class:"node-master-mysql-db-table",rules:[{required:!0,message:"请选择要同步的数据库",trigger:"change"}]})})(),u(" ",[{content:"添加后仅同步选中的数据库数据，如需新增数据库需删除主从重新配置"}]),c("首次同步方式",()=>{let e;return _(I,{modelValue:E.value.sync_type,"onUpdate:modelValue":e=>E.value.sync_type=e},"function"==typeof(a=e=A.map(e=>_(w,{class:"mt-[1rem]",value:e.value,key:e.value,style:{height:"auto",lineHeight:"1",alignItems:"flex-start"}},{default:()=>[_("span",{class:"radio-label"},[e.label]),_("div",{class:"radio-desc mt-[1rem] mb-[1rem] w-[43rem]",style:{whiteSpace:"normal",lineHeight:"1.5"}},[e.desc])]})))||"[object Object]"===Object.prototype.toString.call(a)&&!q(a)?e:{default:()=>[e]});var a},"sync_type"),u("",[{content:"仅支持mysql-5.7+版本（不支持mariadb）"},{content:"只支持通过app/或api添加的节点"}])],submit:async(e,r,o)=>{try{await r(),await a({icon:"warning-filled",title:"提示",content:"首次配置将会重启数据库，如从库有同名数据库将会进行数据覆盖，建议空闲时间配置，是否继续？"})}catch(i){return!1}if(e.value.db_type.includes("MyISAM"))try{await new Promise((e,a)=>{t({title:"MyISAM 引擎警告",area:50,showFooter:!0,component:()=>_("div",{class:"p-[2rem] text-base"},[_("div",{style:"color:var(--el-color-danger-dark-2);margin-bottom:8px;font-size: var(--el-font-size-base);"},[h("检测到选中的数据库包含 MyISAM 存储引擎的表，可能存在以下风险：")]),_("ul",{style:"margin-bottom:16px;list-style: disc;padding-left: 2rem;"},[_("li",null,[h("数据不一致：MyISAM 不支持事务，同步过程中可能出现数据不完整")]),_("li",null,[h("主从中断：表级锁定机制在高并发时内容易导致同步失败")]),_("li",null,[h("错误频发：需要设置错误跳过机制才能正常运行")])]),_("div",{style:"margin-bottom:2rem"},[_("div",{style:"margin-bottom:1rem"},[h("建议方案：")]),_("div",{style:"color:var(--el-color-primary); font-size: var(--el-font-size-base);margin-bottom:1rem"},[h("【推荐】转换为 InnoDB: ALTER TABLE table_name ENGINE=InnoDB")]),_("div",{style:"color:var(--el-base-supplement); font-size: var(--el-font-size-base);"},[h("【备选】继续使用并设置错误跳过码（如: 1062）")])]),_("div",null,[h("确定要继续选择这些数据库吗？")])]),confirmText:"继续添加",cancelText:"取消",onConfirm:()=>(e(!0),!0),onCancel:()=>(a(),!1)})})}catch(m){return!1}const n=s.load("正在添加主从，请稍后...");try{const a=await l(e.value);return a.status?(s.success("创建成功"),g(e.value.slave_ip),!0):(s.error(a.msg),!1)}catch(i){return s.error("创建失败，请重试"),!1}finally{D.value=!0,n.close()}}});return y({validate:V,onConfirm:L,formData:E}),(e,a)=>(x(),z("div",S,[_(P(T))]))}}),[["__scopeId","data-v-93d76ea6"]]);export{k as default};
