import{k as e,_ as a,B as t,H as s,M as l,az as o,Q as r,kQ as u,R as n,kR as i,bH as d,r as c,L as m,bE as p,l as v,$ as _,j as f,f0 as h,p as y,kS as w,aC as x}from"./utils-lib.js?v=1763689792";import{c as b,s as k,aB as j,x as S,y as g,z as D,O as C,C as L,A as V,B as M,G as A,e as T,R as I,D as N,aZ as O,H as P,r as R,o as E,g as q,V as U,v as B,F as H,b1 as W,ag as z,ad as X,aE as F,j as G,P as J,m as Q,aD as K}from"./base-lib.js?v=1763689792";import{_ as Y}from"./index109.js?v=1763689792";import{L as Z}from"./ssl.js?v=1763689792";import{f as $}from"./useController15.js?v=1763689792";import{l as ee}from"./useMethod12.js?v=1763689792";import{u as ae}from"./useStore12.js?v=1763689792";import{authDomainApi as te,validateDomain as se,getCertList as le}from"./site.js?v=1763689792";import{c as oe}from"./index61.js?v=1763689792";import{u as re}from"./column.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./useStore4.js?v=1763689792";import"./useController6.js?v=1763689792";import"./validator.js?v=1763689792";import"./index107.js?v=1763689792";import"./useController5.js?v=1763689792";import"./useMethod5.js?v=1763689792";import"./useController4.js?v=1763689792";import"./useStore11.js?v=1763689792";import"./useMethod7.js?v=1763689792";import"./index118.js?v=1763689792";import"./useMethod9.js?v=1763689792";import"./useMethod11.js?v=1763689792";import"./header-nav-tools.vue_vue_type_script_setup_true_lang.js?v=1763689792";const ue={class:"cert-info"},ne={class:"cert-value"},ie={class:"cert-info"},de={class:"cert-value"},ce={class:"mb-16px flex justify-between gap-[10px]"},me={class:"w-48%"},pe={class:"w-48%"},ve={class:"mb-12px flex"},_e=a(b({__name:"other",setup(a){const{keys:t,crt:s,domains:l,menuData:o}=k(He()),{onSave:r,onDel:u}=He(),n=j("popupClose");return(a,i)=>{var d;const c=O,m=e,p=P;return S(),g("div",null,[(null==(d=D(o))?void 0:d.row.ssl_status)?(S(),C(c,{key:0,class:"mb-16px",type:"success","show-icon":!1},{default:L(()=>{var e;return[V("div",ue,[i[4]||(i[4]=V("span",{class:"cert-label"},"品牌: ",-1)),V("span",ne,M(null==(e=D(o))?void 0:e.row.ssl_info.issuer),1)]),V("div",ie,[i[5]||(i[5]=V("span",{class:"cert-label"},"认证域名: ",-1)),V("span",de,M(D(l)),1)])]}),_:1})):A("",!0),V("div",ce,[V("div",me,[i[6]||(i[6]=V("div",{class:"mb-8px"},"密钥(KEY)",-1)),T(m,{type:"textarea",class:"!w-full",modelValue:D(t),"onUpdate:modelValue":i[0]||(i[0]=e=>I(t)?t.value=e:null),rows:14},null,8,["modelValue"])]),V("div",pe,[i[7]||(i[7]=V("div",{class:"mb-8px"},"证书(CRT/PEM格式)",-1)),T(m,{type:"textarea",class:"!w-full",modelValue:D(s),"onUpdate:modelValue":i[1]||(i[1]=e=>I(s)?s.value=e:null),rows:14},null,8,["modelValue"])])]),V("div",ve,[T(p,{type:"primary",onClick:i[2]||(i[2]=e=>D(r)(D(n)))},{default:L(()=>[...i[8]||(i[8]=[N(" 保存 ",-1)])]),_:1}),T(p,{onClick:i[3]||(i[3]=e=>D(u)(D(n)))},{default:L(()=>[...i[9]||(i[9]=[N(" 关闭 ",-1)])]),_:1})])])}}}),[["__scopeId","data-v-3dc2a7c3"]]),{setApplyInfo:fe,letApplyInfo:he}=ae(),ye=R(null),we=R([]),xe=R(!1),be=R("");R(!1);const ke=R([]),je=E({resource:"1",auth_to:!1,autoWildcard:!1,domain:[],checkList:[]}),Se=R(!1),ge=R(""),De=(e,a)=>{if(!1===e.status&&e.hasOwnProperty("msg")&&o(e.msg))l.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:e.msg,type:"error",showClose:!0,duration:0});else if(!0!==e.status&&"pending"!==e.status&&void 0===(null==e?void 0:e.save_path))$(e,he.value.dnsTable,he.value.info);else{if("pending"===e.status&&"dns"===a.auth_type){we.value=[];for(let a=0;a<e.auths.length;a++){let t=[];const s=e.auths[a].domain.replace("*.","");t.push({domain:"_acme-challenge.".concat(s),type:"TXT",auth_value:e.auths[a].auth_value,must:"是",force:"是"}),t.push({domain:s,type:"CAA",auth_value:'0 issue "letsencrypt.org"',must:"否",force:"否"}),we.value.push({domain:e.auths[a].domain,data:t})}return e.hasOwnProperty("error")?xe.value=e.error:xe.value=!1,fe(e,a),void(Se.value=!0)}Ve(e)}},Ce=async e=>{const a=await ee(),{data:t}=await te({index:ge.value,domain:e.domain});a._props.onCancel(),Se.value=!1,"valid"===t.status?l.success("验证成功"):!0===t.status?Ve(t):$(t,e.data,{auth_type:"dns"})},Le=async()=>{const e=await ee(),a=await r({request:se({index:ge.value}),message:!1});e._props.onCancel(),Se.value=!1,!0===a.status?Ve(a):$({msg:a.data},[],{auth_type:"dns"})},Ve=async e=>{r({loading:"正在部署证书，请稍候...",request:u({domain:e.domains[0],key:e.private_key,csr:e.cert+e.root}),message:!0,success:e=>{!0===e.status&&(l.success("证书部署成功"),ye.value(),oe())}})},Me=R([{label:"解析域名",prop:"domain"},{label:"记录值",prop:"auth_value",render(e,a){const s=e.auth_value;return T("div",{class:"flex items-center"},[T("div",{class:"truncate w-[15rem]"},[s]),T("span",{class:"svgtofont-icon-copy ml-[4px] text-secondary text-medium w-[1.6rem] cursor-pointer",onClick:()=>t({value:s})},null)])}},{label:"类型",prop:"type",render:(e,a)=>{T("span",null,[e.type])}},{label:"必需",prop:"must",width:100}]),Ae=R([{text:"解析域名需要一定时间来生效,完成所以上所有解析操作后,请等待1分钟后再点击验证按钮"},{text:""},{text:"若您使用的是宝塔云解析插件,阿里云DNS,DnsPod作为DNS,可使用DNS接口自动解析"}]),Te=async e=>{try{const a={search_limit:e.search_limit||0,search_name:e.search||"",force_refresh:1},{data:t}=await r({request:le(a)});return n(t)||l.request(t),{data:t,total:0,other:{}}}catch(a){return{data:[],total:0,other:{}}}},Ie=async e=>{var a;const{MAIL_DOMAIN_SSL:t}=await s(()=>Promise.resolve().then(()=>We),void 0,import.meta.url),l=t(),{menuData:o}=k(l);r({loading:"正在部署证书，请稍候...",message:!0,request:i({ssl_hash:e.hash,domain:null==(a=o.value)?void 0:a.row.domain}),success:async e=>{e.status&&(oe(),ye.value())}})},Ne={class:"p-[12px] border-[1px] w-[50rem] h-[22rem] flex flex-col overflow-auto rounded-small border-light checkGroup"},Oe={class:"w-[41rem] flex items-center justify-between"},Pe={class:"p-[1.5rem]"},Re={class:"ml-[.4rem] text-danger"},Ee={class:"max-h-[38rem] overflow-auto"},qe={key:0,class:"flex justify-end"},Ue=b({__name:"apply",setup(e){const a=He(),{menuData:t}=k(a);ye.value=j("popupClose");const o=R([{content:"如开启后无法使用HTTPS访问，请检查安全组是否正确放行443端口"},{content:()=>T("span",null,[N("在DNS验证中，我们提供了多种自动化DNS-API，并提供了手动模式-"),T("span",{class:"bt-link",onClick:()=>{d(),c.push({name:"domain"})}},[N("点击添加DNS接口")])])},{content:"使用DNS接口申请证书可自动续期，手动模式下证书到期后需重新申请"}]),{BtForm:r,submit:u,param:n}=m({data:je,options:e=>q(()=>[{type:"radio",label:"验证方法",key:"resource",options:[{label:"DNS验证(支持通配符)",value:"1"}]},{type:"custom",render:()=>T(p,{label:" "},{default:()=>[T(U,{modelValue:e.value.auth_to,"onUpdate:modelValue":a=>e.value.auth_to=a},{default:()=>[N(" 手动解析 ")]})]})},{type:"custom",render:()=>T(p,{label:" "},{default:()=>[T(U,{modelValue:e.value.autoWildcard,"onUpdate:modelValue":a=>e.value.autoWildcard=a},{default:()=>[N("自动组合泛域名")]}),T("div",{class:"text-small"},[N("* 如需申请通配符域名请勾选此项，且不要在下方域名列表中选中泛域名")])]})},{type:"slots",key:"domain"},{type:"custom",render:()=>T(p,{label:" "},{default:()=>[T(P,{type:"primary",onClick:()=>u()},{default:()=>[N("申请证书")]})]})},{type:"help",options:o.value}]),submit:async e=>await(async e=>{var a,t;const{MAIL_DOMAIN_SSL:o}=await s(()=>Promise.resolve().then(()=>We),void 0,import.meta.url),r=o(),{menuData:u}=k(r);if(0===e.value.checkList.length)return l.error("请选择一个域名"),!1;if(!(null==(t=null==(a=u.value)?void 0:a.row)?void 0:t.dns_id)&&!e.value.auth_to)return l.error("选中的域名存在未设置DNS接口配置"),!1;let n={domains:JSON.stringify(e.value.checkList),auth_type:"dns",auth_to:e.value.auth_to?"dns":JSON.stringify(e.value.checkList),auto_wildcard:e.value.autoWildcard?"1":"0"};try{const a=await ee(),t=await Z(n);ge.value=t.data.index,a._props.onCancel(),De(t.data,{auth_type:"dns",...e.value}),Ae.value[1].text="可通过CMD命令来手动验证域名解析是否生效: nslookup -q=txt _acme-challenge.".concat(je.checkList[0].replace("*.",""))}catch(i){}})(e)});return B(()=>{je.checkList=[],je.auth_to=!1,je.autoWildcard=!1,je.domain=[],(async()=>{const{MAIL_DOMAIN_SSL:e}=await s(()=>Promise.resolve().then(()=>We),void 0,import.meta.url),a=e(),{menuData:t}=k(a);ke.value=[],ke.value.push(t.value.row.domain),je.checkList=ke.value})()}),(e,a)=>{const s=P,l=z,o=X,u=v,i=Y,d=_,c=f;return S(),g(H,null,[T(D(r),{class:"p-2rem"},{domain:L(()=>[T(o,{label:"域名"},{default:L(()=>[V("div",Ne,[T(l,{class:"flex flex-col",modelValue:D(n).checkList,"onUpdate:modelValue":a[0]||(a[0]=e=>D(n).checkList=e)},{default:L(()=>[(S(!0),g(H,null,W(D(ke),(e,l)=>(S(),g("div",{class:"flex flex-col",key:l},[(S(),C(D(U),{class:"w-full !mx-0 mb-[4px] overflow-hidden",value:e,key:e,border:""},{default:L(()=>{var l;return[V("div",Oe,[V("span",null,M(e),1),(null==(l=D(t))?void 0:l.row.dns_id)||D(je).auth_to?A("",!0):(S(),C(s,{key:0,type:"primary",size:"small",class:"ml-auto"},{default:L(()=>[...a[2]||(a[2]=[N(" 配置DNS ",-1)])]),_:1}))])]}),_:2},1032,["value"]))]))),128))]),_:1},8,["modelValue"])])]),_:1})]),_:1}),T(c,{modelValue:D(Se),"onUpdate:modelValue":a[1]||(a[1]=e=>I(Se)?Se.value=e:null),area:70,title:"手动解析TXT记录"},{default:L(()=>[V("div",Pe,[a[5]||(a[5]=N(" 请按以下列表做TXT解析: ",-1)),V("span",Re,M(D(be)),1),T(i,null,{content:L(()=>[V("div",Ee,[(S(!0),g(H,null,W(D(we),(e,t)=>(S(),g(H,null,[e.data.length?(S(),g("div",{key:t},[V("span",null,"验证域名："+M(e.domain),1),T(u,{class:"my-[1rem]",column:D(Me),data:e.data},null,8,["column","data"]),D(xe)?(S(),g("div",qe,[T(s,{type:"default",onClick:a=>D(Ce)(e)},{default:L(()=>[...a[3]||(a[3]=[N("验证",-1)])]),_:1},8,["onClick"])])):A("",!0)])):A("",!0)],64))),256))])]),"footer-right":L(()=>[D(xe)?A("",!0):(S(),C(s,{key:0,type:"default",onClick:D(Le)},{default:L(()=>[...a[4]||(a[4]=[N("验证",-1)])]),_:1},8,["onClick"]))]),_:1}),T(d,{list:D(Ae),listStyle:"disc",class:"ml-[20px]"},null,8,["list"])])]),_:1},8,["modelValue"])],64)}}}),Be=b({__name:"folder",setup(e){const{BtTable:a,BtSearch:t,BtTableSelect:s,refresh:l}=h({request:Te,columns:[{label:"域名",prop:"subject",render:e=>{var a;return F("div",{class:"whitespace-pre-wrap"},(null==(a=e.dns)?void 0:a.join("\n"))||e.subject)}},{label:"到期时间",prop:"not_after"},{label:"品牌",prop:"info.issuer",showOverflowTooltip:!0},{label:"位置",render:e=>e.cloud_id>0?"云端":"本地"},re([{onClick:Ie,title:"部署"}])]});return(e,t)=>(S(),g("div",null,[T(D(a),{"max-height":500})]))}}),He=G("MAIL_DOMAIN_SSL",()=>{const e=R("other"),a=[{type:"other",title:"当前证书",component:_e},{type:"apply",title:"申请证书",component:Ue},{type:"folder",title:"证书夹",component:Be}],t=R(""),s=R(""),o=R(),r=q(()=>{var e,a;return((null==(a=null==(e=o.value)?void 0:e.row)?void 0:a.ssl_info.dns)||[]).join(", ")});return{menu:e,menus:a,menuData:o,initMenu:e=>{o.value={row:e.row,onRefresh:()=>{e.onRefresh&&e.onRefresh()}},e.row.ssl_status&&(t.value=e.row.ssl_info.key,s.value=e.row.ssl_info.src)},keys:t,crt:s,domains:r,onSave:async e=>{var a,r;if(!t.value||""===t.value||!s.value||""===s.value)return void l.error("证书不能为空");const{data:n}=await u({domain:null==(a=o.value)?void 0:a.row.domain,key:t.value,csr:s.value});if(l.request(n),!n.status)return!1;null==(r=o.value)||r.onRefresh(),e()},onDel:async e=>{var a,r;try{await y({title:"确认删除",content:"是否删除SSL证书?"});const{data:u}=await w({domain:null==(a=o.value)?void 0:a.row.domain,key:t.value,csr:s.value});if(l.request(u),!u.status)return!1;null==(r=o.value)||r.onRefresh(),e()}catch(u){}}}}),We=Object.freeze(Object.defineProperty({__proto__:null,MAIL_DOMAIN_SSL:He,default:He},Symbol.toStringTag,{value:"Module"})),ze={class:"h-full p-16px"},Xe=b({__name:"index",props:{compData:{}},setup(e){const{menu:a,menuData:t}=k(He()),{initMenu:s,menus:l}=He();return s(e.compData),(e,s)=>{const o=K,r=x;return S(),g("div",ze,[T(r,{modelValue:D(a),"onUpdate:modelValue":s[0]||(s[0]=e=>I(a)?a.value=e:null),type:"card"},{default:L(()=>[(S(!0),g(H,null,W(D(l),e=>(S(),C(o,{key:e.type,label:e.title,name:e.type},{default:L(()=>[(S(),C(J(e.component),Q({ref_for:!0},D(t)),null,16))]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])])}}});export{Xe as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
