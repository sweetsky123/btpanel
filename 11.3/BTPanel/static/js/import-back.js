import{_ as a}from"./index123.js?v=1763689792";import{p as e,Q as t,M as s,iT as l,W as o,P as n,l as i,$ as r,k as m,j as d}from"./utils-lib.js?v=1763689792";import{c,r as p,o as u,aE as f,bS as v,v as g,I as w,x as h,y as x,e as y,C as b,A as _,D as k,z as j,G as q,J as S,S as V,R as z,H as C,b2 as D,ad as H,ab as M}from"./base-lib.js?v=1763689792";import{_ as U}from"./index109.js?v=1763689792";import{_ as O}from"./index118.js?v=1763689792";import{restoreModuleBack as T,restoreBack as Y,getImportLog as A,getBackup as F,getModulesBackup as J}from"./database.js?v=1763689792";import{g as N}from"./useStore2.js?v=1763689792";import{h as P,u as R}from"./column.js?v=1763689792";import{f as E}from"./validator.js?v=1763689792";import{t as G,v as I}from"./useMethod4.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./index107.js?v=1763689792";const Q={class:"p-[20px]"},W={class:"flex items-center"},$={key:0,class:"ml-[1.2rem]"},B={class:"p-2rem flex flex-col"},K=c({__name:"import-back",props:{compData:{default:{}}},setup(c){const{refs:{tabActive:K}}=N(),L=c,X=p(0),Z=p([]),aa=p(!1),ea=p({}),ta=p(!1),sa=p(),la=u({password:""}),oa=p(!1),na=p(!1),ia=p(""),ra=[{content:"仅支持sql、zip、sql.gz、(tar.gz|gz|tgz)"},{content:"zip、tar.gz压缩包结构：test.zip或test.tar.gz压缩包内，必需包含test.sql"},{content:"若文件过大，您还可以使用SFTP工具，将数据库文件上传到您设置的默认备份目录"},{content:"若未设置默认备份目录，默认路径为/www/backup/database"}],ma=u({password:[{required:!0,message:"请输入压缩密码",trigger:"blur"}]}),da=u({p:1,limit:10,search:""}),ca=()=>{E({type:"file",path:"/www/backup",change:async a=>{pa({path:a})},confirmText:"导入"})},pa=async(a,s=!1)=>{ea.value=a,await e({title:"导入数据库",content:'<div class="text-base leading-2rem">【'.concat(L.compData.name,"】数据库将被覆盖，是否继续操作？</div>"),isHtml:!0,icon:"warning-filled",type:"calc"});let l={file:a.path,name:L.compData.name};"mysql"===K.value?(s&&(l.disk_check=!0),ua(l,()=>pa(a,!0))):await t({request:T({data:JSON.stringify(l)},K.value),loading:"正在导入数据库,请稍后...",message:!0})},ua=async(a,e)=>{var s;const l=G({type:"import",config:{name:L.compData.name}}),o=await l,n=await t({request:Y(a),message:!0});return"请您输入密码"===n.msg?(null==o||o.unmount(),void(ta.value=!0)):-1!==(null==(s=n.msg)?void 0:s.indexOf("警告"))?(await fa(n.msg),void e()):void(null==o||o.unmount())},fa=a=>e({title:"提示",isHtml:!0,width:"50rem",iconColor:"error",confirmText:"继续导入",content:'<div class="flex"><div><div>'.concat(a,"</div><div>\n\t\t\t<p>如继续导入可能会有以下影响：</p>\n\t\t\t<p>1.导入数据不完整</p>\n\t\t\t<p>2.系统运行缓慢</p>\n\t\t\t<p>3.面板无法正常工作</p>\n\t\t\t<p>4.mysql无法正常运行</p></div></div></div>")}),va=async(a=!1)=>{await sa.value.validate();let e={file:ea.value.path,name:L.compData.name,password:la.password};a&&(e.disk_check=!0),ua(e,()=>va(!0))},ga=()=>{oa.value=!0,wa()},wa=async a=>{var e;-1!==(null==(e=(await t({loading:na,request:A(),data:{msg:[String,ia]}})).msg)?void 0:e.indexOf("Database recovery successful"))&&s.success("导入已完成"),a&&s.success("刷新成功")},ha=()=>{I(()=>xa())},xa=async()=>{await t({loading:aa,request:"mysql"===K.value?F({...da}):J({data:JSON.stringify({...da})},K.value),data:{data:[Array,Z],page:o(X)}})},ya=[{label:"文件名",prop:"name"},{label:"修改时间",width:200,render:a=>{const e=new Date(Math.floor(1e3*a.mtime));return f("span",v(e,"YYYY-MM-DD HH:mm:ss"))}},P({prop:"size",width:100}),R([{onClick:a=>pa(a),title:"导入"},{onClick:a=>(async a=>{await e({title:"删除文件",content:"删除文件【".concat(a.name,"】后，该数据库文件将迁至回收站，是否继续操作？"),icon:"warning-filled"}),await t({request:l({path:a.path}),loading:"正在删除文件，请稍后...",message:!0}),xa()})(a),title:"删除"}])];return g(()=>{xa(),(async()=>{const a=await t({request:A(),data:{db_name:String}});(null==a?void 0:a.db_name)&&G({type:"import",config:{name:null==a?void 0:a.db_name}})})()}),(e,t)=>{const s=C,l=D,o=n,c=i,p=O,u=U,f=r,v=m,g=H,T=M,Y=d,A=a,F=w("bt-loading"),J=w("focus");return h(),x("div",Q,[y(u,null,{"header-left":b(()=>[_("div",W,[y(s,{onClick:ha},{default:b(()=>[...t[8]||(t[8]=[k("从本地上传",-1)])]),_:1}),"mysql"===j(K)?(h(),x("div",$,[y(s,{onClick:ca},{default:b(()=>[...t[9]||(t[9]=[k("从本机导入",-1)])]),_:1}),y(l,{direction:"vertical",class:"!h-2rem !mx-1.2rem"}),y(s,{onClick:ga},{default:b(()=>[...t[10]||(t[10]=[k("显示日志",-1)])]),_:1})])):q("",!0)])]),"header-right":b(()=>[y(o,{modelValue:j(da).search,"onUpdate:modelValue":t[0]||(t[0]=a=>j(da).search=a),placeholder:"请输入搜索关键字",onSearch:xa},null,8,["modelValue"])]),content:b(()=>[S(y(c,{column:ya,data:j(Z),"max-height":"360"},null,8,["data"]),[[F,j(aa)]])]),"footer-right":b(()=>[y(p,{total:j(X),page:j(da).p,"onUpdate:page":t[1]||(t[1]=a=>j(da).p=a),row:j(da).limit,"onUpdate:row":t[2]||(t[2]=a=>j(da).limit=a),onChange:xa},null,8,["total","page","row"])]),_:1}),y(f,{options:ra,class:"ml-[20px] mt-[20px]"}),y(Y,{title:"导入数据库",modelValue:j(ta),"onUpdate:modelValue":t[5]||(t[5]=a=>z(ta)?ta.value=a:null),area:40,showFooter:"",onConfirm:va},{default:b(()=>[y(T,{model:j(la),ref_key:"inputMysqlForm",ref:sa,class:"p-[20px]",rules:j(ma),onSubmit:t[4]||(t[4]=V(()=>{},["prevent"]))},{default:b(()=>[t[11]||(t[11]=_("div",{class:"flex items-center mt-[1rem] mb-[2rem]"},[_("i",{class:"el-icon-warning text-[4rem] text-warning"}),_("div",{class:"ml-[1rem] text-medium leading-[2.2rem] text-secondary"},"当前文件存在压缩密码，请输入压缩密码进行导入")],-1)),y(g,{label:"压缩密码",prop:"password"},{default:b(()=>[S(y(v,{placeholder:"如未设置压缩密码，可为空",modelValue:j(la).password,"onUpdate:modelValue":t[3]||(t[3]=a=>j(la).password=a)},null,8,["modelValue"]),[[J]])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),y(Y,{title:"显示日志",modelValue:j(oa),"onUpdate:modelValue":t[7]||(t[7]=a=>z(oa)?oa.value=a:null),area:70},{default:b(()=>[S((h(),x("div",B,[_("div",null,[y(s,{onClick:t[6]||(t[6]=a=>wa(!0)),type:"default",class:"!mb-1rem"},{default:b(()=>[...t[12]||(t[12]=[k("刷新日志",-1)])]),_:1})]),y(A,{class:"h-41rem",content:j(ia),isHtml:!0,fullScreen:{title:"全屏查看【数据库导入】日志",onRefresh:wa}},null,8,["content","fullScreen"])])),[[F,j(na)]])]),_:1},8,["modelValue"])])}}});export{K as default};
