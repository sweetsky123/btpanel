var e=Object.defineProperty,t=(t,i,s)=>(((t,i,s)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s})(t,"symbol"!=typeof i?i+"":i,s),s);import{x as i,l as s,_ as a,b6 as l,bi as o,al as r,lh as d,n,b as u,az as p,p as h,e as c}from"./utils-lib.js?v=1763689792";import{c as m,r as f,x as g,y as v,A as S,e as T,z,L,n as F,o as b,g as w,v as y,aG as x,J as I,K as _,F as U,C as k,D as E,G as N,B as C,M as D,O as P,at as R,as as j,ar as G,H as M,aT as B}from"./base-lib.js?v=1763689792";import{_ as O}from"./index110.js?v=1763689792";import{s as q}from"./vue-virtual-scroller.esm.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";const A={class:""},H=a(m({__name:"file-cover-confirm",props:{compData:{default:()=>{}}},setup(e,{expose:t}){const a=e,l=f([{label:"文件名",prop:"name"},{label:"文件差异(本地->线上)",render:e=>"".concat(i(e.locaSize)," -> ").concat(i(e.size))}]);return t({onConfirm:e=>(a.compData.confirm(e,!0),!1),onCancel:e=>(a.compData.cancel(e,!1),!1)}),(e,t)=>{const i=s;return g(),v("div",{class:L(["confirm-default","text-default relative p-2rem"])},[t[0]||(t[0]=S("div",{class:"content flex items-center mb-[10px]"},[S("i",{class:"svgtofont-el-warning text-titleLarge text-warning"}),S("div",{class:"message flex flex-col flex-1 ml-4 py-[.3rem] leading-[2.4rem] text-base"},[S("div",{class:"text text-base text-secondary leading-[2.5rem]"},"检测到上传目录包含重复文件，是否覆盖？")])],-1)),S("div",A,[T(i,{column:z(l),data:a.compData.data,"max-height":170},null,8,["column","data"])])])}}}),[["__scopeId","data-v-c8d5190f"]]),K=u();class X{constructor(e){t(this,"target",""),t(this,"uploadPath",""),t(this,"uploadElement",null),t(this,"loading",{close:()=>{}}),t(this,"isUpload",!0),t(this,"isGetFiles",!1),t(this,"readFileTimeout",0),t(this,"limit",{size:32212254720,number:1e3}),t(this,"uploadStatus","paused"),t(this,"uploadLimitSize",2097152),t(this,"uploadList",[]),t(this,"uploadTime",{endTime:0,startTime:0}),t(this,"uploadInfo",{estimatedTime:0,uploadedSize:0,speedInterval:null,speedAverage:0,uploadTime:0,fileSize:0,startTime:0,endTime:0,success:0,error:0}),t(this,"fileList",[]),t(this,"fileTotalSize",0),t(this,"fileTotalNumber",0),t(this,"uploadInterval",0),t(this,"uploadCycleSize",[]),t(this,"speedLastTime",0),t(this,"timerSpeed",0),t(this,"uploadError",0),t(this,"nodeId",0),t(this,"isOpenCoverLayer",0),t(this,"uploadedFiles",[]),t(this,"initData",(e=!1)=>{this.uploadStatus="paused",this.uploadList=[],this.isUpload=!0,this.uploadTime={endTime:0,startTime:0},this.isGetFiles=!1,this.uploadInfo={estimatedTime:0,uploadedSize:0,speedInterval:null,speedAverage:0,uploadTime:0,fileSize:0,startTime:0,endTime:0,success:0,error:0},this.fileList=[],this.fileTotalSize=0,this.fileTotalNumber=0,this.uploadInterval=0,this.uploadCycleSize=[],this.speedLastTime=0,this.timerSpeed=0,e&&this.watchFileUploadStatus({status:"paused",timeElapsed:0,averageSpeed:0,uploadSize:"0B",successNumber:0,errorNumber:0})}),t(this,"watchFileList",e=>e),t(this,"watchFileUploadSpeed",e=>e),t(this,"watchFileUploadStatus",e=>e),t(this,"fileUploadLimit",(e,t)=>{const s=t;if(!this.isGetFiles)return!1;const a=e.name.split(".");let o=(t=t||e.webkitRelativePath).split("/");t=("/"+o.slice(0,o.length-1).join("/")).replace("//","/");let r=!1;return this.fileList.forEach((t,a)=>{if(t.path+t.name==s&&t.size==i(e.size))return K.error("该文件已存在"),r=!0}),!!r||(this.fileList=this.fileList.filter((e,t)=>e.path+e.name!==s),this.fileList.push({vid:l(8),file:e,path:t,name:e.name,size:i(e.size),type:a.length>1?a[a.length-1]:"txt",status:"paused",progress:0}),this.watchFileList(this.fileList),this.fileTotalSize+=e.size,this.fileTotalNumber++,this.fileTotalNumber>=this.limit.number?(K.error("当前文件数量已超过文件上传上限".concat(this.limit.number,"个， 请压缩文件夹后重试！")),!1):!(this.fileTotalSize>=this.limit.size)||(K.error("当前文件大小已超过文件上传".concat(i(this.limit.size),"限制， 请使用SFTP/FTP等工具上传文件！")),!1))}),t(this,"uploadFile",(e=0,t=0)=>0!==this.fileList.length&&(0==e&&0==this.uploadList.length&&(this.isOpenCoverLayer=0,this.uploadStatus="uploading",this.uploadedFiles=[],this.uploadCycleSize=[],this.uploadTime.startTime=this.getTimeReal()),this.fileList.length===t?(clearTimeout(this.uploadInterval),this.uploadStatus="success",this.uploadTime.endTime=this.getTimeReal(),this.renderUploadSpeed(),this.initData(),!1):void this.uploadFileItem(e,t))),t(this,"uploadFileItem",async(e,t)=>{let i=this.fileList[t],s=0;if(null==i)return!1;const a=this.uploadInfo.uploadedSize;this.uploadInterval=setInterval(()=>{4===this.uploadCycleSize.length&&this.uploadCycleSize.splice(0,1),this.uploadCycleSize.push(Math.abs(this.uploadInfo.uploadedSize-a))},1e3),this.uploadInfo.endTime=this.getTimeReal();const l=(this.uploadInfo.endTime-this.uploadInfo.startTime)/1e3;this.timerSpeed=Number((this.uploadInfo.fileSize/l).toFixed(2)),this.uploadInfo.startTime=this.getTimeReal();let d=this.getUpdateSpeed(),n=this.uploadLimitSize;const u=Math.floor(d/this.uploadLimitSize);u&&t>1&&(n*=u>4?4:u),0==e&&(this.uploadInfo.startTime=this.getTimeReal(),i={...i,progress:0,upload:2,upload_size:"0B"}),s=Math.min(i.file.size,e+n),this.uploadInfo.fileSize=s-e;const p=this.uploadPath+i.path,h=new FormData,{request_time:c,request_token:m}=o();h.append("f_path",p),h.append("f_name",i.name),h.append("f_size",i.file.size),h.append("f_start",e.toString()),h.append("blob",i.file.slice(e,s)),h.append("node_id",this.nodeId.toString()),h.append("request_time","".concat(c)),h.append("request_token",m);try{const{data:a}=await r({method:"post",url:""+this.target,headers:{"x-http-token":window.vite_public_request_token},data:h});await this.watchUploadStatus(a,i,t,{fileStart:e,fileEnd:s})}catch(f){}}),t(this,"fileSelectHandler",(e,t)=>{var i,s;if(this.readFileTimeout=0,this.isGetFiles=!0,this.loading=K.load("正在获取上传文件，请稍候..."),null==(i=e.target)?void 0:i.files){const i=null==(s=e.target)?void 0:s.files;[].forEach.call(i,e=>{this.traverseFileTree(e,t)})}else if(e.dataTransfer.items){const i=e.dataTransfer.items;[].forEach.call(i,e=>{const i=(e.webkitGetAsEntry||e.getAsEntry).call(e);if(i){if(!this.isUpload)return!1;this.traverseFileTree(i,t)}})}}),t(this,"traverseFileTree",(e,t)=>{const i=e.fullPath||"";if(e.isFile)e.file(e=>{this.isGetFiles=this.fileUploadLimit(e,i),clearTimeout(this.readFileTimeout),this.readFileTimeout=setTimeout(()=>{if(this.loading.close(),!this.isGetFiles)return this.clearUploadFileList(),this.watchFileList(this.fileList),!1;t&&t(this.fileList)},100)});else if(e.isDirectory){const i=e.createReader(),s=e=>{[].forEach.call(e,e=>{if(!this.isUpload)return!1;this.traverseFileTree(e,t)}),e.length>0&&i.readEntries(s)};i.readEntries(s),setTimeout(()=>{if(0===this.fileList.length&&this.isGetFiles)return K.error("拖拽上传文件夹内容为空")},500)}}),t(this,"watchUploadStatus",(e,t,s,a)=>{"number"==typeof e?(this.renderUploadSpeed(s,{...t,progress:(e/t.file.size*100).toFixed(2),upload:2,upload_size:i(e)}),a.fileEnd!=e?this.uploadInfo.uploadedSize+=e:this.uploadInfo.uploadedSize+=parseInt((a.fileEnd-a.fileStart).toString()),setTimeout(()=>{this.uploadFile(e,s)},50)):(e.status?(this.uploadInfo.success++,this.uploadInfo.endTime=this.getTimeReal(),this.uploadInfo.uploadedSize+=parseInt((a.fileEnd-a.fileStart).toString()),this.renderUploadSpeed(s,{...t,upload:1,upload_size:t.size})):(this.renderUploadSpeed(s,{...t,progress:100,upload:-1,errorMsg:e.msg}),this.uploadInfo.error++),this.uploadFile(0,++s))}),t(this,"getUpdateSpeed",()=>{let e=0;for(let i=0;i<this.uploadCycleSize.length;i++)e+=this.uploadCycleSize[i];const t=e/this.uploadCycleSize.length;return isNaN(t)?0:t}),t(this,"renderUploadSpeed",(e,t)=>{if(void 0===e){const e=this.getTimeReal();return void this.watchFileUploadStatus({status:"success",timeElapsed:this.diffTime(this.uploadTime.startTime,e),averageSpeed:this.toSize(this.uploadInfo.uploadedSize/((e-this.uploadTime.startTime)/1e3)),uploadSize:i(this.uploadInfo.uploadedSize),successNumber:this.uploadInfo.success,errorNumber:this.uploadInfo.error})}try{const s=this.fileList[e];if(1===t.upload||-1===t.upload){s.is_upload=!0,this.uploadList.push(s);const e=document.querySelector(".file-upload-list");e&&(1===this.uploadList.length&&(e.scrollTop=0),this.uploadList.length>1&&(e.scrollTop+=45.5))}s.progress=t.progress,s.status=this.isUploadStatus(t.upload),s.message=t.errorMsg||"",this.watchFileList(this.fileList),this.watchFileUploadSpeed({totalProgress:(this.uploadInfo.uploadedSize/this.fileTotalSize*100).toFixed(2),currentSpeed:i(isNaN(this.timerSpeed)?0:this.timerSpeed),timeRemaining:this.time(parseInt(((this.fileTotalSize-this.uploadInfo.uploadedSize)/this.timerSpeed*1e3).toString())),uploadList:this.uploadList.length})}catch(s){}}),t(this,"getFileName",e=>(e.path+"/"+e.name).replace(/\/\//,"/")),t(this,"useFileUploadExistsConfirm",async()=>{const e=this.fileList.map(e=>this.uploadPath+this.getFileName(e)),{data:t}=await d({files:e.join("\n"),node_id:this.nodeId.toString()});if(!t)return;const i=[];if(this.fileList.forEach((e,s)=>{const a=t[s];a.exists&&i.push({name:this.getFileName(e),size:a.size,locaSize:e.file.size})}),i.length){const e=(e,t)=>{if(!t)for(let s=this.fileList.length-1;s>=0;s--){const e=this.fileList[s];i.findIndex(t=>t.name.indexOf(e.name)>-1)>=0&&this.fileList.splice(s,1)}F(()=>{e(),this.fileList.length?this.uploadFile():this.clearUploadFileList()})};await n({title:"文件冲突确认",area:40,component:H,compData:{data:i,confirm:e,cancel:e},showFooter:!0,cancelText:"跳过",confirmText:"覆盖"})}else this.fileList.length&&this.uploadFile()}),t(this,"cancelFile",e=>{const t=this.fileList.filter((t,i)=>t.vid!==e.vid);this.fileList=t,this.watchFileList(this.fileList),0===this.fileList.length&&this.clearUploadFileList()}),t(this,"toSize",e=>{const t=[" B"," KB"," MB"," GB"," TB"," PB"];for(let i=0;i<t.length;i+=1){if(e<1024){let s=e.toFixed(2)+t[i];return isNaN(e.toFixed(2))||void 0===s?"0B":s}e/=1024}}),t(this,"time",e=>{let t=Math.floor(e/36e5),i=Math.floor(e/6e4),s=e%6e4/1e3,a=s+"秒";return i>0&&(a="".concat(i,"分钟").concat(s.toFixed(0),"秒")),t>0&&(a="".concat(t,"小时").concat(Math.floor((e-36e5*t)/6e4),"分钟")),a}),this.target=e.target,this.uploadPath=e.uploadPath,this.nodeId=e.nodeId,this.watchFileList=e.renewalData,this.watchFileUploadSpeed=e.renewalSpeed,this.watchFileUploadStatus=e.renewalStatus,this.initData()}uploadStatusInfo(e){return{success:"上传成功",error:"上传失败",uploading:"上传中",paused:"等待上传",waiting:"等待上传"}[e]}isUploadStatus(e){return{"-1":"error",0:"paused",1:"success",2:"uploading",3:"waiting"}[e]}getTimeReal(){return(new Date).getTime()}clearUploadFileList(){this.initData(!0),this.watchFileList(this.fileList)}diffTime(e,t){"number"!=typeof e&&(e=e.getTime()),"number"!=typeof t&&(t=t.getTime());const i=t-e,s=Math.floor(i/6e4),a=i%6e4/1e3;let l=a.toFixed(s>0?0:2)+"秒";return s>0&&(l=s+"分"+a.toFixed(0)+"秒"),l}}const J=e=>{e.preventDefault()},Q=e=>{const t=document.querySelector("#upload-mask");return window.addEventListener("dragenter",t=>{J(t),e.dragenter(t)}),null==t||t.addEventListener("dragenter",t=>{J(t),e.dragenter(t)}),null==t||t.addEventListener("dragleave",t=>{J(t),e.dragleave(t)}),null==t||t.addEventListener("dragover",t=>{J(t),e.dragover(t)}),null==t||t.addEventListener("drop",t=>{J(t),e.drop(t)}),e},V={id:"upload-mask"},W={class:"p-[20px]"},Y=["webkitdirectory"],Z={class:"mb-[16px] flex justify-between"},$={key:1,class:"upload-press"},ee={key:2,class:"upload-press"},te={key:3,class:"upload-files-tips"},ie={key:4,class:"uploader-list"},se={class:"th"},ae={class:"td justify-end"},le={class:"uploader-file tr"},oe={class:"td-block"},re={class:"td !w-[55%] flex"},de=["title"],ne={class:"td"},ue={class:"td"},pe={class:"truncate"},he={key:0},ce={class:"td justify-end"},me={class:"flex justify-end"},fe=a(m({__name:"node-upload",props:{compData:{default:()=>({path:"",nodeId:0,refresh:()=>{}})}},setup(e,{expose:t}){const i=e,s=u();let a=null;const l=f(),o=f(!1),r=f("paused"),d=f([]),n=f(),m=f(!1),F=b({totalProgress:0,uploadList:0,sizeUploaded:0,currentSpeed:0,timeRemaining:0,timeElapsed:0,averageSpeed:0,errorNumber:0,successNumber:0,uploadSize:""}),A=new X({target:"/mod/node/file_transfer/file_upload",uploadPath:i.compData.path,nodeId:i.compData.nodeId,renewalData:e=>{d.value=[...e]},renewalSpeed:e=>{F.totalProgress=e.totalProgress,F.uploadList=e.uploadList,F.sizeUploaded=e.sizeUploaded,F.currentSpeed=e.currentSpeed,F.timeRemaining=e.timeRemaining},renewalStatus:e=>{r.value=e.status,F.timeElapsed=e.timeElapsed,F.averageSpeed=e.averageSpeed,F.uploadSize=e.uploadSize,F.successNumber=e.successNumber,F.errorNumber=e.errorNumber}}),{uploadStatusInfo:H,initData:K,fileUploadLimit:J,cancelFile:fe}=A,ge=w(()=>!d.value.length),ve=w(()=>!d.value.length),Se=e=>(e.path+"/"+e.name).replace(/\/\//,"/"),Te=e=>{if(e.isFolder)return"folder";const t=e.name.split(".").pop();return["zip","rar","gz","tar","war","tgz","bz2","7z","tar.gz"].includes(t)?"compress":t},ze=e=>{A.isGetFiles=!0,"file"!==e&&p(e)?m.value=!0:m.value=!1,setTimeout(()=>{n.value.click()},0)},Le=e=>{const t=e.target.files;for(let s=0;s<t.length;s++){var i="/".concat(""==t[s].webkitRelativePath?t[s].name:t[s].webkitRelativePath);if(!J(t[s],i))return!1}if(!A.isGetFiles)return!1},Fe=e=>"success"===e.status?{transform:"translateX(-0%)"}:{transform:"translateX(-".concat(100-e.progress,"%)")},be=()=>{if(0===d.value.length)return s.error("请添加需要上传的文件");r.value="uploading",A.useFileUploadExistsConfirm()},we=()=>{K(),d.value=[],r.value="paused",n.value.value=""},ye=()=>{o.value=!0,"success"===r.value&&we()},xe=()=>{o.value=!1},Ie=e=>{o.value=!1,A.fileSelectHandler(e,e=>{d.value=e||[]})};return y(()=>{a={...Q({dragenter:ye,dragleave:xe,drop:Ie,dragover:()=>{}})}}),x(()=>{(e=>{const t=document.querySelector("#upload-mask");window.removeEventListener("dragenter",e.dragenter),null==t||t.removeEventListener("dragenter",e.dragenter),null==t||t.removeEventListener("dragover",e.dragover),null==t||t.removeEventListener("dragleave",e.dragleave),null==t||t.removeEventListener("drop",e.drop)})(a)}),t({onCancel:async()=>{try{if(["uploading","paused"].includes(r.value)&&d.value.length)return await h({title:"取消上传",width:"35rem",icon:"warning-filled",content:"是否取消上传，取消后将清空上传列表？"}),i.compData.refresh(),!0}catch(e){return!1}}}),(e,t)=>{const i=R,s=j,a=G,u=M,p=O,h=B,f=c;return g(),v("div",{class:"upload-file-view",ref_key:"upload",ref:l},[I(S("div",V,"请将需要上传的文件/文件夹拖到此处",512),[[_,z(o)]]),S("div",W,[z(r).indexOf("paused")>-1?(g(),v(U,{key:0},[S("input",{type:"file",ref_key:"uploadFileInput",ref:n,webkitdirectory:z(m),onChange:Le,style:{display:"none"},multiple:""},null,40,Y),S("div",Z,[T(a,{"split-button":"",type:"default","show-timeout":50,"hide-timeout":50,onClick:ze,onCommand:ze},{dropdown:k(()=>[T(s,{class:"w-[10rem]"},{default:k(()=>[T(i,{command:"file"},{default:k(()=>[...t[0]||(t[0]=[E("上传文件",-1)])]),_:1}),T(i,{command:"dir"},{default:k(()=>[...t[1]||(t[1]=[E("上传文件夹",-1)])]),_:1})]),_:1})]),default:k(()=>[t[2]||(t[2]=E(" 上传文件 ",-1))]),_:1}),T(u,{onClick:we,disabled:z(ge)},{default:k(()=>[...t[3]||(t[3]=[E("清空列表",-1)])]),_:1},8,["disabled"])])],64)):N("",!0),z(r).indexOf("uploading")>-1?(g(),v("div",$,[S("span",null,"总进度："+C(z(F).totalProgress)+"%",1),T(p),S("span",null,"正在上传：("+C("".concat(z(F).uploadList,"/").concat(z(d).length))+")",1),T(p),S("span",null,"上传速度："+C(z(F).currentSpeed)+"/s",1),T(p),S("span",null,"预计耗时："+C(z(F).timeRemaining),1)])):N("",!0),z(r).indexOf("success")>-1?(g(),v("div",ee,[S("span",null,"上传大小："+C(z(F).uploadSize),1),T(p),S("span",null,"共耗时："+C(z(F).timeElapsed),1),T(p),S("span",null,"平均上传速度："+C(z(F).averageSpeed)+"/s",1),T(p),S("span",null,"上传成功："+C(z(F).successNumber)+"个",1),I(T(p,null,null,512),[[_,z(F).errorNumber>0]]),I(S("span",null,"上传失败："+C(z(F).errorNumber)+"个",513),[[_,z(F).errorNumber>0]])])):N("",!0),z(ve)?(g(),v("div",te,[...t[4]||(t[4]=[S("span",null,"请将需要上传的文件/文件夹拖到此处",-1)])])):(g(),v("div",ie,[S("div",se,[t[5]||(t[5]=S("div",{class:"td !w-[55%]"},"文件名",-1)),t[6]||(t[6]=S("div",{class:"td"},"文件大小",-1)),t[7]||(t[7]=S("div",{class:"td"},"上传状态",-1)),I(S("div",ae,"操作",512),[[_,"success"!==z(r)]])]),S("div",null,[T(z(q),{class:L(["!mb-0 overflow-auto file-upload-list files-list","!h-[400px]"]),items:z(d),"item-size":45,buffer:800,"key-field":"vid"},{default:k(({item:e})=>[S("div",le,[S("div",{class:L({"td-progress":!0,error:"error"===e.status,success:"success"===e.status}),style:D(Fe(e))},null,6),S("div",oe,[S("div",re,[S("i",{class:L(["icon-bg","".concat(Te(e),"-icon")])},null,2),S("span",{class:"flex-1 w-0 ml-[4px] truncate h-[20px] leading-[20px]",title:Se(e)},C(Se(e)),9,de)]),S("div",ne,C(e.size),1),S("div",ue,[I(T(h,{effect:"dark",content:"".concat(z(H)(e.status)).concat(e.message?"，".concat(e.message):""),placement:"right","show-after":200},{default:k(()=>[I(S("span",pe,[E(C(z(H)(e.status))+" ",1),e.message?(g(),v("span",he," ,"+C(e.message),1)):N("",!0)],512),[[_,"uploading"!==e.status]])]),_:2},1032,["content"]),[[_,"uploading"!==e.status]]),I(S("span",null,[S("span",null,"上传中("+C(parseInt(e.progress))+"%)",1)],512),[[_,"uploading"===e.status]])]),I(S("div",ce,[I(T(f,{onClick:t=>z(fe)(e)},{default:k(()=>[...t[8]||(t[8]=[E("取消",-1)])]),_:1},8,["onClick"]),[[_,z(r).indexOf("paused")>-1]])],512),[[_,"success"!==z(r)]])])])]),_:1},8,["items"])])])),S("div",me,[z(r).indexOf("paused")>-1?(g(),P(u,{key:0,type:"primary",onClick:be},{default:k(()=>[...t[9]||(t[9]=[E(" 开始上传 ",-1)])]),_:1})):N("",!0),["success","error"].includes(z(r))?(g(),P(u,{key:1,type:"primary",onClick:we},{default:k(()=>[...t[10]||(t[10]=[E(" 继续上传 ",-1)])]),_:1})):N("",!0)])])],512)}}}),[["__scopeId","data-v-dda0d9ba"]]);export{fe as default};
