import{u as e,V as a,p as t,Q as l,aH as s,aK as n,b as i,ag as o,P as r,l as c,k as u,j as d,n as m,H as p,ah as v,aj as y,$ as f,_ as b}from"./utils-lib.js?v=1763689792";import{c as _,r as g,W as w,e as h,D as x,aE as A,o as V,v as k,I as j,x as C,y as I,z as q,C as T,A as U,R as H,J as R,O as S,H as z,ap as D,ad as E,ab as F,G as P,B as L}from"./base-lib.js?v=1763689792";import{_ as B}from"./index124.js?v=1763689792";import{_ as N}from"./index109.js?v=1763689792";import{getUserCert as O,downClientPfx as G,revokeClientCert as J,getSslList as K,getSslConfig as M,setSslConfig as Q,setSslVerify as W,getSslSiteList as $,deleteDirAuth as X,delFileDeny as Y,deleteDirAuthMultiple as Z,getFileDeny as ee,getDirAuth as ae}from"./site.js?v=1763689792";import{u as te}from"./useStore4.js?v=1763689792";import{_ as le}from"./index137.js?v=1763689792";import{a as se,u as ne}from"./column.js?v=1763689792";import{o as ie}from"./useController6.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./validator.js?v=1763689792";import"./index110.js?v=1763689792";import"./index107.js?v=1763689792";import"./index.vue_vue_type_style_index_0_scoped_cdc7f4d3_lang.js?v=1763689792";const oe={class:"h-full overflow-auto"},re={key:0},ce={class:"flex items-center"},ue={class:"ml-[20px]"},de={class:"flex items-center"},me={class:"p-[20px]"},pe={class:"p-[20px]"},ve=_({__name:"index",setup(m){const p=i(),{payment:v}=e(),{siteInfo:y}=te(),{authType:f}=v.value,b=g(null),_=g({status:!0}),P=g({title:"限制访问型证书-功能介绍",ps:"提供双向认证证书，可用于限制指定人员访问",source:61,isInstall:!1,desc:["限制指定人员访问","双向认证","内网自签SSL"],height:36,tabImgs:["https://www.bt.cn/Public/new/plugin/introduce/site/ssl_verify_preview.png"]}),L=[{label:"全部",value:0},{label:"正常",value:1},{label:"已撤销",value:-1}],X=w([{label:"使用者",prop:"client"},{label:"公司名称",prop:"company"},{label:"到期时间",width:220,render:e=>{if(e.day){let t=e.addtime+24*e.day*60*60;return h("span",null,[a(t,"yyyy-mm-dd"),x("（剩余"),e.day,x("天）")])}return"--"}},{label:"状态",render:e=>h("span",null,[1===e.status?"正常":0===e.status?"未知":"已撤销"])},{label:"操作",align:"right",render:e=>1!==e.status?A("span",{},"--"):A("div",[A("span",{class:{hidden:1!==e.status||e.day>30,"mr-[8px]":!0,"bt-link":!0,"cursor-pointer":!0},onClick:async()=>{try{const a=await O({client:e.client});p.request(a),Ae()}catch(a){}}},"续签"),A("span",{class:{"mr-[8px]":!0,hidden:1!==e.status,"bt-link":!0,"cursor-pointer":!0},onClick:async()=>{let a=p.load("正在请求下载，请稍后...");try{const t=await G({id:e.id});t.status?(window.open("/download?filename="+t.msg,"_blank","noopener,noreferrer"),a.close()):p.error(t.msg)}catch(t){}finally{a.close()}}},"下载"),A("span",{class:{hidden:1!==e.status,"bt-link":!0,"cursor-pointer":!0},onClick:async()=>{be(e)}},"撤销")])}]),Y=g([]),Z=g(!1),ee=g(0),ae=g(""),le=g(!1),se=g(!1),ne=g(!1),ie=V({company:"",domain:""}),ve=V({client:""}),ye=V({company:[{required:!0,message:"请输入公司名称",trigger:"blur"}],domain:[{required:!0,message:"请输入域名列表",trigger:"blur"}]}),fe=async()=>{(await l({loading:"正在生成，请稍后...",request:O({client:ve.client}),message:!0})).status&&_e()},be=async e=>{await t({title:"撤销证书【".concat(e.client,"】的访问证书"),content:"撤销颁发的访问证书后，证书将不在可用，是否继续操作？",icon:"warning-filled"});(await l({loading:"正在撤销，请稍后...",request:J({id:e.id}),message:!0})).status&&Ae()},_e=()=>{le.value=!1,ve.client=""},ge=()=>{var e;se.value=!1,null==(e=b.value)||e.clearValidate()},we=async()=>{await he(),se.value=!0},he=async()=>{try{if(P.value.isInstall||"ltd"!==f)return;const e=await M();e.data.length||se.value||(p.error("请先完善证书配置"),se.value=!0),ie.company=e.data[0].company,ie.domain=e.data[0].domain,ge()}catch(e){n(e)}},xe=async()=>{await b.value.validate();(await l({loading:"正在设置，请稍后...",request:Q(ie),message:!0})).status&&ge()},Ae=async()=>{var e,a,t;try{Z.value=!0;const{data:n}=await K({status:ee.value,search:ae.value});if((null==(e=n.msg)?void 0:e.includes("插件不存在"))||(null==(a=n.msg)?void 0:a.includes("未购买"))||(null==(t=n.msg)?void 0:t.includes("已到期"))){try{const{data:e}=await s({sName:"ssl_verify"});_.value.status=e.endtime>-1&&e.setup,P.value.isInstall="ltd"===f?!e.setup||"":!e.setup&&e.endtime>-1||"",P.value.pluginInfo=e}catch(l){}return}_.value.status=!0,Y.value=n}catch(l){n(l)}finally{Z.value=!1}},Ve=async e=>{const a=await l({loading:"正在设置，请稍后...",request:W({siteName:y.value.name,status:e?1:0}),message:!0});ne.value=a.status?e:!e,a.status&&(ne.value=e,ke(),Ae())},ke=async()=>{let e=p.load("正在获取状态，请稍后...");try{(await $()).data.forEach(e=>{e.name===y.value.name&&(ne.value=e.ssl_verify)})}catch(a){n(a)}finally{e.close()}};return k(async()=>{await Ae(),await he(),_.value.status&&await ke()}),(e,a)=>{var t;const l=z,s=D,n=o,i=r,m=c,p=u,v=E,y=F,f=d,g=N,w=B,A=j("bt-loading");return C(),I("div",oe,[(null==(t=q(_))?void 0:t.status)?(C(),I("div",re,[h(g,null,{"header-left":T(()=>[U("div",ce,[h(l,{onClick:a[0]||(a[0]=e=>le.value=!0),type:"primary"},{default:T(()=>[...a[9]||(a[9]=[x("生成证书",-1)])]),_:1}),U("div",ue,[a[10]||(a[10]=x(" 双向认证开关 ",-1)),h(s,{modelValue:q(ne),"onUpdate:modelValue":a[1]||(a[1]=e=>H(ne)?ne.value=e:null),onChange:Ve},null,8,["modelValue"])])])]),"header-right":T(()=>[U("div",de,[h(n,{type:"button",modelValue:q(ee),"onUpdate:modelValue":a[2]||(a[2]=e=>H(ee)?ee.value=e:null),options:L,onChange:Ae,class:"mr-[1rem] !flex-nowrap"},null,8,["modelValue"]),h(i,{class:"ml-[12px] w-[16rem]",modelValue:q(ae),"onUpdate:modelValue":a[3]||(a[3]=e=>H(ae)?ae.value=e:null),onSearch:Ae,placeholder:"请输入使用者"},null,8,["modelValue"])])]),content:T(()=>[R(h(m,{column:q(X),data:q(Y)},null,8,["column","data"]),[[A,q(Z)]])]),"footer-left":T(()=>[h(l,{type:"default",onClick:we},{default:T(()=>[...a[11]||(a[11]=[x("证书配置",-1)])]),_:1})]),"footer-right":T(()=>[...a[12]||(a[12]=[])]),popup:T(()=>[h(f,{title:"生成证书",modelValue:q(le),"onUpdate:modelValue":a[5]||(a[5]=e=>H(le)?le.value=e:null),area:42,showFooter:"",onCancel:_e,onConfirm:fe},{default:T(()=>[U("div",me,[h(y,{model:q(ve),ref:"generateFormRef"},{default:T(()=>[h(v,{label:"使用者"},{default:T(()=>[h(p,{modelValue:q(ve).client,"onUpdate:modelValue":a[4]||(a[4]=e=>q(ve).client=e),placeholder:"请输入使用者（如“研发部-张三”）",width:"24rem"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"]),h(f,{title:"证书配置",modelValue:q(se),"onUpdate:modelValue":a[8]||(a[8]=e=>H(se)?se.value=e:null),area:42,showFooter:"",onConfirm:xe},{default:T(()=>[U("div",pe,[h(y,{model:q(ie),ref_key:"certFormRef",ref:b,rules:q(ye)},{default:T(()=>[h(v,{label:"公司名称",prop:"company"},{default:T(()=>[h(p,{modelValue:q(ie).company,"onUpdate:modelValue":a[6]||(a[6]=e=>q(ie).company=e),placeholder:"请输入公司名称",width:"24rem"},null,8,["modelValue"])]),_:1}),h(v,{label:"使用者",prop:"domain"},{default:T(()=>[h(p,{type:"textarea",resize:"none",rows:6,modelValue:q(ie).domain,"onUpdate:modelValue":a[7]||(a[7]=e=>q(ie).domain=e),placeholder:"请输入域名列表，多个域名可以用英文状态下的逗号隔开",width:"24rem"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])])]),_:1},8,["modelValue"])]),_:1}),a[13]||(a[13]=U("ul",{class:"list-disc mt-[20px] pl-[28px]"},[U("li",null,"双向认证仅支持【HTTPS访问】，如需全站设置，还需通过网站设置开启【强制HTTPS】."),U("li",null,"给网站开启【双向认证】，开启后用户需要将【证书】导入到浏览器后才能访问该网站（目前支持Nginx/Apache）")],-1))])):(C(),S(w,{key:1,data:q(P),class:"!px-[20px] !pt-[8px]"},null,8,["data"]))])}}}),ye={class:"relative"},fe=_({__name:"index",props:{tabActive:{default:"encryptedAccess"},compData:{default:()=>({})}},setup(a){const s=a,{plugin:o}=e(),{siteInfo:r}=te(),u=i(),d=g(),y=g(!1),f=g([]),b=g(!1),_=async e=>{let a="encryptedAccess"===s.tabActive;await t({title:"删除".concat(a?"加密":"禁止","访问规则【").concat(e.name,"】"),content:"删除选中的规则后，".concat(a?"访问".concat(e.site_dir,"将不再需要安全验证，"):"该保护目录将失去防护，","是否继续操作？"),icon:"warning-filled",type:"calc"});(await l({loading:"正在删除，请稍后...",request:a?X({id:r.value.id,name:e.name}):Y({website:r.value.name,deny_name:e.name}),message:!0})).status&&V()},A=e=>{const a="encryptedAccess"===s.tabActive;m({isAsync:!0,title:"".concat(e?"编辑":"添加").concat(a?"加密访问":"禁止访问"),area:a&&e?58:46,showFooter:!a||!e,compData:{...e,id:r.value.id,website:r.value.name,refresh:V},component:()=>p(a?e?()=>import("./edit-pass-limit.js?v=1763689792"):()=>import("./add-pass-limit.js?v=1763689792"):()=>import("./add-forbid-limit.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})},V=()=>{"encryptedAccess"===s.tabActive?(async()=>{try{y.value=!0;const e=await ae({id:r.value.id});f.value=e.data[r.value.name]}catch(e){n(e)}finally{y.value=!1}})():"forbidAccess"===s.tabActive&&(async()=>{l({loading:y,request:ee({website:r.value.name}),data:[Array,f]})})()},H="encryptedAccess"===s.tabActive?w([se(),{label:"加密访问",prop:"site_dir"},{label:"名称",prop:"name"},{label:"用户",prop:"user_list",render:e=>e.user_list.join(",")},ne([{onClick:A,title:"编辑"},{onClick:_,title:"删除"}])]):w([{label:"名称",prop:"name"},{label:"保护的目录",prop:"dir"},{label:"规则",prop:"suffix"},ne([{onClick:A,title:"编辑"},{onClick:_,title:"删除"}])]),D=[{label:"删除加密访问",value:"delete",event:async(e,a,l,s,i)=>{var o;await t({title:"批量删除加密访问规则",content:"批量删除选中的加密访问规则，该操作可能会存在风险，是否继续？"});let c=u.load("正在删除,请稍后...");try{const e=await Z({site_id:r.value.id,names:l.value.map(e=>e.name)});let a=null==(o=e.data.success)?void 0:o.map(e=>({name:e,status:!0}));Object.keys(e.data.error).forEach(t=>{a.push({name:t,status:!1,msg:e.data.error[t]})}),ie({resultData:a,resultTitle:"删除加密访问规则"}),V(),i()}catch(d){n(d)}finally{c.close()}}}];return k(()=>{"nginx"!=o.value.webserver?(u.error("不支持nginx之外的服务器!"),b.value=!0):(b.value=!1,V())}),(e,a)=>{const t=le,l=z,n=c,i=v,o=N,r=j("bt-loading");return C(),I("div",ye,[q(b)?(C(),S(t,{key:0},{content:T(()=>[...a[1]||(a[1]=[U("div",{class:"content-mask"},[U("i",{class:"svgtofont-el-warning text-warning !text-subtitleLarge mr-4px"}),x(" 不支持nginx之外的服务器 ")],-1)])]),_:1})):P("",!0),h(o,null,{"header-left":T(()=>[h(l,{type:"primary",onClick:a[0]||(a[0]=e=>A())},{default:T(()=>[x("添加"+L("encryptedAccess"===s.tabActive?"加密":"禁止")+"访问",1)]),_:1})]),"header-right":T(()=>[...a[2]||(a[2]=[])]),content:T(()=>[R(h(n,{column:q(H),ref_key:"encryptedAccessRef",ref:d,data:q(f)},null,8,["column","data"]),[[r,q(y)]])]),"footer-left":T(()=>["encryptedAccess"===s.tabActive?(C(),S(i,{key:0,"table-ref":q(d),options:q(D)},null,8,["table-ref","options"])):P("",!0)]),_:1})])}}}),be=b(_({__name:"index",setup(a){const{enterpriseRec:t}=e(),l=g("encryptedAccess"),{BtTabs:s}=y({type:"card",value:l,options:[{label:"加密访问",lazy:!0,name:"encryptedAccess",render:h(fe,{tabActive:"encryptedAccess"},null)},{label:"禁止访问",lazy:!0,name:"forbidAccess",render:h(fe,{tabActive:"forbidAccess"},null)},...t.value?[{label:()=>h("span",{innerHTML:'<span class="inline-flex items-center">\n\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\tclass="svgtofont-icon-ltd text-medium text-ltd mr-[4px] inline-flex"></i>\n\t\t\t\t\t\t\t\t双向认证 <span class="text-warning">【推荐】</span></span\n\t\t\t\t\t\t\t>'},null),lazy:!0,name:"addBatch",render:h(ve,null,null)}]:[]]}),n=g([{content:"目录设置加密访问后，访问时需要输入账号密码才能访问"},{content:"例如我设置了加密访问 /test/ ,那我访问 http://aaa.com/test/ 时就要输入账号密码才能访问"}]),i=g([{content:"后缀：禁止访问的文件后缀"},{content:"目录：规则会在这个目录内生效"}]);return(e,a)=>{const t=f;return C(),I("div",null,[h(q(s),{type:"card",modelValue:q(l),"onUpdate:modelValue":a[0]||(a[0]=e=>H(l)?l.value=e:null)},null,8,["modelValue"]),["encryptedAccess","forbidAccess"].includes(q(l))?(C(),S(t,{key:0,options:"encryptedAccess"===q(l)?q(n):q(i),class:"ml-[20px] mt-[20px]"},null,8,["options"])):P("",!0)])}}}),[["__scopeId","data-v-c4b3a995"]]);export{be as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
