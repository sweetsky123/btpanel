import{r as e,q as a,g as t,e as l,av as s,c as r,aB as n,a0 as o,w as i,D as c,x as d,y as u,A as p,C as m,F as f,b1 as h,z as v,M as g,B as _,S as y,an as b,H as w,aT as x,O as T,am as k,$ as P,v as I}from"./base-lib.js?v=1763689792";import"./file-icon.js?v=1763689792";import{Q as L,hc as N,p as S,hd as C,n as j,H as R,L as z,b as D,ay as A,he as E,hf as q,aA as O,hg as B,u as V,x as F,an as H,_ as J}from"./utils-lib.js?v=1763689792";import{a as M,u as Q}from"./column.js?v=1763689792";import{b as U}from"./form-item.js?v=1763689792";import{aC as W}from"./validator.js?v=1763689792";import{_ as $}from"./index109.js?v=1763689792";import{F as G}from"./files-path.js?v=1763689792";import{u as K}from"./useStore10.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./index107.js?v=1763689792";const X=D(),Y=e(null),Z=a(()=>{X.error("不能直接上传文件到系统根目录!")},2e3),ee=(e,a,t,l)=>{var s,r;if(e.preventDefault(),"/"!==a){if(null==(s=null==e?void 0:e.dataTransfer)?void 0:s.items){Array.from(null==(r=null==e?void 0:e.dataTransfer)?void 0:r.items).some(e=>"file"===e.kind)&&(Y.value||ae(a,t,l))}}else Z()},ae=(e,a,t)=>{"/"!==e?Y.value=j({title:"上传文件到【".concat(e,"】"),area:"72",component:()=>R(()=>import("./node-upload.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{path:e,nodeId:a,refresh:t},onCancel:()=>{t(),Y.value=null}}):X.error("不能直接上传文件到系统根目录!")},te=(e,a)=>{const t="node_file_path_".concat(e);if(void 0!==a)return localStorage.setItem(t,a),a;return localStorage.getItem(t)||"/"},le=({lpver:e})=>!!e;let se=null;const re=async(a,t=!1)=>{const l=e({source_path:"",target_path:"",target_node:"",source_node:"",file_count:0,file_complete:0,file_error:0,fileList:[]});let s=null;const r=async()=>{s=await j({title:"文件传输日志",area:75,component:()=>R(()=>import("./index381.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:l,onCancel:()=>{null==se||se.close(),s=null},btns:!1})},n=async()=>{let a=0,t=0;const s=[],r=[];l.value.fileList&&(l.value.fileList.forEach(e=>{"complete"===e.status?(a++,r.push(e)):(t++,s.push(e))}),j({title:"文件传输结果",area:45,component:()=>R(()=>import("./transfer-result.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{success:a,fail:t,sendList:e([...s,...r])}}))};null==se||se.close(),se=A({route:"/ws_modsoc",onMessage:(e,o)=>{const i=JSON.parse(o.data);if("end"===i.type)return null==se||se.close(),s&&s.unmount(),void(t||(l.value={...i.task,fileList:i.file_status_list},n(),X.success("文件传输完成"),a()));"error"===i.type&&X.error(i.msg),s||(s=!0,r()),i.task&&(l.value={...i.task,fileList:i.file_status_list})},onDisconnected:()=>{a()}}),null==se||se.send({mod_name:"node",sub_mod_name:"file_transfer",def_name:"transfer_status",callback:"xxxxxxo",data:{}})},ne=async e=>new Promise((a,t)=>{j({title:"文件传输",area:45,component:()=>R(()=>import("./transfer-confirm.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),btn:!0,compData:{...e,complete:e=>{a(e)}},onCancel:()=>{t(!1)}})}),oe=async(e,a,s)=>{let r=null;const{BtForm:n,submit:o}=z({data:()=>({name:""}),options:e=>t(()=>[U("名称","name",{attrs:{class:"!w-[23rem]",placeholder:"请输入文件夹名称",onkeydown:async e=>{if("Enter"===e.key){e.preventDefault(),e.stopPropagation();await o()&&(null==r||r.unmount())}}},rules:[{required:!0,message:"请输入文件夹名称"},{validator:(e,a,t)=>{RegExp(/[\*\|\:\\\"\/\<\>\?]+/).test(a)?t(new Error("文件夹名称不能包含特殊字符")):t()},trigger:["blur","change"]}]})]),submit:async(t,l,r)=>{try{return await l(),await(async t=>{try{return await L({message:!0,loading:"创建中...",request:E({node_id:a.toString(),path:"".concat(e,"/").concat(t.value.name).replace(/\/\//g,"/")})}),!0}catch(l){return!1}finally{s()}})(t)}catch(n){return!1}}});r=await j({title:"新建文件夹【".concat(e,"】"),area:45,component:()=>l("div",{class:"p-[2rem]"},[l(n,null,null)]),btn:!0,onConfirm:o})},ie={class:"flex items-center mb-[1.6rem]"},ce={class:"flex flex-col !h-[5rem] pt-[1rem]"},de={class:"mb-0 leading-[1.2rem] !vertical-middle"},ue={class:"text-tertiary text-small"},pe={class:"flex items-center gap-3"},me={class:"flex items-center gap-3"},fe={class:"text-tertiary"},he=r({__name:"files-list-card",props:{panelType:{type:String,required:!0}},setup(a,{expose:t}){const P=a,{mainHeight:I}=V(),{currentNodes:j}=K(),R=e([]),z=n("nodeList",e([])),D=n("createTask",(e,a,t)=>{}),A=e([]),E=e(te(j.value[P.panelType]));o("currentPath",E);const B=e({p:1,showRow:200,path:s(E),search:""}),J=e=>{switch(P.panelType){case"source":return e===j.value.target;case"target":return e===j.value.source}},U=e=>{A.value=e?z.value.filter(a=>a.label.includes(e)||a.server_ip.includes(e)):z.value};i(z,e=>{A.value=e}),i(()=>j.value[P.panelType],()=>{X(),ve.value.limit=100,_e(te(j.value[P.panelType])),ne()});const X=()=>{const e=j.value[P.panelType];e&&localStorage.setItem("fileTransfer_".concat(P.panelType,"_nodeId"),e)},Y=[M({key:"vid"}),{label:"文件名称",prop:"name",minWidth:200,showOverflowTooltip:!0,render:e=>l("div",{class:"flex items-center files-list"},[l("i",{class:"icon-bg ".concat(["zip","rar","7z","gz","tar.gz","tgz","war"].includes(e.ext)?"compress":e.ext,"-icon")},null),l("span",{onClick:()=>ye(e),class:"cursor-pointer hover:text-primary truncate ml-[4px] fileName ".concat(e.isReName?"hidden":""),title:e.fileName+e.isLink},[e.fileName+e.isLink])])},{label:"文件大小",prop:"size",width:120,render:e=>"folder"===e.ext?l(xe,{row:e},null):F(e.size)},Q([{title:"source"===P.panelType?"发送到右侧":"发送到左侧",width:100,onClick:e=>be(e)},{title:"删除",onClick:e=>(async(e,a)=>{await S({title:"删除文件",content:'确定要删除文件 "'.concat(e.fileName,'" 吗？')}),await L({message:!0,loading:"删除中...",request:C({node_id:e.nodeId,path:e.path,is_dir:e.isFile?0:1})}),a()})(e,ne)}])],{BtTable:Z,BtSearch:le,BtPage:se,BtColumn:re,refresh:ne,ref:he,param:ve}=H({request:async({p:e,limit:a,search:t})=>{const l=await(async({nodeId:e,path:a,p:t,showRow:l,search:r})=>{if(!e)return{data:[]};try{const n=await L({request:q({p:t,showRow:l,node_id:e,path:a,search:r})}),{data:o}=n,{path:i,dir:c,files:d,bt_sync:u,tamper_data:p}=o,{dirs:m,files:f,msg:h}=p||{dirs:[],files:[],msg:""},v=new Array(c.length+d.length);let g=0;for(let a=0;a<c.length;a++)v[g++]={...W("dir",c[a],h?"":m[a],i,u),vid:"dir".concat(g),nodeId:e,loading:s(!1)};for(let a=0;a<d.length;a++)v[g++]={...W("file",d[a],h?"":f[a],i),vid:"file".concat(g),nodeId:e};return{data:v,total:O(o.page),path:i}}catch(n){return{data:[],path:a}}})({nodeId:j.value[P.panelType],path:B.value.path,p:e,showRow:a,search:t});return te(j.value[P.panelType],l.path),_e(l.path),he.value.clearAllSelect(),l},columns:Y,extension:[]}),ge=async e=>{_e(e),ne()},_e=e=>{switch(E.value=e,P.panelType){case"source":j.value.sourcePath=e;break;case"target":j.value.targetPath=e}},ye=e=>{e.isFile||(E.value="".concat(e.path),ne())},be=async e=>{try{const a="all"===e?R.value:[e];D(P.panelType,a,()=>{he.value.clearAllSelect()})}catch(a){he.value.clearAllSelect()}},we=e=>{R.value=e},xe=r({props:{row:{type:Object,required:!0}},setup:e=>()=>l("a",{class:"flex items-center",title:"点击计算大小",onClick:()=>(async e=>{if(!e.loading&&!e.dirSize)try{e.loading=!0;const{data:a}=await L({request:N({node_id:e.nodeId,path:e.path})});e.dirSize=a.size,e.loading=!1}catch(a){e.loading=!1}})(e.row)},[e.row.loading&&l("span",{class:"svgtofont-el-loading animate-spin mr-2px"},null),e.row.loading&&l("span",{class:""},[c("计算中")]),!e.row.loading&&l("div",{class:"text-primary cursor-pointer"},[void 0===e.row.dirSize?"计算":e.row.dirSize])])});return t({refresh:ne}),(e,a)=>{const t=k,s=b,r=w,n=x;return d(),u("div",{class:"rounded-base module-ui shadow-[0 1px 3px 1px rgba(var(--el-color-black-rgb), 0.05)]",onDragenter:a[4]||(a[4]=y(()=>{},["prevent"])),onDragover:a[5]||(a[5]=y(e=>v(ee)(e,v(E),v(j)[P.panelType],v(ne)),["prevent"]))},[p("div",ie,[l(s,{class:"!w-[16rem] mr-[1.6rem]",modelValue:v(j)[P.panelType],"onUpdate:modelValue":a[0]||(a[0]=e=>v(j)[P.panelType]=e),filterable:"","filter-method":U,onChange:e.handleNodeChange},{default:m(()=>[(d(!0),u(f,null,h(v(A),e=>(d(),T(t,{class:"!h-[5rem]",key:e.value,label:e.label,value:e.value,disabled:J(e.value)},{default:m(()=>[p("div",ce,[p("span",de,_(e.label),1),p("span",ue,_(e.server_ip),1)])]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue","onChange"]),l(G,{initialPath:v(E),onPathChange:ge,onRefresh:v(ne)},null,8,["initialPath","onRefresh"])]),l(v($),null,{"header-left":m(()=>[l(r,{type:"primary",disabled:!v(B).path,onClick:a[1]||(a[1]=e=>v(ae)(v(E),v(j)[P.panelType],v(ne)))},{default:m(()=>[...a[6]||(a[6]=[c(" 上传文件 ",-1)])]),_:1},8,["disabled"]),l(r,{type:"default",disabled:!v(B).path,onClick:a[2]||(a[2]=e=>v(oe)(v(E),v(j)[P.panelType],v(ne)))},{default:m(()=>[...a[7]||(a[7]=[c(" 新建文件夹 ",-1)])]),_:1},8,["disabled"])]),"header-right":m(()=>[p("div",pe,[l(v(le),{disabled:!v(B).path,placeholder:"请输入文件名称"},null,8,["disabled"])])]),content:m(()=>[l(v(Z),{style:g("height:".concat(v(I)-290,"px")),onSelectionChange:we},null,8,["style"])]),"footer-left":m(()=>[p("div",me,[l(n,{content:"请先选择文件",placement:"top",disabled:v(R).length>0},{default:m(()=>[l(r,{type:"primary",disabled:0===v(R).length,onClick:a[3]||(a[3]=e=>be("all"))},{default:m(()=>[c("发送到"+_("source"===P.panelType?"右侧":"左侧"),1)]),_:1},8,["disabled"])]),_:1},8,["disabled"]),p("span",fe,"当前选中"+_(v(R).length)+"个文件",1)])]),"footer-right":m(()=>[l(v(se),{layout:"prev, pager, next"})]),_:1})],32)}}}),ve={class:"file-transfer"},ge={class:"transfer-container"},_e={class:"transfer-panel left-panel"},ye={class:"transfer-panel right-panel"},be=J(r({__name:"index",setup(a){const{getAllNodeList:t,currentNodes:r}=K(),n=D(),i=e([]);o("nodeList",i);const c=P("leftPanelRef"),m=P("rightPanelRef"),f=async()=>{const e=await t();i.value=(e=>e.map(e=>({...e,isLocal:e.is_local,label:e.remarks,value:e.id})))(e.data);const a=Number(localStorage.getItem("fileTransfer_source_nodeId")),l=Number(localStorage.getItem("fileTransfer_target_nodeId"));let s=null,n=null,o=null;for(let t=0;t<i.value.length;t++)i.value[t].isLocal?(o=i.value[t].id,r.value.localNodeId=o):n||(n=i.value[t].id),i.value[t].id===a&&(s=i.value[t].id),i.value[t].id===l&&(n=i.value[t].id);s||(s=o),r.value.source=s,r.value.target=n};return o("refreshNodeList",f),o("createTask",async(e,a,t)=>{const l=r.value[e],o=r.value["source"===e?"target":"source"];let d=null,u=null;for(let s=0;s<i.value.length&&(i.value[s].id===l&&(d=i.value[s]),i.value[s].id===o&&(u=i.value[s]),!d||!u);s++);if(!u)return n.error("请选择目标节点"),void t();(async e=>{try{if(le(e.sourceNode)&&le(e.targetNode))return X.error("当前两节点均为1panel节点，无法创建文件分发任务"),void e.callback();if("/"===e.targetPath)return X.error("目标节点处于根目录，无法创建文件分发任务"),void e.callback();const a=await ne(e),t=await L({message:!0,loading:"创建传输任务...",request:B({source_node_id:e.sourceNode.id,target_node_id:e.targetNode.id,source_path_list:JSON.stringify(e.sourcePathList.value.map(e=>({path:e.path,is_dir:!e.isFile,size:e.size}))),target_path:e.targetPath,default_mode:a})});e.callback(),t.status&&re(e.complete)}catch(a){e.callback()}})({sourceNode:d,targetNode:u,sourcePathList:s(a),targetPath:r.value["source"===e?"targetPath":"sourcePath"],callback:t,complete:()=>{var a,t;"source"===e?null==(a=m.value)||a.refresh():null==(t=c.value)||t.refresh()}})}),I(()=>{f(),re(()=>{},!0)}),(e,a)=>(d(),u("div",ve,[p("div",ge,[p("div",_e,[l(he,{ref_key:"leftPanelRef",ref:c,"panel-type":"source"},null,512)]),p("div",ye,[l(he,{ref_key:"rightPanelRef",ref:m,"panel-type":"target"},null,512)])])]))}}),[["__scopeId","data-v-d45560ca"]]);export{be as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
