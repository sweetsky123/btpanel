import{o as a,Q as t,J as e,l,K as c,e as i}from"./utils-lib.js?v=1763689792";import{ab as n,ac as s,ad as o}from"./config.js?v=1763689792";import{c as d,r as u,h as r,o as p,B as m,C as v,p as _,k as g,l as y,q as k,I as b,aY as f,G as D,v as h,F as x,z as w,J as C,n as A}from"./base-lib.js?v=1763689792";import{C as j}from"./checkbox-group.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";const T={class:"p-2rem overflow-auto"},q={class:"flex"},H={class:"backup-config !pt-0 w-[40%]"},P=["onClick"],J={key:0,class:"inline-block text-danger ml-[1.2rem]"},N=["onClick"],E={key:0,class:"inline-block text-danger ml-[1.2rem]"},I={key:2,class:"flex mb-1rem"},M={class:"children-title"},F={class:"config-item-content"},L={class:"backup-config !pt-0 w-[60%]"},O={class:"flex my-1rem"},z=["onClick"],B={key:2,class:"flex mb-1rem"},G={class:"children-title"},K={class:"config-item-content"},Q=i(d({__name:"recover-back-task",props:{compData:{default:{refresh:()=>{}}}},setup(i,{expose:d}){var Q;const R=i;u();const S=u(!1);u(!1);const V=r({bp_type:"all",backup_type:"整机备份",name:"整机备份",backup_config:{},type:(null==(Q=R.compData)?void 0:Q.rowData)?2:1,next_exec_time:""}),Y=u([]),U=u({}),W=r({php:"PHP项目",node:"Node项目",proxy:"反向代理",python:"Python项目",other:"其他项目",net:".Net项目",java:"Java项目",html:"HTML项目"}),X=u({});u({env_list:!0,safety:!0,ftp_list:!0,site_list:!0,sql_list:!0}),u({disabledDate:a=>a.getTime()<Date.now()-864e5});const Z=u([{title:"整机备份",value:"all",disabled:!!R.compData.rowData},{title:"环境备份",value:"env_list",disabled:!!R.compData.rowData},{title:"数据备份",value:"data_list",disabled:!!R.compData.rowData}]),$=a=>{X.value={...X.value,[a]:!X.value[a]}},aa=a=>{var t;return null==(t=Z.value.find((t=>t.value===a)))?void 0:t.title},ta=a=>({site_list:"网站",sql_list:"数据库",ftp_list:"FTP",terminal_list:"终端",crontab_list:"计划任务",safety:"安全"}[a]),ea=(a,t,e,l,c)=>{var i,n,s,o,d,u;let r="";if("logs"===(null==(i=R.compData)?void 0:i.type)){const t="backup"===(null==(n=R.compData)?void 0:n.active)?"备份":"还原",e=a[(null==(s=R.compData)?void 0:s.active)+"_status"];r=4===a.status?"[ 未恢复 ]":((a,t,e)=>{const l={"-1":"".concat(t,"中"),0:"等待".concat(t),1:'<b class="text-primary cursor-default" title="'.concat(e,'">').concat(t,"完成</b>"),2:'<b class="text-danger cursor-default" title="'.concat(e,'">').concat(t,"失败</b>")};return l[a]?" [ ".concat(l[a]," ]"):""})(e,t,null==a?void 0:a.msg)}const p="env_list"===e?t+("php"===t?"-":""):"",m=3===a.status?" [ 待开发 ]":!1===(null==a?void 0:a.setup)?' [ <span class="text-orange">未安装</span> ] ':"logs"===(null==(o=R.compData)?void 0:o.type)?r:"";let v=null==(u=null==(d=V.backup_config[e])?void 0:d[t])?void 0:u[l];return c&&a&&1===(null==a?void 0:a.status)&&(null==v?void 0:v.name)!==(null==a?void 0:a.name)&&(null==a?void 0:a.name)?(Y.value.includes(t)||Y.value.push(t),"".concat(p).concat(a.name,' [ <span class="text-danger"  title="版本不一致，强行还原可能会失败，建议切换版本后再试">版本不一致</span> ]')):"".concat(p).concat(a.name).concat((null==a?void 0:a.ps)?"（".concat(a.ps,"）"):"").concat(m)},la=a=>{var t;return 3===a.status||!1===(null==a?void 0:a.setup)||2===V.type&&(!(null==a?void 0:a.backup_status)||4===(null==a?void 0:a.backup_status))||"logs"===(null==(t=R.compData)?void 0:t.type)},ca=(a,t,e,l)=>{A((()=>{t&&U.value[t][e].forEach((t=>{t.name===a.name&&(t.status=a.status)}))}))},ia=(a,t,e,l)=>{var c,i;return"php"===e?V.backup_config[t][e].some((t=>t.name==a.name&&!1!==(null==t?void 0:t.setup)&&2!==(null==t?void 0:t.backup_status))):(null==(c=V.backup_config[t][e])?void 0:c.length)===(null==(i=U.value[t][e])?void 0:i.length)&&!1!==V.backup_config[t][e][l].setup};return d({onConfirm:async i=>{var s;await a({title:"还原备份",isHtml:!0,content:'<div class="text-[#333]">还原将覆盖现有数据，是否继续操作？</div><div>'+((null==(s=Y.value)?void 0:s.length)?"当前".concat(Y.value.join(","),"版本不一致，还原可能会失败，建议切换版本后再试<br>"):"")+"在还原数据库备份时，网站将不可访问</div>",type:"calc",width:"43rem",confirmText:"还原",cancelText:"取消"});let o={...V,backup_config:JSON.stringify(V.backup_config),next_exec_time:t(V.next_exec_time,"yyyy-MM-dd HH:mm:ss")};delete o.bp_type,2===o.type&&(o.id=R.compData.rowData.id,o.reduction_config=o.backup_config,delete o.backup_config,delete o.next_exec_time),e({loading:"正在还原备份，请稍后...",request:n(o),success:async({data:a})=>{if(!a.status)return i();await R.compData.refresh(),setTimeout((()=>{l({title:"详情【".concat(R.compData.rowData.name,"】"),area:[90,"80%"],compData:{...R.compData.rowData,tabName:"reduction"},component:()=>c((()=>import("./back-restore-log.js?v=1763689792")),__vite__mapDeps([]),import.meta.url)})}),2e3),i()}})}}),p((()=>{var a;R.compData.rowData&&(V.next_exec_time=R.compData.rowData.exec_time,V.name=R.compData.rowData.name,V.db_type=null==(a=Z.value.find((a=>a.title===R.compData.rowData.backup_type)))?void 0:a.value,V.storage_type=R.compData.rowData.storage_type),(async()=>{var a,t,e;try{S.value=!0;const l=(null==(a=R.compData)?void 0:a.rowData)?await s({id:null==(t=R.compData)?void 0:t.rowData.id},"backup"):await o();if(l.status){V.backup_config=l.data,(null==(e=R.compData)?void 0:e.rowData)&&delete V.backup_config.status;for(const t in V.backup_config){const a=V.backup_config[t];if(X.value[t]=!0,"data_list"===t)for(const t in a)X.value[t]=!0}const a=await o();a.status&&(U.value=a.data)}}catch(l){}finally{S.value=!1}})()})),(a,t)=>{const e=m("bt-loading");return v((g(),y("div",T,[k("div",q,[k("div",H,[(g(!0),y(b,null,f(_(V).backup_config,((a,t)=>(g(),y("div",{class:"backup-config-item",key:t,style:D({width:"env_list"!==t?"200%":""})},[k("div",{class:"config-item-title",onClick:a=>$(t)},[k("span",null,h(aa(t)),1),k("i",{class:x("svgtofont-el-arrow-".concat(_(X)[t]?"down":"up"))},null,2),"all"!==_(V).db_type&&_(V).db_type!==t||"config_list"===t?w("",!0):(g(),y("div",J,"覆盖当前以下数据！"))],8,P),"env_list"===t?(g(),y("div",{key:0,class:x(["text-[1.4rem] ml-1rem pt-[4px]",{hidden:!_(X)[t],grid:"data_list"!==t}])},"备份数据",2)):w("",!0),k("div",{class:x(["config-item-content",{hidden:!_(X)[t],grid:"data_list"!==t}])},[(g(!0),y(b,null,f(a,((e,l)=>(g(),y(b,null,[Array.isArray(a)?(g(),C(j,{key:"".concat(t+l),"comp-data":{item:e,getDisabled:la,changeCheckbox:ca,title:ea(e)}},null,8,["comp-data"])):(g(),y(b,{key:1},["data_list"!==t?(g(!0),y(b,{key:0},f(e,((a,e)=>(g(),y(b,null,[!1!==(null==a?void 0:a.setup)&&2!==(null==a?void 0:a.backup_status)?(g(),C(j,{key:"".concat(l+e),"comp-data":{item:a,title:ea(a,l,t,e),getDisabled:la,changeCheckbox:ca,key1:l,key:t,key2:e}},null,8,["comp-data"])):w("",!0)],64)))),256)):(g(),y(b,{key:1},[k("div",{class:x(["flex",_(X)[l]?"":"my-1rem"])},[k("div",{class:"config-item-title",onClick:a=>$(l)},[k("span",null,h(ta(l)),1),k("i",{class:x("svgtofont-el-arrow-".concat(_(X)[l]?"down":"up"))},null,2),"crontab_list"==l?(g(),y("div",E,"存在同名计划任务将跳过！")):w("",!0)],8,N)],2),k("div",{class:x(["config-item-content",{hidden:!_(X)[l],grid:"site_list"!==l&&"sql_list"!==l}])},[(g(!0),y(b,null,f(e,((a,t)=>{var c;return g(),y(b,null,[Array.isArray(e)?(g(),C(j,{key:"".concat(l+t),"comp-data":{item:a,getDisabled:la,changeCheckbox:ca,title:ea(a)}},null,8,["comp-data"])):"safety"==l?(g(!0),y(b,{key:1},f(a,((a,e)=>(g(),C(j,{key:"".concat(t+e),"comp-data":{item:a,getDisabled:la,changeCheckbox:ca,title:ea(a)}},null,8,["comp-data"])))),128)):Array.isArray(a)&&"safaty"!==l?(g(),y("div",I,[k("span",M,h(null!=(c=_(W)[t])?c:t)+"：",1),k("div",F,[(g(!0),y(b,null,f(a,((a,t)=>(g(),C(j,{key:t,"comp-data":{item:a,title:ea(a),getDisabled:la,changeCheckbox:ca}},null,8,["comp-data"])))),128))])])):w("",!0)],64)})),256))],2)],64))],64))],64)))),256))],2)],4)))),128))]),k("div",L,[(g(!0),y(b,null,f(_(U),((a,e)=>(g(),y(b,null,["env_list"===e?(g(),y("div",{class:"backup-config-item",key:e},[t[0]||(t[0]=k("div",{class:"config-item-title h-2rem"},null,-1)),"env_list"===e?(g(),y("div",{key:0,class:x(["text-[1.4rem] ml-1rem pt-[4px]",{hidden:!_(X)[e],grid:"data_list"!==e}])},"当前数据",2)):w("",!0),k("div",{class:x(["config-item-content",{hidden:!_(X)[e],grid:"data_list"!==e}])},[(g(!0),y(b,null,f(a,((t,l)=>(g(),y(b,null,[Array.isArray(a)?(g(),C(j,{key:"".concat(e+l),"comp-data":{item:t,getDisabled:la,changeCheckbox:ca,title:ea(t)}},null,8,["comp-data"])):(g(),y(b,{key:1},["data_list"!==e?(g(!0),y(b,{key:0},f(t,((a,t)=>(g(),y(b,null,[ia(a,e,l,t)?(g(),C(j,{key:"".concat(l+t),"comp-data":{item:a,title:ea(a,l,e,t,!0),getDisabled:la,changeCheckbox:ca}},null,8,["comp-data"])):w("",!0)],64)))),256)):(g(),y(b,{key:1},[k("div",O,[k("div",{class:"config-item-title",onClick:a=>$(l)},[k("span",null,h(ta(l)),1),k("i",{class:x("svgtofont-el-arrow-".concat(_(X)[l]?"down":"up"))},null,2)],8,z)]),k("div",{class:x(["config-item-content",{hidden:!_(X)[l],grid:"site_list"!==l&&"sql_list"!==l}])},[(g(!0),y(b,null,f(t,((a,e)=>{var c;return g(),y(b,null,[Array.isArray(t)?(g(),C(j,{key:"".concat(l+e),"comp-data":{item:a,getDisabled:la,changeCheckbox:ca,title:ea(a)}},null,8,["comp-data"])):"safety"==l?(g(!0),y(b,{key:1},f(a,((a,t)=>(g(),C(j,{key:"".concat(e+t),"comp-data":{item:a,getDisabled:la,changeCheckbox:ca,title:ea(a)}},null,8,["comp-data"])))),128)):Array.isArray(a)&&"safaty"!==l?(g(),y("div",B,[k("span",G,h(null!=(c=_(W)[e])?c:e)+"：",1),k("div",K,[(g(!0),y(b,null,f(a,((a,t)=>(g(),C(j,{key:t,"comp-data":{item:a,title:ea(a),getDisabled:la,changeCheckbox:ca}},null,8,["comp-data"])))),128))])])):w("",!0)],64)})),256))],2)],64))],64))],64)))),256))],2)])):w("",!0)],64)))),256))])])])),[[e,_(S)]])}}}),[["__scopeId","data-v-45b02601"]]);export{Q as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
