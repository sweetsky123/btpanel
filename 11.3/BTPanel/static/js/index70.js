import{Q as e,hh as t,W as a,n as l,H as s,V as r,p as n,hi as o,hj as c,hk as i,P as d,l as u,ah as p,y as m,an as v,hl as f,hm as h,E as y,hn as _,aA as g,ho as b,u as k,M as w,gR as x,hp as C,eG as S,L as V,hq as T,k as j,ay as P,_ as A,aC as E}from"./utils-lib.js?v=1763689792";import{_ as O}from"./index109.js?v=1763689792";import{_ as q}from"./index118.js?v=1763689792";import{s as L,j as U,r as R,o as I,W as D,c as z,v as N,a8 as B,I as H,x as G,y as M,e as W,C as F,A as J,z as Q,D as K,J as Z,H as $,be as X,aT as Y,bO as ee,F as te,bP as ae,i as le,bQ as se,aQ as re,an as ne,am as oe,U as ce,ag as ie,V as de,Z as ue,g as pe,w as me,n as ve,aH as fe,$ as he,B as ye,R as _e,K as ge,b1 as be,ay as ke,O as we}from"./base-lib.js?v=1763689792";import{a as xe,u as Ce,c as Se}from"./column.js?v=1763689792";import{B as Ve}from"./index119.js?v=1763689792";import{_ as Te}from"./index123.js?v=1763689792";import{b as je,e as Pe,h as Ae,j as Ee}from"./form-item.js?v=1763689792";import{f as Oe}from"./validator.js?v=1763689792";import{e as qe}from"./useController11.js?v=1763689792";import{u as Le}from"./useStore10.js?v=1763689792";import{_ as Ue}from"./index107.js?v=1763689792";const Re=U("NODE-SCRIPT-MASS-STORE",()=>({activeTabs:R("script-distribute"),contentType:R("byCustom"),isExecute:R(!1),isCanReset:R(!1),currentTaskId:R(0),taskList:R([])}),{persist:{storage:localStorage,paths:["taskList","isCanReset","currentTaskId"]}}),Ie=()=>L(Re()),De=I({p:1,limit:20,search:"",script_type:"all",group_id:"-1"}),ze=R();R(!1);const Ne=R(0),Be=R([]),He=R(!1),Ge=R([]),Me=async t=>{await n({title:"删除脚本",icon:"warning-filled",content:"删除后脚本信息不可恢复,是否继续操作？"}),await e({loading:"正在删除脚本,请稍后...",request:o(t),message:!0,success:We})},We=async()=>{await e({loading:He,request:t(De),data:{data:[Array,Be],page:a(Ne)}})},Fe=(e,t,a)=>{if(tt(),e){const{id:e,name:a,content:l,description:s,script_type:r}=t;Object.assign($e,{name:a,id:e,script_type:r,content:l,description:s})}l({title:(e?"编辑":"创建")+"脚本",area:57,component:()=>s(()=>import("./add-script.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),onConfirm:async()=>{const t=await et(!!e,!!a);return t&&(null==a||a()),t},showFooter:!0})},Je=[{label:"删除脚本",value:"delete",event:async(e,t)=>{const a=async e=>await o({id:e.id});await e({title:"批量删除",content:"即将删除所选中的数据，是否继续操作?",column:[{prop:"name",label:"脚本名称"},Se()],onConfirm:async()=>(await t(a),We(),!1)})}}];R();const Qe=I({title:"脚本参数",form:{args:"",placeholder:"请输入脚本参数"},name:"",script_id:""}),Ke=R(),Ze=I({args_title:"",args_ps:""}),$e=I({name:"",content:"",script_type:"shell",description:""}),Xe=[],Ye=I({name:[{required:!0,message:"请输入脚本名称",trigger:"blur"}],content:[{required:!0,message:"请输入脚本内容",trigger:"blur"}]}),et=async(t,a)=>{await Ke.value.validate();let l={...$e};t||delete l.id;const s=t?c:i;return(await e({loading:"正在".concat(t?"编辑":"创建","脚本，请稍后..."),request:s(l),message:!0,success:e=>{e.status&&tt(),!0!==a&&We()}})).status},tt=()=>{Object.assign($e,{name:"",content:"",script_type:"shell",description:"",id:""}),Object.assign(Ze,{args_title:"",args_ps:""}),Object.assign(Qe,{title:"脚本参数",form:{args:"",placeholder:"请输入脚本参数"},name:"",script_id:""})},at=()=>{Be.value=[],Ge.value=[]},lt={class:"flex items-center"},st={class:"flex items-center"},rt=z({__name:"index",setup(e,{expose:t}){const a=D([xe(),{label:"名称",prop:"name"},{label:"类型",prop:"script_type"},{label:"创建时间",render:e=>r(e.updated_at)},{label:"备注",prop:"description",showOverflowTooltip:!0},Ce([{onClick:e=>Fe(!0,e),title:"编辑"},{onClick:Me,title:"删除"}])]);return N(async()=>{We()}),B(at),t({init:We}),(e,t)=>{const l=$,s=d,r=u,n=p,o=q,c=O,i=H("bt-loading");return G(),M("div",null,[W(c,null,{"header-left":F(()=>[J("div",lt,[W(l,{onClick:t[0]||(t[0]=e=>Q(Fe)()),type:"primary"},{default:F(()=>[...t[4]||(t[4]=[K("创建脚本",-1)])]),_:1})])]),"header-right":F(()=>[J("div",st,[W(s,{modelValue:Q(De).search,"onUpdate:modelValue":t[1]||(t[1]=e=>Q(De).search=e),class:"ml-12px !w-[32rem]",placeholder:"请输入搜索关键字",onSearch:Q(We)},null,8,["modelValue","onSearch"])])]),content:F(()=>[Z(W(r,{ref_key:"scriptTableRef",ref:ze,column:Q(a),data:Q(Be)},null,8,["column","data"]),[[i,Q(He)],[i,"正在加载中，请稍后...","title"]])]),"footer-left":F(()=>[W(n,{"table-ref":Q(ze),options:Q(Je)},null,8,["table-ref","options"])]),"footer-right":F(()=>[W(o,{total:Q(Ne),page:Q(De).p,"onUpdate:page":t[2]||(t[2]=e=>Q(De).p=e),row:Q(De).limit,"onUpdate:row":t[3]||(t[3]=e=>Q(De).limit=e),onChange:Q(We)},null,8,["total","page","row","onChange"])]),_:1})])}}});const nt=z({name:"Editor",props:{modelValue:{type:String,default:""},type:{type:String,default:"shell"}},setup(e){const t=se(e,"modelValue"),a={mode:"ace/mode/".concat("python"===e.type?"python":"sh"),theme:y.value?"ace/theme/clouds_midnight":"ace/theme/chrome",wrap:!0,showInvisibles:!1,showFoldWidgets:!1,useSoftTabs:!0,tabSize:2,showPrintMargin:!1,readOnly:!0,fontSize:"12px"};return()=>W("div",null,[W(Ve,{class:"!h-[36rem] !w-[70rem]",modelValue:t.value,"onUpdate:modelValue":e=>t.value=e,editorOption:a},null)])}}),ot=z({name:"Collapse",props:{modelValue:{type:Boolean,default:!1}},setup(e,{slots:t}){const a=se(e,"modelValue"),l=R(null),s=e=>{e.style.height="0"},r=e=>{e.style.height=e.scrollHeight+"px"},n=e=>{e.style.height="auto"},o=e=>{e.style.height=e.scrollHeight+"px"},c=e=>{e.offsetHeight,e.style.height="0"},i=e=>{e.style.height="0"};return()=>W("div",null,[W(re,{onBeforeEnter:s,onEnter:r,onAfterEnter:n,onBeforeLeave:o,onLeave:c,onAfterLeave:i},{default:()=>{var e;return[a.value&&W("div",{ref:l,class:"collapse-content mt-[1.2rem]",style:{overflow:"hidden",transition:"height 0.3s ease"}},[null==(e=t.default)?void 0:e.call(t)])]}})])}}),ct=t=>{const a=t.task_type;const{BtTable:s}=v({request:async()=>{let a=t.result;if(!a){const l=await e({request:"command"===t.task_type?f({task_id:t.id}):h({task_id:t.id})});if(!l.status)return{data:[],total:0};a=l.data.data.data}return(e=>{if("command"===t.task_type){const t=(null==e?void 0:e.sort((e,t)=>e.dst_node_idx-t.dst_node_idx))||[];return{data:t,total:t.length}}{const t=function(e){const t=new Map;for(const a of e){const{dst_node_idx:e,...l}=a;t.has(e)||t.set(e,[]),t.get(e).push(l)}return Array.from(t,([e,t])=>({dst_node_idx:e,data:t}))}(e)||[];return{data:t,total:t.length}}})(a)},columns:[..."command"===t.task_type?[]:[{type:"expand",render:e=>W("div",{class:"px-[1.2rem]"},[e.data.map(e=>{const t=(e=>{const t={color:"var(--el-color-text-secondary)",content:"等待执行"};switch(e){case 0:t.color="var(--el-color-text-secondary)",t.content="等待中";break;case 1:t.color="var(--el-color-text-secondary)",t.content="进行中";break;case 2:t.color="var(--el-color-success)",t.content="执行成功";break;case 3:t.color="var(--el-color-danger)",t.content="执行失败";break;case 4:t.color="var(--el-color-warning)",t.content="command"===a?"异常":"跳过"}return W("span",{style:{color:t.color}},[t.content])})(e.status);return W("div",{class:"flex items-center justify-between border-b py-[.8rem]"},[W("div",{class:"w-[600px] truncate",title:e.dst_file},[e.dst_file]),W("div",null,[t])])})])}],{label:"节点地址",prop:"ssh_host",width:"command"===t.task_type?195:670,render:e=>"command"===t.task_type?e.ssh_host:t.dst_nodes[e.dst_node_idx].name},..."command"===t.task_type?[{label:"状态",width:80,render:e=>{const t={color:"var(--el-color-text-secondary)",content:"等待执行"};switch(e.status){case 0:t.color="var(--el-color-text-secondary)",t.content="等待中";break;case 1:t.color="var(--el-color-text-secondary)",t.content="进行中";break;case 2:t.color="var(--el-color-success)",t.content="执行成功";break;case 3:t.color="var(--el-color-danger)",t.content="执行失败";break;case 4:t.color="var(--el-color-warning)",t.content="command"===a?"异常":"跳过"}return W("span",{style:{color:t.color}},[t.content])}},Ce([{title:"查看详情",width:80,onClick:e=>{mt(e.log_name,e.message,()=>{})}}])]:[]]});l({title:"任务详情",area:"command"===t.task_type?40:75,component:()=>W("div",{class:"p-[1.2rem]"},[W(s,{"max-height":300},null)])})},it=z({name:"TaskCard",props:{task:{type:Object,default:()=>({})},index:{type:Number,default:0},type:{type:String,default:"execute"}},emits:["edit"],setup(e,{emit:t}){const{isExecute:a,taskList:s,isCanReset:r}=Ie(),o=R(!0),c=R(!1),i=R("show"===e.type),d={backgroundColor:"var(--el-fill-color-dark) !important",color:"var(--el-base-supplement) !important",borderColor:"var(--el-color-border-dark) !important"},u=t=>{switch(e.task.status){case 0:return{type:"info",content:"等待中"};case 1:return{type:"info",content:"进行中"};case 2:return{type:"success",content:"执行成功"};case 3:return{type:"danger",content:"执行失败"};case 4:return"command"===e.task.task_type?{type:"danger",content:"异常"}:{type:"danger",content:"执行失败"}}if(a.value&&void 0===t)return{type:"info",content:"执行中"};switch(t){case"success":return{type:"success",content:"执行成功"};case"error":return{type:"danger",content:"执行失败"}}return{type:"info",content:"等待执行"}};return()=>{let r;return W("div",{class:"border border-light rounded-large p-[1.2rem] mb-[1.6rem] box-shadow-[0_0.1rem_0.3rem_rgba(0,0,0,0.1)] task-card"},[W("div",{class:"flex items-center justify-between py-[.8rem] h-[3rem] cursor-pointer",onClick:()=>o.value=!o.value},[W("div",{class:"flex items-center"},[!e.task.status&&!a.value&&!i.value&&W("i",{class:"svgtofont-icon-drag cursor-move mover align-middle mr-[.8rem]"},null),W("div",{class:"text-medium font-bold max-w-[40rem] truncate"},[e.task.name]),W("div",{class:"flex items-center gap-[.8rem] ml-[1.2rem]"},[W(X,{type:"warning",style:"command"===e.task.task_type?d:{}},{default:()=>["command"===e.task.task_type?"命令任务":"文件任务"]}),W(X,{type:u(e.task.status).type},{default:()=>[u(e.task.status).content]})]),!e.task.status&&!a.value&&!i.value&&W("div",{class:"flex items-center gap-[1.2rem] hover-btn"},[W(Y,{content:"编辑任务",placement:"top"},{default:()=>[W($,{type:"default",class:"!ml-[.8rem]",style:{padding:"6px 12px !important"},size:"small",circle:!0,onClick:a=>{a.stopPropagation(),t("edit",e.task)}},{default:()=>[W("i",{class:"svgtofont-el-edit"},null)]})]}),W(Y,{content:"复制任务",placement:"top"},{default:()=>[W($,{type:"default",class:"!ml-0",style:{padding:"6px 12px !important"},size:"small",circle:!0,onClick:t=>{t.stopPropagation(),s.value.splice(e.index+1,0,{...e.task,id:m(16)})}},{default:()=>[W("i",{class:"svgtofont-el-document-copy"},null)]})]}),W(Y,{content:"删除任务",placement:"top"},{default:()=>[W($,{type:"danger",class:"!ml-0",style:{padding:"6px 12px !important"},size:"small",circle:!0,onClick:async t=>{t.stopPropagation(),await n({title:"删除任务",content:"确定删除该任务吗？"}),s.value=s.value.filter(t=>t.id!==e.task.id)}},{default:()=>[W("i",{class:"svgtofont-el-delete text-white"},null)]})]})])]),W("div",{class:"text-small"},[W("span",{class:o.value?"svgtofont-el-arrow-up":"svgtofont-el-arrow-down"},null)])]),W(ot,{modelValue:o.value,"onUpdate:modelValue":e=>o.value=e},{default:()=>[W(ee,{column:1,border:!0},{default:()=>{return["command"===e.task.task_type?W(te,null,[W(ae,{label:"类型","label-class-name":"!w-[12rem]"},{default:()=>[e.task.script_id?"脚本库":"自定义命令"]}),!e.task.script_id&&W(ae,{label:"命令类型","label-class-name":"!w-[12rem]"},{default:()=>[e.task.script_type]}),W(ae,{label:"命令内容","label-class-name":"!w-[12rem]"},{default:()=>[W("div",null,[W("pre",{class:"!text-small !whitespace-pre-wrap"},[c.value?e.task.script_content:e.task.script_content.length>120?e.task.script_content.substring(0,120)+"...":e.task.script_content]),e.task.script_content.length>120&&W("span",{class:"bt-link mt-[.8rem] text-small",onClick:()=>{var t,a;e.task.script_content.length>1e3?(t=e.task.script_content,a=e.task.script_type,l({title:"命令详情",area:75,component:()=>W("div",{class:"p-[1.2rem]"},[W(nt,{modelValue:t,"onUpdate:modelValue":e=>t=e,type:a},null)])})):c.value=!c.value}},[c.value?"收起":"查看完整命令"])])]})]):W(te,null,[W(ae,{label:"源节点","label-class-name":"!w-[12rem]"},(s=e.task,t=r=s.src_node?"".concat(s.src_node.name,"(").concat(s.src_node.address?s.src_node.address:"127.0.0.1",")"):"".concat(s.src_node_id,"(").concat(s.src_node_ip,")"),"function"==typeof t||"[object Object]"===Object.prototype.toString.call(t)&&!le(t)?r:{default:()=>[r]})),e.task.path_list.map(e=>W(ae,{label:"传输路径","label-class-name":"!w-[12rem]"},{default:()=>[W("div",{class:"w-full flex items-center justify-between"},[W("div",{class:"w-[41%] max-w-[34rem] truncate",title:e.path},[K("源: "),e.path]),W("div",{class:""},[K(">>已选择执行节点的:")]),W("div",{class:"w-[41%] max-w-[34rem] truncate",title:e.dst_path},[e.dst_path])])]}))]),!a.value&&e.task.status||i.value?W(ae,{label:"执行结果","label-class-name":"!w-[12rem]"},{default:()=>[W("span",{class:"bt-link",onClick:()=>ct(e.task)},[K("点击查看")])]}):null];var t,s}})]})])}}}),dt=z({props:{task:{type:Object,default:()=>{}}},setup(e){const t=R(!0);return()=>W("div",{class:"p-[1.2rem]"},[W("div",{class:"p-[1.2rem] border border-dark rounded-large mb-[1.2rem]"},[W("div",{class:"flex items-center justify-between py-[.8rem] h-[3rem] cursor-pointer",onClick:()=>t.value=!t.value},[W("div",{class:"text-medium font-bold"},[K("执行节点")])]),W(ot,{modelValue:t.value,"onUpdate:modelValue":e=>t.value=e},{default:()=>[W("div",{class:"grid grid-cols-4 gap-[1.4rem] max-h-[30rem] overflow-y-auto"},[e.task.server_list.map(e=>W("div",{key:e.id,class:"flex items-center p-3 border border-dark rounded-base transition-all  max-w-[24rem] duration-200 hover:shadow-md"},[W("div",{class:"flex-1 min-w-0"},[W("div",{class:"flex items-center gap-2 mb-[.5rem]"},[W("span",{class:"text-base h-[2rem] flex items-center truncate",title:e.name},[e.name])]),W("div",{class:"text-small font-mono text-tertiary"},[e.server_ip])])]))])]})]),W("div",{class:"p-[1.2rem] border border-dark rounded-large"},[W("div",{class:"flex items-center justify-between py-[.8rem] h-[3rem] mb-[1.2rem]"},[W("div",{class:"text-medium font-bold"},[K("任务列表")])]),e.task.steps.map(e=>W(it,{key:e.id,task:e,type:"show"},null))])])}}),ut=e=>{l({title:"执行记录",area:110,component:()=>W(dt,{task:e},null)})},pt=z({props:{logName:{type:String,default:""},content:{type:String,default:""}},setup(e){const t=R(e.content||"获取中...");return e.content||(async()=>{const{data:a}=await b({path:"/www/server/panel/logs/executor_log/"+e.logName});t.value=a.data})(),()=>W("div",{class:"flex-wrap"},[W(Te,{class:"h-[40rem] !rounded-none",content:t.value},null)])}}),mt=async(e,t,a)=>{l({title:"执行记录",component:()=>W(pt,{logName:e,content:t},null),area:55,onCancel:a})},vt={class:"relative"},ft=z({__name:"index",setup(t,{expose:a}){const{mainHeight:l}=k(),{BtTable:s,BtPage:n,refresh:o}=v({request:t=>(async t=>{const a=await e({request:_(t)});return{data:a.data.data,total:g(a.data.page)}})(t),columns:[{label:"执行时间",prop:"updated_at",width:160,render:e=>r(e.updated_at)},{label:"执行节点",prop:"size",width:300,render:e=>{const t=e.server_list[0].name;return"".concat(t).concat(e.server_list.length>1?"等".concat(e.server_list.length,"个节点"):"")}},{label:"执行任务",prop:"script_content",showOverflowTooltip:!0,render:e=>e.steps.map(e=>e.name).join("，")},Ce([{onClick:ut,width:80,title:"执行结果"}])]});return a({init:o}),(e,t)=>{const a=O;return G(),M("div",vt,[W(a,null,{"header-left":F(()=>[...t[0]||(t[0]=[J("div",{class:"flex items-center"},null,-1)])]),"header-right":F(()=>[...t[1]||(t[1]=[])]),content:F(()=>[W(Q(s),{"max-height":Q(l)-320},null,8,["max-height"])]),"footer-left":F(()=>[...t[2]||(t[2]=[])]),"footer-right":F(()=>[W(Q(n))]),popup:F(()=>[...t[3]||(t[3]=[])]),_:1})])}}});const ht=z({name:"ServerSelector",props:{value:{type:Array,default:()=>[]},options:{type:Array,default:()=>[]}},emits:["goAddNode","refresh"],setup(e,{emit:t}){const{selectedServers:a,filteredServers:r,filterServer:n,selectAllServers:o,invertSelection:c,clearSelection:i,serverGroups:d,selectedGroup:u,handleGroupChange:p}=(e=>{const t=ue(e,"value"),a=ue(e,"options"),l=R(e.options),s=R([]),{nodeCategory:r}=Le(),n=pe(()=>r.value.filter(e=>"0"!==e.value&&"all"!==e.value));N(()=>{qe()}),me(a,()=>{o()});const o=(e="")=>{let t=a.value.filter(e=>!e.is_local);s.value&&s.value.length>0&&(t=t.filter(e=>s.value.includes(e.category_id.toString()))),e&&(t=t.filter(t=>{var a;return t.remarks.toLowerCase().includes(e.toLowerCase())||(null==(a=t.address)?void 0:a.includes(e))})),l.value=t};return{selectedServers:t,filteredServers:l,filterServer:e=>{o(e)},handleServerToggle:e=>{t.value.includes(e)?t.value=t.value.filter(t=>t!==e):t.value=[...t.value,e]},selectAllServers:()=>{t.value=l.value.map(e=>e.id)},invertSelection:()=>{const e=l.value.map(e=>e.id),a=e.filter(e=>!t.value.includes(e)),s=t.value.filter(t=>!e.includes(t));t.value=[...s,...a]},clearSelection:()=>{t.value=[]},serverGroups:n,selectedGroup:s,handleGroupChange:e=>{s.value=e,o()}}})(e);let m="";return()=>{let e;return W("div",{class:"p-[1.2rem] border border-dark rounded-large space-y-3"},[W("div",{class:"flex flex-col sm:flex-row gap-2"},[W(ne,{class:"!w-[20rem]",placeholder:"分组筛选",clearable:!0,multiple:!0,"collapse-tags":!0,"max-collapse-tags":1,modelValue:u.value,"onUpdate:modelValue":e=>u.value=e,onChange:p},(v=e=d.value.map(e=>W(oe,{key:e.value,value:e.value,label:e.label},null)),"function"==typeof v||"[object Object]"===Object.prototype.toString.call(v)&&!le(v)?e:{default:()=>[e]})),W("div",{class:"relative w-full max-w-[36rem]"},[W(ce,{type:"text",placeholder:"搜索节点",modelValue:m,"onUpdate:modelValue":e=>m=e,clearable:!0,onInput:n,onClear:()=>n("")},null)]),W("div",{class:"flex gap-2"},[W($,{type:"default",onClick:o},{default:()=>[K("全选")]}),W($,{type:"default",onClick:c},{default:()=>[K("反选")]}),W($,{type:"default",onClick:i},{default:()=>[K("清空")]})])]),W("div",{class:"max-h-[20rem] overflow-y-auto"},[r.value.length>0?W(ie,{modelValue:a.value,"onUpdate:modelValue":e=>a.value=e},{default:()=>[W("div",{class:"grid grid-cols-4 gap-[1.4rem]"},[r.value.map(e=>{var r;const n=(null==(r=d.value.find(t=>t.value===e.category_id))?void 0:r.label)||"未分组",o=a.value.includes(e.id),c=e.server_ip||e.ip,i=!e.has_ssh;return W(Y,{placement:"top",effect:"dark",content:"点击关联SSH",disabled:!i},{default:()=>[W("div",{key:e.id,class:"flex items-center p-3 border rounded-base transition-all cursor-pointer max-w-[24rem] duration-200 hover:shadow-md ".concat(o?"border-primary":i?"":"border-light hover:border-dark"," ").concat(i?"opacity-50":""),onClick:()=>{i?l({title:"添加root账号信息",area:50,compData:{node_id:e.id,server_ip:e.server_ip,ssh_conf:{},callback:()=>{t("refresh")}},btn:["保存"],component:()=>s(()=>import("./ssh-edit.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)}):a.value=o?a.value.filter(t=>t!==e.id):[...a.value,e.id]}},[W(de,{class:"mr-3 pointer-events-none",value:e.id,checked:o,disabled:i},null),W("div",{class:"flex-1 min-w-0"},[W("div",{class:"flex items-center gap-2 mb-[.5rem]"},[W("span",{class:"text-base h-[2rem] flex items-center truncate",title:e.remarks},[e.remarks]),W("span",{class:"w-3 h-3 rounded-full ".concat(0===e.error_num?"bg-success":"bg-danger")},null)]),W("div",{class:"text-small font-mono text-darkTertiary"},[c])]),W("div",{class:"text-small text-right min-w-0"},[W("div",{class:"font-medium truncate",title:n},[n])])])]})})])]}):W("div",{class:"col-span-full p-4 text-center text-secondary text-small"},[K("暂无数据,"),W("span",{class:"bt-link",onClick:()=>t("goAddNode")},[K("前往添加节点")])])])]);var v}}}),yt=z({name:"ContentSelect",props:{modelValue:{type:Number||void 0,default:void 0},scriptType:{type:String,default:"shell"},content:{type:String,default:""}},setup(a,{expose:l}){const s=se(a,"modelValue"),r=se(a,"scriptType"),n=se(a,"content"),o=R([]),c=R([]);let i=[];const d=()=>{o.value=[],c.value=[],e({request:t({p:"1",limit:"200"}),success:e=>{e.status&&(i=e.data.data,e.data.data.forEach(e=>{"shell"===e.script_type?o.value.push({label:e.name,value:e.id,content:e.content}):"python"===e.script_type&&c.value.push({label:e.name,value:e.id,content:e.content})}))}})};return d(),l({getScriptData:d}),()=>W("div",{class:"flex items-center gap-[1.2rem]"},[W(ne,{class:"!w-[50rem]",placeholder:"请选择脚本",filterable:!0,modelValue:s.value,"onUpdate:modelValue":e=>s.value=e,onChange:e=>{const t=i.find(t=>t.id===e);t&&(n.value=t.content||"")}},{default:()=>["shell"===r.value?o.value.map(e=>W(Y,{"popper-class":"!max-w-[35rem]",placement:"right"},{default:()=>W(oe,{key:e.value,value:e.value,label:e.label},{default:()=>[W("span",{class:"truncate max-w-[20rem]"},[e.label])]}),content:()=>W("pre",{class:"whitespace-pre-wrap"},[e.content.length>120?e.content.substring(0,120)+"...":e.content])})):c.value.map(e=>W(Y,{"popper-class":"!max-w-[35rem]",placement:"right"},{default:()=>W(oe,{key:e.value,value:e.value,label:e.label},{default:()=>[W("span",{class:"truncate max-w-[20rem]"},[e.label])]}),content:()=>W("pre",{class:"whitespace-pre-wrap"},[e.content.length>120?e.content.substring(0,120)+"...":e.content])}))]}),W("span",{class:"bt-link",onClick:()=>Fe(!1,void 0,d)},[K("创建脚本")])])}}),_t=async(e,t)=>{const a=[{label:"执行命令",value:"cmd"},{label:"发送文件",value:"file"}],s=[{label:"脚本库",value:"bySelect"},{label:"自定义命令",value:"byCustom"}],r=[{label:"Shell",value:"shell"},{label:"Python",value:"python"}],n=R(),o=R(!!t),c=R([]),{BtForm:i,ref:d,submit:u,clearValidate:p}=V({data:()=>{var e;return{name:(null==t?void 0:t.name)||"",taskType:"file"===(null==t?void 0:t.task_type)?"file":"cmd",script_content:((null==t?void 0:t.script_id)?"":null==t?void 0:t.script_content)||"",cmd_type:o.value?(null==t?void 0:t.script_id)?"bySelect":"byCustom":"bySelect",script_type:((null==t?void 0:t.script_id)?"shell":null==t?void 0:t.script_type)||"shell",script_id:(null==t?void 0:t.script_id)||void 0,source_node:(null==t?void 0:t.src_node_id)||void 0,pathArray:(null==(e=null==t?void 0:t.path_list)?void 0:e.map(e=>({key:e.key||m(16),sourcePath:e.path,isDir:e.is_dir,targetPath:e.dst_path})))||[{key:m(16),sourcePath:"",isDir:!1,targetPath:""}]}},options:e=>{const t=pe(()=>"shell"===e.value.script_type?"ace/mode/sh":"ace/mode/python"),l=()=>{var e;p();const a=null==(e=n.value)?void 0:e.getEditor();a&&a.session.setMode(t.value)};return pe(()=>[je("任务名称","name",{attrs:{placeholder:"请输入任务名称",class:"!w-[30rem]"},rules:[{required:!0,message:"请输入任务名称"}]}),Pe("任务类型","taskType",a,{attrs:{disabled:o.value}}),..."cmd"===e.value.taskType?[Pe("来源","cmd_type",s,{attrs:{onChange:l}}),Pe("命令类型","script_type",r,{attrs:{onChange:()=>{var a;if("bySelect"===e.value.cmd_type)return void(e.value.script_id=void 0);const l=null==(a=n.value)?void 0:a.getEditor();l&&l.session.setMode(t.value)}}}),..."byCustom"===e.value.cmd_type?[Ae("命令内容",()=>W(Ve,{class:"!h-[36rem] !w-[84rem]",ref:n,modelValue:e.value.script_content,"onUpdate:modelValue":t=>e.value.script_content=t,editorOption:{mode:t.value}},null),"script_content",{rules:[{required:!0,message:"请输入命令内容"}]})]:[Ae("选择脚本",()=>W(yt,{modelValue:e.value.script_id,"onUpdate:modelValue":t=>e.value.script_id=t,scriptType:e.value.script_type,"onUpdate:scriptType":t=>e.value.script_type=t,content:e.value.script_content,"onUpdate:content":t=>e.value.script_content=t},null),"script_id",{rules:[{required:!0,message:"请选择脚本"}]})]]:[Ee("源节点","source_node",c.value.map(e=>({label:"".concat(e.remarks,"(").concat(e.server_ip,")"),value:e.id})),{attrs:{class:"!w-[30rem]"},rules:[{required:!0,message:"请选择源节点"}]}),Ae("文件内容",()=>W("div",null,[...e.value.pathArray.map(t=>W("div",{class:"flex items-center mb-[1rem] gap-[1.2rem]"},[W(Ue,{modelValue:t.sourcePath,"onUpdate:modelValue":e=>t.sourcePath=e,icon:"el-folder-opened",placeholder:"请选择源文件路径",readonly:!0,width:"32rem",onIconClick:async()=>{var a;e.value.source_node?Oe({type:"all",path:t.sourcePath||"/www/wwwroot",change:(e,a)=>{t.sourcePath=e,t.isDir="dir"===a},disabledCreate:!0,customRequest:!0,customRequestApi:t=>T({...t,node_id:e.value.source_node})}):null==(a=d.value)||a.validateField("source_node")}},null),W("span",null,[K("传输到已选目标节点的:")]),W(j,{modelValue:t.targetPath,"onUpdate:modelValue":e=>t.targetPath=e,placeholder:"请输入目标文件路径",width:"32rem"},null),W("span",{class:"text-danger cursor-pointer",onClick:()=>{e.value.pathArray=e.value.pathArray.filter(e=>t.key!==e.key)}},[K("删除")])])),W($,{type:"default",onClick:()=>{e.value.pathArray.push({key:m(16),sourcePath:"",isDir:!1,targetPath:e.value.pathArray.length>0?e.value.pathArray[e.value.pathArray.length-1].targetPath:""})}},{default:()=>[K("添加传输文件")]})]),"filePath",{rules:[{required:!0,trigger:["blur","change"],validator:(t,a,l)=>{bt(e.value.pathArray,l)}}]})]])},submit:async(e,a)=>{var l;await a();const s=(null==(l=c.value.find(t=>t.id===e.value.source_node))?void 0:l.server_ip)||"";return gt(e,o.value,s,null==t?void 0:t.id),!0}});l({title:"".concat(o.value?"编辑":"添加","任务"),area:100,showFooter:!0,component:()=>W("div",{class:"p-[1.2rem]"},[W(i,null,null)]),onConfirm:u});const v=await e("file_src");c.value=v},gt=(e,t,a,l)=>{const{taskList:s,currentTaskId:r}=Ie();r.value=0;const n={id:m(16),task_type:"cmd"===e.value.taskType?"command":"file",name:e.value.name};switch(e.value.taskType){case"cmd":"byCustom"===e.value.cmd_type?(n.script_content=e.value.script_content,n.script_type=e.value.script_type):(n.script_id=e.value.script_id,n.script_content=e.value.script_content);break;case"file":n.src_node_id=e.value.source_node,n.src_node_ip=a,n.path_list=e.value.pathArray.map(e=>({path:e.sourcePath,dst_path:e.targetPath,is_dir:e.isDir}))}if(t){for(let o=0;o<s.value.length;o++)if(s.value[o].id===l){s.value[o]={...s.value[o],...n};break}}else s.value.push(n)},bt=async(e,t)=>{if(0==e.length)return!t&&w.error("请添加传输文件"),t&&t(new Error("请添加传输文件")),!1;const a={};for(let l=0;l<e.length;l++){const s=e[l];switch(!0){case""==s.sourcePath:return!t&&w.error("文件内容第".concat(l+1,"行")+"源文件路径不能为空"),t&&t(new Error("文件内容第".concat(l+1,"行")+"源文件路径不能为空")),!1;case""==s.targetPath:return!t&&w.error("文件内容第".concat(l+1,"行")+"目标文件路径不能为空"),t&&t(new Error("文件内容第".concat(l+1,"行")+"目标文件路径不能为空")),!1}a["".concat(s.sourcePath)]=s.targetPath}return t&&t(),a},kt=()=>{const{contentType:t,isExecute:a,taskList:l,isCanReset:s,currentTaskId:r}=Ie(),{createWebSocket:o,closeWebSocket:c}=(()=>{const e=R();return{createWebSocket:(t,a)=>{var l,s;null==(l=e.value)||l.close(),e.value=P({route:"/ws_modsoc",onMessage:a}),null==(s=e.value)||s.send(t)},closeWebSocket:()=>{var t;null==(t=e.value)||t.close()}}})(),i=R([]),d=R([]),u=R(!1),p=R(!1),m=async(e,t=!1)=>{var n,o;if(p.value=!0,null==(n=e.data)?void 0:n.steps)r.value=e.data.id,l.value=l.value.map((t,a)=>({...t,...e.data.steps[a]}));else if(null==(o=e.data)?void 0:o.task_id){const{complete:t,error:a,count:s}=e.data,r=s==a+t?a>0?"error":"success":void 0;l.value[e.data.flow_idx].status=r,e.data.data.forEach(t=>{l.value[e.data.flow_idx].result||(l.value[e.data.flow_idx].result=[]),l.value[e.data.flow_idx].result[t.log_idx]=t})}else if("error"===e.type)w.error(e.msg),r.value&&(s.value=!0),a.value=!1,c();else{for(let e=0;e<l.value.length;e++)if("error"==l.value[e].status){s.value=!0;break}!t&&w.success("任务执行完成"),ve(()=>{a.value=!1}),c()}},v=async(t="all")=>{const a=await e({request:x({node_type:t})});return a.status?"file_src"===t?a.data.data:void(i.value=a.data.data):(w.error(a.msg),[])},f=()=>{d.value=[],s.value=!1,a.value=!1,r.value=0};return{contentType:t,serverList:i,selectedServers:d,fetchServerList:v,submit:async()=>{if(a.value)return void e({request:C({flow_id:r.value}),loading:"正在停止任务...",message:!0,success:e=>{e.status&&(a.value=!1,s.value=!0)}});if(!d.value.length&&!s.value)return w.error("请选择执行节点");let t={mod_name:"node",sub_mod_name:"executor",def_name:s.value?"retry_flow":"run_flow_task",callback:s.value?"retry_flow":"run_flow_task",data:{...s.value?{flow_id:r.value}:{node_ids:d.value,flow_data:l.value,run_when_error:u.value}}};a.value=!0,s.value=!1;let n=w.load("开始创建任务...");o(t,(e,t)=>{const a=JSON.parse(t.data);m(a),ve(()=>{n.close()})})},init:()=>{o({mod_name:"node",sub_mod_name:"executor",def_name:"flow_task_status",callback:"flow_task_status",data:{}},(e,t)=>{var a;const s=JSON.parse(t.data);"end"!==s.type?p.value=!0:s.last_flow&&(null==(a=s.last_flow)?void 0:a.id)===r.value&&l.value.length>0&&(s.data=s.last_flow),m(s,!0)})},isAll:u,createTask:async()=>{if(a.value&&!s.value)return w.error("当前存在正在执行中的任务，请先停止并清空任务");r.value&&(await n({title:"提示",content:"是否清空当前任务列表并新建任务？"}),l.value=[],r.value=0,s.value=!1,a.value=!1),_t(v)},rowDrop:()=>{const e=document.querySelector(".drug-task-list");S.create(e,{animation:500,handle:".svgtofont-icon-drag",chosenClass:"ghost",onEnd:async e=>{const t=l.value.splice(e.oldIndex,1)[0];l.value.splice(e.newIndex,0,t)}})},taskList:l,isShowTaskList:p,editTask:e=>{_t(v,e)},clearTask:async(e=!0)=>{if(a.value)return w.error("当前任务正在执行，无法清空，请先停止任务");e&&await n({title:"清空任务",content:"确定清空当前任务吗？"}),f(),l.value=[]},isCanReset:s,isExecute:a}},wt={class:"p-[1.2rem]"},xt={class:"flex items-baseline"},Ct={class:"ml-[2rem] text-small leading-[3rem] text-tertiary"},St={class:"ml-[2rem] text-small leading-[3rem] text-tertiary"},Vt={class:"flex items-center mt-[1.2rem]"},Tt={class:"drug-task-list mt-[1.2rem] w-[107rem]"},jt={class:"w-[107rem]"},Pt=A(z({__name:"index",setup(e,{expose:t}){const{selectedServers:a,serverList:l,fetchServerList:s,submit:r,init:n,isAll:o,createTask:c,rowDrop:i,taskList:d,editTask:u,clearTask:p,isExecute:m,isCanReset:v,isShowTaskList:f}=kt(),h=fe();return he("script"),N(async()=>{n(),await s(),i()}),t({init:n}),(e,t)=>{const n=$,i=de,y=ke;return G(),M("div",wt,[J("div",xt,[t[5]||(t[5]=J("h3",{class:"text-medium font-medium leading-[3rem]"},"选择执行节点:",-1)),J("span",Ct,ye("已选择".concat(Q(a).length,"个节点")),1),J("span",St,[t[4]||(t[4]=K(ye("关联SSH后可通过分发管理进行群发命令")+" ",-1)),J("span",{class:"bt-link ml-[.5rem]",onClick:t[0]||(t[0]=e=>Q(h).push("/node/node-mgt"))}," 前往添加节点 ")])]),W(Q(ht),{class:"w-[107rem]",value:Q(a),"onUpdate:value":t[1]||(t[1]=e=>_e(a)?a.value=e:null),options:Q(l),onGoAddNode:t[2]||(t[2]=e=>Q(h).push("/node/node-mgt")),onRefresh:Q(s)},null,8,["value","options","onRefresh"]),J("div",Vt,[W(n,{type:"primary",onClick:Q(c)},{default:F(()=>[...t[6]||(t[6]=[K("添加任务",-1)])]),_:1},8,["onClick"]),W(n,{type:"default",class:"!hover:bg-[var(--el-color-danger-light-9)] !hover:text-danger !hover:border-[var(--el-color-danger-light-5)]",plain:"",onClick:Q(p)},{default:F(()=>[...t[7]||(t[7]=[K("清空任务",-1)])]),_:1},8,["onClick"]),W(i,{modelValue:Q(o),"onUpdate:modelValue":t[3]||(t[3]=e=>_e(o)?o.value=e:null),class:"ml-[1.2rem]"},{default:F(()=>[...t[8]||(t[8]=[K("失败后继续执行",-1)])]),_:1},8,["modelValue"])]),Z(J("div",Tt,[(G(!0),M(te,null,be(Q(d),(e,t)=>(G(),we(Q(it),{key:e.id,task:e,index:t,onEdit:Q(u)},null,8,["task","index","onEdit"]))),128))],512),[[ge,Q(f)]]),J("div",jt,[Z(W(n,{type:Q(m)?"danger":"primary",size:"large",class:"mt-[1.2rem] !text-base",style:{padding:"8px 16px !important"},onClick:Q(r)},{default:F(()=>[K(ye(Q(m)?"停止":Q(v)?"重新执行":"执行"),1)]),_:1},8,["type","onClick"]),[[ge,Q(d).length>0&&Q(f)]]),Z(W(y,{description:"还没有添加任务"},{default:F(()=>[W(n,{type:"primary",onClick:Q(c)},{default:F(()=>[...t[9]||(t[9]=[K("添加第一个任务",-1)])]),_:1},8,["onClick"])]),_:1},512),[[ge,0===Q(d).length||!Q(f)]])])])}}}),[["__scopeId","data-v-69931ec1"]]),At={class:"module-ui"},Et=z({__name:"index",setup(e){const{activeTabs:t}=Ie(),a=R([{label:"分发",name:"script-distribute",lazy:!0,render:()=>W(Pt,null,null)},{label:"执行日志",name:"mass-table",lazy:!0,render:()=>W(ft,null,null)},{label:"脚本库",name:"script-table",lazy:!0,render:()=>W(rt,null,null)}]);return(e,l)=>{const s=E;return G(),M("div",At,[W(s,{type:"card",modelValue:Q(t),"onUpdate:modelValue":l[0]||(l[0]=e=>_e(t)?t.value=e:null),options:Q(a)},null,8,["modelValue","options"])])}}}),Ot=Object.freeze(Object.defineProperty({__proto__:null,default:Et},Symbol.toStringTag,{value:"Module"}));export{$e as a,Ke as b,Ye as c,Xe as h,Ot as i};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
