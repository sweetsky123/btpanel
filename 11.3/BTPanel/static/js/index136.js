import{c as e,r as a,aB as s,o as t,g as l,x as u,y as o,e as r,C as i,z as n,a1 as p,D as d,B as m,A as c,L as _,G as h,O as f,J as g,K as b,ad as q,ap as x,ab as y}from"./base-lib.js?v=1763689792";import{cU as v}from"./validator.js?v=1763689792";import{R as w,M as V,Q as j,k}from"./utils-lib.js?v=1763689792";import{addDatabaseQuota as z,databaseQuotaCheck as B,restoreDataAuth as M}from"./database.js?v=1763689792";import{g as C}from"./useStore2.js?v=1763689792";import{k as U}from"./useMethod4.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./column.js?v=1763689792";import"./index107.js?v=1763689792";const D={class:"p-[20px]"},N={class:"flex items-center"},O={key:0},E=["disabled"],T={class:"flex items-center"},F={class:"mt-8 leading-10 list-disc"},R=e({__name:"index",props:{compData:{default:{}}},setup(e,{expose:R}){var A;const G=e,{refreshTableList:J}=C(),K=a(),L=a(!1),S=a(),{quota:H,name:I}=G.compData,{used:P,size:Q,quota_push:Y,quota_storage:Z}=H,$=s("popupClose"),W=(e,a,s)=>{""===a&&s(new Error("请输入配置数据"));/^(0|[1-9][0-9]*)$/.test(a)&&0!==a?s():s(new Error("请输入大于等于0的正整数")),s()},X=t({size:[{required:!0,message:"请输入容量配额",trigger:"blur"},{validator:W}],"quota_push.size":[{trigger:"blur",validator:W}],"quota_push.push_count":[{required:!0,message:"请输入容量配额",trigger:"blur"},{validator:W}]}),ee=t({used:P,size:Q,quota_push:Y,quota_storage:Z,module:w(Y.module)?Y.module:null==(A=Y.module)?void 0:A.split(",")}),ae=l({get:()=>Object.keys(Z).includes("insert_accept")?Z.insert_accept?"text-primary":"text-danger":"text-warning",set:e=>e}),se=l({get:()=>Object.keys(Z).includes("insert_accept")?Z.insert_accept?"正常":"已撤销":"未配置",set:e=>e}),te=l(()=>-1===ee.used?"未配置容量大小":((e,a=2)=>{var s;if(0===e)return"0 Bytes";const t=a<0?0:a,l=Math.floor(Math.log(e)/Math.log(1024));return parseFloat(null==(s=e/Math.pow(1024,l))?void 0:s.toFixed(t))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][l]})(ee.used)),le=e=>{e<1&&(ee.quota_push.status=!1)},ue=e=>{e&&Number(ee.size)<=0&&(V.error("请输入容量配额"),ee.quota_push.status=!1)},oe=async()=>{var e;null==(e=S.value)||e.refresh(),V.success("刷新成功")},re=async()=>{L.value=!0,await j({request:B(),message:!0}),await J(),U.value.forEach(e=>{if(e.id===G.compData.id){const{quota_storage:a}=e.quota,s=Object.keys(a).includes("insert_accept");se.value=s?a.insert_accept?"正常":"已撤销":"未配置",ae.value=s?a.insert_accept?"text-primary":"text-danger":"text-warning"}}),L.value=!1,V.success("已提交刷新权限任务，将会在后台计算运行，时间约为1分钟")},ie=async()=>{await j({loading:"正在恢复，请稍后...",request:M({db_name:I}),message:!0}),$(),J()};return R({onConfirm:async e=>{var a;await K.value.validate();const s={db_name:I,quota_push:{module:null==(a=ee.module)?void 0:a.join(","),status:ee.quota_push.status,size:Number(ee.quota_push.size),push_count:Number(ee.quota_push.push_count)||0},quota_storage:{size:Number(ee.size)}};await j({loading:"正在提交，请稍后...",request:z(JSON.stringify(s)),message:!0}),J(),e()}}),(e,a)=>{const s=k,t=q,l=x,w=v,V=y;return u(),o("div",D,[r(V,{ref_key:"quotaDBFormRef",ref:K,model:n(ee),rules:n(X),class:"px-[2rem] flex justify-center flex-col justify-items-start addfrom"},{default:i(()=>[r(t,{label:"当前已用容量：",prop:"used"},{default:i(()=>[r(s,{modelValue:n(te).split(" ")[0],"onUpdate:modelValue":a[0]||(a[0]=e=>n(te).split(" ")[0]=e),class:"mr-4",width:"16rem",readonly:"",textType:n(te).split(" ")[1]},p({_:2},[n(te).split(" ")[1]?{name:"append",fn:i(()=>[d(m(n(te).split(" ")[1]),1)]),key:"0"}:void 0]),1032,["modelValue","textType"])]),_:1}),r(t,{label:"当前容量配额：",prop:"size"},{default:i(()=>[r(s,{modelValue:n(ee).size,"onUpdate:modelValue":a[1]||(a[1]=e=>n(ee).size=e),class:"mr-4",width:"16rem",type:"number",onChange:le},{append:i(()=>[...a[6]||(a[6]=[d(" MB ",-1)])]),_:1},8,["modelValue"])]),_:1}),r(t,{label:"写入权限状态："},{default:i(()=>[c("div",N,[c("span",{class:_(n(ae))},m(n(se)),3),"已撤销"===n(se)?(u(),o("span",O,[a[7]||(a[7]=d("【",-1)),c("span",{class:"bt-link",onClick:ie},"恢复数据库写入权限"),a[8]||(a[8]=d("】",-1))])):h("",!0),c("i",{disabled:n(L),class:_("svgtofont-el-".concat(n(L)?"loading":"refresh","  bt-link ml-4px")),onClick:re},null,10,E)])]),_:1}),r(t,{label:"设置容量告警："},{default:i(()=>[r(l,{modelValue:n(ee).quota_push.status,"onUpdate:modelValue":a[2]||(a[2]=e=>n(ee).quota_push.status=e),onChange:ue},null,8,["modelValue"])]),_:1}),n(ee).quota_push.status?(u(),f(t,{key:0},{default:i(()=>[r(t,{label:"触发告警大小：",prop:"quota_push.size"},{default:i(()=>[r(s,{modelValue:n(ee).quota_push.size,"onUpdate:modelValue":a[3]||(a[3]=e=>n(ee).quota_push.size=e),class:"mr-4",width:"16rem",type:"number",min:1},{append:i(()=>[...a[9]||(a[9]=[d(" MB ",-1)])]),_:1},8,["modelValue"])]),_:1}),r(t,{label:"告警次数：",class:"mt-20px",prop:"quota_push.push_count"},{default:i(()=>[c("div",T,[a[10]||(a[10]=c("span",{class:"text-small text-secondary whitespace-nowrap"},"每日最多触发",-1)),r(s,{modelValue:n(ee).quota_push.push_count,"onUpdate:modelValue":a[4]||(a[4]=e=>n(ee).quota_push.push_count=e),class:"mx-4",width:"10rem",type:"number"},null,8,["modelValue"]),a[11]||(a[11]=c("span",{class:"text-small text-secondary whitespace-nowrap"},"次告警",-1))])]),_:1}),r(t,{label:"告警方式：",class:"mt-20px"},{default:i(()=>[r(w,{ref_key:"alertItemRef",ref:S,class:"!w-[28rem]",modelValue:n(ee).module,"onUpdate:modelValue":a[5]||(a[5]=e=>n(ee).module=e),isMult:!0,needAll:!1,name:"channel",limit:["sms"]},null,8,["modelValue"])]),_:1})]),_:1})):h("",!0),c("ul",F,[g(c("li",null,[a[12]||(a[12]=d("点击配置后告警状态未更新，尝试点击【",-1)),c("span",{class:"bt-link",onClick:oe},"手动刷新"),a[13]||(a[13]=d("】",-1))],512),[[b,n(ee).quota_push.status]]),a[14]||(a[14]=c("li",null,"温馨提示：此功能为企业版专享功能",-1)),a[15]||(a[15]=c("li",{class:"text-danger"},"到达限额容量后仅撤销当前数据库用户插入权限",-1)),a[16]||(a[16]=c("li",{class:"text-danger"},"使用面板导入或使用root账号导入，不受配额影响",-1)),a[17]||(a[17]=c("li",null,"配额容量：如需取消容量配额，请设为“0”",-1)),a[18]||(a[18]=c("li",null,"此处是直接计算数据文件大小，与实际占用会存在些许误差",-1)),a[19]||(a[19]=c("li",null,"写入权限状态需在后台计算获取，若进入状态不是最新，请重新手动刷新权限",-1))])]),_:1},8,["model","rules"])])}}});export{R as default};
