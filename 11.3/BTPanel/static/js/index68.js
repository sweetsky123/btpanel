import{Q as e,h1 as a,h2 as t,aK as l,h3 as s,h4 as n,u as r,gR as o,M as i,n as c,H as u,p,an as m,x as d,V as _,h5 as v,h6 as b,b3 as y,h7 as g,ao as h,ap as f,$ as w,_ as R,h8 as k,h9 as x,ha as E,hb as S,aC as q}from"./utils-lib.js?v=1763689792";import{j as L,k as C,s as D,r as j,e as M,D as O,bO as T,bP as B,i as A,c as P,v as I,n as V,x as W,y as H,C as z,z as N,L as Q,O as Y,R as $}from"./base-lib.js?v=1763689792";import{_ as G}from"./index109.js?v=1763689792";import{c as F,u as K,a as U}from"./column.js?v=1763689792";import"./useController6.js?v=1763689792";const J=L("MASTER-STORE",()=>({tabActive:C("nodeRedisTabActive","mysqlMaster")})),X=L("MASTER-MYSQL-STORE",()=>{const r=j(!1),o=j([]);return{deleteMysqlSlaveEvent:async t=>{try{let l={slave_ip:t.slave_ip};const s=await e({loading:"正在删除从库，请稍候...",request:a(l),message:!0});return{status:s.status,msg:s.msg}}catch(l){return{status:!1,msg:"删除从库失败"}}},multDeleteMysqlSlaveEvent:async(e,t,l,s)=>{const{label:n,value:o}=s,i=async(e,t)=>{if("delete"===o)return await a({slave_ip:e.slave_ip})};await e({title:"批量".concat(n,"从库"),content:"批量".concat(n,"已选的从库，是否继续操作！"),column:[{label:"从库地址",prop:"slave_ip"},F()],onConfirm:async()=>(await t(i),r.value=!0,!1)})},setMysqlSlaveEvent:async(e,a)=>{try{return await n({slave_ip:e.slave_ip,status:a})}catch(t){l(t)}},getMysqlSlaveHistoryEvent:async()=>{try{return await t()}catch(e){l(e)}},deleteMysqlSlaveHistoryEvent:async e=>{try{return await s(e)}catch(a){l(a)}},isRefreshList:r,mysqlRowData:o}}),Z=()=>({...X(),...D(X())});function ee(e){return"function"==typeof e||"[object Object]"===Object.prototype.toString.call(e)&&!A(e)}const{mysqlRowData:ae}=Z(),{plugin:te,getGlobalInfo:le}=r(),se=async()=>{var a;const t=await le();await e({request:o(),loading:"正在获取节点数据，请稍等...",success:e=>{e.msg&&!1===e.status&&i.error(e.msg),ae.value=e.data.data.filter(e=>!e.is_local&&!e.lpver).map(e=>({label:"".concat(e.remarks," - ").concat(e.server_ip),value:e.id,remarks:e.server_ip}))}}),c({title:"添加主从",area:62,compData:{panel_address:"object"==typeof t&&(null==(a=null==t?void 0:t.panel)?void 0:a.address)},btn:["添加","取消"],component:()=>u(()=>import("./add-form.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),showFooter:!0})},ne=(e,a=!1)=>{const{openMasterSlaveLog:t}=oe();t(e,a)},re=async e=>{await p({title:"".concat("start"===e.run_status?"停止":"启动","从库同步【").concat(e.slave_ip,"】"),content:"是否确认".concat("start"===e.run_status?"停止":"启动","从库同步【").concat(e.slave_ip,"】？")});const{setMysqlSlaveEvent:a,isRefreshList:t}=Z();await a(e,"start"===e.run_status?"stop":"start"),t.value=!0},oe=()=>({openMasterSlaveLog:async(e,a=!1)=>{let t=j();if(a&&"done"===e.config_status){const{data:a}=await v({slave_ip:e.slave_ip});t.value=a}else{if(b(e.error_msg))return void("done"!==e.config_status&&i.error("主从配置未完成，请先完成主从配置：操作 - 同步中"));t.value=e.error_msg}const l=i.load("正在获取日志信息，请稍后...");c({title:"从库状态日志",area:60,component:()=>{let a;return M("div",{class:"p-[1.6rem] max-h-[60rem] overflow-y-auto"},[M("div",{class:"mb-[1.6rem]"},[O("从库地址: "),e.slave_ip]),M(T,{column:1,border:!0},ee(a=Object.entries(t.value).map(([e,a])=>{let t;return M(B,{label:e},ee(t=String(a))?t:{default:()=>[t]})}))?a:{default:()=>[a]})])}}),null==l||l.close()}}),ie=e=>{c({title:"同步进度",area:[60,"auto"],component:()=>u(()=>import("./index375.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{slave_ip:e}})},ce=R(P({__name:"index",setup(e){r();const{isRefreshList:a,multDeleteMysqlSlaveEvent:t}=Z(),{BtOperation:l}=y({options:[{type:"button",label:"添加主从",active:!0,onClick:se},{type:"button",label:"历史备份",active:!1,onClick:()=>{const{openHistoryBackup:e}=(()=>{const{getMysqlSlaveHistoryEvent:e,deleteMysqlSlaveHistoryEvent:a}=Z();return{openHistoryBackup:()=>{const{BtTable:t,refresh:l}=m({request:async()=>{const{data:a}=await e();return a.msg&&!1===a.status&&i.error(a.msg),{data:a.data,total:a.data.length}},columns:[{label:"文件名",prop:"name"},{label:"大小",prop:"size",render:e=>d(e.size)},{label:"创建时间",prop:"mtime",width:160,render:e=>_(e.mtime)},K([{title:"下载",onClick:e=>{window.open("/download?filename="+e.path)}},{title:"删除",onClick:async e=>{await p({title:"删除备份文件",content:"是否确认删除该备份文件？"});const{status:t,msg:s}=await a({path:e.path});t?(i.success(s),l()):i.error(s)}}])]});c({title:"主库历史备份文件",area:62,component:()=>M("div",{class:"p-[1.6rem]"},[M(t,{maxHeight:"40rem"},null)])})}}})();e()}}]}),s=f([{label:"删除",value:"delete",event:t}]),n=e=>({label:e.label,prop:e.prop,render:a=>{const t="function"==typeof e.status?e.status(a):a[e.prop];return e.render?e.render(a):M("span",{class:"bt-link ".concat(e.onClick?"cursor-pointer":""," ").concat(e.class?e.class(a):""),style:{color:"success"===t.type?"var(--el-color-primary)":"#ef0808"},onClick:()=>{var t;null==(t=e.onClick)||t.call(e,a)}},[t.text])}}),{BtTable:o,BtSearch:v,BtRefresh:b,BtPage:R,BtColumn:k,BtBatch:x,refresh:E}=m({request:async e=>{const{data:a}=await g(e);return a.msg&&!1===a.status&&i.error(a.msg),{data:a.data,total:0,search:{}}},columns:[U({key:"slave_ip"}),{label:"从库地址",prop:"slave_ip",minWidth:220},{label:"同步中的数据库",prop:"db_name",render:e=>e.db_name},n({label:"读写状态",prop:"io_status",status:e=>({type:"Yes"===e.io_status&&"done"===e.config_status?"success":"danger",text:"done"!==e.config_status?"未开始":"Yes"===e.io_status?"正常":"api_error"===e.sql_status?"从库面板api连接异常":"异常"}),onClick:ne}),n({label:"同步状态",prop:"sql_status",status:e=>({type:"Yes"===e.sql_status&&"done"===e.config_status?"success":"danger",text:"done"!==e.config_status?"未开始":"Yes"===e.sql_status?"正常":"api_error"===e.sql_status?"从库面板api连接异常":"异常"}),onClick:ne}),n({label:"是否启用",prop:"run_status",status:e=>({type:"start"===e.run_status?"success":"danger",text:"start"===e.run_status?"已启用":"已停用"}),onClick:re}),K([{render:e=>{const a="done"===e.config_status?"状态":"同步中";return M("span",null,[M("span",{onClick:()=>"done"===e.config_status?ne(e,!0):ie(e.slave_ip),title:a,class:"bt-link"},[a]),M("div",{class:"el-divider el-divider--vertical",role:"separator",style:"--el-border-style: solid;"},null)])}},{title:"删除",onClick:e=>(async e=>{const{deleteMysqlSlaveEvent:a,isRefreshList:t}=Z();await p({title:"".concat("删除mysql从库【".concat(e.slave_ip,"】")),content:"".concat("风险操作，此操作不可逆，删除【".concat(e.slave_ip,"】后您将无法管理该从库，是否继续操作？"))});const{status:l,msg:s}=await a(e);l?(i.success(s),t.value=!0):i.error(s)})(e)}])],extension:[s,h(a)],empty:()=>M("span",null,[O("您的列表为空，您可以"),M("span",{class:"bt-link",onClick:se},[O("添加一个主从")])])});return I(()=>{V(()=>{u(()=>import("./index376.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),u(()=>import("./index377.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)})}),(e,a)=>{const t=G,s=w;return W(),H("div",null,[M(t,null,{"header-left":z(()=>[M(N(l))]),"header-right":z(()=>[M(N(v),{class:Q(["mr-[10px]","!w-[210px]"]),placeholder:"请输入地址"}),M(N(b))]),content:z(()=>[M(N(o))]),"footer-left":z(()=>[M(N(x))]),"footer-right":z(()=>[M(N(R))]),_:1}),M(s,{class:"mt-[1rem]",options:[{content:"如从库面板连接异常(从库面板停止，密钥变更)，将无法正常获取读写/同步状态"}]})])}}}),[["__scopeId","data-v-1779f5de"]]),ue=L("MASTER-REDIS-STORE",()=>({isRedisRefreshList:j(!1),redisRowData:j([]),redisAvailableNodes:j({row:[],nodes:[]}),redisGroupDetail:j({}),openNodesLoading:j(!0),slaveListLoad:j(!0)})),pe=()=>({...ue(),...D(ue())}),{isRedisRefreshList:me,redisAvailableNodes:de,redisGroupDetail:_e,openNodesLoading:ve,slaveListLoad:be}=pe(),ye=(e,a=2)=>{if("number"!=typeof e||isNaN(e))return"-";let t=(+(100*e).toFixed(a)).toString();return t.indexOf(".")>-1&&(t=t.replace(/\.0+$/,""),t=t.replace(/(\.[1-9]*)0+$/,"$1")),t+"%"},ge=async()=>{c({title:"新建主从复制组",area:60,btn:["创建","取消"],component:()=>u(()=>import("./index378.js?v=1763689792"),__vite__mapDeps([]),import.meta.url)});try{const{data:e}=await k();e.status||i.error(e.msg||"获取可用节点失败！"),de.value={row:e.data,nodes:e.data.map(e=>{var a;return{label:"".concat(e.name," - ").concat(e.server_ip," ").concat(null===e.group_info?"":"（主从组 - ".concat(null==(a=e.group_info)?void 0:a.group_name,"）")),value:e.id,server_ip:e.server_ip,disabled:null!==e.group_info}})}}catch(e){}finally{ve.value=!1}},he=async(e,a,t,l)=>{const{label:s,value:n}=l,r=async(e,a)=>{if("delete"===n)return await E({group_id:e.group_id})};await e({title:"批量".concat(s),content:"批量删除选中的项目后，项目将无法恢复，是否继续操作？",column:[{label:"主从组名称",prop:"group_name"},F()],onConfirm:async()=>(await a(r),me.value=!0,!1)})},fe=async e=>{c({title:"管理主从复制组【".concat(e.group_name,"】"),area:80,component:()=>u(()=>import("./index379.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{rowData:e}});const{data:a}=await x({group_id:e.group_id});a.status||i.error(a.msg||"获取主从复制组失败！"),_e.value=a.data,be.value=!1},we=(e,a)=>{var t,l,s;c({title:"".concat("slave"===a?"从节点详情【".concat(e.data.server_ip,"】"):"主节点详情【".concat(null==(s=null==(l=null==(t=e.value)?void 0:t.master_detail)?void 0:l.data)?void 0:s.address,"】")),area:70,component:()=>u(()=>import("./index380.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{rowData:e,type:a||"master"}})},Re=async a=>{try{await p({icon:"warning-filled",title:"删除主从复制组【".concat(a.group_name,"】"),content:"即将删除主从复制组，是否继续操作？"}),await e({loading:"正在删除主从复制组，因需重新还原所有redis相关配置进行重启操作，过程可能较长请稍等...",request:E({group_id:a.group_id}),message:!0,success:e=>{me.value=!0}})}catch(t){}},ke=async e=>{c({title:"创建主从复制组",area:60,component:()=>u(()=>import("./redis-create-log.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{task_id:e}})};function xe(e,a="master"){var t,l,s,n,r,o,i,c,u,p,m,_,v,b,y,g,h,f,w,R,k,x,E,S,q,L,C,D,j,M;const O="master"==a?(null==(t=e.value)?void 0:t.master_detail.data)||{}:e.data||{},T=O.memory||{},B=O.performance||{},A=O.connections||{},P=O.replication||{},I=[{name:"base",label:"基础信息",items:[{label:"节点状态",value:"online"===O.status?"在线":"离线"},{label:"Redis版本",value:O.redis_version||"--"},{label:"运行天数",value:(null!=(l=O.uptime_days)?l:"--")+"天"},{label:"监听端口",value:null!=(s=O.port)?s:"--"},{label:"连接数",value:null!=(n=O.connected_slaves)?n:"--"},{label:"角色",value:null!=(r=O.role)?r:"--"}]},{name:"memory",label:"内存信息",items:[{label:"已使用内存",value:null!=(o=T.used_memory_human)?o:"--"},{label:"系统内存",value:T.max_memory?d(T.max_memory):"--"},{label:"内存使用率",value:null!=T.usage_percent?ye(T.usage_percent):"--",tooltip:"计算方式：已使用内存/系统内存"}]},{name:"connection",label:"连接信息",items:[{label:"当前连接数",value:null!=(i=A.connected_clients)?i:"--"},{label:"总连接数",value:null!=(c=A.total_connections)?c:"--",tooltip:"仅记录TCP连接数"},{label:"最大连接数限制",value:null!=(u=A.max_clients)?u:"--"},{label:"拒绝连接数",value:null!=(p=A.rejected_connections)?p:"--"}]},{name:"performance",label:"性能统计",items:[{label:"当前QPS",value:null!=(m=B.qps)?m:"--"},{label:"总执行命令数",value:null!=(_=B.total_commands)?_:"--"},{label:"键命中次数",value:null!=(v=B.keyspace_hits)?v:"--"},{label:"键未命中次数",value:null!=(b=B.keyspace_misses)?b:"--"},{label:"命中率",value:null!=B.hit_rate?ye(B.hit_rate):"--"}]}],V=[{name:"base",label:"基础信息",items:[{label:"Redis版本",value:O.redis_version||"--"},{label:"运行天数",value:(null!=(y=O.uptime_days)?y:"--")+"天"},{label:"监听端口",value:null!=(g=O.tcp_port)?g:"--"},{label:"角色",value:null!=(h=P.role)?h:"--"},{label:"主节点地址",value:null!=(f=P.master_host)?f:"--"},{label:"主节点端口",value:null!=(w=P.master_port)?w:"--"}]},{name:"memory",label:"内存信息",items:[{label:"已使用内存",value:null!=(R=T.used_memory_human)?R:"--"},{label:"系统内存",value:T.max_memory?d(T.max_memory):"--"},{label:"内存使用率",value:null!=T.usage_percent?ye(T.usage_percent):"--"}]},{name:"connection",label:"连接信息",items:[{label:"当前连接数",value:null!=(k=A.connected_clients)?k:"--"},{label:"总连接数",value:null!=(x=A.total_connections)?x:"--"},{label:"阻塞连接数",value:null!=(E=A.rejected_connections)?E:"--"}]},{name:"replication",label:"复制信息",items:[{label:"主从连接状态",value:null!=(S=P.master_link_status)?S:"--"},{label:"最后IO时间",value:P.last_io_seconds?P.last_io_seconds+"秒前":"--"},{label:"同步进度",value:P.sync_in_progress?"是":"否"},{label:"复制偏移量",value:null!=(q=P.repl_offset)?q:"--"},{label:"复制延迟（秒）",value:null!=(L=P.lag)?L:"--"},{label:"是否在线",value:P.is_online?"是":"否"}]},{name:"performance",label:"性能统计",items:[{label:"当前QPS",value:null!=(C=B.qps)?C:"--"},{label:"总执行命令数",value:null!=(D=B.total_commands)?D:"--"},{label:"键命中次数",value:null!=(j=B.keyspace_hits)?j:"--"},{label:"键未命中次数",value:null!=(M=B.keyspace_misses)?M:"--"},{label:"命中率",value:null!=B.hit_rate?ye(B.hit_rate):"--"}]}];return"master"==a?I:V}const Ee={class:"node-master-redis"},Se=P({__name:"index",setup(e){const{isRedisRefreshList:a}=pe(),t=f([{label:"删除主从组",value:"delete",event:he}]),{BtOperation:l}=y({options:j([{type:"button",label:"新建主从复制组",active:!0,onClick:()=>ge()}])}),s=[U({key:"group_id"}),{label:"主从组名称",prop:"group_name",minWidth:120},{label:"主库地址",prop:"master_server_ip",minWidth:160},{label:"内存占用",prop:"memory_usage",minWidth:100,render:e=>M("span",{style:{color:e.memory_usage>=.95?"var(--el-color-danger)":e.memory_usage>.8?"var(--el-color-warning)":"var(--el-color-primary)"}},[ye(e.memory_usage,0)])},{label:"QPS",prop:"qps",minWidth:80},{label:"连接数",prop:"connections",minWidth:80},{label:"从库数量",prop:"slave_count",minWidth:80},{label:"从库正常数",prop:"normal_slaves",minWidth:100,render:e=>M("span",{style:{color:e.normal_slaves<e.slave_count?"var(--el-color-danger)":"var(--el-color-text-primary)"}},[e.normal_slaves])},{label:"平均延迟（秒）",prop:"avg_lag",minWidth:100},K([{title:"管理",onClick:fe},{title:"删除",onClick:Re}])],{BtTable:n,BtBatch:r,BtSearch:o,BtRefresh:c,BtPage:u}=m({request:async e=>{const{data:a}=await S(e);return a.status||i.error(a.msg),{data:a.data,total:a.page.total_count,search:{}}},columns:s,extension:[t,h(a)],empty:()=>M("span",null,[O("您的列表为空，您可以"),M("span",{class:"bt-link",onClick:()=>ge()},[O("新建主从复制组")])])});return(e,a)=>{const t=G;return W(),H("div",Ee,[M(t,null,{"header-left":z(()=>[M(N(l))]),"header-right":z(()=>[M(N(o),{class:Q(["mr-[10px]","!w-[210px]"]),placeholder:"请输入名称或地址"}),M(N(c))]),content:z(()=>[M(N(n))]),"footer-left":z(()=>[M(N(r))]),"footer-right":z(()=>[M(N(u))]),_:1})])}}}),qe=[{label:"MySQL",name:"mysqlMaster",lazy:!0,render:()=>M(ce,null,null)},{label:"Redis",name:"redisMaster",lazy:!0,render:()=>M(Se,null,null)}],Le=P({__name:"index",setup(e){const{tabActive:a}=D(J());return(e,t)=>{const l=q;return W(),Y(l,{class:"module-ui",type:"card",modelValue:N(a),"onUpdate:modelValue":t[0]||(t[0]=e=>$(a)?a.value=e:null),options:N(qe)},null,8,["modelValue","options"])}}}),Ce=Object.freeze(Object.defineProperty({__proto__:null,default:Le},Symbol.toStringTag,{value:"Module"}));export{Z as a,ie as b,ye as f,xe as g,we as h,Ce as i,ke as o,pe as u};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
