var t,a,e,r,s,l,o,n,i;import{Q as u,M as p,aK as d,p as c,hy as v,L as m,n as y,H as _,ao as g,r as x,bE as f,k as h}from"./utils-lib.js?v=1763689792";import{j as w,s as j,r as E,o as b,c as S,aB as k,v as C,x as P,y as V,A as T,D as F,e as L,z as q,R as N,C as O,G as I,g as J,ap as U,H as A,V as D}from"./base-lib.js?v=1763689792";import{B as R}from"./index442.js?v=1763689792";import{l as H,n as M}from"./form-item.js?v=1763689792";import{p as B}from"./useController6.js?v=1763689792";import{u as z,S as X}from"./useStore4.js?v=1763689792";import{m as $}from"./useController17.js?v=1763689792";import{setJavaStaticFile as G,getPythonPortStatus as K,getPortStatus as Q,removeServerProxy as W,bindExtranet as Y,unbindExtranet as Z,addServerProxy as tt,modifyServerProxy as at,addPythonServerProxy as et}from"./site.js?v=1763689792";import{f as rt}from"./validator.js?v=1763689792";const st=w("SITE-EXTERNAL-MAP-STORE",()=>{const{siteInfo:t,siteType:a}=z();return{isRefreshPortList:E(!1),setStaticFileEvent:async a=>{try{const{status:e,index:r,path:s}=a,l=await u({loading:"正在设置静态文件...",request:G({status:e?1:0,index:r,path:s,project_name:t.value.name}),message:!0});return{status:l.status,msg:l.msg}}catch(e){return{status:!1,msg:"设置静态文件失败"}}},getJavaPortData:async()=>{try{const e="python"===a.value?await K({project_name:t.value.name}):await Q({project_name:t.value.name});return Array.isArray(e.data.data)?{data:e.data.data,total:e.data.data.length,other:{}}:{data:[],total:0,other:{}}}catch(e){return{data:[],total:0,other:{}}}},deleteProxyEvent:async t=>{try{const a=await u({loading:"正在删除反向代理映射...",request:W(t),message:!0});return{status:a.status,msg:a.msg}}catch(a){return{status:!1,msg:"删除代理失败"}}},changeStatusEvent:async(t,{status:e})=>{let r=p.load("正在修改状态，请稍后...");try{let r=a.value;const s=e?Y:Z,{data:l}=await s(t,r),o=l.msg||l.data||l.error_msg;return{status:l.status,msg:o}}catch(s){return{status:!1,msg:"修改状态失败"}}finally{r.close()}},saveProxyMapEvent:async(t,e)=>{try{let r=()=>{};switch(!0){case"python"===a.value:r=et;break;case e:r=at;break;case!e:r=tt}const s=await u({loading:"正在操作中，请稍后...",request:r(t)});return{msg:s.msg,status:s.status}}catch(r){d(r)}}}}),{activeType:lt,siteInfo:ot,siteType:nt,rowData:it}=z(),{getFileEvent:ut,saveFileEvent:pt,setSiteInfo:dt,getProjectConfig:ct,jumpTabEvent:vt}=X(),{isRefreshPortList:mt}=j(st()),{setStaticFileEvent:yt,deleteProxyEvent:_t,getJavaPortData:gt,saveProxyMapEvent:xt,changeStatusEvent:ft}=st(),ht=b({status:null==(e=null==(a=null==(t=ot.value)?void 0:t.project_config)?void 0:a.static_info)?void 0:e.status,index:(null==(l=null==(s=null==(r=ot.value)?void 0:r.project_config)?void 0:s.static_info)?void 0:l.index)||"index.html",path:(null==(i=null==(n=null==(o=ot.value)?void 0:o.project_config)?void 0:n.static_info)?void 0:i.path)||"",popup:!1}),wt=E(!1),jt=E(!1),Et=E(!1),bt=async t=>{const a=await yt(t);return a.status&&(ht.popup=!1,St()),a.status},St=async()=>{try{let{project_type:t,name:a}=ot.value,e="python"===t?{name:a}:{project_name:a};const r=await ct(e);if(r.status&&r.data.name){const{project_config:a}=r.data;wt.value=!!a.bind_extranet,jt.value="springboot"!==a.java_type&&"java"===t,a&&dt(r.data)}}catch(t){return{status:!1,msg:"获取域名信息失败"}}},kt=t=>{let a=t.split("\n").filter(t=>""!==t),e=[];return a.forEach(t=>{let a=t.split("=");e.push({k:a[0],v:a[1]})}),e},Ct=t=>"".concat(t,"/").replace(/\s+/g,"").replace(/\/\//g,"/"),Pt=async t=>{try{const a=nt.value;"java"!==a&&(wt.value=!t,await c({width:40,title:"外网映射",content:"".concat(t?"开启":"关闭","外网映射后，").concat(t?"可以通过绑定域名进行访问":"已绑定域名将取消关联访问","，是否继续操作？"),icon:"warning-filled"}));const{name:e,project_config:r}=ot.value,s={python:{data:JSON.stringify({name:e})},java:{data:JSON.stringify({project_name:e})},default:{data:JSON.stringify({project_name:e,domains:r.domains})}},l=s[a]||s.default,o=await ft(l,{status:t});p.request(o),o.status&&(St(),mt.value=!0),Vt(o)}catch(a){d(a)}},Vt=t=>{var a,e,r,s,l;const o=nt.value;if("java"===o&&t.msg.includes("域名")){wt.value=!1;const a=()=>{vt("domain")};return p.msg({message:"".concat(t.msg,'，<span class="text-primary cursor-pointer go-domains">前往添加域名</span>'),duration:3e3,dangerouslyUseHTMLString:!0,type:"error",onClose:()=>{a&&window.removeEventListener("click",a)}}),void(a&&window.addEventListener("click",a,{once:!0}))}if("java"!==o)return t.status&&($.value=!1),void(t.status||t.data.status?p.success((null==(a=t.data)?void 0:a.msg)||(null==(e=t.data)?void 0:e.data)||t.msg):p.error((null==(r=t.data)?void 0:r.error_msg)||(null==(s=t.data)?void 0:s.msg)||(null==(l=t.data)?void 0:l.data)));p.request(t)},Tt=async(t,a)=>{var e,r;if((null==(r=null==(e=ot.value.project_config)?void 0:e.static_info)?void 0:r.status)&&"/"===t.value.proxy_dir)return p.error("项目已存在根路由【/】配置，无法设置该代理目录"),!1;await a(),t.value.rewrite.src_path=t.value.proxy_dir;try{if(!t.value.status&&t.value.proxy_id)return Et.value=!1,(async t=>{const a={proxy_id:t.proxy_id,site_name:ot.value.name},e=await _t(a);return e.status&&(mt.value=!0),e.status})(t.value);{t.value.rewrite.src_path=Ct(t.value.rewrite.src_path),t.value.rewrite.target_path=Ct(t.value.rewrite.target_path);let a=(t=>{let a={python:{site_name:ot.value.name,proxy_port:t.proxy_port,status:t.status?1:0},java:{...t,status:t.status?1:0,site_name:ot.value.name,rewrite:JSON.stringify(t.rewrite),add_headers:JSON.stringify(kt(t.add_headers))}}[nt.value];return a.isEdit||delete a.proxy_id,delete a.isEdit,a})(t.value);const e=await xt(a,t.value.isEdit);return p.request(e),e.status&&(Et.value=!1,mt.value=!0),e.status}}catch(s){}},Ft={class:"flex flex-col"},Lt={class:"flex items-center"},qt={key:0},Nt={key:0,class:"flex items-center"},Ot={class:"mt-[8px] leading-8 text-small list-disc ml-[20px]"},It={key:0,class:"text-danger"},Jt=S({__name:"index",setup(t,{expose:a}){const{siteType:e,siteInfo:r}=j(X()),{isRefreshPortList:s}=j(st()),{getJavaPortData:l}=st(),o=k("popupClose"),n=E(!1),{BtTable:i,refresh:u,config:d}=v({request:async()=>await l(),columns:[B(),{label:"防火墙状态",prop:"fire_wall",width:200,render:t=>{var a,e;return L("span",{onClick:()=>{null===t.fire_wall?y({title:"端口规则",area:44,component:()=>_(()=>import("./add-port-rule.js?v=1763689792"),__vite__mapDeps([]),import.meta.url),compData:{...null===t.fire_wall?{port:t.port,isEdit:!1,noNps:!0}:{...t.fire_wall,isEdit:!0,noNps:!0},refreshFn:()=>{St(),u()}},showFooter:!0}):p.msg({message:L("span",null,[F("请前往系统防火墙模块修改，"),L("span",{class:"text-primary cursor-pointer go-firewall",onClick:b},[F("立即前往")])]),duration:2e3,dangerouslyUseHTMLString:!0,type:"error"})},class:(null===t.fire_wall||"drop"===(null==(a=t.fire_wall)?void 0:a.Strategy)?"text-danger":"text-primary")+" cursor-pointer"},[null===t.fire_wall?"未配置":"accept"===(null==(e=t.fire_wall)?void 0:e.Strategy)?"放行":"禁止"])}},{label:"外网映射",prop:"nginx_proxy",showOverflowTooltip:!1,render:t=>{var a,r,s,l,o;return wt.value?L("div",{class:"flex"},[L("span",{onClick:()=>{let a={isEdit:!1,proxy_dir:"",proxy_id:"",proxy_port:"",site_name:"",rewrite:{status:!1,src_path:"",target_path:""},add_headers:"",status:!0};null!==t.nginx_proxy?(a.isEdit=!0,a.proxy_id=t.nginx_proxy.proxy_id,a.proxy_dir=t.nginx_proxy.proxy_dir,a.proxy_port=t.nginx_proxy.proxy_port,a.site_name=t.nginx_proxy.site_name,a.status=!!t.nginx_proxy.status,"python"!==e.value&&(a.rewrite=t.nginx_proxy.rewrite,a.add_headers=t.nginx_proxy.add_headers.map(t=>"".concat(t.k,"=").concat(t.v)).join("\n"))):(a.isEdit=!1,a.proxy_port=t.port),"python"===e.value&&(a.proxy_dir="/"),$(a)},class:(null===t.nginx_proxy||0===(null==(a=t.nginx_proxy)?void 0:a.status)?"text-danger":"text-primary")+" cursor-pointer max-w-[26rem] truncate",title:null!==t.nginx_proxy&&(null==(r=t.nginx_proxy)?void 0:r.status)?"已开启，代理路由："+(null==(s=t.nginx_proxy)?void 0:s.proxy_dir):""},[null===t.nginx_proxy?"未配置":(null==(l=t.nginx_proxy)?void 0:l.status)?"已开启，代理路由："+(null==(o=t.nginx_proxy)?void 0:o.proxy_dir):"已停止"])," "]):"请先点击上方启用外网映射后再使用"}}],extension:[g(s)]}),w=(t,a)=>({type:"custom",render:a=>(a.value.hasOwnProperty("status")||(a.value.status=!1),L(f,{label:"开启代理"},{default:()=>[L(D,{modelValue:t.value.status,"onUpdate:modelValue":a=>t.value.status=a},null)]}))}),b=()=>{o(),x.push({path:"/firewall/system"})},S=async t=>{var a,e,s,l,o,n;t?z():(await c({title:"确定要关闭静态文件吗？",content:"关闭静态文件后，项目将无法访问静态文件"}),bt({status:!1,index:(null==(s=null==(e=null==(a=r.value)?void 0:a.project_config)?void 0:e.static_info)?void 0:s.index)||"index.html",path:(null==(n=null==(o=null==(l=r.value)?void 0:l.project_config)?void 0:o.static_info)?void 0:n.path)||""}))},z=t=>{var a,e,s,l,o,n;if(!wt.value)return p.error("请先点击上方启用外网映射后再使用");if(d.data.some(t=>{var a;return"/"===(null==(a=t.nginx_proxy)?void 0:a.proxy_dir)}))return r.value.project_config.static_info.status=!1,void p.error("项目已存在根路由【/】配置,无法设置静态文件");const{BtForm:i,submit:u}=m({data:{status:!0,index:(null==(s=null==(e=null==(a=r.value)?void 0:a.project_config)?void 0:e.static_info)?void 0:s.index)||"index.html",path:(null==(n=null==(o=null==(l=r.value)?void 0:l.project_config)?void 0:o.static_info)?void 0:n.path)||""},options:t=>{var a,e;return t.value.status=(null==(e=null==(a=r.value.project_config)?void 0:a.static_info)?void 0:e.status)||!1,J(()=>[{type:"input",label:"默认文档",key:"index",attrs:{placeholder:"请输入内容，用,分割",class:"w-[26rem]"},rules:[{validator:(a,e,r)=>{t.value.status&&""===e?r(new Error("默认文档不能为空")):r()}}]},H("文件路径","path",{attrs:{style:"width: 26rem"},rules:[{validator:(a,e,r)=>{t.value.status&&""===e?r(new Error("文件路径不能为空")):r()}}]},()=>{rt({type:"dir",path:t.value.path,change:a=>{t.value.path=a}})})])},submit:async(t,a)=>(await a(),bt(t.value))});y({title:"设置静态文件【".concat(r.value.name,"】"),area:65,showFooter:!0,component:()=>L(i,{class:"p-2rem"},null),onConfirm:u,onCancel:()=>{St()}})},$=t=>{const{BtForm:a,submit:r}=m({data:t,options:t=>J(()=>[w(t),{type:"input",label:"代理路由",key:"proxy_dir",attrs:{width:"26rem",placeholder:"请输入内容，用,分割",disabled:"python"===e.value,onInput:()=>{}},rules:[{required:!0,message:"请输入代理路由",trigger:"blur"}]},{type:"custom",render:a=>L(f,{label:"代理端口",prop:"proxy_port"},{default:()=>[L(R,{modelValue:t.value.proxy_port,"onUpdate:modelValue":a=>t.value.proxy_port=a,"controls-position":"right",class:"!w-[10rem]"},null)]}),rules:{proxy_port:[{required:!0,message:"请输入代理端口",trigger:"blur"},{validator:(t,a,e)=>{/^\d+$/.test(a)?a<0||a>65535?e(new Error("端口号范围为0-65535")):e():e(new Error("端口号必须为数字，范围0-65535"))}}]}},..."python"!==e.value?[M(n),...n.value?[{type:"textarea",label:"自定义头部",key:"add_headers",attrs:{placeholder:"自定义头部，1行1个,例如：\nX-Client-IP=$remote_addr",class:"!w-[26rem]",width:"26rem",rows:4,resize:"none"}},{type:"custom",render:()=>L(f,{label:"路由重写"},{default:()=>[L(D,{modelValue:t.value.rewrite.status,"onUpdate:modelValue":a=>t.value.rewrite.status=a},null)]})},...t.value.rewrite.status?[{type:"custom",render:()=>L(f,{label:"后端路由",prop:"targetPath"},{default:()=>[L(h,{modelValue:t.value.rewrite.target_path,"onUpdate:modelValue":a=>t.value.rewrite.target_path=a,class:"w-[25rem]",placeholder:"后端路由,例如：".concat(t.value.proxy_dir,"/xxx/").replace(/ /g,"").replace(/\/\//g,"/")},null)]})}]:[]]:[]]:[]]),submit:Tt});y({title:"".concat(t.isEdit?"修改反向代理映射":"添加反向代理映射"),area:50,showFooter:!0,component:()=>L(a,{class:"p-2rem"},null),onConfirm:r})};return C(St),a({init:()=>{St(),u()}}),(t,a)=>{var s;const l=U,o=A;return P(),V("div",Ft,[T("div",Lt,[a[3]||(a[3]=F(" 外网映射 ",-1)),L(l,{modelValue:q(wt),"onUpdate:modelValue":a[0]||(a[0]=t=>N(wt)?wt.value=t:null),class:"ml-[8px]",disabled:q(jt),onChange:q(Pt)},null,8,["modelValue","disabled","onChange"])]),"java"===q(e)||"python"===q(e)?(P(),V("div",qt,[L(q(i),{class:"my-2rem",maxHeight:450}),"springboot"===(null==(s=q(r).project_config)?void 0:s.java_type)?(P(),V("div",Nt,[a[5]||(a[5]=F(" 静态文件： ",-1)),T("span",null,[L(l,{modelValue:q(r).project_config.static_info.status,"onUpdate:modelValue":a[1]||(a[1]=t=>q(r).project_config.static_info.status=t),onChange:S},null,8,["modelValue"])]),L(o,{class:"!ml-[2rem]",type:"default",onClick:a[2]||(a[2]=t=>z())},{default:O(()=>[...a[4]||(a[4]=[F(" 设置静态文件 ",-1)])]),_:1})])):I("",!0)])):I("",!0),T("ul",Ot,[a[6]||(a[6]=T("li",null,"如果您的是HTTP项目，且需要外网通过80/443访问，请开启外网映射",-1)),a[7]||(a[7]=T("li",null,"开启外网映射前，请到【域名管理】中至少添加1个域名",-1)),"java"===q(e)?(P(),V("li",It,"外网映射开启后可在配置文件中查看修改服务器（Nginx/Apache）的配置文件")):I("",!0)])])}}});export{Jt as _};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
