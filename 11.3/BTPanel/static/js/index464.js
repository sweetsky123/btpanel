import{_ as e}from"./index109.js?v=1763689792";import{_ as a,al as t,j as o,b as l,b3 as s,p as n,l as r,k as p,$ as i}from"./utils-lib.js?v=1763689792";import{c as u,r as c,w as d,x as m,y as v,A as f,B as _,z as h,e as w,o as b,C as y,J as g,R as D,H as V,b4 as z,K as k,v as x,I as C,ad as j,ab as U}from"./base-lib.js?v=1763689792";import{u as q}from"./column.js?v=1763689792";import{removeVersionProject as T,recoverVersionProject as R,setVersionPs as S,getVersionProject as H,nowFileBack as I}from"./site.js?v=1763689792";import{_ as B}from"./index423.js?v=1763689792";import{u as F}from"./useStore4.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";const M={class:"download-speed"},P={class:"download-speed-top"},E={class:"download-speed-top-title"},O={class:"download-speed-top-score"},W=a(u({__name:"upload-speed",props:{compData:{default:()=>({})}},setup(e){const a=e,t=c(0);return d(()=>a.compData,e=>{t.value=e.percentum}),(a,o)=>{const l=B;return m(),v("div",M,[f("div",P,[f("div",E,_(e.compData.title),1),f("div",O,_(h(t))+"%",1)]),w(l,{strokeWidth:5,percentage:h(t),showText:!1},null,8,["percentage"])])}}}),[["__scopeId","data-v-cfdd07ba"]]),$={class:"p-2rem"},A=u({__name:"upload-version-file",props:{compData:{default:{}}},setup(e,{expose:a}){const s=e,n=c(),r=c(),p=l(),i=window.location.protocol+"//"+window.location.host+"/mod/php/php_async/upload_version",u=c(!1),d=[".tar.gz",".gz",".zip",".tar",".bz2","xz"].join(","),_=b({f_size:0,f_path:"/tmp/",f_name:"",f_start:0,ps:s.compData.ps,version:s.compData.version,sitename:s.compData.sitename,blob:""}),x=c([]),C=c(0),j=({file:e,onProgress:a,onSuccess:o,onError:l})=>{const n=new FormData,r=Math.min(e.size,_.f_start+2097152);n.append("f_name",e.name),n.append("f_size",e.size),n.append("f_start",_.f_start.toString()),n.append("ps",s.compData.ps),n.append("version",s.compData.version),n.append("sitename",s.compData.sitename),n.append("blob",e.slice(_.f_start,r)),n.append("f_path",_.f_path);const i=t.CancelToken.source();return C.value||(u.value=!0),C.value=Math.round(_.f_start/e.size*100),t.post(s.compData.uploadUrl?s.compData.uploadUrl:"/mod/php/php_async/upload_version",n,{headers:{"Content-Range":"bytes ".concat(_.f_start,"-").concat(e.size,"/"),"x-http-token":window.vite_public_request_token,"Content-Type":"application/x-www-form-urlencoded"},onUploadProgress:e=>{e.event.lengthComputable&&a({percent:Math.round(100*e.loaded/e.total)})},cancelToken:i.token}).then(t=>{"number"==typeof t.data?(_.f_start=t.data,j({file:e,onProgress:a,onSuccess:o,onError:l})):(C.value=0,u.value=!1,p.request(t.data),s.compData.getVersion(),s.compData.close(),o(t.data))}).catch(e=>{C.value=0,u.value=!1,p.error("导入失败"),l(e)}),{abort(){i.cancel("Upload cancelled")}}},U=(e,a)=>{x.value=a},q=(e,a,t)=>{_.f_start=e.percent,x.value=t.map(t=>(t.uid===a.uid&&(t.percentage=e.percent),t))},T=()=>{n.value.submit()};return a({onConfirm:T,open:()=>{r.value.$el.click()},fileData:_}),(e,a)=>{const t=V,l=z,s=o;return m(),v("div",null,[w(l,{"show-file-list":!1,class:"upload-demo",ref_key:"upload",ref:n,name:"blob",accept:h(d),action:i,"auto-upload":!0,multiple:!1,"file-list":h(x),"on-progress":q,"on-change":U,"http-request":j},{default:y(()=>[g(w(t,{ref_key:"openRef",ref:r,size:"small",type:"primary"},null,512),[[k,!1]]),g(w(t,{style:{"margin-left":"10px"},size:"small",type:"success",onClick:T},null,512),[[k,!1]])]),_:1},8,["accept","file-list"]),w(s,{title:!1,modelValue:h(u),"onUpdate:modelValue":a[0]||(a[0]=e=>D(u)?u.value=e:null),area:40},{default:y(()=>[f("div",$,[w(W,{compData:{title:"正在上传文件，请稍后...",percentum:h(C)}},null,8,["compData"])])]),_:1},8,["modelValue"])])}}}),J=u({__name:"index",setup(a,{expose:t}){const{siteInfo:u,activeType:d}=F(),f=d.value,_=l(),V=c(),z=c([]),k=c(!1),B=c(!1),M=c(),P=b({name:"",version:"",ps:""}),E={version:[{required:!0,message:"请输入版本号",trigger:"blur"}]},O=c(!1),W=c(),$=b({version:""}),{BtOperation:J}=s({options:[{label:"添加版本",type:"button",active:!0,onClick:()=>{P.ps="",P.version="",B.value=!0}},{label:"当前目录生成版本",type:"button",onClick:()=>{$.version="",O.value=!0}}]}),K=c([{label:"版本号",prop:"version"},{label:"备注",prop:"ps",minWidth:120,isCustom:!0,showOverflowTooltip:!1,render:e=>{var a;const t={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return e.ps=null==(a=e.ps)?void 0:a.replace(/&(lt|gt|nbsp|amp|quot);/gi,function(e,a){return t[a]}),w("input",{type:"text",value:e.ps,class:"bt-table-input w-full !whitespace-pre-line",placeholder:"点击编辑备注",onBlur:a=>{if(e.ps===a.target.value)return!1;e.ps=a.target.value,(async e=>{try{const a=await S({sitename:u.value.name,version:e.version,ps:e.ps},f);_.request(a),G()}catch(a){}})(e)}},null)}},q([{onClick:async e=>{let a;try{await n({title:"恢复版本【".concat(e.version,"】"),isHtml:!1,content:"恢复版本，会删除目录下所有文件后恢复，请将【当前目录生成版本】备份后继续操作？",type:"calc",icon:"warning-filled"}),a=_.load("正在恢复版本，请稍后...");const t=await R({sitename:u.value.name,version:e.version},f);_.request(t)}catch(t){}finally{a.close()}},title:"恢复"},{onClick:async e=>{try{await n({title:"删除版本【".concat(e.version,"】"),isHtml:!1,content:"删除版本，是否继续操作？",icon:"warning-filled"});const a=await T({sitename:u.value.name,version:e.version},f);_.request(a),a.status&&G()}catch(a){}},title:"删除"}])]),G=async()=>{k.value=!0;try{const{data:e}=await H({sitename:u.value.name},f);z.value=e.data,k.value=!1}catch(e){}},L=async()=>{let e;await W.value.validate();try{e=_.load("正在生成版本，请稍后...");const a=await I({sitename:u.value.name,version:$.version},f);_.request(a),a.status&&(O.value=!1,G())}catch(a){}finally{e.close()}},N=async()=>(await M.value.validate(),V.value.open(),!1),Q=async e=>{};return x(G),t({init:G}),(a,t)=>{const l=r,s=p,n=j,c=i,d=U,f=o,_=e,b=C("bt-loading");return m(),v("div",null,[w(_,null,{"header-left":y(()=>[w(h(J))]),"header-right":y(()=>[...t[5]||(t[5]=[])]),content:y(()=>[g(w(l,{"max-height":"500",column:h(K),data:h(z)},null,8,["column","data"]),[[b,h(k)]])]),"footer-left":y(()=>[...t[6]||(t[6]=[])]),"footer-right":y(()=>[...t[7]||(t[7]=[])]),popup:y(()=>[w(f,{title:"添加版本",area:44,modelValue:h(B),"onUpdate:modelValue":t[2]||(t[2]=e=>D(B)?B.value=e:null),"show-footer":"",confirmText:"上传文件",onConfirm:N},{default:y(()=>[w(d,{class:"p-[2rem]",ref_key:"addFromRef",ref:M,model:h(P),rules:E},{default:y(()=>[w(n,{label:"版本号",prop:"version"},{default:y(()=>[w(s,{modelValue:h(P).version,"onUpdate:modelValue":t[0]||(t[0]=e=>h(P).version=e),placeholder:"请输入版本号",width:"24rem"},null,8,["modelValue"])]),_:1}),w(n,{label:"备注",prop:"ps"},{default:y(()=>[w(s,{modelValue:h(P).ps,"onUpdate:modelValue":t[1]||(t[1]=e=>h(P).ps=e),placeholder:"请输入备注",width:"24rem"},null,8,["modelValue"])]),_:1}),w(A,{ref_key:"fileIpRef",ref:V,onUploadSuccess:Q,compData:{...h(P),sitename:h(u).name,getVersion:G,close:()=>{B.value=!1}}},null,8,["compData"]),w(c,{options:[{content:"支持zip,tar.gz,tar,bz2,gz,xz格式"}],class:"list-disc ml-[7rem]"})]),_:1},8,["model"])]),_:1},8,["modelValue"]),w(f,{title:"当前目录生成版本",area:44,modelValue:h(O),"onUpdate:modelValue":t[4]||(t[4]=e=>D(O)?O.value=e:null),"show-footer":"",onConfirm:L},{default:y(()=>[w(d,{class:"p-2rem",ref_key:"nowFromRef",ref:W,model:h($),rules:E},{default:y(()=>[w(n,{label:"版本号",prop:"version"},{default:y(()=>[w(s,{modelValue:h($).version,"onUpdate:modelValue":t[3]||(t[3]=e=>h($).version=e),placeholder:"请输入版本号",width:"26rem"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]),_:1})])}}});export{J as default};
