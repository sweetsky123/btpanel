import{u as a,V as e,x as l,Q as t,M as s,p as o,iT as n,W as i,l as r,j as u,k as d,_ as p}from"./utils-lib.js?v=1763689792";import{_ as m}from"./index109.js?v=1763689792";import{c,W as v,r as g,o as f,aE as x,v as b,I as w,x as h,y,e as _,C as k,D as j,z as C,J as V,R as q,A as U,F as A,b1 as S,O as z,S as F,G as I,H as R,am as D,an as H}from"./base-lib.js?v=1763689792";import{_ as J}from"./index118.js?v=1763689792";import{h as L,u as M,a as O}from"./column.js?v=1763689792";import{v as P,g as T}from"./useMethod4.js?v=1763689792";import{getBackupDatabase as W,getMysqlCloudServer as B,getMysqlBackupInfo as E,inputDatabase as G,getMysqlAllBackup as N,backupDatabase as Q}from"./database.js?v=1763689792";import"./__commonjsHelpers__.js?v=1763689792";import"./index110.js?v=1763689792";import"./useStore2.js?v=1763689792";import"./validator.js?v=1763689792";import"./index107.js?v=1763689792";const K={class:"p-20px"},X={class:"p-20px flex flex-col"},Y={key:0},Z={class:"p-16px flex flex-col bg-base"},$=p(c({__name:"index",setup(p,{expose:c}){var $;const{panel:aa}=a(),ea=v([]),la=g(null==($=ea.value[0])?void 0:$.id),ta=g(!1),sa=g([]),oa=f({p:1,limit:10,total:0}),na=g({}),ia=g(""),ra=g("detail"),ua=g(!1),da=g([]),pa=g(!1),ma=g(),ca=g(!1),va=g([]),ga=[{label:"数据库名称",prop:"name"},{label:"大小",prop:"size",render:a=>l(a.size)}],fa=(aa.value.backupPath+"/database/mysql/all_backup/").replace(/\/\//g,"/"),xa=async()=>{const a=await t({request:W({sid:la.value}),loading:pa,data:{status:Boolean,msg:String,data:[Array,da]}});a.status||(s.error(a.msg||"获取数据库备份列表失败"),da.value=[])},ba=async()=>{await wa(),await xa(),ja.value=[O(),{label:"数据库名称",prop:"name",width:200},{label:"表数量",prop:"table_num"},T(ea.value,"mysql"),{label:"大小",prop:"size"}],ua.value=!0},wa=async()=>{var a;await t({loading:"正在获取服务器数据，请稍后...",request:B(),data:[Array,ea]}),la.value=null==(a=ea.value[0])?void 0:a.id},ha=async a=>"detail"===ra.value?a():"我已知晓"!==ia.value?(s.error("输入错误，请重新输入！"),!1):(await t({request:G({file:na.value.path}),loading:"正在导入数据库，请稍后...",message:!0}),void(ia.value="")),ya=async()=>{await t({request:N({...oa}),loading:ta,data:{data:[Array,sa],page:i(oa)}})},_a=async()=>{const a=ma.value.tableSelectList;if(!a.length)return s.error("请选择需要备份的数据库"),!1;await t({request:Q({sid:la.value,db_list:JSON.stringify(a.map(a=>a.name))}),loading:"正在备份中，请稍后...",message:!0}),ua.value=!1,ya()},ka=[{label:"文件名称",prop:"name"},{label:"备份时间",prop:"mtime",width:200,render:a=>{const l=new Date(1e3*a.mtime);return x("span",e(l))}},L({prop:"size",width:100}),M([{onClick:async a=>{await t({request:E({file:a.path}),loading:"正在获取数据库详情，请稍后...",data:{data:[Array,va],msg:String},success:a=>{"ok"!==a.msg?s.error(a.msg):(ra.value="detail",ca.value=!0)}})},title:"详情"},{onClick:async a=>{na.value=a,await t({request:E({file:a.path}),loading:"正在获取数据库详情，请稍后...",data:{data:[Array,va]}}),ca.value=!0,ra.value="restore"},title:"恢复"},{onClick:async a=>{window.open("/download?filename="+encodeURIComponent(a.path),"_blank","noopener,noreferrer")},title:"下载"},{onClick:async a=>{await o({title:"删除文件",content:"删除选中数据库备份文件后，该数据库备份文件将永久消失，是否继续操作？",icon:"warning-filled"}),await t({request:n({path:a.path}),loading:"正在删除文件，请稍后...",message:!0}),ya()},title:"删除"}])],ja=g();return b(ya),c({init:ya}),(a,e)=>{const l=R,t=r,s=J,o=D,n=H,i=m,p=u,c=d,v=w("bt-loading"),g=w("focus");return h(),y("div",null,[_(i,null,{"header-left":k(()=>[_(l,{onClick:ba,type:"primary"},{default:k(()=>[...e[10]||(e[10]=[j("数据库备份",-1)])]),_:1}),_(l,{onClick:e[0]||(e[0]=a=>C(P)(()=>ya(),C(fa)))},{default:k(()=>[...e[11]||(e[11]=[j("从本地上传",-1)])]),_:1})]),content:k(()=>[V(_(t,{column:ka,data:C(sa)},null,8,["data"]),[[v,C(ta)]])]),"footer-right":k(()=>[_(s,{total:C(oa).total,page:C(oa).p,"onUpdate:page":e[1]||(e[1]=a=>C(oa).p=a),row:C(oa).limit,"onUpdate:row":e[2]||(e[2]=a=>C(oa).limit=a),onChange:e[3]||(e[3]=a=>ya())},null,8,["total","page","row"])]),popup:k(()=>[_(p,{title:"数据库备份",modelValue:C(ua),"onUpdate:modelValue":e[5]||(e[5]=a=>q(ua)?ua.value=a:null),onConfirm:_a,showFooter:"",area:60},{default:k(()=>[U("div",K,[_(i,null,{"header-right":k(()=>[_(n,{class:"!w-[16rem]",modelValue:C(la),"onUpdate:modelValue":e[4]||(e[4]=a=>q(la)?la.value=a:null),onChange:xa},{default:k(()=>[(h(!0),y(A,null,S(C(ea),(a,e)=>(h(),z(o,{key:e,label:a.ps,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),content:k(()=>[V(_(t,{ref_key:"backupTableRef",ref:ma,column:C(ja),data:C(da),"max-height":"360"},null,8,["column","data"]),[[v,C(pa)],[v,"正在加载列表，请稍后...","title"]])]),_:1})])]),_:1},8,["modelValue"]),_(p,{title:"restore"===C(ra)?"恢复数据库":"数据库详情",modelValue:C(ca),"onUpdate:modelValue":e[8]||(e[8]=a=>q(ca)?ca.value=a:null),showFooter:"",area:60,onConfirm:ha,onCancel:e[9]||(e[9]=a=>ia.value="")},{default:k(()=>[U("div",X,[_(t,{column:ga,data:C(va),"max-height":"360"},null,8,["data"]),"restore"===C(ra)?(h(),y("div",Y,[e[13]||(e[13]=U("div",{class:"flex items-center my-12px text-base"},[U("i",{class:"text-warning svgtofont-el-warning-filled !text-titleLarge mr-8px"}),U("span",null,"恢复后会覆盖当前数据库数据，此操作不可逆，是否继续操作？")],-1)),U("div",Z,[e[12]||(e[12]=U("span",{class:"mb-4px"},[j("请手动输入 "),U("span",{class:"text-danger"},'"我已知晓"'),j(" ，完成验证")],-1)),V(_(c,{modelValue:C(ia),"onUpdate:modelValue":e[6]||(e[6]=a=>q(ia)?ia.value=a:null),width:"52rem",onPasteCapture:e[7]||(e[7]=F(()=>{},["prevent"]))},null,8,["modelValue"]),[[g]])])])):I("",!0)])]),_:1},8,["title","modelValue"])]),_:1}),e[14]||(e[14]=U("ul",{class:"mt-16px leading-8 text-small list-disc ml-20px"},[U("li",null,"恢复仅限于在本页面进行的备份进行恢复，非本页面的备份数据可能无法正确恢复，请注意。")],-1))])}}}),[["__scopeId","data-v-4c898673"]]);export{$ as default};
